# ðŸš€ ä½“é‡ç®¡ç†ã‚¢ãƒ—ãƒª CI/CD Pipeline
# ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ & GitHub Pagesè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  CACHE_VERSION: 'v1'

jobs:
  # ðŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¸ãƒ§ãƒ–
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        browser: [chrome, firefox]
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci
          # JSDoMç’°å¢ƒç”¨ã®è¿½åŠ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm install --save-dev puppeteer jsdom
        
      - name: ðŸ”§ Setup test environment
        run: |
          # ãƒ†ã‚¹ãƒˆç”¨ã®ç’°å¢ƒå¤‰æ•°è¨­å®š
          echo "CI=true" >> $GITHUB_ENV
          echo "NODE_ENV=test" >> $GITHUB_ENV
          # Puppeteerç”¨ã®Chromeè¨­å®š
          export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=false
          
      - name: ðŸš€ Run Firebase Tests
        run: npm run test:firebase
        continue-on-error: false
        
      - name: ðŸŽ¯ Run UI Tests
        run: |
          # ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§UI ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          export HEADLESS=true
          npm run test:ui
        continue-on-error: false
        
      - name: ðŸ’¾ Run Storage Tests  
        run: npm run test:storage
        continue-on-error: false
        
      - name: âš–ï¸ Run Weight Management Tests
        run: npm run test:weight
        continue-on-error: false
        
      - name: ðŸ” Run Field Validation Tests
        run: npm run test:field-validation
        continue-on-error: false
        
      - name: ðŸ”— Run Integration Tests
        run: npm run test:integration
        continue-on-error: false
        
      - name: ðŸ“Š Generate Test Coverage
        run: |
          # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆå°†æ¥çš„ã«è¿½åŠ ï¼‰
          echo "Test coverage reporting - TODO"
          
      - name: ðŸ“‹ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.browser }}
          path: |
            development/tools/testing/test-results/*.json
            development/tools/testing/test-results/*.html
            tools/testing/test-results/*.json
          retention-days: 30
          
  # ðŸ” ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
  quality:
    name: ðŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ðŸ“¦ Install dependencies
        run: npm ci
        
      - name: ðŸ” Run ESLint (if configured)
        run: |
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
            echo "Running ESLint..."
            npx eslint . --ext .js,.html --ignore-path .gitignore || echo "ESLint not configured, skipping"
          else
            echo "ESLint not configured, skipping"
          fi
        continue-on-error: true
        
      - name: ðŸŽ¨ Check Code Format (Prettier)
        run: |
          if [ -f ".prettierrc" ]; then
            echo "Checking code format..."
            npx prettier --check . || echo "Prettier not configured, skipping"
          else
            echo "Prettier not configured, skipping"
          fi
        continue-on-error: true
        
      - name: ðŸ“Š Analyze Bundle Size
        run: |
          # ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºåˆ†æžï¼ˆç°¡æ˜“ç‰ˆï¼‰
          echo "Analyzing project size..."
          du -sh . --exclude=node_modules --exclude=.git
          find . -name "*.js" -not -path "./node_modules/*" -not -path "./.git/*" | xargs wc -l | tail -1

  # ðŸš€ GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
  deploy:
    name: ðŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [test, quality]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
      pages: write
      id-token: write
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ðŸ“¦ Install dependencies
        run: npm ci
        
      - name: ðŸ”§ Prepare for deployment
        run: |
          # ãƒ†ã‚¹ãƒˆã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
          find . -name "*test-evidence*.json" -delete || echo "No test evidence files found"
          # æœ¬ç•ªç”¨ã®æœ€é©åŒ–å‡¦ç†
          echo "Preparing production build..."
          
      - name: ðŸ“‹ Setup Pages
        uses: actions/configure-pages@v4
        
      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
          
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ðŸ“ˆ PRåˆ†æžï¼ˆãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿ï¼‰
  pr-analysis:
    name: ðŸ“ˆ PR Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ðŸ“Š Analyze changes
        run: |
          echo "ðŸ“Š PR Analysis Results" >> pr-analysis.md
          echo "=====================" >> pr-analysis.md
          echo "" >> pr-analysis.md
          
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD | wc -l)
          echo "ðŸ“ Changed files: $CHANGED_FILES" >> pr-analysis.md
          
          # å¤‰æ›´è¡Œæ•°
          ADDED_LINES=$(git diff --numstat origin/main...HEAD | awk '{sum += $1} END {print sum}')
          DELETED_LINES=$(git diff --numstat origin/main...HEAD | awk '{sum += $2} END {print sum}')
          echo "âž• Added lines: $ADDED_LINES" >> pr-analysis.md
          echo "âž– Deleted lines: $DELETED_LINES" >> pr-analysis.md
          echo "" >> pr-analysis.md
          
          # å¤‰æ›´ã•ã‚ŒãŸã‚¿ãƒ–ã®ç‰¹å®š
          echo "ðŸ·ï¸ Changed tabs:" >> pr-analysis.md
          git diff --name-only origin/main...HEAD | grep "tabs/" | cut -d'/' -f2 | sort -u >> pr-analysis.md || echo "No tab changes" >> pr-analysis.md
          
          cat pr-analysis.md
          
      - name: ðŸ’¬ Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('pr-analysis.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ¤– **è‡ªå‹•PRåˆ†æžçµæžœ**\n\n```\n' + analysis + '\n```'
            });

  # ðŸ”„ å®šæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæ¯Žé€±æ—¥æ›œæ—¥ï¼‰
  cleanup:
    name: ðŸ”„ Weekly Cleanup
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸ§¹ Clean old artifacts
        run: |
          echo "Cleaning old test evidence files..."
          find . -name "*test-evidence*.json" -mtime +7 -delete || echo "No old files found"
          
          # å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å‰Šé™¤
          find . -name "*.backup*" -mtime +30 -delete || echo "No old backups found"
          
      - name: ðŸ“Š Generate cleanup report
        run: |
          echo "ðŸ§¹ Weekly cleanup completed on $(date)" > cleanup-report.txt
          echo "Files cleaned: $(find . -name "*test-evidence*.json" | wc -l)" >> cleanup-report.txt

# ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®šï¼ˆæ¯Žé€±æ—¥æ›œæ—¥ AM 2:00 UTCï¼‰
on:
  schedule:
    - cron: '0 2 * * 0'