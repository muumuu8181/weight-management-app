# 体重管理アプリ - プロジェクト引き継ぎ文書 v0.66

## プロジェクト概要

### 基本情報
- **アプリケーション名**: 体重管理アプリ
- **現在バージョン**: v0.66
- **開発開始**: 2025年8月
- **技術スタック**: HTML + CSS + JavaScript + Firebase
- **ホスティング**: GitHub Pages（自動デプロイ）

### アプリケーション構成
- **メインファイル**: `index.html`（単一ファイル構成）
- **データベース**: Firebase Realtime Database
- **認証**: Google OAuth
- **チャート**: Chart.js
- **レスポンシブ**: モバイルファースト設計

## バージョン管理方針

### バージョンアップルール
- **増分**: 0.01刻み（v0.65 → v0.66 → v0.67...）
- **タイミング**: 機能追加・修正の都度
- **表示場所**: アプリ内タイトル、ログ出力
- **管理場所**: `APP_VERSION`定数（493行目付近）

### リリースフロー（必須手順）
1. ローカルで開発・テスト
2. バージョン番号を0.01増加（APP_VERSION定数を更新）
3. **必須**: Git commit & push で GitHub Pages へ自動デプロイ
   - `git add .`
   - `git commit -m "commit message with Claude Code signature"`
   - `git push origin main`
4. GitHub Pages自動デプロイ（数分後に本番反映）

**重要**: 機能実装後は必ずGitHub Pagesまで公開すること。ローカルテストのみで終了してはいけない。

## アーキテクチャ詳細

### タブベース設計
現在8タブ構成で設計されており、各タブが独立した機能を持つ：

1. **タブ1**: 体重管理（完全実装）
2. **タブ2**: 睡眠管理（完全実装）
3. **タブ3**: 部屋片づけ（プレースホルダー）
4. **タブ4**: ストレッチ（プレースホルダー）
5. **タブ5-8**: 未実装（プレースホルダー）

### データベース構造（Firebase Realtime Database）
```
/users/{uid}/
├── weightData/
│   └── {push_id}/
│       ├── weight: number
│       ├── timing: string
│       ├── memo: string
│       ├── date: "YYYY-MM-DD"
│       ├── time: "HH:MM"
│       └── timestamp: ServerValue
└── sleepData/
    └── {push_id}/
        ├── sleepType: string
        ├── sleepTime: "HH:MM"
        ├── quality: number (1-5)
        ├── tags: Array<string>
        ├── memo: string
        ├── date: "YYYY-MM-DD"
        └── timestamp: ServerValue
```

### 認証システム
- **方式**: Google OAuth（Firebase Auth）
- **UI**: ログイン/ログアウトボタン
- **状態管理**: `window.user`グローバル変数
- **権限**: ユーザーは自分のデータのみアクセス可能

## 実装済み機能詳細

### タブ1: 体重管理
- **測定記録**: 体重値、測定タイミング、メモ
- **制限**: なし（1日何回でも記録可能）
- **チャート表示**: 
  - 1日表示（時間軸：00:00-23:59固定）
  - 1週間/1ヶ月表示（日付軸）
- **固定範囲**: Y軸 71.5-74.0kg
- **統計**: 平均値、最大・最小値、記録数
- **モード**: 通常・追加・削除の3モード統一システム

### タブ2: 睡眠管理
- **記録項目**: 
  - 睡眠タイプ（夜間睡眠、昼寝、仮眠）
  - 記録時間（現在時刻がデフォルト）
  - 睡眠の質（1-5点評価）
  - タグ機能（二度寝、夢を見た、など）
  - メモ（任意）
- **デフォルト値**: 
  - 記録日：今日の日付
  - 記録時間：現在時刻
- **初期化**: ログイン状態に関係なくタブ切り替え時に実行

### 共通機能
- **動的タイトル**: タブ切り替え時にタイトルが変更
- **レスポンシブ**: モバイルファースト設計
- **エラーハンドリング**: Firebase操作の例外処理
- **ログシステム**: 操作履歴の表示
- **データエクスポート**: CSV形式でのデータコピー

## 技術実装のポイント

### Chart.js 使用時の注意
- **重要**: 新しいチャート作成前に必ず`chart.destroy()`を実行
- **理由**: メモリリーク防止、イベントリスナー重複回避
- **実装場所**: `updateChart()`関数内

### Firebase データ操作
- **非同期処理**: async/await パターンを使用
- **エラーハンドリング**: try-catch でラップ
- **リアルタイム更新**: `.on('value')`リスナーを活用

### モード切り替えシステム
```javascript
// 3つのモード: normal, add, delete
let currentMode = 'normal';

// モード切り替え時の統一処理
function switchMode(mode) {
    currentMode = mode;
    updateModeUI();  // UI状態を更新
    updateModeButtons();  // ボタン状態を更新
}
```

### UI フィードバック
- **保存ボタン**: 色変化 + アニメーション + テキスト変更
- **モード切り替え**: 視覚的フィードバック（色・アニメーション）
- **データ表示**: 直近7件に制限（パフォーマンス向上）

## これまでの問題と対策

### 解決済みの問題

#### 1. 平均値 > 最大値 問題
- **原因**: 異なるデータセット間での日付範囲不一致
- **対策**: データフィルタリング処理の統一化
- **修正版**: v0.58で解決

#### 2. 削除モード動作不良
- **原因**: イベントリスナーの重複登録
- **対策**: `replaceWith(cloneNode(true))`による要素置換
- **修正版**: v0.61で解決

#### 3. ユーザー参照エラー
- **原因**: スコープ問題（`user` vs `window.user`）
- **対策**: グローバル参照への統一
- **修正版**: v0.62で解決

#### 4. 睡眠タグが保存されない
- **原因**: 過度な必須項目バリデーション
- **対策**: バリデーション条件の緩和
- **修正版**: v0.63で解決

#### 5. 睡眠デフォルト値が設定されない
- **原因**: ログイン状態依存の初期化
- **対策**: タブ切り替え時の無条件初期化
- **修正版**: v0.66で解決

### 開発時の注意点
1. **既存機能の保護**: 新機能追加時は既存機能を破壊しない
2. **バックアップ**: 大きな変更前は必ずバックアップ作成
3. **単一責任**: 各関数は単一の責任を持つよう設計
4. **テスト**: 実装後は必ず手動テストを実施
5. **バージョンアップ**: 機能追加・修正の都度0.01刻みで更新

## 開発方針・設計原則

### コード品質
- **可読性**: わかりやすい変数名・関数名
- **保守性**: 機能ごとの関数分離
- **拡張性**: 新しいタブの追加が容易な構造
- **安定性**: エラー処理の充実

### データ管理
- **重要データ**: Firebase Realtime Database
- **軽量設定**: localStorage（カスタムタイミング等）
- **セキュリティ**: ユーザーごとのデータ分離

### UI/UX
- **フィードバック**: ユーザー操作に対する視覚的反応
- **応答性**: モバイルデバイスでの快適な操作
- **直感性**: 説明なしで使える操作感

## 今後の開発計画

### Phase 1: 安定化（v0.66-v0.70）
- 既存機能のバグ修正
- パフォーマンス最適化
- UI/UX の微調整

### Phase 2: タブ拡張（v0.71-v0.80）
- タブ3: 部屋片づけ機能実装
- タブ4: ストレッチ機能実装
- 各タブの独立性確保

### Phase 3: 機能強化（v0.81-v0.90）
- データエクスポート機能拡張
- チャートカスタマイズ機能
- 統計機能の充実

### Phase 4: モバイル最適化（v0.91-v1.00）
- PWA対応
- オフライン機能
- プッシュ通知

### 次の優先実装項目
1. **タブ3（部屋片づけ）**: 清掃記録、部屋評価システム
2. **タブ4（ストレッチ）**: 運動記録、継続性追跡
3. **データバックアップ**: 全データの一括エクスポート

## ファイル構造

```
weight-management-app/
├── index.html                          # メインアプリケーション
├── PROJECT_HANDOVER_v0.66.md          # この引き継ぎ文書
├── KNOWLEDGE_VERIFICATION.md          # 知識確認チェックリスト
├── answers/                           # チェックリスト解答フォルダ
│   └── CHECKLIST_ANSWERS.md          # 解答集
└── .github/
    └── workflows/
        └── deploy.yml                 # 自動デプロイ設定
```

## 緊急時の対処方法

### サイトダウン時
1. GitHub Pages の状況確認
2. 最新コミットの確認
3. 必要に応じて前のバージョンにロールバック

### データベース問題
1. Firebase Console でデータ確認
2. 認証設定の確認
3. セキュリティルールの確認

### 開発環境問題
1. ローカルファイルの確認
2. Git 状態の確認
3. ブラウザキャッシュのクリア

## 連絡先・リソース

### 重要なURL
- **本番サイト**: https://muumuu8181.github.io/weight-management-app/
- **GitHub Repository**: https://github.com/muumuu8181/weight-management-app
- **Firebase Console**: https://console.firebase.google.com/

### 学習リソース
- Firebase公式ドキュメント
- Chart.js公式ドキュメント
- JavaScript非同期処理の基礎
- レスポンシブデザインの原則

---

**最終更新**: 2025年8月28日  
**対象バージョン**: v0.66  
**作成者**: Claude Code Assistant

このドキュメントは継続的に更新され、プロジェクトの完全な理解と円滑な引き継ぎを支援します。