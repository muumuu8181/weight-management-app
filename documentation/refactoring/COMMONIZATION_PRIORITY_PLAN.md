# 🚀 共通化作業計画書 - 優先度付きロードマップ

## 📋 概要

Git Worktree展開前に実施すべき共通化作業の優先度付き計画書です。全16タブの効率化と保守性向上を目指します。

---

## 🎯 **優先度スコア計算基準**

各項目を以下の基準で100点満点で評価：

| 評価項目 | 配点 | 判定基準 |
|----------|------|----------|
| **影響範囲** | 30点 | 対象ファイル数・行数 |
| **削減効果** | 25点 | 期待される行数削減 |
| **リスク度** | 20点 | 作業の複雑さ・危険性 |
| **緊急性** | 15点 | 他の作業への影響度 |
| **実装コスト** | 10点 | 必要な作業時間 |

---

## 🏆 **優先度ランキング TOP10**

### **🥇 1位: Firebase CRUD操作統一 (95点)**
- **スコア内訳**: 影響30 + 削減25 + リスク15 + 緊急15 + コスト10
- **対象**: 全10タブ、146箇所
- **削減効果**: 800-1000行
- **作業時間**: 2-3日
- **緊急理由**: 全タブのデータ操作に影響、最優先統一が必須

#### 具体的な統一内容：
```javascript
// 現状（各タブで重複）
database.ref(`users/${userId}/weights`).push(data)
database.ref(`users/${userId}/weights`).on('value', callback)
database.ref(`users/${userId}/weights/${id}`).update(data)
database.ref(`users/${userId}/weights/${id}`).remove()

// 統一後
FirebaseCRUD.save('weights', userId, data)
FirebaseCRUD.load('weights', userId, callback) 
FirebaseCRUD.update('weights', userId, id, data)
FirebaseCRUD.delete('weights', userId, id)
```

---

### **🥈 2位: tab-weight-original.js分割・統合 (92点)**
- **スコア内訳**: 影響28 + 削減25 + リスク14 + 緊急15 + コスト10
- **対象**: 1,897行の巨大ファイル
- **削減効果**: 1,500行
- **作業時間**: 3-4日
- **緊急理由**: プロジェクト最大ファイル、他の共通化作業の基盤

#### 分割方針：
1. **Firebase操作** → `shared/utils/firebase-crud.js`
2. **Chart.js処理** → `shared/components/chart-wrapper.js`
3. **UI操作** → `shared/components/form-handler.js`
4. **データ検証** → `shared/utils/validation.js`

---

### **🥉 3位: タブ初期化処理統一 (88点)**
- **スコア内訳**: 影響26 + 削減22 + リスク15 + 緊急15 + コスト10
- **対象**: 73箇所、11ファイル
- **削減効果**: 500-700行
- **作業時間**: 2-3日
- **緊急理由**: 全タブの起動処理、統一により安定性向上

#### 統一パターン：
```javascript
// 現状（各タブで異なる初期化）
function initWeightTab() { ... }
function initSleepTab() { ... }
function initRoomTab() { ... }

// 統一後
TabInitializer.init('weight', weightConfig)
TabInitializer.init('sleep', sleepConfig)
TabInitializer.init('room', roomConfig)
```

---

### **4位: tab-memo-list.js共通機能化 (85点)**
- **スコア内訳**: 影響24 + 削減23 + リスク13 + 緊急13 + コスト12
- **対象**: 1,308行
- **削減効果**: 600-800行
- **作業時間**: 2-3日
- **共通化対象**: 優先度管理、フィルター機能、統合処理

---

### **5位: データ検証・バリデーション統一 (82点)**
- **スコア内訳**: 影響22 + 削減20 + リスク15 + 緊急15 + コスト10
- **対象**: 全タブの入力検証処理
- **削減効果**: 400-500行
- **作業時間**: 1-2日

---

### **6位: UI状態管理・ボタン操作統一 (79点)**
- **スコア内訳**: 影響21 + 削減18 + リスク15 + 緊急15 + コスト10
- **対象**: window.select系関数、DOM操作
- **削減効果**: 300-400行
- **作業時間**: 1-2日

---

### **7位: Chart.js描画処理統一 (76点)**
- **スコア内訳**: 影響19 + 削減17 + リスク15 + 緊急15 + コスト10
- **対象**: 体重・睡眠・万歩計等のグラフ
- **削減効果**: 200-300行
- **作業時間**: 1-2日

---

### **8位: tab6-job-dc.js機能共通化 (73点)**
- **スコア内訳**: 影響18 + 削減16 + リスク14 + 緊急13 + コスト12
- **対象**: 726行
- **削減効果**: 300-400行
- **作業時間**: 2日

---

### **9位: エラーハンドリング・ログ処理統一 (70点)**
- **スコア内訳**: 影響17 + 削減15 + リスク13 + 緊急13 + コスト12
- **対象**: try-catch、log()関数
- **削減効果**: 150-200行
- **作業時間**: 1日

---

### **10位: CSS・スタイル処理共通化 (67点)**
- **スコア内訳**: 影響16 + 削減14 + リスク12 + 緊急13 + コスト12
- **対象**: 重複スタイル、動的CSS変更
- **削減効果**: 100-200行
- **作業時間**: 1-2日

---

## 📅 **実装タイムライン**

### **Week 1: 最重要基盤整備**
| 日 | 作業内容 | 担当 | 成果物 |
|----|----------|------|--------|
| Day 1-2 | Firebase CRUD操作統一 | メイン開発者 | `shared/utils/firebase-crud.js` |
| Day 3-4 | tab-weight-original.js分割 | メイン開発者 | 4ファイルに分割 |
| Day 5 | タブ初期化処理統一(1/2) | サブ開発者 | `shared/core/tab-initializer.js` |

### **Week 2: 高優先度機能統合**
| 日 | 作業内容 | 担当 | 成果物 |
|----|----------|------|--------|
| Day 6-7 | タブ初期化処理統一(2/2) | メイン開発者 | 全タブ統一完了 |
| Day 8-9 | tab-memo-list.js共通化 | サブ開発者 | 機能分離・統合 |
| Day 10 | データ検証統一 | メイン開発者 | `shared/utils/validation.js` |

### **Week 3: 仕上げ・安定化**
| 日 | 作業内容 | 担当 | 成果物 |
|----|----------|------|--------|
| Day 11-12 | UI状態管理統一 | サブ開発者 | `shared/components/ui-manager.js` |
| Day 13 | Chart.js処理統一 | メイン開発者 | `shared/components/chart-wrapper.js` |
| Day 14 | 全タブ統合テスト | 全員 | テスト完了報告書 |

---

## ⚠️ **リスク管理**

### **高リスク項目**
1. **tab-weight-original.js分割** - 既存機能への影響大
2. **Firebase CRUD統一** - データ操作の根幹変更
3. **タブ初期化統一** - 全タブの起動に影響

### **リスク軽減策**
- バックアップ必須（各作業前）
- 段階的テスト実行
- ロールバック手順準備
- 機能単位での分割実装

---

## 📊 **期待される成果**

| 指標 | 現状 | 目標 | 改善率 |
|------|------|------|--------|
| **総コード行数** | 21,235行 | 17,335行 | -18.4% |
| **タブ固有コード** | 9,090行 | 5,190行 | -42.9% |
| **共通化率** | 50.9% | 65.2% | +14.3pt |
| **重複コード** | 約30% | 約10% | -20pt |

---

## 🎯 **成功の判定基準**

### **必達目標**
- ✅ Firebase操作を100%統一
- ✅ 3,900行以上のコード削減  
- ✅ 全テスト通過（npm test）
- ✅ 既存機能の動作保証

### **理想目標**
- 🏆 4,500行のコード削減
- 🏆 共通化率70%達成
- 🏆 新機能追加時間50%短縮
- 🏆 バグ修正時間80%短縮

---

## 📞 **作業体制**

### **役割分担**
- **📋 プロジェクトマネージャー**: 全体進捗管理、品質保証
- **👨‍💻 メイン開発者**: 高リスク項目、Firebase関連
- **👩‍💻 サブ開発者**: UI系、低リスク項目
- **🧪 テスター**: 各工程での動作確認

### **コミュニケーション**
- **日次**: 進捗共有（10分）
- **週次**: 品質レビュー（30分）
- **問題発生時**: 即時対応・相談

---

## 🚨 **重要な注意点**

1. **Git Worktree展開は共通化完了後に実施**
2. **作業中は必ずブランチを分けて実装**
3. **各段階でのバックアップとテストを徹底**
4. **既存機能への影響を最小限に抑制**

---

**📝 この計画書は共通化作業の指針として、全AI・全開発者が参照可能です。**

**🎯 目標: 2週間で4,000行削減、Git Worktree展開準備完了！**