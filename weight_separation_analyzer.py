#!/usr/bin/env python3
"""
ä½“é‡ç®¡ç†ã‚³ãƒ¼ãƒ‰å®Œå…¨åˆ†é›¢ãƒ„ãƒ¼ãƒ«
index.htmlã‹ã‚‰ä½“é‡é–¢é€£ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•æ¤œå‡ºãƒ»åˆ†æ
"""

import re
import json
from pathlib import Path

class WeightCodeAnalyzer:
    def __init__(self, index_file="index.html"):
        self.index_file = Path(index_file)
        self.weight_patterns = [
            r'weight[A-Z]\w*',  # weightChart, weightValue etc
            r'Weight[A-Z]\w*',  # WeightTab etc
            r'\.weight-\w+',    # CSS classes
            r'loadUserWeightData',
            r'saveWeightData',
            r'allWeightData',
            r'selectedTimingValue',
            r'selectedTopValue', 
            r'selectedBottomValue',
            r'editingEntryId',
            r'weightChart',
            r'timing.*btn',     # timing buttons
            r'clothing.*btn',   # clothing buttons
        ]
        
    def analyze(self):
        """index.htmlã‹ã‚‰ä½“é‡é–¢é€£ã‚³ãƒ¼ãƒ‰ã‚’å…¨æ¤œå‡º"""
        if not self.index_file.exists():
            return {"error": f"{self.index_file} not found"}
            
        content = self.index_file.read_text(encoding='utf-8')
        lines = content.split('\n')
        
        results = {
            "total_lines": len(lines),
            "weight_related": [],
            "functions_to_remove": [],
            "variables_to_remove": [],
            "css_to_remove": []
        }
        
        # å„è¡Œã‚’ãƒã‚§ãƒƒã‚¯
        for line_num, line in enumerate(lines, 1):
            for pattern in self.weight_patterns:
                if re.search(pattern, line, re.IGNORECASE):
                    results["weight_related"].append({
                        "line": line_num,
                        "content": line.strip(),
                        "pattern": pattern
                    })
                    
        # é–¢æ•°ãƒ–ãƒ­ãƒƒã‚¯ã®æ¤œå‡º
        function_patterns = [
            r'window\.saveWeightData\s*=.*?\{',
            r'window\.loadUserWeightData\s*=.*?\{',
            r'function.*weight.*\(',
            r'async.*weight.*\('
        ]
        
        for pattern in function_patterns:
            matches = re.finditer(pattern, content, re.IGNORECASE | re.MULTILINE)
            for match in matches:
                start_pos = match.start()
                line_num = content[:start_pos].count('\n') + 1
                results["functions_to_remove"].append({
                    "line": line_num,
                    "pattern": pattern,
                    "match": match.group()
                })
        
        return results
    
    def generate_removal_script(self, analysis_result):
        """é™¤å»ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ"""
        script_lines = [
            "#!/bin/bash",
            "# ä½“é‡é–¢é€£ã‚³ãƒ¼ãƒ‰è‡ªå‹•é™¤å»ã‚¹ã‚¯ãƒªãƒ—ãƒˆ",
            "# Generated by WeightCodeAnalyzer",
            "",
            "BACKUP_FILE='index.html.pre-separation-backup'",
            "cp index.html $BACKUP_FILE",
            "echo 'âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ: $BACKUP_FILE'",
            "",
        ]
        
        # CSSé™¤å»
        css_removes = [
            "sed -i 's/\\.weight-input[^}]*}//g' index.html",
            "echo 'âœ… weight-input CSSé™¤å»å®Œäº†'"
        ]
        
        # å¤‰æ•°é™¤å»  
        var_removes = [
            "sed -i '/let.*weight.*=/d' index.html",
            "sed -i '/const.*weight.*=/d' index.html", 
            "sed -i '/window\\.editingEntryId/d' index.html",
            "echo 'âœ… ä½“é‡é–¢é€£å¤‰æ•°é™¤å»å®Œäº†'"
        ]
        
        script_lines.extend(css_removes)
        script_lines.extend(var_removes)
        
        script_lines.extend([
            "",
            "echo 'ğŸ¯ ä½“é‡é–¢é€£ã‚³ãƒ¼ãƒ‰é™¤å»å®Œäº†'",
            f"echo 'ğŸ“Š å‡¦ç†å¯¾è±¡: {len(analysis_result['weight_related'])}ç®‡æ‰€'",
            "wc -l index.html"
        ])
        
        return '\n'.join(script_lines)

if __name__ == "__main__":
    analyzer = WeightCodeAnalyzer()
    result = analyzer.analyze()
    
    print("ä½“é‡é–¢é€£ã‚³ãƒ¼ãƒ‰åˆ†æçµæœ")
    print(f"ç·è¡Œæ•°: {result['total_lines']}")
    print(f"ä½“é‡é–¢é€£ã‚³ãƒ¼ãƒ‰: {len(result['weight_related'])}ç®‡æ‰€")
    print(f"é–¢æ•°ãƒ–ãƒ­ãƒƒã‚¯: {len(result['functions_to_remove'])}å€‹")
    
    # è©³ç´°çµæœã‚’JSONã§å‡ºåŠ›
    with open('weight_analysis.json', 'w') as f:
        json.dump(result, f, indent=2, ensure_ascii=False)
    
    # é™¤å»ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ
    removal_script = analyzer.generate_removal_script(result)
    with open('remove_weight_code.sh', 'w') as f:
        f.write(removal_script)
    
    print("\nç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«:")
    print("- weight_analysis.json (è©³ç´°åˆ†æçµæœ)")  
    print("- remove_weight_code.sh (è‡ªå‹•é™¤å»ã‚¹ã‚¯ãƒªãƒ—ãƒˆ)")
    print("\næ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: bash remove_weight_code.sh")