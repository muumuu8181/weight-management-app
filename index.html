
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½“é‡ç®¡ç†ã‚¢ãƒ—ãƒª</title>
    
    <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« -->
    <link rel="stylesheet" href="custom/styles.css">
    
    <!-- ã‚¿ãƒ–å›ºæœ‰ã‚¹ã‚¿ã‚¤ãƒ« -->
    <link rel="stylesheet" href="tabs/tab3-room-cleaning/room-cleaning.css">
    <link rel="stylesheet" href="tabs/tab8-memo-list/memo-list.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Chart.js with date adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <!-- ã‚«ã‚¹ã‚¿ãƒ è¨­å®š -->
    <script type="module" src="custom/app-config.js"></script>
    
    <!-- ã‚¿ãƒ–å›ºæœ‰JavaScript -->
    <script src="tabs/tab3-room-cleaning/room-cleaning.js"></script>
    <script src="tabs/tab8-memo-list/memo-list.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 2px; background: #f5f5f5; line-height: 1.2; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 6px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* ã‚¹ãƒãƒ›å¯¾å¿œ */
        @media (max-width: 768px) {
            body { padding: 3px; }
            .container { padding: 8px; margin: 0; border-radius: 0; }
            .weight-input { grid-template-columns: 1fr; gap: 8px; }
            .input-card { padding: 8px; }
        }
        .auth-section { background: #e7f3ff; color: #0c5460; padding: 6px; border-radius: 5px; margin-bottom: 6px; text-align: center; }
        .weight-input { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin: 8px 0; }
        .input-card { border: 1px solid #ddd; padding: 8px; border-radius: 8px; }
        
        /* ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .memo-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            background: #fefefe;
        }
        .memo-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }
        .memo-category {
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-right: 5px;
        }
        .memo-date {
            color: #666;
            font-size: 11px;
        }
        .memo-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
            color: #333;  /* æ–‡å­—ã‚’æ¿ƒãã—ã¦èª­ã¿ã‚„ã™ã */
            font-weight: 500;  /* ã‚„ã‚„å¤ªã‚ã«ã—ã¦è¦–èªæ€§å‘ä¸Š */
        }
        .memo-delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            margin-left: 10px;
        }
        .memo-delete-btn:hover {
            background: #c82333;
        }
        
        /* ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .timing-panel { 
            background: #f8f9fa; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            padding: 8px; 
            margin: 5px 0; 
        }
        .timing-buttons { 
            display: flex; 
            gap: 4px; 
            flex-wrap: wrap; 
            justify-content: center;
        }
        .timing-btn { 
            background: #6c757d; 
            color: white; 
            border: none; 
            padding: 6px 8px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 11px;
            transition: all 0.2s;
            min-width: 85px;
            text-align: center;
            flex: 1;
            max-width: 120px;
        }
        .timing-btn:hover {
            transform: scale(1.05);
        }
        .timing-btn.selected {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .timing-buttons { gap: 3px; }
            .timing-btn { 
                padding: 4px 6px; 
                font-size: 10px;
                min-width: 75px;
            }
        }

        /* æœè£…ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«çµ±ä¸€ */
        .clothing-btn {
            border: none;
            padding: 6px 8px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 10px;
            min-width: 85px;
            text-align: center;
            transition: all 0.2s;
            flex: 1;
            max-width: 120px;
        }
        .clothing-btn:hover {
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .clothing-btn {
                padding: 4px 6px;
                min-width: 75px;
                font-size: 9px;
            }
        }
        .input-field { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 5px 0; font-size: 16px; }
        .save-button { background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin: 5px; font-size: 16px; }
        .save-button:hover { background: #218838; }
        .auth-button { background: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .auth-button:hover { background: #357ae8; }
        .logout-button { background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .data-area { background: #f8f9fa; border: 1px solid #dee2e6; padding: 8px; border-radius: 5px; font-family: monospace; min-height: 120px; }
        .hidden { display: none; }
        .user-info { background: #d4edda; color: #155724; padding: 4px 6px; border-radius: 5px; margin-bottom: 6px; font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤ºï¼ˆä¸€ç•ªä¸Šï¼‰ -->
        <div class="user-info hidden" id="userInfo" style="margin-bottom: 10px;">
            <span>ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <span id="userName"></span></span>
            <button class="logout-button" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>

        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div id="tabNavigation" class="hidden" style="margin-bottom: 15px;">
            <div style="display: flex; border-bottom: 2px solid #ddd; flex-wrap: wrap;">
                <button id="tab1" class="tab-btn active" onclick="switchTab(1)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #007bff; color: white; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">ä½“é‡</button>
                <button id="tab2" class="tab-btn" onclick="switchTab(2)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">ç¡çœ </button>
                <button id="tab3" class="tab-btn" onclick="switchTab(3)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">éƒ¨å±‹ç‰‡ã¥ã‘</button>
                <button id="tab4" class="tab-btn" onclick="switchTab(4)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">ã‚¹ãƒˆãƒ¬ãƒƒãƒ</button>
                <button id="tab5" class="tab-btn" onclick="switchTab(5)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx5</button>
                <button id="tab6" class="tab-btn" onclick="switchTab(6)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx6</button>
                <button id="tab7" class="tab-btn" onclick="switchTab(7)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx7</button>
                <button id="tab8" class="tab-btn" onclick="switchTab(8)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆ</button>
            </div>
            <!-- 2è¡Œç›®ã®ã‚¿ãƒ–ï¼ˆ9-16ï¼‰ -->
            <div style="display: flex; border-bottom: 2px solid #ddd; flex-wrap: wrap;">
                <button id="tab9" class="tab-btn" onclick="switchTab(9)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx9</button>
                <button id="tab10" class="tab-btn" onclick="switchTab(10)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx10</button>
                <button id="tab11" class="tab-btn" onclick="switchTab(11)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx11</button>
                <button id="tab12" class="tab-btn" onclick="switchTab(12)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx12</button>
                <button id="tab13" class="tab-btn" onclick="switchTab(13)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx13</button>
                <button id="tab14" class="tab-btn" onclick="switchTab(14)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx14</button>
                <button id="tab15" class="tab-btn" onclick="switchTab(15)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx15</button>
                <button id="tab16" class="tab-btn" onclick="switchTab(16)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-bottom: 1px; font-size: 12px;">xx16</button>
            </div>
        </div>

        <!-- ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒˆãƒ« -->
        <div class="app-header hidden" id="appHeader">
            <h1 class="app-title" id="appTitle">ğŸ“Š ä½“é‡ç®¡ç†ã‚¢ãƒ—ãƒª</h1>
            <p class="app-subtitle">Core/Customãƒ•ã‚©ãƒ«ãƒ€åˆ†é›¢ç‰ˆ - Firebase + Googleèªè¨¼</p>
        </div>

        <!-- èªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="auth-section" id="authSection">
            <h1 class="app-title">ğŸ“Š ä½“é‡ç®¡ç†ã‚¢ãƒ—ãƒª</h1>
            <p class="app-subtitle">Core/Customãƒ•ã‚©ãƒ«ãƒ€åˆ†é›¢ç‰ˆ - Firebase + Googleèªè¨¼</p>
            <h3>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</h3>
            <p>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ãƒ»åŒæœŸã§ãã¾ã™</p>
            <button class="auth-button" onclick="handleGoogleLogin()">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>

        <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div id="tabContent1" class="tab-content">
            <!-- ä½“é‡ç®¡ç†ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯å‹•çš„èª­ã¿è¾¼ã¿ -->
            <div style="text-align: center; padding: 20px; color: #666;">
                <span>ğŸ“Š ä½“é‡ç®¡ç†æ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
        <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚¨ãƒªã‚¢ -->
        <div class="mode-control hidden" id="modeControl" style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 8px; margin: 8px 0; text-align: center;">
            <div style="margin-bottom: 8px;">
                <span style="font-size: 13px; color: #444; font-weight: bold;">ğŸ”§ æ“ä½œãƒ¢ãƒ¼ãƒ‰</span>
            </div>
            <div style="display: flex; gap: 5px; justify-content: center; margin-bottom: 8px;">
                <button id="normalModeBtn" onclick="setMode('normal')" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 11px;">ğŸ“ é€šå¸¸</button>
                <button id="addModeBtn" onclick="setMode('add')" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 11px;">â• è¿½åŠ </button>
                <button id="deleteModeBtn" onclick="setMode('delete')" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 11px;">ğŸ—‘ï¸ å‰Šé™¤</button>
            </div>
            <div style="display: flex; gap: 5px; justify-content: center; align-items: center;">
                <span style="font-size: 11px; color: #666;">å¯¾è±¡:</span>
                <button id="timingTargetBtn" onclick="selectTarget('timing')" style="background: #6c757d; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">â° ã‚¿ã‚¤ãƒŸãƒ³ã‚°</button>
                <button id="topTargetBtn" onclick="selectTarget('top')" style="background: #6c757d; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">ğŸ‘• ä¸Š</button>
                <button id="bottomTargetBtn" onclick="selectTarget('bottom')" style="background: #6c757d; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">ğŸ‘– ä¸‹</button>
            </div>
            
            <!-- è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ç”¨ã®çµ±ä¸€å…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div id="unifiedAddInput" style="display: none; margin-top: 8px; padding: 8px; background: #e8f5e8; border-radius: 5px; border: 2px solid #28a745;">
                <div style="margin-bottom: 5px;">
                    <span style="font-size: 11px; color: #155724; font-weight: bold;">âœ¨ æ–°è¦é …ç›®ã‚’è¿½åŠ </span>
                </div>
                <div style="display: flex; gap: 3px; align-items: center;">
                    <input type="text" id="unifiedAddText" placeholder="é …ç›®åã‚’å…¥åŠ›" style="flex: 1; padding: 4px 8px; border: 1px solid #28a745; border-radius: 3px; font-size: 11px;">
                    <button onclick="executeAdd()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">âœ“ è¿½åŠ </button>
                    <button onclick="cancelAdd()" style="background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">âœ— ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="weight-input hidden" id="weightInput">
            <div class="input-card">
                <h3 style="margin-top: 0; margin-bottom: 8px;">ğŸ“ ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²</h3>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="date" class="input-field" id="dateInput" style="flex: 1; min-width: 140px;">
                    <input type="number" class="input-field" id="weightValue" placeholder="å€¤" step="0.1" min="0" max="300" value="72.0" style="flex: 1; min-width: 100px;" onkeydown="handleWeightKeypress(event)">
                    <span style="font-size: 11px; color: #666; white-space: nowrap;">â†‘â†“ã§èª¿æ•´</span>
                </div>
                
                <!-- ã‚¿ã‚¤ãƒŸãƒ³ã‚°é¸æŠãƒ‘ãƒãƒ« -->
                <div class="timing-panel">
                    <div style="text-align: center; margin-bottom: 8px;">
                        <span style="font-size: 13px; color: #444; font-weight: bold;">â° ã‚¿ã‚¤ãƒŸãƒ³ã‚°</span>
                    </div>
                    <div class="timing-buttons" id="timingButtons">
                        <button type="button" class="timing-btn" onclick="selectTiming('èµ·åºŠå¾Œ')" data-timing="èµ·åºŠå¾Œ" style="background: #55a3ff;">ğŸ›ï¸ èµ·åºŠå¾Œ</button>
                        <button type="button" class="timing-btn" onclick="selectTiming('ãƒˆã‚¤ãƒ¬å‰')" data-timing="ãƒˆã‚¤ãƒ¬å‰" style="background: #81ecec;">ğŸš½ ãƒˆã‚¤ãƒ¬å‰</button>
                        <button type="button" class="timing-btn" onclick="selectTiming('ãƒˆã‚¤ãƒ¬å¾Œ')" data-timing="ãƒˆã‚¤ãƒ¬å¾Œ" style="background: #74b9ff;">ğŸš½ ãƒˆã‚¤ãƒ¬å¾Œ</button>
                        <button type="button" class="timing-btn" onclick="selectTiming('é¢¨å‘‚å‰')" data-timing="é¢¨å‘‚å‰" style="background: #fd79a8;">ğŸ› é¢¨å‘‚å‰</button>
                        <button type="button" class="timing-btn" onclick="selectTiming('é¢¨å‘‚å¾Œ')" data-timing="é¢¨å‘‚å¾Œ" style="background: #00b894;">ğŸ›€ é¢¨å‘‚å¾Œ</button>
                        <button type="button" class="timing-btn" onclick="selectTiming('é£Ÿäº‹å‰')" data-timing="é£Ÿäº‹å‰" style="background: #e84393;">ğŸ½ï¸ é£Ÿäº‹å‰</button>
                        <button type="button" class="timing-btn" onclick="selectTiming('é£Ÿäº‹å¾Œ')" data-timing="é£Ÿäº‹å¾Œ" style="background: #a29bfe;">ğŸ½ï¸ é£Ÿäº‹å¾Œ</button>
                    </div>
                    <input type="text" class="input-field" id="selectedTiming" placeholder="ã‚¿ã‚¤ãƒŸãƒ³ã‚°" readonly style="margin-top: 5px; font-size: 12px; padding: 6px; text-align: center; background: #f0f8ff;">
                </div>
                
                <!-- æœè£…è¨˜éŒ²ãƒ‘ãƒãƒ« (å¾©æ´»+æ”¹è‰¯ç‰ˆ) -->
                <div class="clothing-panel" style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 8px; margin: 5px 0;">
                    <h4 style="margin: 2px 0 5px 0; font-size: 13px; text-align: center;">ğŸ‘• æœè£…è¨˜éŒ²</h4>
                    
                    <!-- ä¸ŠåŠèº« -->
                    <div style="margin: 3px 0;">
                        <div style="text-align: center; margin-bottom: 3px;">
                            <span style="font-size: 11px; color: #444;">ä¸Š:</span>
                        </div>
                        <div id="topClothingButtons" style="display: flex; gap: 3px; flex-wrap: wrap; justify-content: center;">
                            <button type="button" class="clothing-btn" onclick="selectClothingTop('ãªã—')" data-clothing-top="ãªã—" style="background: #e0e0e0; color: #424242;">âŒ ãªã—</button>
                            <button type="button" class="clothing-btn" onclick="selectClothingTop('ä¸‹ç€ã‚·ãƒ£ãƒ„')" data-clothing-top="ä¸‹ç€ã‚·ãƒ£ãƒ„" style="background: #87ceeb; color: #2f4f4f;">ğŸ‘• ä¸‹ç€ã‚·ãƒ£ãƒ„</button>
                            <button type="button" class="clothing-btn" onclick="selectClothingTop('ãƒ¯ã‚¤ã‚·ãƒ£ãƒ„')" data-clothing-top="ãƒ¯ã‚¤ã‚·ãƒ£ãƒ„" style="background: #add8e6; color: #2f4f4f;">ğŸ‘” ãƒ¯ã‚¤ã‚·ãƒ£ãƒ„</button>
                        </div>
                        <input type="text" class="input-field" id="selectedTop" placeholder="ä¸Š" readonly style="margin-top: 2px; font-size: 10px; padding: 4px; text-align: center; background: #ffffff;">
                    </div>
                    
                    <!-- ä¸‹åŠèº« -->
                    <div style="margin: 3px 0;">
                        <div style="text-align: center; margin-bottom: 3px;">
                            <span style="font-size: 11px; color: #444;">ä¸‹:</span>
                        </div>
                        <div id="bottomClothingButtons" style="display: flex; gap: 3px; flex-wrap: wrap; justify-content: center;">
                            <button type="button" class="clothing-btn" onclick="selectClothingBottom('ãªã—')" data-clothing-bottom="ãªã—" style="background: #e0e0e0; color: #424242;">âŒ ãªã—</button>
                            <button type="button" class="clothing-btn" onclick="selectClothingBottom('ãƒˆãƒ©ãƒ³ã‚¯ã‚¹')" data-clothing-bottom="ãƒˆãƒ©ãƒ³ã‚¯ã‚¹" style="background: #dda0dd; color: #4b0082;">ğŸ©² ãƒˆãƒ©ãƒ³ã‚¯ã‚¹</button>
                            <button type="button" class="clothing-btn" onclick="selectClothingBottom('ãƒãƒ¼ãƒ•ãƒ‘ãƒ³ãƒ„')" data-clothing-bottom="ãƒãƒ¼ãƒ•ãƒ‘ãƒ³ãƒ„" style="background: #f0e68c; color: #8b4513;">ğŸ©³ ãƒãƒ¼ãƒ•ãƒ‘ãƒ³ãƒ„</button>
                        </div>
                        <input type="text" class="input-field" id="selectedBottom" placeholder="ä¸‹" readonly style="margin-top: 2px; font-size: 10px; padding: 4px; text-align: center; background: #ffffff;">
                    </div>
                </div>
                
                <textarea class="input-field" id="memoInput" placeholder="ãƒ¡ãƒ¢ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)" rows="2"></textarea>
                <button class="save-button" onclick="saveWeightData()">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>

        <!-- ã‚°ãƒ©ãƒ•ãƒ‘ãƒãƒ«ï¼ˆä¸Šã«ç§»å‹•ï¼‰ -->
        <div class="input-card hidden" id="chartPanel">
            <h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿æ¨ç§»ã‚°ãƒ©ãƒ•</h3>
            <div style="position: relative; height: 300px;">
                <canvas id="weightChart"></canvas>
            </div>
            
            <!-- æœŸé–“é¸æŠã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div style="margin-top: 10px;">
                <!-- æœŸé–“é¸æŠãƒœã‚¿ãƒ³ -->
                <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px;">
                    <button onclick="updateChartRange(1)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">1æ—¥</button>
                    <button onclick="updateChartRange(7)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">1é€±é–“</button>
                    <button onclick="updateChartRange(30)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">1ãƒ¶æœˆ</button>
                    <button onclick="updateChartRange(90)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">3ãƒ¶æœˆ</button>
                    <button onclick="updateChartRange(365)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">1å¹´</button>
                    <button onclick="updateChartRange(0)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">å…¨æœŸé–“</button>
                    <button id="previousPeriodBtn" onclick="togglePreviousPeriod()" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">å‰æœŸé–“ã®è¨˜éŒ²</button>
                </div>
                
                <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
                    <button onclick="navigateChart('prev')" style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 3px; cursor: pointer; font-size: 14px; font-weight: bold;">â† å‰</button>
                    <span id="chartPeriodInfo" style="font-size: 12px; color: #666; min-width: 120px; text-align: center;">æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
                    <button onclick="navigateChart('next')" style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 3px; cursor: pointer; font-size: 14px; font-weight: bold;">æ¬¡ â†’</button>
                </div>
            </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿å±¥æ­´ï¼ˆã‚°ãƒ©ãƒ•ã®ä¸‹ã«ç§»å‹•ï¼‰ -->
        <div class="input-card hidden" id="weightHistoryPanel">
            <h3>ğŸ“ˆ ãƒ‡ãƒ¼ã‚¿å±¥æ­´</h3>
            <div class="data-area" id="weightHistory">
                ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...<br>
            </div>
        </div>

        <h3>ğŸ“‹ ã‚¢ãƒ—ãƒªãƒ­ã‚° <button class="universal-copy-btn" onclick="copyLogs()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">ğŸ“‹ ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼</button></h3>
        <div class="data-area" id="logArea">
            ã‚¢ãƒ—ãƒªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèµ·å‹•å®Œäº†...<br>
            ğŸ”¥ Firebaseè¨­å®šå®Œäº†<br>
            ğŸ” Googleèªè¨¼æº–å‚™å®Œäº†<br>
        </div>
        
        <!-- ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
        <div style="margin-top: 8px; text-align: center;">
            <button class="universal-copy-btn" onclick="debugFirebaseConnection()" style="background: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">ğŸ” Firebase Debug</button>
            <button class="universal-copy-btn" onclick="checkLoginIssues()" style="background: #ffc107; color: #212529; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">âš ï¸ ãƒ­ã‚°ã‚¤ãƒ³å•é¡Œè¨ºæ–­</button>
            <button class="universal-copy-btn" onclick="copyDebugInfo()" style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">ğŸ“‹ ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼</button>
            <button class="universal-copy-btn" onclick="checkDatabaseStructure()" style="background: #6f42c1; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">ğŸ—ï¸ DBæ§‹é€ ç¢ºèª</button>
            <button class="universal-copy-btn" onclick="checkMobileSupport()" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">ğŸ“± ãƒ¢ãƒã‚¤ãƒ«è¨ºæ–­</button>
            <button class="universal-copy-btn" onclick="forceAuthCheck()" style="background: #fd7e14; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">ğŸ”„ èªè¨¼çŠ¶æ…‹ç¢ºèª</button>
            <button class="universal-copy-btn" onclick="checkFirebaseConfig()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">ğŸ”§ Firebaseè¨­å®š</button>
            <button class="universal-copy-btn" onclick="testPopup()" style="background: #20c997; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">ğŸ§ª ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ</button>
        </div>
        </div> <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„1çµ‚äº† -->

        <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„2 -->
        <div id="tabContent2" class="tab-content hidden">
            <!-- ã‚¿ãƒ–2: ç¡çœ ç®¡ç† -->
            <div id="tab2Content">
                <!-- ç¡çœ è¨˜éŒ²å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                <div class="input-card" id="sleepInput">
                    <h3>ğŸ›ï¸ ç¡çœ è¨˜éŒ²</h3>
                    
                    <!-- æ—¥ä»˜é¸æŠ -->
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                        <label style="font-weight: bold;">ğŸ“… è¨˜éŒ²æ—¥:</label>
                        <input type="date" id="sleepDateInput" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    </div>

                    <!-- ç¡çœ è¨˜éŒ²ã‚¿ã‚¤ãƒ—é¸æŠ -->
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 8px;">ğŸ›ï¸ ç¡çœ ã‚¿ã‚¤ãƒ—:</label>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="sleep-type-btn" data-type="å¤œé–“ç¡çœ " onclick="selectSleepType('å¤œé–“ç¡çœ ')" style="background: #6f42c1; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸŒ™ å¤œé–“ç¡çœ </button>
                            <button type="button" class="sleep-type-btn" data-type="æ˜¼å¯" onclick="selectSleepType('æ˜¼å¯')" style="background: #ffc107; color: #212529; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">â˜€ï¸ æ˜¼å¯</button>
                            <button type="button" class="sleep-type-btn" data-type="ä»®çœ " onclick="selectSleepType('ä»®çœ ')" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸ˜´ ä»®çœ </button>
                        </div>
                        <input type="hidden" id="selectedSleepType" value="">
                    </div>


                    <!-- è¨˜éŒ²æ™‚é–“ -->
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <div>
                            <label style="font-weight: bold; display: block; margin-bottom: 3px;">â° è¨˜éŒ²æ™‚é–“:</label>
                            <input type="time" id="sleepTimeInput" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                        </div>
                    </div>

                    <!-- ç¡çœ ã®è³ªè©•ä¾¡ -->
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 8px;">â­ ç¡çœ ã®è³ª:</label>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="quality-btn" data-quality="1" onclick="selectQuality(1)" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸ˜´ 1 (æœ€æ‚ª)</button>
                            <button type="button" class="quality-btn" data-quality="2" onclick="selectQuality(2)" style="background: #fd7e14; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸ˜ª 2 (æ‚ªã„)</button>
                            <button type="button" class="quality-btn" data-quality="3" onclick="selectQuality(3)" style="background: #ffc107; color: #212529; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸ˜ 3 (æ™®é€š)</button>
                            <button type="button" class="quality-btn" data-quality="4" onclick="selectQuality(4)" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸ˜Š 4 (è‰¯ã„)</button>
                            <button type="button" class="quality-btn" data-quality="5" onclick="selectQuality(5)" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸ˜´ 5 (æœ€é«˜)</button>
                        </div>
                        <input type="hidden" id="selectedQuality" value="">
                    </div>

                    <!-- ç¡çœ ã‚¿ã‚°é¸æŠ -->
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 8px;">ğŸ·ï¸ ç¡çœ ã‚¿ã‚°ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰:</label>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="sleep-tag-btn" data-tag="äºŒåº¦å¯" onclick="toggleSleepTag('äºŒåº¦å¯')" style="background: #6f42c1; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸ˜´ äºŒåº¦å¯</button>
                            <button type="button" class="sleep-tag-btn" data-tag="å¤¢ã‚’è¦‹ãŸ" onclick="toggleSleepTag('å¤¢ã‚’è¦‹ãŸ')" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸ’­ å¤¢ã‚’è¦‹ãŸ</button>
                            <button type="button" class="sleep-tag-btn" data-tag="ç†Ÿç¡" onclick="toggleSleepTag('ç†Ÿç¡')" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸ˜´ ç†Ÿç¡</button>
                            <button type="button" class="sleep-tag-btn" data-tag="é€”ä¸­ã§èµ·ããŸ" onclick="toggleSleepTag('é€”ä¸­ã§èµ·ããŸ')" style="background: #fd7e14; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸ˜ª é€”ä¸­ã§èµ·ããŸ</button>
                            <button type="button" class="sleep-tag-btn" data-tag="å¯ã¤ããŒæ‚ªã„" onclick="toggleSleepTag('å¯ã¤ããŒæ‚ªã„')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸ˜£ å¯ã¤ããŒæ‚ªã„</button>
                        </div>
                        <input type="hidden" id="selectedSleepTags" value="">
                        <div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; min-height: 20px;">
                            <span style="font-size: 12px; color: #666;">é¸æŠä¸­:</span>
                            <span id="selectedTagsDisplay" style="font-size: 12px; color: #007bff; font-weight: bold;">ãªã—</span>
                        </div>
                    </div>

                    <!-- ãƒ¡ãƒ¢å…¥åŠ› -->
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">ğŸ“ ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰:</label>
                        <input type="text" id="sleepMemoInput" placeholder="ä½“èª¿ã€èµ·ããŸæ™‚ã®æ„Ÿæƒ³ãªã©" style="width: 100%; max-width: 400px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    </div>

                    <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
                    <div style="text-align: center;">
                        <button onclick="saveSleepData()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">ğŸ’¾ ç¡çœ è¨˜éŒ²ã‚’ä¿å­˜</button>
                    </div>
                </div>

                <!-- ç¡çœ å±¥æ­´è¡¨ç¤º -->
                <div class="input-card" id="sleepHistory">
                    <h3>ğŸ“Š ç¡çœ å±¥æ­´ <button class="universal-copy-btn" onclick="copySleepHistory()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">ğŸ“‹ å±¥æ­´ã‚’ã‚³ãƒ”ãƒ¼</button></h3>
                    <div class="data-area" id="sleepHistoryArea">
                        ã¾ã ç¡çœ è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“
                    </div>
                </div>

                <!-- ç¡çœ çµ±è¨ˆ -->
                <div class="input-card" id="sleepStats">
                    <h3>ğŸ“ˆ ç¡çœ çµ±è¨ˆ</h3>
                    <div id="sleepStatsArea" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 24px; font-weight: bold; color: #007bff;">--</div>
                            <div style="font-size: 12px; color: #6c757d;">å¹³å‡ç¡çœ æ™‚é–“</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 24px; font-weight: bold; color: #28a745;">--</div>
                            <div style="font-size: 12px; color: #6c757d;">å¹³å‡ç¡çœ ã®è³ª</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 24px; font-weight: bold; color: #ffc107;">--</div>
                            <div style="font-size: 12px; color: #6c757d;">ä»Šé€±ã®è¨˜éŒ²æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">--</div>
                            <div style="font-size: 12px; color: #6c757d;">ä»Šæœˆã®è¨˜éŒ²æ•°</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„3 -->
        <div id="tabContent3" class="tab-content hidden">
            <!-- éƒ¨å±‹ç‰‡ä»˜ã‘ç®¡ç† -->
            <div id="tab3Content">
                <!-- ç‰‡ä»˜ã‘ã‚¿ã‚¹ã‚¯å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                <div class="input-card" id="roomInput">
                    <h3>ğŸ§¹ éƒ¨å±‹ç‰‡ä»˜ã‘è¨˜éŒ²</h3>
                    
                    <!-- æ“ä½œãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
                    <div class="room-mode-control" style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 8px; margin: 8px 0; text-align: center;">
                        <div style="margin-bottom: 8px;">
                            <span style="font-size: 13px; color: #444; font-weight: bold;">ğŸ”§ å ´æ‰€ç®¡ç†ãƒ¢ãƒ¼ãƒ‰</span>
                        </div>
                        <div style="display: flex; gap: 5px; justify-content: center; margin-bottom: 8px;">
                            <button id="roomNormalModeBtn" onclick="setRoomMode('normal')" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 11px;">ğŸ“ é€šå¸¸</button>
                            <button id="roomAddModeBtn" onclick="setRoomMode('add')" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 11px;">â• è¿½åŠ </button>
                            <button id="roomDeleteModeBtn" onclick="setRoomMode('delete')" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 11px;">ğŸ—‘ï¸ å‰Šé™¤</button>
                        </div>
                        
                        <!-- è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ç”¨ã®çµ±ä¸€å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                        <div id="roomUnifiedAddInput" style="display: none; margin-top: 8px; padding: 8px; background: #e8f5e8; border-radius: 5px; border: 2px solid #28a745;">
                            <div style="margin-bottom: 5px;">
                                <span style="font-size: 11px; color: #155724; font-weight: bold;">âœ¨ æ–°ã—ã„å ´æ‰€ã‚’è¿½åŠ </span>
                            </div>
                            <div style="display: flex; gap: 3px; align-items: center;">
                                <input type="text" id="roomUnifiedAddText" placeholder="å ´æ‰€åã‚’å…¥åŠ›" style="flex: 1; padding: 4px 8px; border: 1px solid #28a745; border-radius: 3px; font-size: 11px;">
                                <button onclick="executeRoomAdd()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">âœ“ è¿½åŠ </button>
                                <button onclick="cancelRoomAdd()" style="background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">âœ— ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            </div>
                        </div>
                    </div>

                    <!-- æ—¥ä»˜ãƒ»æ™‚åˆ»è¡¨ç¤ºï¼ˆè‡ªå‹•å–å¾—ï¼‰ -->
                    <div style="margin-bottom: 10px;">
                        <input type="date" class="input-field" id="roomDateInput" style="width: 100%;" readonly>
                        <input type="time" class="input-field" id="roomTimeInput" style="width: 100%; margin-top: 5px;" readonly>
                    </div>
                    
                    <!-- é–‹å§‹ãƒ»çµ‚äº†ãƒœã‚¿ãƒ³ -->
                    <div style="margin-bottom: 15px; text-align: center;">
                        <button id="startRoomBtn" onclick="startRoomCleaning()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; margin-right: 10px;">â–¶ï¸ ç‰‡ä»˜ã‘é–‹å§‹</button>
                        <button id="endRoomBtn" onclick="endRoomCleaning()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; display: none;">â¹ï¸ ç‰‡ä»˜ã‘çµ‚äº†</button>
                    </div>
                    
                    <!-- ç‰‡ä»˜ã‘å ´æ‰€é¸æŠ -->
                    <div style="margin-bottom: 10px;">
                        <div style="text-align: center; margin-bottom: 8px;">
                            <span style="font-size: 13px; color: #444; font-weight: bold;">ğŸ“ ç‰‡ä»˜ã‘å ´æ‰€</span>
                        </div>
                        <div id="roomButtons" style="display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; margin-bottom: 8px;">
                            <button type="button" class="room-btn" onclick="selectRoom('ãƒªãƒ“ãƒ³ã‚°')" data-room="ãƒªãƒ“ãƒ³ã‚°" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸ›‹ï¸ ãƒªãƒ“ãƒ³ã‚°</button>
                            <button type="button" class="room-btn" onclick="selectRoom('ã‚­ãƒƒãƒãƒ³')" data-room="ã‚­ãƒƒãƒãƒ³" style="background: #ffc107; color: #212529; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸ³ ã‚­ãƒƒãƒãƒ³</button>
                            <button type="button" class="room-btn" onclick="selectRoom('å¯å®¤')" data-room="å¯å®¤" style="background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸ›ï¸ å¯å®¤</button>
                            <button type="button" class="room-btn" onclick="selectRoom('ãŠé¢¨å‘‚')" data-room="ãŠé¢¨å‘‚" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸ› ãŠé¢¨å‘‚</button>
                            <button type="button" class="room-btn" onclick="selectRoom('ãƒˆã‚¤ãƒ¬')" data-room="ãƒˆã‚¤ãƒ¬" style="background: #fd79a8; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸš½ ãƒˆã‚¤ãƒ¬</button>
                            <button type="button" class="room-btn" onclick="selectRoom('ç„é–¢')" data-room="ç„é–¢" style="background: #6f42c1; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸšª ç„é–¢</button>
                            <button type="button" class="room-btn" onclick="selectRoom('ãã®ä»–')" data-room="ãã®ä»–" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7;">ğŸ“¦ ãã®ä»–</button>
                        </div>
                        <input type="text" class="input-field" id="selectedRoom" placeholder="é¸æŠã—ãŸå ´æ‰€" readonly style="margin-top: 5px; font-size: 12px; padding: 6px; text-align: center; background: #f0f8ff;">
                    </div>
                    
                    <!-- ç‰‡ä»˜ã‘æ™‚é–“ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰ -->
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #444;">â±ï¸ ç‰‡ä»˜ã‘æ™‚é–“</label>
                        <input type="text" class="input-field" id="roomDuration" placeholder="é–‹å§‹ãƒœã‚¿ãƒ³ã§è¨ˆæ¸¬é–‹å§‹" readonly style="width: 100%; text-align: center; background: #f0f8ff;">
                    </div>
                    
                    <!-- é”æˆåº¦ -->
                    <div style="margin-bottom: 10px;">
                        <div style="text-align: center; margin-bottom: 8px;">
                            <span style="font-size: 13px; color: #444; font-weight: bold;">ğŸ“Š é”æˆåº¦</span>
                        </div>
                        <div style="display: flex; gap: 5px; justify-content: center; margin-bottom: 8px;">
                            <button type="button" class="achievement-btn" onclick="selectAchievement(1)" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">ğŸ˜ 1</button>
                            <button type="button" class="achievement-btn" onclick="selectAchievement(2)" style="background: #fd7e14; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">ğŸ˜ 2</button>
                            <button type="button" class="achievement-btn" onclick="selectAchievement(3)" style="background: #ffc107; color: #212529; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">ğŸ™‚ 3</button>
                            <button type="button" class="achievement-btn" onclick="selectAchievement(4)" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">ğŸ˜Š 4</button>
                            <button type="button" class="achievement-btn" onclick="selectAchievement(5)" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">ğŸ¤© 5</button>
                        </div>
                        <input type="text" class="input-field" id="selectedAchievement" placeholder="é”æˆåº¦" readonly style="margin-top: 5px; font-size: 12px; padding: 6px; text-align: center; background: #f0f8ff;">
                    </div>
                    
                    <!-- ãƒ¡ãƒ¢ -->
                    <textarea class="input-field" id="roomMemoInput" placeholder="ç‰‡ä»˜ã‘ã®ãƒ¡ãƒ¢ãƒ»æ°—ã¥ãï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰" rows="3" style="margin-bottom: 10px;"></textarea>
                    
                    <div style="text-align: center;">
                        <button onclick="saveRoomData()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">ğŸ’¾ ç‰‡ä»˜ã‘è¨˜éŒ²ã‚’ä¿å­˜</button>
                    </div>
                </div>

                <!-- ç‰‡ä»˜ã‘å±¥æ­´è¡¨ç¤º -->
                <div class="input-card" id="roomHistory">
                    <h3>ğŸ§¹ ç‰‡ä»˜ã‘å±¥æ­´ <button class="universal-copy-btn" onclick="copyRoomHistory()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">ğŸ“‹ å±¥æ­´ã‚’ã‚³ãƒ”ãƒ¼</button></h3>
                    <div class="data-area" id="roomHistoryArea">
                        ã¾ã ç‰‡ä»˜ã‘è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“
                    </div>
                </div>

                <!-- ç‰‡ä»˜ã‘çµ±è¨ˆ -->
                <div class="input-card" id="roomStats">
                    <h3>ğŸ“ˆ ç‰‡ä»˜ã‘çµ±è¨ˆ</h3>
                    <div id="roomStatsArea" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 24px; color: #007bff; font-weight: bold;" id="totalRoomSessions">-</div>
                            <div style="font-size: 12px; color: #6c757d;">ç·ç‰‡ä»˜ã‘å›æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 24px; color: #28a745; font-weight: bold;" id="totalRoomTime">-</div>
                            <div style="font-size: 12px; color: #6c757d;">ç·ç‰‡ä»˜ã‘æ™‚é–“</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 24px; color: #ffc107; font-weight: bold;" id="avgRoomAchievement">-</div>
                            <div style="font-size: 12px; color: #6c757d;">å¹³å‡é”æˆåº¦</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 24px; color: #17a2b8; font-weight: bold;" id="thisMonthRoomCount">-</div>
                            <div style="font-size: 12px; color: #6c757d;">ä»Šæœˆã®è¨˜éŒ²æ•°</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„4 -->
        <div id="tabContent4" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>ğŸ”§ xx4</h3>
                <p>ã“ã¡ã‚‰ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯å¾Œã§å®Ÿè£…äºˆå®šã§ã™</p>
            </div>
        </div>

        <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„5 -->
        <div id="tabContent5" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>ğŸ”§ xx5</h3>
                <p>ã“ã¡ã‚‰ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯å¾Œã§å®Ÿè£…äºˆå®šã§ã™</p>
            </div>
        </div>

        <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„6 -->
        <div id="tabContent6" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>ğŸ”§ xx6</h3>
                <p>ã“ã¡ã‚‰ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯å¾Œã§å®Ÿè£…äºˆå®šã§ã™</p>
            </div>
        </div>

        <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„7 -->
        <div id="tabContent7" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>ğŸ”§ xx7</h3>
                <p>ã“ã¡ã‚‰ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯å¾Œã§å®Ÿè£…äºˆå®šã§ã™</p>
            </div>
        </div>

        <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„8: ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆ -->
        <div id="tabContent8" class="tab-content hidden">
            <div id="tab8Content">
                <!-- ãƒ¡ãƒ¢è¿½åŠ ã‚¨ãƒªã‚¢ -->
                <div class="input-card" id="memoInput">
                    <h3>ğŸ“ ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆ</h3>
                    
                    <!-- ãƒ¡ãƒ¢å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
                    <div style="margin-bottom: 15px;">
                        <textarea id="newMemoText" placeholder="è€ƒãˆãŸã“ã¨ã€ã‚„ã‚ŠãŸã„ã“ã¨ã€ãªã‚“ã§ã‚‚è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„..." 
                            style="width: 100%; max-width: 600px; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical; font-family: inherit; font-size: 14px; line-height: 1.4;"></textarea>
                    </div>

                    <!-- ã‚«ãƒ†ã‚´ãƒªãƒ»é‡è¦åº¦ãƒ»å¯¾å¿œæ™‚é–“ã®é¸æŠ -->
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <label style="font-weight: bold;">ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒªï¼ˆä»»æ„ï¼‰:</label>
                        <select id="memoCategory" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <option value="">é¸æŠãªã—</option>
                            <option value="ã‚¢ã‚¤ãƒ‡ã‚¢">ğŸ’¡ ã‚¢ã‚¤ãƒ‡ã‚¢</option>
                            <option value="ã‚„ã‚‹ã“ã¨">âœ… ã‚„ã‚‹ã“ã¨</option>
                            <option value="è€ƒãˆäº‹">ğŸ¤” è€ƒãˆäº‹</option>
                            <option value="ãƒ¡ãƒ¢">ğŸ“ ãƒ¡ãƒ¢</option>
                            <option value="é‡è¦">âš ï¸ é‡è¦</option>
                            <option value="ãã®ä»–">ğŸ“‹ ãã®ä»–</option>
                        </select>
                    </div>

                    <!-- é‡è¦åº¦é¸æŠ -->
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <label style="font-weight: bold;">ğŸ¯ é‡è¦åº¦:</label>
                        <select id="memoPriority" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <option value="">é¸æŠãªã—</option>
                            <option value="S">ğŸ”¥ S - æœ€é‡è¦ï¼ˆç·Šæ€¥å¯¾å¿œï¼‰</option>
                            <option value="A">âš¡ A - é‡è¦ï¼ˆå„ªå…ˆå¯¾å¿œï¼‰</option>
                            <option value="B">ğŸ“‹ B - ä¸­ç¨‹åº¦ï¼ˆé€šå¸¸å¯¾å¿œï¼‰</option>
                            <option value="C">ğŸ“ C - ä½ã‚ï¼ˆæ™‚é–“ãŒã‚ã‚‹ã¨ãï¼‰</option>
                        </select>
                    </div>

                    <!-- å¯¾å¿œæ™‚é–“é¸æŠ -->
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <label style="font-weight: bold;">â° å¯¾å¿œæ™‚é–“:</label>
                        <select id="memoTimeframe" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <option value="">é¸æŠãªã—</option>
                            <option value="çŸ­æœŸ">âš¡ çŸ­æœŸï¼ˆã™ãã«çµ‚ã‚ã‚‹ï¼‰</option>
                            <option value="ä¸­é•·æœŸ">ğŸ“… ä¸­é•·æœŸï¼ˆæ™‚é–“ã‚’ã‹ã‘ã‚‹ï¼‰</option>
                        </select>
                    </div>

                    <!-- è¿½åŠ ãƒœã‚¿ãƒ³ -->
                    <div style="text-align: center;">
                        <button onclick="addMemo()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">â• ãƒ¡ãƒ¢ã‚’è¿½åŠ </button>
                    </div>
                </div>

                <!-- ãƒ¡ãƒ¢ä¸€è¦§è¡¨ç¤º -->
                <div class="input-card" id="memoList">
                    <h3>ğŸ“‹ ãƒ¡ãƒ¢ä¸€è¦§ 
                        <button class="universal-copy-btn" onclick="copyAllMemos()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">ğŸ“‹ å…¨ãƒ¡ãƒ¢ã‚’ã‚³ãƒ”ãƒ¼</button>
                        <button onclick="clearAllMemos()" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-left: 5px;">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
                    </h3>
                    <div class="data-area" id="memoListArea">
                        ã¾ã ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“
                    </div>
                </div>

                <!-- ãƒ¡ãƒ¢çµ±è¨ˆ -->
                <div class="input-card" id="memoStats">
                    <h3>ğŸ“Š ãƒ¡ãƒ¢çµ±è¨ˆ</h3>
                    <div id="memoStatsArea" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div id="totalMemoCount" style="font-size: 24px; font-weight: bold; color: #007bff;">0</div>
                            <div style="font-size: 12px; color: #6c757d;">ç·ãƒ¡ãƒ¢æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div id="todayMemoCount" style="font-size: 24px; font-weight: bold; color: #28a745;">0</div>
                            <div style="font-size: 12px; color: #6c757d;">ä»Šæ—¥ã®ãƒ¡ãƒ¢</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div id="weekMemoCount" style="font-size: 24px; font-weight: bold; color: #ffc107;">0</div>
                            <div style="font-size: 12px; color: #6c757d;">ä»Šé€±ã®ãƒ¡ãƒ¢</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div id="monthMemoCount" style="font-size: 24px; font-weight: bold; color: #17a2b8;">0</div>
                            <div style="font-size: 12px; color: #6c757d;">ä»Šæœˆã®ãƒ¡ãƒ¢</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ã‚¿ãƒ–9-16ã®ç©ºã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div id="tabContent9" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>ğŸ”§ xx9</h3>
                <p>ã“ã®ã‚¿ãƒ–ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            </div>
        </div>

        <div id="tabContent10" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>ğŸ”§ xx10</h3>
                <p>ã“ã®ã‚¿ãƒ–ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            </div>
        </div>

        <div id="tabContent11" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>ğŸ”§ xx11</h3>
                <p>ã“ã®ã‚¿ãƒ–ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            </div>
        </div>

        <div id="tabContent12" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>ğŸ”§ xx12</h3>
                <p>ã“ã®ã‚¿ãƒ–ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            </div>
        </div>

        <div id="tabContent13" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>ğŸ”§ xx13</h3>
                <p>ã“ã®ã‚¿ãƒ–ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            </div>
        </div>

        <div id="tabContent14" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>ğŸ”§ xx14</h3>
                <p>ã“ã®ã‚¿ãƒ–ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            </div>
        </div>

        <div id="tabContent15" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>ğŸ”§ xx15</h3>
                <p>ã“ã®ã‚¿ãƒ–ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            </div>
        </div>

        <div id="tabContent16" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>ğŸ”§ xx16</h3>
                <p>ã“ã®ã‚¿ãƒ–ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            </div>
        </div>
    </div>

    <script>
        // Core Firebaseè¨­å®šï¼ˆå¤‰æ›´ç¦æ­¢ - core/src/firebase-config.jså‚ç…§ï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyA5PXKChizYDCXF_GJ4KL6Ylq9K5hCPXWE",
            authDomain: "shares-b1b97.firebaseapp.com",
            databaseURL: "https://shares-b1b97-default-rtdb.firebaseio.com",
            projectId: "shares-b1b97",
            storageBucket: "shares-b1b97.firebasestorage.app",
            messagingSenderId: "38311063248",
            appId: "1:38311063248:web:0d2d5726d12b305b24b8d5"
        };

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let selectedTimingValue = '';
        let selectedTopValue = '';
        let selectedBottomValue = '';
        let weightChart = null;
        let allWeightData = [];
        window.editingEntryId = null;

        // çµ±ä¸€ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ç®¡ç†
        let currentMode = 'normal'; // 'normal', 'add', 'delete'
        let selectedTarget = null; // 'timing', 'top', 'bottom' ã®ã„ãšã‚Œã‹

        // å‰æœŸé–“æ¯”è¼ƒæ©Ÿèƒ½ã®çŠ¶æ…‹ç®¡ç†
        let showPreviousPeriod = false; // å‰æœŸé–“è¡¨ç¤ºã®ON/OFF

        // ã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆä¸€å…ƒç®¡ç†ï¼‰
        const APP_VERSION = 'v0.91';
        
        // ã‚«ãƒ©ãƒ¼é…åˆ—å®šæ•°åŒ–ï¼ˆ3ç®‡æ‰€ã®é‡è¤‡çµ±ä¸€ï¼‰
        const RANDOM_COLORS = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a55eea'];

        // ã‚«ã‚¹ã‚¿ãƒ é …ç›®ã®æ°¸ç¶šåŒ–æ©Ÿèƒ½ï¼ˆlocalStorageæ´»ç”¨ï¼‰
        const STORAGE_KEYS = {
            customTimings: 'weightApp_customTimings',
            customTops: 'weightApp_customTops',
            customBottoms: 'weightApp_customBottoms'
        };

        // ã‚«ã‚¹ã‚¿ãƒ é …ç›®ã‚’localStorageã«ä¿å­˜
        function saveCustomItems() {
            const customTimings = Array.from(document.querySelectorAll('.timing-btn:not([data-timing="èµ·åºŠå¾Œ"]):not([data-timing="ãƒˆã‚¤ãƒ¬å‰"]):not([data-timing="ãƒˆã‚¤ãƒ¬å¾Œ"]):not([data-timing="é¢¨å‘‚å‰"]):not([data-timing="é¢¨å‘‚å¾Œ"]):not([data-timing="é£Ÿäº‹å‰"]):not([data-timing="é£Ÿäº‹å¾Œ"])'))
                .map(btn => ({
                    text: btn.getAttribute('data-timing'),
                    color: btn.style.background
                }));
            
            const customTops = Array.from(document.querySelectorAll('.clothing-btn[data-clothing-top]:not([data-clothing-top="ãªã—"]):not([data-clothing-top="ä¸‹ç€ã‚·ãƒ£ãƒ„"]):not([data-clothing-top="ãƒ¯ã‚¤ã‚·ãƒ£ãƒ„"])'))
                .map(btn => ({
                    text: btn.getAttribute('data-clothing-top'),
                    color: btn.style.background
                }));
            
            const customBottoms = Array.from(document.querySelectorAll('.clothing-btn[data-clothing-bottom]:not([data-clothing-bottom="ãªã—"]):not([data-clothing-bottom="ãƒˆãƒ©ãƒ³ã‚¯ã‚¹"]):not([data-clothing-bottom="ãƒãƒ¼ãƒ•ãƒ‘ãƒ³ãƒ„"])'))
                .map(btn => ({
                    text: btn.getAttribute('data-clothing-bottom'),
                    color: btn.style.background
                }));

            localStorage.setItem(STORAGE_KEYS.customTimings, JSON.stringify(customTimings));
            localStorage.setItem(STORAGE_KEYS.customTops, JSON.stringify(customTops));
            localStorage.setItem(STORAGE_KEYS.customBottoms, JSON.stringify(customBottoms));
        }

        // ã‚«ã‚¹ã‚¿ãƒ é …ç›®ã‚’localStorageã‹ã‚‰å¾©å…ƒ
        function loadCustomItems() {
            // ã‚¿ã‚¤ãƒŸãƒ³ã‚°é …ç›®ã®å¾©å…ƒ
            const savedTimings = localStorage.getItem(STORAGE_KEYS.customTimings);
            if (savedTimings) {
                const timings = JSON.parse(savedTimings);
                const container = document.getElementById('timingButtons');
                timings.forEach(item => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'timing-btn';
                    button.setAttribute('data-timing', item.text);
                    button.onclick = () => selectTiming(item.text);
                    button.style.cssText = `background: ${item.color}; color: white; opacity: 0.7;`;
                    button.setAttribute('data-original-color', item.color);
                    button.textContent = `â° ${item.text}`;
                    container.appendChild(button);
                });
            }

            // ä¸ŠåŠèº«é …ç›®ã®å¾©å…ƒ
            const savedTops = localStorage.getItem(STORAGE_KEYS.customTops);
            if (savedTops) {
                const tops = JSON.parse(savedTops);
                const container = document.getElementById('topClothingButtons');
                tops.forEach(item => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'clothing-btn';
                    button.setAttribute('data-clothing-top', item.text);
                    button.onclick = () => selectClothingTop(item.text);
                    button.style.cssText = `background: ${item.color}; color: white; opacity: 0.7;`;
                    button.setAttribute('data-original-color', item.color);
                    button.textContent = `ğŸ‘” ${item.text}`;
                    container.appendChild(button);
                });
            }

            // ä¸‹åŠèº«é …ç›®ã®å¾©å…ƒ
            const savedBottoms = localStorage.getItem(STORAGE_KEYS.customBottoms);
            if (savedBottoms) {
                const bottoms = JSON.parse(savedBottoms);
                const container = document.getElementById('bottomClothingButtons');
                bottoms.forEach(item => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'clothing-btn';
                    button.setAttribute('data-clothing-bottom', item.text);
                    button.onclick = () => selectClothingBottom(item.text);
                    button.style.cssText = `background: ${item.color}; color: white; opacity: 0.7;`;
                    button.setAttribute('data-original-color', item.color);
                    button.textContent = `ğŸ‘– ${item.text}`;
                    container.appendChild(button);
                });
            }
        }

        // çµ±ä¸€ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡æ©Ÿèƒ½
        window.setMode = (mode) => {
            currentMode = mode;
            updateModeUI();
            
            // ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã®è¡¨ç¤ºæ›´æ–°
            if (mode === 'delete' && selectedTarget) {
                updateDeleteModeDisplay();
            } else if (mode !== 'delete') {
                restoreNormalDisplay();
            }
            
            log(`ğŸ”§ ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´: ${mode === 'normal' ? 'é€šå¸¸' : mode === 'add' ? 'è¿½åŠ ' : 'å‰Šé™¤'}ãƒ¢ãƒ¼ãƒ‰`);
        };

        // å¯¾è±¡é¸æŠæ©Ÿèƒ½ï¼ˆçµ±ä¸€ç‰ˆï¼‰
        window.selectTarget = (target) => {
            selectedTarget = target;
            updateTargetUI();
            log(`ğŸ¯ å¯¾è±¡é¸æŠ: ${target === 'timing' ? 'ã‚¿ã‚¤ãƒŸãƒ³ã‚°' : target === 'top' ? 'ä¸ŠåŠèº«' : 'ä¸‹åŠèº«'}`);
            
            // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦å‡¦ç†å®Ÿè¡Œ
            handleModeAction();
            
            // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹æ›´æ–°
            if (currentMode === 'delete') {
                updateDeleteModeGuidance();
            }
        };

        // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸå‡¦ç†å®Ÿè¡Œ
        function handleModeAction() {
            if (currentMode === 'add' && selectedTarget) {
                // è¿½åŠ ãƒ¢ãƒ¼ãƒ‰: çµ±ä¸€å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¡¨ç¤º
                showUnifiedAddInput();
            } else if (currentMode === 'delete' && selectedTarget) {
                // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰: ã‚«ã‚¹ã‚¿ãƒ é …ç›®ã®è¡¨ç¤ºå¤‰æ›´
                updateDeleteModeDisplay();
            }
        }

        // çµ±ä¸€è¿½åŠ å…¥åŠ›è¡¨ç¤º
        function showUnifiedAddInput() {
            const inputArea = document.getElementById('unifiedAddInput');
            
            // å…ƒã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«å¾©å…ƒ
            inputArea.innerHTML = `
                <div style="margin-bottom: 5px;">
                    <span style="font-size: 11px; color: #155724; font-weight: bold;">âœ¨ æ–°è¦é …ç›®ã‚’è¿½åŠ </span>
                </div>
                <div style="display: flex; gap: 3px; align-items: center;">
                    <input type="text" id="unifiedAddText" placeholder="é …ç›®åã‚’å…¥åŠ›" style="flex: 1; padding: 4px 8px; border: 1px solid #28a745; border-radius: 3px; font-size: 11px;">
                    <button onclick="executeAdd()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">âœ“ è¿½åŠ </button>
                    <button onclick="cancelAdd()" style="background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">âœ— ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            `;
            inputArea.style.background = '#e8f5e8';
            inputArea.style.borderColor = '#28a745';
            inputArea.style.display = 'block';
            
            const textField = document.getElementById('unifiedAddText');
            textField.value = '';
            textField.placeholder = `${selectedTarget === 'timing' ? 'ã‚¿ã‚¤ãƒŸãƒ³ã‚°' : selectedTarget === 'top' ? 'ä¸ŠåŠèº«ã®æœè£…' : 'ä¸‹åŠèº«ã®æœè£…'}ã‚’å…¥åŠ›`;
            textField.focus();
        }

        // çµ±ä¸€è¿½åŠ å®Ÿè¡Œ
        window.executeAdd = () => {
            const newItem = document.getElementById('unifiedAddText').value.trim();
            if (!newItem || !selectedTarget) return;

            // ãƒ©ãƒ³ãƒ€ãƒ ã‚«ãƒ©ãƒ¼ç”Ÿæˆ
            const randomColor = RANDOM_COLORS[Math.floor(Math.random() * RANDOM_COLORS.length)];
            
            // å¯¾è±¡ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ä½œæˆ
            const containers = {
                timing: document.getElementById('timingButtons'),
                top: document.getElementById('topClothingButtons'),
                bottom: document.getElementById('bottomClothingButtons')
            };
            
            const button = document.createElement('button');
            button.type = 'button';
            
            if (selectedTarget === 'timing') {
                button.className = 'timing-btn';
                button.setAttribute('data-timing', newItem);
                button.onclick = () => selectTiming(newItem);
                button.textContent = `â° ${newItem}`;
            } else if (selectedTarget === 'top') {
                button.className = 'clothing-btn';
                button.setAttribute('data-clothing-top', newItem);
                button.onclick = () => selectClothingTop(newItem);
                button.textContent = `ğŸ‘” ${newItem}`;
            } else if (selectedTarget === 'bottom') {
                button.className = 'clothing-btn';
                button.setAttribute('data-clothing-bottom', newItem);
                button.onclick = () => selectClothingBottom(newItem);
                button.textContent = `ğŸ‘– ${newItem}`;
            }
            
            button.style.cssText = `background: ${randomColor}; color: white; opacity: 0.7;`;
            button.setAttribute('data-original-color', randomColor);
            
            containers[selectedTarget].appendChild(button);
            
            // è¿½åŠ å¾Œã™ãã«é¸æŠ
            if (selectedTarget === 'timing') selectTiming(newItem);
            else if (selectedTarget === 'top') selectClothingTop(newItem);
            else if (selectedTarget === 'bottom') selectClothingBottom(newItem);
            
            // æ°¸ç¶šåŒ–ä¿å­˜
            saveCustomItems();
            
            // ãƒ­ã‚°å‡ºåŠ›
            const targetName = selectedTarget === 'timing' ? 'ã‚¿ã‚¤ãƒŸãƒ³ã‚°' : selectedTarget === 'top' ? 'ä¸ŠåŠèº«' : 'ä¸‹åŠèº«';
            log(`âœ… ${targetName}é …ç›®è¿½åŠ : ${newItem}`);
            
            // å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
            cancelAdd();
        };

        // è¿½åŠ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        window.cancelAdd = () => {
            document.getElementById('unifiedAddInput').style.display = 'none';
            document.getElementById('unifiedAddText').value = '';
        };

        // ãƒ¢ãƒ¼ãƒ‰UIæ›´æ–°
        function updateModeUI() {
            const buttons = {
                normal: document.getElementById('normalModeBtn'),
                add: document.getElementById('addModeBtn'),
                delete: document.getElementById('deleteModeBtn')
            };

            // ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆ
            Object.entries(buttons).forEach(([key, btn]) => {
                btn.style.background = '#6c757d';
            });

            // é¸æŠã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰ã‚’å¼·èª¿
            if (buttons[currentMode]) {
                const colors = { normal: '#007bff', add: '#28a745', delete: '#dc3545' };
                buttons[currentMode].style.background = colors[currentMode];
            }

            // ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®è¡¨ç¤ºåˆ¶å¾¡
            if (currentMode === 'add') {
                // è¿½åŠ ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹è¡¨ç¤º
                updateAddModeGuidance();
            } else if (currentMode === 'delete') {
                // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹è¡¨ç¤º
                updateDeleteModeGuidance();
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯çµ±ä¸€å…¥åŠ›ã‚’éè¡¨ç¤º
                document.getElementById('unifiedAddInput').style.display = 'none';
            }
        }

        // è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹æ›´æ–°
        function updateAddModeGuidance() {
            const inputArea = document.getElementById('unifiedAddInput');
            
            if (!selectedTarget) {
                // å¯¾è±¡æœªé¸æŠæ™‚ã¯ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹è¡¨ç¤º
                inputArea.style.display = 'block';
                inputArea.innerHTML = `
                    <div style="margin-bottom: 5px;">
                        <span style="font-size: 11px; color: #856404; font-weight: bold;">ğŸ‘† è¿½åŠ ã—ãŸã„é …ç›®ã®å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
                    </div>
                `;
                inputArea.style.background = '#fff3cd';
                inputArea.style.borderColor = '#ffc107';
            }
        }

        // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹æ›´æ–°
        function updateDeleteModeGuidance() {
            const inputArea = document.getElementById('unifiedAddInput');
            
            if (!selectedTarget) {
                // å¯¾è±¡æœªé¸æŠæ™‚ã¯ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹è¡¨ç¤º
                inputArea.style.display = 'block';
                inputArea.innerHTML = `
                    <div style="margin-bottom: 5px;">
                        <span style="font-size: 11px; color: #721c24; font-weight: bold;">ğŸ‘† å‰Šé™¤ã—ãŸã„é …ç›®ã®å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
                    </div>
                `;
                inputArea.style.background = '#f8d7da';
                inputArea.style.borderColor = '#dc3545';
            } else {
                // å¯¾è±¡é¸æŠæ¸ˆã¿æ™‚ã¯å‰Šé™¤æ–¹æ³•ã®æ¡ˆå†…
                inputArea.style.display = 'block';
                inputArea.innerHTML = `
                    <div style="margin-bottom: 5px;">
                        <span style="font-size: 11px; color: #721c24; font-weight: bold;">âŒ èµ¤è‰²ã®ã‚«ã‚¹ã‚¿ãƒ é …ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‰Šé™¤</span>
                    </div>
                `;
                inputArea.style.background = '#f8d7da';
                inputArea.style.borderColor = '#dc3545';
            }
        }

        // å¯¾è±¡UIæ›´æ–°
        function updateTargetUI() {
            const buttons = {
                timing: document.getElementById('timingTargetBtn'),
                top: document.getElementById('topTargetBtn'),
                bottom: document.getElementById('bottomTargetBtn')
            };

            // ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆ
            Object.entries(buttons).forEach(([key, btn]) => {
                btn.style.background = '#6c757d';
            });

            // é¸æŠã•ã‚ŒãŸå¯¾è±¡ã‚’å¼·èª¿
            if (selectedTarget && buttons[selectedTarget]) {
                buttons[selectedTarget].style.background = '#007bff';
            }
        }

        // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºæ›´æ–°
        function updateDeleteModeDisplay() {
            if (currentMode !== 'delete' || !selectedTarget) {
                // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ä»¥å¤–ã§ã¯å…ƒã®è¡¨ç¤ºã«æˆ»ã™
                restoreNormalDisplay();
                return;
            }

            const selectors = {
                timing: '.timing-btn',
                top: '.clothing-btn[data-clothing-top]',
                bottom: '.clothing-btn[data-clothing-bottom]'
            };

            const buttons = document.querySelectorAll(selectors[selectedTarget]);
            
            buttons.forEach(btn => {
                const item = btn.getAttribute(`data-${selectedTarget === 'timing' ? 'timing' : selectedTarget === 'top' ? 'clothing-top' : 'clothing-bottom'}`);
                if (isCustomItem(item, selectedTarget)) {
                    // ã‚«ã‚¹ã‚¿ãƒ é …ç›®ã‚’å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºã«
                    btn.style.background = '#dc3545';
                    btn.style.transform = 'scale(0.9)';
                    btn.innerHTML = `âŒ ${item}`;
                    
                    // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰æ–°ã—ã„ã‚‚ã®ã‚’è¿½åŠ 
                    btn.replaceWith(btn.cloneNode(true));
                    const newBtn = document.querySelector(`[data-${selectedTarget === 'timing' ? 'timing' : selectedTarget === 'top' ? 'clothing-top' : 'clothing-bottom'}="${item}"]`);
                    newBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        deleteCustomItem(item, selectedTarget);
                        // å‰Šé™¤å¾Œã«ãƒ¢ãƒ¼ãƒ‰ã‚’é€šå¸¸ã«æˆ»ã™
                        setMode('normal');
                    });
                } else {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé …ç›®ã¯ç„¡åŠ¹åŒ–ï¼ˆå‰Šé™¤ä¸å¯ã®è¡¨ç¤ºï¼‰
                    btn.style.opacity = '0.5';
                    btn.style.transform = 'scale(0.95)';
                }
            });

            log(`ğŸ—‘ï¸ å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰: ${selectedTarget === 'timing' ? 'ã‚¿ã‚¤ãƒŸãƒ³ã‚°' : selectedTarget === 'top' ? 'ä¸ŠåŠèº«' : 'ä¸‹åŠèº«'}ã®ã‚«ã‚¹ã‚¿ãƒ é …ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‰Šé™¤`);
        }

        // é€šå¸¸è¡¨ç¤ºã«å¾©æ—§
        function restoreNormalDisplay() {
            const allButtons = document.querySelectorAll('.timing-btn, .clothing-btn');
            
            allButtons.forEach(btn => {
                const item = btn.getAttribute('data-timing') || btn.getAttribute('data-clothing-top') || btn.getAttribute('data-clothing-bottom');
                const originalColor = btn.getAttribute('data-original-color');
                
                // é€šå¸¸ã®è¡¨ç¤ºã«å¾©æ—§
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
                
                if (originalColor) {
                    // ã‚«ã‚¹ã‚¿ãƒ é …ç›®
                    btn.style.background = originalColor;
                    if (btn.classList.contains('timing-btn')) {
                        btn.innerHTML = `â° ${item}`;
                        btn.onclick = () => selectTiming(item);
                    } else if (btn.hasAttribute('data-clothing-top')) {
                        btn.innerHTML = `ğŸ‘” ${item}`;
                        btn.onclick = () => selectClothingTop(item);
                    } else if (btn.hasAttribute('data-clothing-bottom')) {
                        btn.innerHTML = `ğŸ‘– ${item}`;
                        btn.onclick = () => selectClothingBottom(item);
                    }
                }
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé …ç›®ã¯å…ƒã‹ã‚‰æ­£ã—ã„è¡¨ç¤ºãªã®ã§ä½•ã‚‚ã—ãªã„
            });
        }

        // ã‚«ã‚¹ã‚¿ãƒ é …ç›®åˆ¤å®šï¼ˆçµ±ä¸€ç‰ˆï¼‰
        function isCustomItem(item, target) {
            const defaults = {
                timing: ['èµ·åºŠå¾Œ', 'ãƒˆã‚¤ãƒ¬å‰', 'ãƒˆã‚¤ãƒ¬å¾Œ', 'é¢¨å‘‚å‰', 'é¢¨å‘‚å¾Œ', 'é£Ÿäº‹å‰', 'é£Ÿäº‹å¾Œ'],
                top: ['ãªã—', 'ä¸‹ç€ã‚·ãƒ£ãƒ„', 'ãƒ¯ã‚¤ã‚·ãƒ£ãƒ„'],
                bottom: ['ãªã—', 'ãƒˆãƒ©ãƒ³ã‚¯ã‚¹', 'ãƒãƒ¼ãƒ•ãƒ‘ãƒ³ãƒ„']
            };
            return !defaults[target].includes(item);
        }

        // ã‚«ã‚¹ã‚¿ãƒ é …ç›®å‰Šé™¤ï¼ˆçµ±ä¸€ç‰ˆï¼‰
        function deleteCustomItem(item, target) {
            const selector = `[data-${target === 'timing' ? 'timing' : target === 'top' ? 'clothing-top' : 'clothing-bottom'}="${item}"]`;
            const button = document.querySelector(selector);
            if (button && isCustomItem(item, target)) {
                button.remove();
                saveCustomItems();
                log(`ğŸ—‘ï¸ ã‚«ã‚¹ã‚¿ãƒ é …ç›®å‰Šé™¤: ${item} (${target === 'timing' ? 'ã‚¿ã‚¤ãƒŸãƒ³ã‚°' : target === 'top' ? 'ä¸ŠåŠèº«' : 'ä¸‹åŠèº«'})`);
            }
        }

        // çµ±ä¸€ãƒ¢ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ å®Œäº† - å¤ã„å€‹åˆ¥é–¢æ•°ç¾¤ã¯å‰Šé™¤æ¸ˆã¿

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã®å€¤èª¿æ•´æ©Ÿèƒ½
        window.handleWeightKeypress = (event) => {
            const weightInput = document.getElementById('weightValue');
            const currentValue = parseFloat(weightInput.value) || 72.0;
            
            if (event.key === 'ArrowUp') {
                event.preventDefault();
                weightInput.value = (currentValue + 0.1).toFixed(1);
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                weightInput.value = Math.max(0, currentValue - 0.1).toFixed(1);
            }
        };

        // ã‚¿ã‚¤ãƒŸãƒ³ã‚°é¸æŠæ©Ÿèƒ½ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        window.selectTiming = (timing) => {
            selectedTimingValue = timing;
            document.getElementById('selectedTiming').value = timing;
            
            // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‹ã‚‰é¸æŠçŠ¶æ…‹ã‚’å‰Šé™¤
            document.querySelectorAll('.timing-btn').forEach(btn => {
                btn.classList.remove('selected');
                btn.style.opacity = '0.7';
            });
            
            // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã«é¸æŠçŠ¶æ…‹ã‚’è¿½åŠ 
            const selectedBtn = document.querySelector(`[data-timing="${timing}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
                selectedBtn.style.opacity = '1';
            }
            
            log(`â° æ¸¬å®šã‚¿ã‚¤ãƒŸãƒ³ã‚°é¸æŠ: ${timing}`);
        };

        // ä¸ŠåŠèº«æœè£…é¸æŠæ©Ÿèƒ½
        window.selectClothingTop = (clothing) => {
            selectedTopValue = clothing;
            document.getElementById('selectedTop').value = clothing;
            
            // ã™ã¹ã¦ã®ä¸ŠåŠèº«ãƒœã‚¿ãƒ³ã‹ã‚‰é¸æŠçŠ¶æ…‹ã‚’å‰Šé™¤
            document.querySelectorAll('.clothing-btn[data-clothing-top]').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã«é¸æŠçŠ¶æ…‹ã‚’è¿½åŠ 
            const selectedBtn = document.querySelector(`[data-clothing-top="${clothing}"]`);
            if (selectedBtn) {
                selectedBtn.style.opacity = '1';
                selectedBtn.style.transform = 'scale(1.05)';
            }
            
            log(`ğŸ‘• ä¸ŠåŠèº«é¸æŠ: ${clothing}`);
        };

        // ä¸‹åŠèº«æœè£…é¸æŠæ©Ÿèƒ½
        window.selectClothingBottom = (clothing) => {
            selectedBottomValue = clothing;
            document.getElementById('selectedBottom').value = clothing;
            
            // ã™ã¹ã¦ã®ä¸‹åŠèº«ãƒœã‚¿ãƒ³ã‹ã‚‰é¸æŠçŠ¶æ…‹ã‚’å‰Šé™¤
            document.querySelectorAll('.clothing-btn[data-clothing-bottom]').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã«é¸æŠçŠ¶æ…‹ã‚’è¿½åŠ 
            const selectedBtn = document.querySelector(`[data-clothing-bottom="${clothing}"]`);
            if (selectedBtn) {
                selectedBtn.style.opacity = '1';
                selectedBtn.style.transform = 'scale(1.05)';
            }
            
            log(`ğŸ©² ä¸‹åŠèº«é¸æŠ: ${clothing}`);
        };

        // çµ±ä¸€ã‚«ã‚¹ã‚¿ãƒ é …ç›®è¿½åŠ ã‚·ã‚¹ãƒ†ãƒ ï¼ˆaddCustomClothingTop ã¯çµ±ä¸€ãƒ¢ãƒ¼ãƒ‰ã«ç§»è¡Œï¼‰

        window.addTopCustomItem = () => {
            const newItem = document.getElementById('topCustomText').value.trim();
            if (newItem) {
                const container = document.getElementById('topClothingButtons');
                
                // ãƒ©ãƒ³ãƒ€ãƒ ã‚«ãƒ©ãƒ¼ç”Ÿæˆï¼ˆçµ±ä¸€å®šæ•°ä½¿ç”¨ï¼‰
                // const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a55eea']; // é‡è¤‡å‰Šé™¤
                const randomColor = RANDOM_COLORS[Math.floor(Math.random() * RANDOM_COLORS.length)];
                
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'clothing-btn';
                button.setAttribute('data-clothing-top', newItem);
                button.onclick = () => selectClothingTop(newItem);
                button.style.cssText = `background: ${randomColor}; color: white; opacity: 0.7;`;
                button.setAttribute('data-original-color', randomColor);
                button.textContent = `ğŸ‘” ${newItem}`;
                
                container.appendChild(button);
                log(`âœ… æ–°ã—ã„ä¸ŠåŠèº«é …ç›®è¿½åŠ : ${newItem}`);
                
                // è¿½åŠ å¾Œã™ãã«é¸æŠ
                selectClothingTop(newItem);
                
                // ã‚«ã‚¹ã‚¿ãƒ é …ç›®ã‚’æ°¸ç¶šåŒ–ä¿å­˜
                saveCustomItems();
                
                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆãƒ»éè¡¨ç¤º
                document.getElementById('topCustomText').value = '';
                document.getElementById('topCustomInput').style.display = 'none';
            }
        };

        window.cancelTopCustom = () => {
            document.getElementById('topCustomText').value = '';
            document.getElementById('topCustomInput').style.display = 'none';
        };

        // ã‚«ã‚¹ã‚¿ãƒ ä¸‹åŠèº«é …ç›®è¿½åŠ ï¼ˆæ”¹è‰¯ç‰ˆ - ã‚¹ãƒãƒ›å¯¾å¿œï¼‰
        window.addCustomClothingBottom = () => {
            document.getElementById('bottomCustomInput').style.display = 'block';
            document.getElementById('bottomCustomText').focus();
        };

        window.addBottomCustomItem = () => {
            const newItem = document.getElementById('bottomCustomText').value.trim();
            if (newItem) {
                const container = document.getElementById('bottomClothingButtons');
                
                // ãƒ©ãƒ³ãƒ€ãƒ ã‚«ãƒ©ãƒ¼ç”Ÿæˆï¼ˆçµ±ä¸€å®šæ•°ä½¿ç”¨ï¼‰
                // const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a55eea']; // é‡è¤‡å‰Šé™¤
                const randomColor = RANDOM_COLORS[Math.floor(Math.random() * RANDOM_COLORS.length)];
                
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'clothing-btn';
                button.setAttribute('data-clothing-bottom', newItem);
                button.onclick = () => selectClothingBottom(newItem);
                button.style.cssText = `background: ${randomColor}; color: white; opacity: 0.7;`;
                button.setAttribute('data-original-color', randomColor);
                button.textContent = `ğŸ‘– ${newItem}`;
                
                container.appendChild(button);
                log(`âœ… æ–°ã—ã„ä¸‹åŠèº«é …ç›®è¿½åŠ : ${newItem}`);
                
                // è¿½åŠ å¾Œã™ãã«é¸æŠ
                selectClothingBottom(newItem);
                
                // ã‚«ã‚¹ã‚¿ãƒ é …ç›®ã‚’æ°¸ç¶šåŒ–ä¿å­˜
                saveCustomItems();
                
                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆãƒ»éè¡¨ç¤º
                document.getElementById('bottomCustomText').value = '';
                document.getElementById('bottomCustomInput').style.display = 'none';
            }
        };

        window.cancelBottomCustom = () => {
            document.getElementById('bottomCustomText').value = '';
            document.getElementById('bottomCustomInput').style.display = 'none';
        };

        // ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¤ãƒŸãƒ³ã‚°é …ç›®è¿½åŠ ï¼ˆæ”¹è‰¯ç‰ˆ - ã‚¹ãƒãƒ›å¯¾å¿œï¼‰
        window.addCustomTiming = () => {
            document.getElementById('timingCustomInput').style.display = 'block';
            document.getElementById('timingCustomText').focus();
        };

        window.addTimingCustomItem = () => {
            const newItem = document.getElementById('timingCustomText').value.trim();
            if (newItem) {
                const container = document.getElementById('timingButtons');
                
                // ãƒ©ãƒ³ãƒ€ãƒ ã‚«ãƒ©ãƒ¼ç”Ÿæˆï¼ˆçµ±ä¸€å®šæ•°ä½¿ç”¨ï¼‰
                // const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a55eea']; // é‡è¤‡å‰Šé™¤
                const randomColor = RANDOM_COLORS[Math.floor(Math.random() * RANDOM_COLORS.length)];
                
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'timing-btn';
                button.setAttribute('data-timing', newItem);
                button.onclick = () => selectTiming(newItem);
                button.style.cssText = `background: ${randomColor}; color: white; opacity: 0.7;`;
                button.setAttribute('data-original-color', randomColor);
                button.textContent = `â° ${newItem}`;
                
                container.appendChild(button);
                log(`âœ… æ–°ã—ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°é …ç›®è¿½åŠ : ${newItem}`);
                
                // è¿½åŠ å¾Œã™ãã«é¸æŠ
                selectTiming(newItem);
                
                // ã‚«ã‚¹ã‚¿ãƒ é …ç›®ã‚’æ°¸ç¶šåŒ–ä¿å­˜
                saveCustomItems();
                
                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆãƒ»éè¡¨ç¤º
                document.getElementById('timingCustomText').value = '';
                document.getElementById('timingCustomInput').style.display = 'none';
            }
        };

        window.cancelTimingCustom = () => {
            document.getElementById('timingCustomText').value = '';
            document.getElementById('timingCustomInput').style.display = 'none';
        };


        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–ï¼ˆæ”¹è‰¯ç‰ˆ + ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¯¾å¿œï¼‰
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            if (user) {
                log(`âœ… èªè¨¼çŠ¶æ…‹ç¢ºèª: ${user.displayName} ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­`);
                log(`ğŸ“§ ãƒ¡ãƒ¼ãƒ«: ${user.email}`);
                showUserInterface(user);
                loadUserWeightData(user.uid);
            } else {
                // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆçµæœã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆiPhoneå¯¾å¿œï¼‰
                try {
                    const result = await auth.getRedirectResult();
                    if (result.user) {
                        log(`âœ… ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ${result.user.displayName}`);
                    }
                } catch (error) {
                    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆåˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ãªã©ï¼‰
                }
                log('ğŸ”’ èªè¨¼çŠ¶æ…‹: æœªãƒ­ã‚°ã‚¤ãƒ³');
                showLoginInterface();
            }
        });

        // åˆæœŸåŒ–å®Œäº†ãƒ­ã‚°
        log('ğŸ”„ Firebaseèªè¨¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº† - èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­...');

        // Googleãƒ­ã‚°ã‚¤ãƒ³ï¼ˆæ”¹è‰¯ç‰ˆ - ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯æ¤œçŸ¥ä»˜ãï¼‰
        window.handleGoogleLogin = async () => {
            try {
                log('ğŸ” Googleãƒ­ã‚°ã‚¤ãƒ³é–‹å§‹...');
                const provider = new firebase.auth.GoogleAuthProvider();
                
                // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºï¼ˆiPhoneå°‚ç”¨å¯¾å¿œï¼‰
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const isIPhone = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                
                // iPhoneã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ–¹å¼ã€ãã‚Œä»¥å¤–ã¯ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ–¹å¼
                if (isIPhone) {
                    log('ğŸ“± iPhone/iPadæ¤œå‡º - ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ–¹å¼ã§ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆSafariå¯¾å¿œï¼‰');
                    log('ğŸ”„ ãƒšãƒ¼ã‚¸ãŒGoogleã«ç§»å‹•ã—ã¾ã™...');
                    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ–¹å¼ï¼ˆiPhoneå°‚ç”¨ï¼‰
                    await auth.signInWithRedirect(provider);
                    return; // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã®ã§ã“ã“ã§çµ‚äº†
                } else if (isMobile) {
                    log('ğŸ“± ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º - ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ–¹å¼ã§ãƒ­ã‚°ã‚¤ãƒ³');
                    log('ğŸ’¡ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé€”ä¸­ã§æ­¢ã¾ã‚‹å ´åˆã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã®ç¢ºèªãŒå¿…è¦ã§ã™');
                } else {
                    log('ğŸ–¥ï¸ ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãƒ‡ãƒã‚¤ã‚¹ - ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ–¹å¼ã§ãƒ­ã‚°ã‚¤ãƒ³');
                }
                
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯æ¤œçŸ¥ã®ãŸã‚ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆiPhoneä»¥å¤–ï¼‰
                log('ğŸªŸ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§Googleãƒ­ã‚°ã‚¤ãƒ³ã‚’é–‹å§‹...');
                
                const loginPromise = auth.signInWithPopup(provider);
                
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ¤œçŸ¥ï¼ˆ15ç§’ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã‹ãªã„å ´åˆï¼‰
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => {
                        reject(new Error('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™'));
                    }, 15000);  // å…ƒã®15ç§’ã«æˆ»ã™ï¼ˆiPhoneä»¥å¤–ç”¨ï¼‰
                });
                
                try {
                    const result = await Promise.race([loginPromise, timeoutPromise]);
                    log(`âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ${result.user.displayName}`);
                } catch (raceError) {
                    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®å ´åˆã®ç‰¹åˆ¥å‡¦ç†
                    if (raceError.message.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')) {
                        log('â° ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒ15ç§’ä»¥å†…ã«é–‹ãã¾ã›ã‚“ã§ã—ãŸ');
                        log('ğŸ”„ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯æ¤œçŸ¥ - è§£æ±ºæ–¹æ³•ã‚’ã”æ¡ˆå†…ã—ã¾ã™');
                        throw new Error('POPUP_TIMEOUT');
                    } else {
                        throw raceError;
                    }
                }
                
            } catch (error) {
                log(`âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                
                // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°æƒ…å ±ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
                if (error.code) {
                    log(`- ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ${error.code}`);
                    
                    // ç‰¹å®šã®ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã«å¯¾ã™ã‚‹è§£æ±ºç­–ã‚’æç¤º
                    switch(error.code) {
                        case 'auth/unauthorized-domain':
                            log('ğŸ’¡ ãƒ‰ãƒ¡ã‚¤ãƒ³è¨±å¯è¨­å®šã®å•é¡Œã§ã™');
                            log('ğŸ’¡ Firebase Consoleã§èªè¨¼ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                            break;
                        case 'auth/popup-blocked':
                            log('ğŸ’¡ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                            showPopupGuide(isMobile);
                            break;
                        case 'auth/popup-closed-by-user':
                            log('ğŸ’¡ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã¾ã—ãŸ');
                            log('ğŸ’¡ ã‚‚ã†ä¸€åº¦ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„');
                            break;
                        case 'auth/cancelled-popup-request':
                            log('ğŸ’¡ å‰å›ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
                            log('ğŸ’¡ ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„');
                            break;
                        default:
                            if (error.message === 'POPUP_TIMEOUT') {
                                log('âš ï¸ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé€”ä¸­ã§æ­¢ã¾ã‚Šã¾ã—ãŸ');
                                showPopupGuide(isMobile);
                            } else {
                                log('ğŸ’¡ ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°ã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„');
                            }
                    }
                } else if (error.message === 'POPUP_TIMEOUT') {
                    showPopupGuide(isMobile);
                }
                
                if (error.credential) {
                    log('- èªè¨¼æƒ…å ±ã¯å–å¾—æ¸ˆã¿');
                }
            }
        };

        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¨±å¯ã‚¬ã‚¤ãƒ‰è¡¨ç¤º
        function showPopupGuide(isMobile) {
            log('ğŸ“– === ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¨±å¯ã‚¬ã‚¤ãƒ‰ ===');
            if (isMobile) {
                log('ğŸ“± ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å‘ã‘è§£æ±ºæ‰‹é †:');
                log('1. ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹ã€Œãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€ã‚’ã‚¿ãƒƒãƒ—');
                log('2. ã¾ãŸã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¡ãƒ‹ãƒ¥ãƒ¼(â‹®) â†’ è¨­å®š â†’ ã‚µã‚¤ãƒˆè¨­å®š â†’ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ â†’ è¨±å¯');
                log('3. Chrome: å³ä¸Šâ‹®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ è¨­å®š â†’ è©³ç´°è¨­å®š â†’ ã‚µã‚¤ãƒˆè¨­å®š â†’ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                log('4. Safari: è¨­å®šã‚¢ãƒ—ãƒª â†’ Safari â†’ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ â†’ ã‚ªãƒ•');
                log('5. è¨­å®šå¾Œã€ã“ã®ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ã‚‚ã†ä¸€åº¦ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„');
            } else {
                log('ğŸ’» PCå‘ã‘è§£æ±ºæ‰‹é †:');
                log('1. ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å³ç«¯ã®ã‚¢ã‚¤ã‚³ãƒ³(ğŸš«)ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ è¨±å¯');
                log('2. ã¾ãŸã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®š â†’ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ â†’ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ â†’ è¨±å¯');
            }
            log('ğŸ’¡ ãã‚Œã§ã‚‚è§£æ±ºã—ãªã„å ´åˆ: ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã™ã‚‹ã‹ã€åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãŠè©¦ã—ãã ã•ã„');
            log('ğŸ”„ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¨­å®šã‚’ç¢ºèªã—ãŸã‚‰ã€å†åº¦ã€ŒGoogleã§ãƒ­ã‚°ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„');
            log('ğŸ“– ========================');
        }

        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
        window.testPopup = () => {
            log('ğŸ§ª ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                const testWindow = window.open('', '_blank', 'width=400,height=500');
                
                if (testWindow) {
                    log('âœ… ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¨±å¯æ¸ˆã¿ - ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ã§ã™');
                    testWindow.close();
                    log('ğŸ’¡ ã€ŒGoogleã§ãƒ­ã‚°ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„');
                } else {
                    log('âŒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™');
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    showPopupGuide(isMobile);
                }
            } catch (error) {
                log(`âŒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                showPopupGuide(isMobile);
            }
        };

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        window.handleLogout = async () => {
            try {
                await auth.signOut();
                log('ğŸ“¤ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†');
            } catch (error) {
                log(`âŒ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        window.saveWeightData = async () => {
            if (!currentUser) {
                log('âŒ ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                return;
            }

            const date = document.getElementById('dateInput').value;
            const weight = document.getElementById('weightValue').value;
            const memo = document.getElementById('memoInput').value;

            if (!date || !weight) {
                log('âŒ æ—¥ä»˜ã¨å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                log('ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ä¸­...');
                
                const now = new Date();
                const timeString = now.toLocaleTimeString('ja-JP', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const weightData = {
                    date: date,
                    time: timeString,
                    value: parseFloat(weight),
                    timing: selectedTimingValue || '',
                    clothing: {
                        top: selectedTopValue || '',
                        bottom: selectedBottomValue || ''
                    },
                    memo: memo || '',
                    userEmail: currentUser.email,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    createdAt: now.toISOString()
                };

                if (window.editingEntryId) {
                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                    const entryRef = database.ref(`users/${currentUser.uid}/weights/${window.editingEntryId}`);
                    await entryRef.update({
                        date: date,
                        time: timeString,
                        weight: parseFloat(weight),
                        timing: selectedTimingValue || '',
                        clothing: {
                            top: selectedTopValue || '',
                            bottom: selectedBottomValue || ''
                        },
                        memo: memo || '',
                        userEmail: currentUser.email,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                } else {
                    // æ–°è¦ä¿å­˜ãƒ¢ãƒ¼ãƒ‰
                    const userRef = database.ref(`users/${currentUser.uid}/weights`);
                    await userRef.push(weightData);
                }
                
                // ä¿å­˜å®Œäº†ãƒ­ã‚°ï¼ˆæœè£…æƒ…å ±ã‚‚å«ã‚€ï¼‰
                let logMessage;
                if (window.editingEntryId) {
                    logMessage = `âœï¸ æ›´æ–°å®Œäº†: ${date} ${timeString} - ${weight}kg`;
                } else {
                    logMessage = `âœ… ä¿å­˜å®Œäº†: ${date} ${timeString} - ${weight}kg`;
                }
                if (selectedTimingValue) logMessage += ` (${selectedTimingValue})`;
                if (selectedTopValue || selectedBottomValue) {
                    const clothingInfo = [selectedTopValue, selectedBottomValue].filter(Boolean).join(', ');
                    logMessage += ` [${clothingInfo}]`;
                }
                log(logMessage);
                
                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢ï¼ˆä½“é‡ã¯72.0ã«æˆ»ã™ï¼‰
                document.getElementById('weightValue').value = '72.0';
                document.getElementById('memoInput').value = '';
                document.getElementById('selectedTop').value = '';
                document.getElementById('selectedBottom').value = '';
                selectedTimingValue = '';
                selectedTopValue = '';
                selectedBottomValue = '';
                
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
                window.editingEntryId = null;
                document.querySelector('.save-button').textContent = 'ğŸ’¾ ä¿å­˜';
                document.querySelector('.save-button').style.background = '#28a745';
                
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤
                const editModeIndicator = document.getElementById('editModeIndicator');
                if (editModeIndicator) {
                    editModeIndicator.remove();
                }
                
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
                const cancelButton = document.getElementById('cancelEditButton');
                if (cancelButton) {
                    cancelButton.remove();
                }
                
                // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.querySelectorAll('.timing-btn').forEach(btn => {
                    btn.style.opacity = '0.7';
                    btn.classList.remove('selected');
                });
                document.querySelectorAll('.clothing-btn').forEach(btn => {
                    btn.style.opacity = '0.7';
                    btn.style.transform = 'scale(1)';
                });
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                loadUserWeightData(currentUser.uid);
            } catch (error) {
                log(`âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };

        // ä½“é‡ãƒ‡ãƒ¼ã‚¿ç·¨é›†æ©Ÿèƒ½
        window.editWeightEntry = async (entryId) => {
            if (!currentUser) {
                log('âŒ ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                return;
            }
            
            try {
                const entryRef = database.ref(`users/${currentUser.uid}/weights/${entryId}`);
                const snapshot = await entryRef.once('value');
                const entry = snapshot.val();
                
                if (!entry) {
                    log('âŒ è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                document.getElementById('dateInput').value = entry.date;
                document.getElementById('weightValue').value = entry.value || entry.weight;
                document.getElementById('memoInput').value = entry.memo || '';
                
                // ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¨­å®š
                if (entry.timing) {
                    selectTiming(entry.timing);
                }
                
                // æœè£…ã‚’è¨­å®š
                if (entry.clothing && entry.clothing.top) {
                    selectClothingTop(entry.clothing.top);
                }
                if (entry.clothing && entry.clothing.bottom) {
                    selectClothingBottom(entry.clothing.bottom);
                }
                
                
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
                window.editingEntryId = entryId;
                document.querySelector('.save-button').textContent = 'âœï¸ æ›´æ–°';
                document.querySelector('.save-button').style.background = '#ffc107';
                
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¢ºã«è¡¨ç¤º
                const editModeIndicator = document.getElementById('editModeIndicator');
                if (editModeIndicator) {
                    editModeIndicator.remove();
                }
                const indicator = document.createElement('div');
                indicator.id = 'editModeIndicator';
                indicator.innerHTML = 'âœï¸ <strong>ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</strong> - ' + entry.date + ' ' + (entry.value || entry.weight) + 'kgã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿®æ­£ã—ã¦æ›´æ–°ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„';
                indicator.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 15px; text-align: center; animation: fadeIn 0.3s;';
                document.querySelector('.save-button').parentNode.insertBefore(indicator, document.querySelector('.save-button'));
                
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                const existingCancelButton = document.getElementById('cancelEditButton');
                if (existingCancelButton) {
                    existingCancelButton.remove();
                }
                const cancelButton = document.createElement('button');
                cancelButton.id = 'cancelEditButton';
                cancelButton.innerHTML = 'âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
                cancelButton.onclick = cancelEdit;
                cancelButton.style.cssText = 'background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; margin-left: 10px;';
                document.querySelector('.save-button').parentNode.insertBefore(cancelButton, document.querySelector('.save-button').nextSibling);
                
                log(`âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: ${entry.date} ${entry.value || entry.weight} ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†ä¸­`);
                
                // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                window.scrollTo(0, 0);
                
            } catch (error) {
                log(`âŒ ç·¨é›†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        // ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ©Ÿèƒ½
        window.cancelEdit = () => {
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('dateInput').value = '';
            document.getElementById('weightValue').value = '';
            document.getElementById('memoInput').value = '';
            
            // é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            selectedTimingValue = '';
            selectedTopValue = '';
            selectedBottomValue = '';
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
            window.editingEntryId = null;
            document.querySelector('.save-button').textContent = 'ğŸ’¾ ä¿å­˜';
            document.querySelector('.save-button').style.background = '#28a745';
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤
            const editModeIndicator = document.getElementById('editModeIndicator');
            if (editModeIndicator) {
                editModeIndicator.remove();
            }
            
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
            const cancelButton = document.getElementById('cancelEditButton');
            if (cancelButton) {
                cancelButton.remove();
            }
            
            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.timing-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.classList.remove('selected');
            });
            document.querySelectorAll('.clothing-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            log('âŒ ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        };
        
        // ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        window.deleteWeightEntry = async (entryId) => {
            if (!currentUser) {
                log('âŒ ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                return;
            }
            
            if (!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                log(`ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ä¸­: ${entryId}`);
                const entryRef = database.ref(`users/${currentUser.uid}/weights/${entryId}`);
                await entryRef.remove();
                log(`âœ… å‰Šé™¤å®Œäº†: ${entryId}`);
            } catch (error) {
                log(`âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        function loadUserWeightData(userId) {
            const userRef = database.ref(`users/${userId}/weights`);
            userRef.on('value', (snapshot) => {
                const data = snapshot.val();
                const historyDiv = document.getElementById('weightHistory');
                
                if (data) {
                    const entries = Object.entries(data)
                        .map(([key, value]) => ({ id: key, ...value }))
                        .sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
                    
                    // ã‚°ãƒ©ãƒ•ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    allWeightData = entries.sort((a, b) => new Date(a.date) - new Date(b.date));
                    updateChart();
                    
                    // ç›´è¿‘7ä»¶ã®ã¿è¡¨ç¤º
                    const recentEntries = entries.slice(-7);
                    
                    historyDiv.innerHTML = recentEntries.map(entry => {
                        let displayText = `${entry.date}`;
                        if (entry.time) displayText += ` ${entry.time}`;
                        displayText += `: ${entry.value || entry.weight}kg`;
                        if (entry.timing) displayText += ` (${entry.timing})`;
                        
                        // æœè£…æƒ…å ±ã‚’è¿½åŠ 
                        if (entry.clothing && (entry.clothing.top || entry.clothing.bottom)) {
                            const clothingInfo = [entry.clothing.top, entry.clothing.bottom].filter(Boolean).join(', ');
                            displayText += ` [${clothingInfo}]`;
                        }
                        
                        if (entry.memo) displayText += ` - ${entry.memo}`;
                        return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 2px 0; border-bottom: 1px solid #eee;"><span>${displayText}</span><div style="display: flex; gap: 2px;"><button onclick="editWeightEntry('${entry.id}')" style="background: #007bff; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">âœï¸</button><button onclick="deleteWeightEntry('${entry.id}')" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">ğŸ—‘ï¸</button></div></div>`;
                    }).join('');
                    
                    log(`ğŸ“ˆ ãƒ‡ãƒ¼ã‚¿å±¥æ­´èª­ã¿è¾¼ã¿å®Œäº†: ${entries.length}ä»¶`);
                } else {
                    historyDiv.innerHTML = 'ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
                    log('ğŸ“ˆ ãƒ‡ãƒ¼ã‚¿å±¥æ­´: ãƒ‡ãƒ¼ã‚¿ãªã—');
                    allWeightData = [];
                    updateChart();
                }
            });
        }

        // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
        // æ—¥ä»˜æŒ‡å®šã§ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
        function updateChartWithDate(days, endDate) {
            const ctx = document.getElementById('weightChart');
            if (!ctx) return;

            const end = new Date(endDate);
            const startDate = new Date(end);
            if (days > 0) {
                startDate.setDate(end.getDate() - days);
            } else {
                // å…¨æœŸé–“ã®å ´åˆã€æœ€ã‚‚å¤ã„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰
                if (allWeightData.length > 0) {
                    startDate.setTime(new Date(allWeightData[0].date).getTime());
                }
            }

            // æœŸé–“å†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const filteredData = allWeightData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startDate && entryDate <= end;
            });

            // æ—¢å­˜ã®updateCharté–¢æ•°ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»
            renderChartWithData(days, filteredData, startDate, end);
        }

        // ãƒãƒ£ãƒ¼ãƒˆæç”»ã®å…±é€šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå®‰å…¨ã‚¢ã‚¯ã‚»ã‚¹å¯¾å¿œï¼‰
        function renderChartWithData(days, filteredData, startDate, endDate) {
            const ctx = document.getElementById('weightChart');
            if (!ctx) {
                console.log('âš ï¸ weightChartè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - ãƒãƒ£ãƒ¼ãƒˆæç”»ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                return;
            }

            let chartData, datasets = [];
            let timeUnit, displayFormat, axisLabel;
            let dateRangeText = '';

            if (days === 1) {
                // 1æ—¥è¡¨ç¤ºï¼šæ™‚é–“è»¸ã‚’ä½¿ç”¨ï¼ˆ24æ™‚é–“è¡¨ç¤ºï¼‰
                chartData = filteredData.map(entry => {
                    const dateTime = entry.time ? 
                        new Date(`${entry.date}T${entry.time}:00`) : 
                        new Date(`${entry.date}T12:00:00`); // æ™‚é–“ãªã—ã®å ´åˆã¯12:00ã¨ã™ã‚‹
                    
                    return {
                        x: dateTime,
                        y: parseFloat(entry.value || entry.weight)
                    };
                }).sort((a, b) => a.x - b.x);
                
                // å¯¾è±¡æ—¥ä»˜ã‚’è¡¨ç¤ºç”¨ã«è¨­å®š
                if (filteredData.length > 0) {
                    const targetDate = new Date(filteredData[0].date);
                    const dateStr = `${targetDate.getMonth() + 1}/${targetDate.getDate()}`;
                    dateRangeText = `${dateStr}ã®ãƒ‡ãƒ¼ã‚¿`;
                }
                
                datasets.push({
                    label: 'ä½“é‡',
                    data: chartData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    pointRadius: 4,
                    pointHoverRadius: 6
                });

                // å‰æœŸé–“ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆ1æ—¥è¡¨ç¤ºç”¨ï¼‰
                if (showPreviousPeriod) {
                    const previousData = getPreviousPeriodData(days, endDate);
                    if (previousData.length > 0) {
                        const previousChartData = previousData.map(entry => {
                            const dateTime = entry.time ? 
                                new Date(`${entry.date}T${entry.time}:00`) : 
                                new Date(`${entry.date}T12:00:00`);
                            
                            return {
                                x: dateTime,
                                y: parseFloat(entry.weight || entry.value)
                            };
                        }).sort((a, b) => a.x - b.x);

                        datasets.push({
                            label: 'å‰æ—¥ã®è¨˜éŒ²',
                            data: previousChartData,
                            borderColor: 'rgba(128, 128, 128, 0.6)',
                            backgroundColor: 'rgba(128, 128, 128, 0.1)',
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderDash: [5, 5]
                        });
                    }
                }
                
                timeUnit = 'hour';
                displayFormat = 'HH:mm';
                axisLabel = 'æ™‚é–“';
            } else {
                // è¤‡æ•°æ—¥è¡¨ç¤ºï¼šæ—¥ä»˜ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆæœ€å¤§å€¤ãƒ»æœ€å°å€¤ãƒ»å¹³å‡å€¤ã‚’è¡¨ç¤ºï¼‰
                const groupedData = {};
                filteredData.forEach(entry => {
                    if (!groupedData[entry.date]) {
                        groupedData[entry.date] = [];
                    }
                    groupedData[entry.date].push(parseFloat(entry.value || entry.weight));
                });

                const avgData = [], maxData = [], minData = [];
                Object.keys(groupedData).sort().forEach(date => {
                    const values = groupedData[date];
                    const avg = values.reduce((a, b) => a + b, 0) / values.length;
                    const max = Math.max(...values);
                    const min = Math.min(...values);
                    
                    avgData.push({ x: date, y: avg });
                    maxData.push({ x: date, y: max });
                    minData.push({ x: date, y: min });
                });

                // è¤‡æ•°æ¸¬å®šæ—¥ãŒã‚ã‚‹å ´åˆã®ã¿å…¨ç³»åˆ—ã‚’è¡¨ç¤º
                const hasMultipleMeasurements = Object.values(groupedData).some(values => values.length > 1);
                
                if (hasMultipleMeasurements) {
                    const avgDataForDisplay = [];
                    const maxDataForDisplay = [];
                    const minDataForDisplay = [];
                    
                    avgData.forEach(item => {
                        const date = item.x;
                        if (groupedData[date] && groupedData[date].length > 1) {
                            avgDataForDisplay.push(item);
                        }
                    });
                    
                    maxData.forEach(item => {
                        const date = item.x;
                        if (groupedData[date] && groupedData[date].length > 1) {
                            maxDataForDisplay.push(item);
                        }
                    });
                    
                    minData.forEach(item => {
                        const date = item.x;
                        if (groupedData[date] && groupedData[date].length > 1) {
                            minDataForDisplay.push(item);
                        }
                    });

                    datasets.push({
                        label: 'å¹³å‡å€¤',
                        data: avgDataForDisplay,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    });

                    if (maxDataForDisplay.length > 0) {
                        datasets.push({
                            label: 'æœ€å¤§å€¤',
                            data: maxDataForDisplay,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderDash: [5, 5]
                        });

                        datasets.push({
                            label: 'æœ€å°å€¤',
                            data: minDataForDisplay,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderDash: [5, 5]
                        });
                    }
                } else {
                    datasets.push({
                        label: 'ä½“é‡',
                        data: avgData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    });
                }

                // å‰æœŸé–“ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆè¤‡æ•°æ—¥è¡¨ç¤ºç”¨ï¼‰
                if (showPreviousPeriod) {
                    const previousData = getPreviousPeriodData(days, endDate);
                    if (previousData.length > 0) {
                        const previousGroupedData = {};
                        previousData.forEach(entry => {
                            if (!previousGroupedData[entry.date]) {
                                previousGroupedData[entry.date] = [];
                            }
                            previousGroupedData[entry.date].push(parseFloat(entry.weight || entry.value));
                        });

                        const previousAvgData = [];
                        Object.keys(previousGroupedData).sort().forEach(date => {
                            const values = previousGroupedData[date];
                            const avg = values.reduce((a, b) => a + b, 0) / values.length;
                            previousAvgData.push({ x: date, y: avg });
                        });

                        const periodName = days === 7 ? 'å‰é€±' : days === 30 ? 'å‰æœˆ' : days === 90 ? 'å‰3ãƒ¶æœˆ' : days === 365 ? 'å‰å¹´' : 'å‰æœŸé–“';
                        datasets.push({
                            label: `${periodName}ã®è¨˜éŒ²`,
                            data: previousAvgData,
                            borderColor: 'rgba(128, 128, 128, 0.6)',
                            backgroundColor: 'rgba(128, 128, 128, 0.1)',
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderDash: [5, 5]
                        });
                    }
                }
                
                // æœŸé–“è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
                if (avgData.length > 0) {
                    const startStr = new Date(avgData[0].x).toLocaleDateString('ja-JP', {month: 'numeric', day: 'numeric'});
                    const endStr = new Date(avgData[avgData.length - 1].x).toLocaleDateString('ja-JP', {month: 'numeric', day: 'numeric'});
                    dateRangeText = `${startStr}ï½${endStr}`;
                }
                
                timeUnit = 'day';
                displayFormat = 'MM/dd';
                axisLabel = 'æ—¥ä»˜';
            }

            // æœŸé–“è¡¨ç¤ºã‚’æ›´æ–°
            updateDateRangeDisplay(dateRangeText);

            // ã‚°ãƒ©ãƒ•ã‚’æç”»
            if (weightChart) {
                weightChart.destroy();
            }

            const chartConfig = {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}kg`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: timeUnit,
                                displayFormats: {
                                    hour: displayFormat,
                                    day: displayFormat
                                }
                            },
                            title: {
                                display: true,
                                text: axisLabel
                            },
                            // 1æ—¥è¡¨ç¤ºã®å ´åˆã¯24æ™‚é–“è¡¨ç¤º
                            ...(days === 1 && filteredData.length > 0 ? {
                                min: new Date(`${filteredData[0].date}T00:00:00`),
                                max: new Date(`${filteredData[0].date}T23:59:59`)
                            } : {})
                        },
                        y: {
                            min: 71.5,
                            max: 74.0,
                            title: {
                                display: true,
                                text: 'ä½“é‡ (kg)'
                            },
                            ticks: {
                                stepSize: 0.5,
                                callback: function(value) {
                                    return value.toFixed(1) + 'kg';
                                }
                            }
                        }
                    }
                }
            };

            weightChart = new Chart(ctx, chartConfig);
            log(`ğŸ“Š ã‚°ãƒ©ãƒ•æ›´æ–°: ${filteredData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º ${dateRangeText}`);
        }

        function updateChart(days = 30) {
            // ç¾åœ¨ã®æ—¥ä»˜ã‚’åŸºæº–ã«æ›´æ–°
            currentChartDays = days;
            currentChartDate = new Date();
            
            const ctx = document.getElementById('weightChart');
            if (!ctx) return;

            const now = new Date();
            const startDate = new Date(now);
            if (days > 0) {
                startDate.setDate(now.getDate() - days);
            } else {
                // å…¨æœŸé–“ã®å ´åˆã€æœ€ã‚‚å¤ã„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰
                if (allWeightData.length > 0) {
                    startDate.setTime(new Date(allWeightData[0].date).getTime());
                }
            }

            // æœŸé–“å†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const filteredData = allWeightData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startDate && entryDate <= now;
            });

            // å…±é€šã®æç”»ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨
            renderChartWithData(days, filteredData, startDate, now);
            
            // æœŸé–“æƒ…å ±ã‚’æ›´æ–°
            updateChartPeriodInfo();
        }

        // æ—¥ä»˜ç¯„å›²è¡¨ç¤ºã‚’æ›´æ–°
        function updateDateRangeDisplay(rangeText) {
            const chartContainer = document.querySelector('#chartPanel div[style*="position: relative"]');
            if (!chartContainer) {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: chartPanelã‚’ä½¿ç”¨
                const chartPanel = document.getElementById('chartPanel');
                if (!chartPanel) {
                    console.warn('Chart panel not found for date range display');
                    return;
                }
                
                let rangeDisplay = document.getElementById('chartDateRange');
                if (!rangeDisplay) {
                    rangeDisplay = document.createElement('div');
                    rangeDisplay.id = 'chartDateRange';
                    rangeDisplay.style.cssText = 'text-align: right; font-size: 12px; color: #666; margin-bottom: 5px; padding: 2px 0;';
                    const h3 = chartPanel.querySelector('h3');
                    if (h3) {
                        h3.insertAdjacentElement('afterend', rangeDisplay);
                    }
                }
                if (rangeDisplay && rangeText) {
                    rangeDisplay.textContent = rangeText;
                }
                return;
            }

            let rangeDisplay = document.getElementById('chartDateRange');
            if (!rangeDisplay) {
                // æ—¥ä»˜ç¯„å›²è¡¨ç¤ºã‚¨ãƒªã‚¢ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
                rangeDisplay = document.createElement('div');
                rangeDisplay.id = 'chartDateRange';
                rangeDisplay.style.cssText = 'position: absolute; top: 5px; right: 10px; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px; font-size: 12px; color: #666; border: 1px solid #ddd; z-index: 10;';
                chartContainer.appendChild(rangeDisplay);
            }
            if (rangeDisplay && rangeText) {
                rangeDisplay.textContent = rangeText;
            }
        }

        // ã‚°ãƒ©ãƒ•ã®è¡¨ç¤ºæœŸé–“ã‚’å¤‰æ›´
        window.updateChartRange = (days) => {
            updateChart(days);
            const rangeName = days === 1 ? '1æ—¥' :
                            days === 7 ? '1é€±é–“' : 
                            days === 30 ? '1ãƒ¶æœˆ' : 
                            days === 90 ? '3ãƒ¶æœˆ' : 
                            days === 365 ? '1å¹´' : 'å…¨æœŸé–“';
            log(`ğŸ“Š ã‚°ãƒ©ãƒ•è¡¨ç¤ºæœŸé–“å¤‰æ›´: ${rangeName}`);
        }

        // ãƒãƒ£ãƒ¼ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç”¨å¤‰æ•°
        let currentChartDays = 30; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœŸé–“
        let currentChartDate = new Date(); // åŸºæº–æ—¥

        // ãƒãƒ£ãƒ¼ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
        window.navigateChart = (direction) => {
            if (currentChartDays === 0) {
                log('âš ï¸ å…¨æœŸé–“è¡¨ç¤ºä¸­ã¯ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã§ãã¾ã›ã‚“');
                return;
            }

            const today = new Date();
            
            if (direction === 'prev') {
                // å‰ã®æœŸé–“ã¸
                currentChartDate.setDate(currentChartDate.getDate() - currentChartDays);
            } else if (direction === 'next') {
                // æ¬¡ã®æœŸé–“ã¸
                currentChartDate.setDate(currentChartDate.getDate() + currentChartDays);
                
                // æœªæ¥ã«è¡Œãéããªã„ã‚ˆã†åˆ¶é™
                if (currentChartDate > today) {
                    currentChartDate = new Date(today);
                }
            }
            
            // ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
            updateChartWithDate(currentChartDays, currentChartDate);
            
            // æœŸé–“æƒ…å ±ã‚’æ›´æ–°
            updateChartPeriodInfo();
            
            const direction_jp = direction === 'prev' ? 'å‰' : 'æ¬¡';
            log(`ğŸ“Š ãƒãƒ£ãƒ¼ãƒˆ${direction_jp}ã¸ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³`);
        };

        // æœŸé–“æƒ…å ±è¡¨ç¤ºã‚’æ›´æ–°
        function updateChartPeriodInfo() {
            const periodInfo = document.getElementById('chartPeriodInfo');
            if (!periodInfo) return;
            
            const endDate = new Date(currentChartDate);
            const startDate = new Date(currentChartDate);
            
            if (currentChartDays === 1) {
                // 1æ—¥è¡¨ç¤º
                periodInfo.textContent = `${endDate.getMonth() + 1}/${endDate.getDate()} (1æ—¥)`;
            } else if (currentChartDays === 7) {
                // 1é€±é–“è¡¨ç¤º
                startDate.setDate(endDate.getDate() - 6);
                periodInfo.textContent = `${startDate.getMonth() + 1}/${startDate.getDate()} - ${endDate.getMonth() + 1}/${endDate.getDate()} (1é€±é–“)`;
            } else if (currentChartDays === 30) {
                // 1ãƒ¶æœˆè¡¨ç¤º
                startDate.setDate(endDate.getDate() - 29);
                periodInfo.textContent = `${startDate.getMonth() + 1}/${startDate.getDate()} - ${endDate.getMonth() + 1}/${endDate.getDate()} (1ãƒ¶æœˆ)`;
            } else if (currentChartDays === 90) {
                // 3ãƒ¶æœˆè¡¨ç¤º
                startDate.setDate(endDate.getDate() - 89);
                periodInfo.textContent = `${startDate.getMonth() + 1}/${startDate.getDate()} - ${endDate.getMonth() + 1}/${endDate.getDate()} (3ãƒ¶æœˆ)`;
            } else if (currentChartDays === 365) {
                // 1å¹´è¡¨ç¤º
                startDate.setDate(endDate.getDate() - 364);
                periodInfo.textContent = `${startDate.getMonth() + 1}/${startDate.getDate()} - ${endDate.getMonth() + 1}/${endDate.getDate()} (1å¹´)`;
            } else {
                periodInfo.textContent = 'å…¨æœŸé–“';
            }
        }

        // å‰æœŸé–“æ¯”è¼ƒæ©Ÿèƒ½
        function togglePreviousPeriod() {
            showPreviousPeriod = !showPreviousPeriod;
            const btn = document.getElementById('previousPeriodBtn');
            
            if (showPreviousPeriod) {
                btn.style.background = '#dc3545';
                btn.textContent = 'å‰æœŸé–“OFF';
            } else {
                btn.style.background = '#28a745';
                btn.textContent = 'å‰æœŸé–“ã®è¨˜éŒ²';
            }
            
            // ãƒãƒ£ãƒ¼ãƒˆã‚’å†æç”»
            updateChartWithDate(currentChartDays, currentChartDate);
            log(`ğŸ“Š å‰æœŸé–“æ¯”è¼ƒ: ${showPreviousPeriod ? 'ON' : 'OFF'}`);
        }

        // å‰æœŸé–“ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        function getPreviousPeriodData(days, currentEndDate) {
            if (days <= 0) return []; // å…¨æœŸé–“è¡¨ç¤ºã®å ´åˆã¯å‰æœŸé–“ãªã—
            
            // å‰æœŸé–“ã®çµ‚äº†æ—¥ã‚’è¨ˆç®—
            const previousEndDate = new Date(currentEndDate);
            if (days === 1) {
                // 1æ—¥è¡¨ç¤ºã®å ´åˆï¼šå‰æ—¥
                previousEndDate.setDate(currentEndDate.getDate() - 1);
            } else {
                // è¤‡æ•°æ—¥è¡¨ç¤ºã®å ´åˆï¼šå‰æœŸé–“ã®çµ‚äº†æ—¥
                previousEndDate.setDate(currentEndDate.getDate() - days);
            }
            
            // å‰æœŸé–“ã®é–‹å§‹æ—¥ã‚’è¨ˆç®—
            const previousStartDate = new Date(previousEndDate);
            if (days === 1) {
                // 1æ—¥è¡¨ç¤ºï¼šé–‹å§‹æ—¥=çµ‚äº†æ—¥ï¼ˆå‰æ—¥ã®ã¿ï¼‰
                previousStartDate.setTime(previousEndDate.getTime());
            } else {
                // è¤‡æ•°æ—¥è¡¨ç¤ºï¼šæœŸé–“ã®é–‹å§‹æ—¥ã‚’è¨ˆç®—
                previousStartDate.setDate(previousEndDate.getDate() - days + 1);
            }
            
            // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
            log(`ğŸ” å‰æœŸé–“ãƒ‡ãƒ¼ã‚¿å–å¾—: ${days}æ—¥, ç¾åœ¨çµ‚äº†æ—¥: ${currentEndDate.toDateString()}`);
            log(`ğŸ” å‰æœŸé–“ç¯„å›²: ${previousStartDate.toDateString()} - ${previousEndDate.toDateString()}`);
            
            // å‰æœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const filteredData = allWeightData.filter(entry => {
                const entryDate = new Date(entry.date);
                const entryDateStr = entry.date; // YYYY-MM-DDå½¢å¼ã®æ–‡å­—åˆ—
                const previousStartStr = previousStartDate.toISOString().split('T')[0];
                const previousEndStr = previousEndDate.toISOString().split('T')[0];
                
                // ãƒ‡ãƒãƒƒã‚°ç”¨
                if (days === 1) {
                    log(`ğŸ” ãƒ‡ãƒ¼ã‚¿ç¢ºèª: ${entryDateStr} vs ${previousStartStr}-${previousEndStr}`);
                }
                
                return entryDateStr >= previousStartStr && entryDateStr <= previousEndStr;
            });
            
            log(`ğŸ” å‰æœŸé–“ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: ${filteredData.length}ä»¶`);
            return filteredData;
        }

        // ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®ã‚¢ã‚¯ã‚»ã‚¹ç”¨ï¼ˆæœ¬ç•ªç’°å¢ƒã«å½±éŸ¿ãªã—ï¼‰
        if (typeof window !== 'undefined' && typeof module !== 'undefined') {
            window.getPreviousPeriodData = getPreviousPeriodData;
        }

        // ç¾åœ¨ã®ã‚¿ãƒ–
        let currentTab = 1;
        
        // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å‹•çš„èª­ã¿è¾¼ã¿
        window.loadTabContent = async (tabNumber, tabType) => {
            try {
                const tabContentDiv = document.getElementById(`tabContent${tabNumber}`);
                if (!tabContentDiv) return;
                
                // HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’èª­ã¿è¾¼ã¿
                const response = await fetch(`tabs/tab${tabNumber}-${tabType}/${tabType}-tab.html`);
                if (response.ok) {
                    const htmlContent = await response.text();
                    tabContentDiv.innerHTML = htmlContent;
                    
                    // JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‹•çš„èª­ã¿è¾¼ã¿
                    await loadTabScript(tabNumber, tabType);
                    
                    log(`âœ… ã‚¿ãƒ–${tabNumber}ï¼ˆ${tabType}ï¼‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„èª­ã¿è¾¼ã¿å®Œäº†`);
                } else {
                    log(`âš ï¸ ã‚¿ãƒ–${tabNumber}ã®åˆ†é›¢ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½¿ç”¨`);
                }
            } catch (error) {
                log(`âŒ ã‚¿ãƒ–èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        // ã‚¿ãƒ–ç”¨JavaScriptã®å‹•çš„èª­ã¿è¾¼ã¿
        window.loadTabScript = async (tabNumber, tabType) => {
            try {
                // æ—¢å­˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’å‰Šé™¤
                const existingScript = document.getElementById(`tab${tabNumber}Script`);
                if (existingScript) {
                    existingScript.remove();
                }
                
                // æ–°ã—ã„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’ä½œæˆ
                const script = document.createElement('script');
                script.id = `tab${tabNumber}Script`;
                script.src = `tabs/tab${tabNumber}-${tabType}/${tabType}-tab.js`;
                document.head.appendChild(script);
                
                return new Promise((resolve, reject) => {
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error(`Script load failed: ${script.src}`));
                });
            } catch (error) {
                throw error;
            }
        };

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ï¼ˆå‹•çš„èª­ã¿è¾¼ã¿å¯¾å¿œï¼‰
        window.switchTab = async (tabNumber) => {
            currentTab = tabNumber;
            
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ï¼ˆ16ã‚¿ãƒ–å¯¾å¿œï¼‰
            for (let i = 1; i <= 16; i++) {
                const tabBtn = document.getElementById(`tab${i}`);
                const tabContent = document.getElementById(`tabContent${i}`);
                
                if (i === tabNumber) {
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–
                    tabBtn.style.background = '#007bff';
                    tabBtn.style.color = 'white';
                    tabContent.classList.remove('hidden');
                    
                    // å‹•çš„èª­ã¿è¾¼ã¿ï¼ˆåˆ†é›¢ã•ã‚ŒãŸã‚¿ãƒ–ã®ã¿ï¼‰
                    // ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ– - å¾“æ¥é€šã‚Šã®å‹•ä½œã‚’ç¶­æŒ
                    // if (i === 1) {
                    //     await loadTabContent(1, 'weight');
                    // }
                } else {
                    // éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–
                    tabBtn.style.background = '#f8f9fa';
                    tabBtn.style.color = '#495057';
                    tabContent.classList.add('hidden');
                }
            }
            
            // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            const tabTitles = {
                1: 'ğŸ“Š ä½“é‡ç®¡ç†ã‚¢ãƒ—ãƒª',
                2: 'ğŸ›ï¸ ç¡çœ ç®¡ç†',
                3: 'ğŸ  éƒ¨å±‹ç‰‡ã¥ã‘',
                4: 'ğŸ¤¸ ã‚¹ãƒˆãƒ¬ãƒƒãƒ',
                5: 'ğŸ”§ xx5',
                6: 'ğŸ”§ xx6', 
                7: 'ğŸ”§ xx7',
                8: 'ğŸ”§ xx8'
            };
            
            const titleElement = document.getElementById('appTitle');
            if (titleElement && tabTitles[tabNumber]) {
                titleElement.textContent = `${tabTitles[tabNumber]} ${APP_VERSION}`;
            }
            
            // ã‚¿ãƒ–å›ºæœ‰ã®åˆæœŸåŒ–å‡¦ç†
            if (tabNumber === 2) {
                // ç¡çœ ç®¡ç†ã‚¿ãƒ–ã®åˆæœŸåŒ–ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã«é–¢ä¿‚ãªãå®Ÿè¡Œï¼‰
                initializeSleepManager();
                if (currentUser) {
                    loadSleepData();
                }
            } else if (tabNumber === 3) {
                // éƒ¨å±‹ç‰‡ä»˜ã‘ã‚¿ãƒ–ã®åˆæœŸåŒ–
                initRoomManagement();
                if (currentUser) {
                    loadRoomData();
                }
            }
            
            log(`ğŸ“‘ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ: ã‚¿ãƒ–${tabNumber}`);
        };

        // UIè¡¨ç¤ºåˆ¶å¾¡
        function showUserInterface(user) {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('tabNavigation').classList.remove('hidden');
            document.getElementById('appHeader').classList.remove('hidden');
            document.getElementById('modeControl').classList.remove('hidden');
            document.getElementById('weightInput').classList.remove('hidden');
            document.getElementById('chartPanel').classList.remove('hidden');
            document.getElementById('weightHistoryPanel').classList.remove('hidden');
            document.getElementById('userName').textContent = user.displayName;
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¿ãƒ–1ã‚’è¡¨ç¤º
            switchTab(1);
            
            // ã‚«ã‚¹ã‚¿ãƒ é …ç›®ã‚’å¾©å…ƒï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«å®Ÿè¡Œï¼‰
            loadCustomItems();
            
            // ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ï¼‰
            loadMemoData();
            
            // ä»Šæ—¥ã®æ—¥ä»˜ã¨ä½“é‡ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è€ƒæ…®ï¼‰
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;
            document.getElementById('dateInput').value = todayString;
            document.getElementById('weightValue').value = '72.0';
            
            // ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹è¨­å®š
            document.querySelectorAll('.timing-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.classList.remove('selected');
            });
            
            // æœè£…ãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹è¨­å®š
            document.querySelectorAll('.clothing-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœè£…é¸æŠ: ä¸Š=ãªã—, ä¸‹=ãƒˆãƒ©ãƒ³ã‚¯ã‚¹
            selectClothingTop('ãªã—');
            selectClothingBottom('ãƒˆãƒ©ãƒ³ã‚¯ã‚¹');
            
        }

        function showLoginInterface() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('tabNavigation').classList.add('hidden');
            document.getElementById('appHeader').classList.add('hidden');
            document.getElementById('modeControl').classList.add('hidden');
            document.getElementById('weightInput').classList.add('hidden');
            document.getElementById('chartPanel').classList.add('hidden');
        }

        // ãƒ­ã‚°å‡ºåŠ›é–¢æ•°ï¼ˆå®‰å…¨ã‚¢ã‚¯ã‚»ã‚¹å¯¾å¿œï¼‰
        function log(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            
            // DOMè¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ã¿
            if (logArea) {
                logArea.innerHTML += `[${timestamp}] ${message}<br>`;
                logArea.scrollTop = logArea.scrollHeight;
            }
            console.log(`[${timestamp}] ${message}`);
        }

        // ãƒ­ã‚°ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ï¼ˆå®‰å…¨ã‚¢ã‚¯ã‚»ã‚¹å¯¾å¿œï¼‰
        window.copyLogs = () => {
            const logArea = document.getElementById('logArea');
            if (!logArea) {
                console.log('âš ï¸ logAreaè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            const logText = logArea.innerText || logArea.textContent;
            navigator.clipboard.writeText(logText).then(() => {
                alert('âœ… ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(() => {
                // fallback
                const textArea = document.createElement('textarea');
                textArea.value = logText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('âœ… ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            });
        };

        // Firebaseæ¥ç¶šãƒ‡ãƒãƒƒã‚°
        window.debugFirebaseConnection = () => {
            log('ğŸ” === Firebase Debug é–‹å§‹ ===');
            
            // 1. Firebaseè¨­å®šç¢ºèª
            log(`ğŸ”¥ Firebase Configç¢ºèª:`);
            log(`- Project ID: ${firebaseConfig.projectId}`);
            log(`- Database URL: ${firebaseConfig.databaseURL}`);
            log(`- Auth Domain: ${firebaseConfig.authDomain}`);
            
            // 2. èªè¨¼çŠ¶æ…‹ç¢ºèª
            if (currentUser) {
                log(`âœ… èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼:`);
                log(`- UID: ${currentUser.uid.substring(0,8)}...`);
                log(`- Email: ${currentUser.email}`);
                log(`- è¡¨ç¤ºå: ${currentUser.displayName}`);
            } else {
                log('âŒ æœªèªè¨¼çŠ¶æ…‹');
            }
            
            // 3. æ¥ç¶šãƒ†ã‚¹ãƒˆ
            const connectedRef = database.ref('.info/connected');
            connectedRef.once('value', (snapshot) => {
                const connected = snapshot.val();
                log(`ğŸŒ Firebaseæ¥ç¶šçŠ¶æ…‹: ${connected ? 'æ¥ç¶šä¸­' : 'æœªæ¥ç¶š'}`);
                
                if (connected && currentUser) {
                    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
                    const testRef = database.ref(`users/${currentUser.uid}/test`);
                    testRef.set({
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        message: 'Connection test',
                        app: 'app-template'
                    }).then(() => {
                        log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›¸ãè¾¼ã¿ãƒ†ã‚¹ãƒˆæˆåŠŸ');
                    }).catch((error) => {
                        log(`âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                        log(`- Error Code: ${error.code}`);
                    });
                }
            });
            
            log('ğŸ” === Firebase Debug å®Œäº† ===');
        };

        // ãƒ¢ãƒã‚¤ãƒ«ç’°å¢ƒè¨ºæ–­
        window.checkMobileSupport = () => {
            log('ğŸ“± === ãƒ¢ãƒã‚¤ãƒ«ç’°å¢ƒè¨ºæ–­ é–‹å§‹ ===');
            
            const userAgent = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            
            log(`ğŸŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: ${userAgent}`);
            log(`ğŸ“± ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹åˆ¤å®š: ${isMobile ? 'ãƒ¢ãƒã‚¤ãƒ«' : 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—'}`);
            
            // ãƒ–ãƒ©ã‚¦ã‚¶åˆ¤å®š
            const isChrome = /Chrome/i.test(userAgent);
            const isSafari = /Safari/i.test(userAgent) && !/Chrome/i.test(userAgent);
            const isFirefox = /Firefox/i.test(userAgent);
            
            log(`ğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶: ${isChrome ? 'Chrome' : isSafari ? 'Safari' : isFirefox ? 'Firefox' : 'ä¸æ˜'}`);
            
            // ãƒ­ã‚°ã‚¤ãƒ³æ–¹å¼ã®æ¨å¥¨
            if (isMobile) {
                log('ğŸ’¡ ãƒ¢ãƒã‚¤ãƒ«ã®æ¨å¥¨è¨­å®š:');
                log('- Googleãƒ­ã‚°ã‚¤ãƒ³ã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ–¹å¼ã‚’ä½¿ç”¨');
                log('- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã®å½±éŸ¿ãªã—');
                log('- èªè¨¼å¾Œã«ãƒšãƒ¼ã‚¸ãŒå†èª­ã¿è¾¼ã¿ã•ã‚Œã¾ã™');
            }
            
            log('ğŸ“± === ãƒ¢ãƒã‚¤ãƒ«ç’°å¢ƒè¨ºæ–­ å®Œäº† ===');
        };

        // Firebaseè¨­å®šè¨ºæ–­
        window.checkFirebaseConfig = () => {
            log('ğŸ”§ === Firebaseè¨­å®šè¨ºæ–­ é–‹å§‹ ===');
            
            // ç¾åœ¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ç¢ºèª
            const currentDomain = window.location.hostname;
            const currentUrl = window.location.href;
            log(`ğŸŒ ç¾åœ¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³: ${currentDomain}`);
            log(`ğŸ”— ç¾åœ¨ã®URL: ${currentUrl}`);
            
            // Firebaseè¨­å®šæƒ…å ±
            log(`ğŸ”¥ Firebaseè¨­å®š:`);
            log(`- Project ID: ${firebaseConfig.projectId}`);
            log(`- Auth Domain: ${firebaseConfig.authDomain}`);
            log(`- Database URL: ${firebaseConfig.databaseURL}`);
            
            // èªè¨¼ãƒ‰ãƒ¡ã‚¤ãƒ³è¨±å¯çŠ¶æ³ã®æ¨æ¸¬
            if (currentDomain === 'muumuu8181.github.io') {
                log('âœ… GitHub Pagesãƒ‰ãƒ¡ã‚¤ãƒ³æ¤œå‡º');
                log('ğŸ’¡ Firebase Consoleã§ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªãŒå¿…è¦');
            } else if (currentDomain === 'localhost' || currentDomain === '127.0.0.1') {
                log('âœ… ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆæ¤œå‡º');
                log('ğŸ’¡ é€šå¸¸ã¯è‡ªå‹•ã§è¨±å¯ã•ã‚Œã¦ã„ã¾ã™');
            } else {
                log('âš ï¸ ä¸æ˜ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã™');
                log('ğŸ’¡ Firebase Consoleã®èªè¨¼è¨­å®šã§è¨±å¯ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“');
            }
            
            // ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆåˆ¶é™ç¢ºèª
            const userAgent = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            
            if (isMobile) {
                log('ğŸ“± ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶å›ºæœ‰ã®åˆ¶é™:');
                log('- Safari: ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£Cookieã®åˆ¶é™ã‚ã‚Š');
                log('- Chrome Mobile: ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯');
                log('- è§£æ±ºç­–: ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ–¹å¼ã¾ãŸã¯ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¨±å¯è¨­å®š');
            }
            
            log('ğŸ”§ === Firebaseè¨­å®šè¨ºæ–­ å®Œäº† ===');
        };

        // èªè¨¼çŠ¶æ…‹ã®å¼·åˆ¶ç¢ºèª
        window.forceAuthCheck = () => {
            log('ğŸ” === èªè¨¼çŠ¶æ…‹å¼·åˆ¶ç¢ºèª é–‹å§‹ ===');
            
            const user = auth.currentUser;
            log(`ğŸ” Firebaseèªè¨¼çŠ¶æ…‹: ${user ? `ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ (${user.displayName})` : 'æœªãƒ­ã‚°ã‚¤ãƒ³'}`);
            
            if (user) {
                log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã™');
                showUserInterface(user);
                loadUserWeightData(user.uid);
            } else {
                log('âŒ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã™');
                showLoginInterface();
            }
            
            // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ç¢ºèª
            if (user) {
                user.getIdToken(true).then(() => {
                    log('âœ… èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ‰åŠ¹ã§ã™');
                }).catch((tokenError) => {
                    log(`âŒ èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ©ãƒ¼: ${tokenError.message}`);
                    log('ğŸ’¡ å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“');
                });
            }
            
            log('ğŸ” === èªè¨¼çŠ¶æ…‹å¼·åˆ¶ç¢ºèª å®Œäº† ===');
        };

        // ãƒ­ã‚°ã‚¤ãƒ³å•é¡Œè¨ºæ–­
        window.checkLoginIssues = () => {
            log('âš ï¸ === ãƒ­ã‚°ã‚¤ãƒ³å•é¡Œè¨ºæ–­ é–‹å§‹ ===');
            
            // 1. ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒã‚§ãƒƒã‚¯
            const protocol = window.location.protocol;
            log(`ğŸŒ ç¾åœ¨ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«: ${protocol}`);
            
            if (protocol === 'file:') {
                log('âŒ å•é¡Œç™ºè¦‹: file://ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã¯Googleèªè¨¼ãŒå‹•ä½œã—ã¾ã›ã‚“');
                log('âœ… è§£æ±ºæ–¹æ³•:');
                log('  1. HTTPã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹');
                log('  2. chrome://flags ã§ insecure origins ã‚’è¨±å¯');
                log('  3. ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼èµ·å‹• (python -m http.server 8000)');
            } else if (protocol === 'https:' || protocol === 'http:') {
                log('âœ… ãƒ—ãƒ­ãƒˆã‚³ãƒ«: å•é¡Œãªã—');
            }
            
            // 2. Web Storageç¢ºèª
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                log('âœ… Web Storage: åˆ©ç”¨å¯èƒ½');
            } catch (e) {
                log('âŒ Web Storage: ç„¡åŠ¹');
                log('âœ… è§£æ±ºæ–¹æ³•: ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§Cookieã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„');
            }
            
            // 3. Firebaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¢ºèª
            if (typeof firebase !== 'undefined') {
                log('âœ… Firebase SDK: èª­ã¿è¾¼ã¿æ¸ˆã¿');
                log(`- Firebase Version: ${firebase.SDK_VERSION || 'Unknown'}`);
            } else {
                log('âŒ Firebase SDK: èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
            }
            
            // 4. ãƒ‰ãƒ¡ã‚¤ãƒ³ç¢ºèª
            const domain = window.location.hostname;
            log(`ğŸ  ç¾åœ¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³: ${domain}`);
            
            if (domain === 'localhost' || domain === '127.0.0.1') {
                log('âœ… ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º: Firebaseè¨­å®šã§è¨±å¯ãŒå¿…è¦');
            }
            
            log('âš ï¸ === ãƒ­ã‚°ã‚¤ãƒ³å•é¡Œè¨ºæ–­ å®Œäº† ===');
        };

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ç¢ºèª
        window.checkDatabaseStructure = async () => {
            if (!currentUser) {
                log('âŒ ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                return;
            }
            
            log('ğŸ—ï¸ === ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ç¢ºèª é–‹å§‹ ===');
            
            try {
                // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®weightsãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºèª
                const userRef = database.ref(`users/${currentUser.uid}/weights`);
                const snapshot = await userRef.once('value');
                const data = snapshot.val();
                
                if (data) {
                    const entries = Object.keys(data);
                    log(`ğŸ“Š ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼(${currentUser.email})ã®ãƒ‡ãƒ¼ã‚¿:`);
                    log(`- ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²æ•°: ${entries.length}ä»¶`);
                    log(`- æœ€æ–°è¨˜éŒ²ID: ${entries[entries.length - 1]}`);
                    
                    // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’è¡¨ç¤º
                    const sampleEntry = data[entries[0]];
                    log(`- ãƒ‡ãƒ¼ã‚¿æ§‹é€ : ${JSON.stringify(sampleEntry, null, 2)}`);
                } else {
                    log('ğŸ“Š ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                }
                
                // ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ã®æ§‹é€ ç¢ºèªï¼ˆç®¡ç†è€…æ¨©é™ãŒå¿…è¦ï¼‰
                try {
                    const rootRef = database.ref('users');
                    const rootSnapshot = await rootRef.once('value');
                    const allUsers = rootSnapshot.val();
                    
                    if (allUsers) {
                        const userCount = Object.keys(allUsers).length;
                        log(`ğŸ‘¥ å…¨ä½“çµ±è¨ˆ:`);
                        log(`- ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${userCount}äºº`);
                        
                        let totalWeights = 0;
                        Object.values(allUsers).forEach(user => {
                            if (user.weights) {
                                totalWeights += Object.keys(user.weights).length;
                            }
                        });
                        log(`- å…¨ä½“ã®ä½“é‡è¨˜éŒ²æ•°: ${totalWeights}ä»¶`);
                    }
                } catch (error) {
                    log(`âš ï¸ å…¨ä½“çµ±è¨ˆã®å–å¾—ã«åˆ¶é™ãŒã‚ã‚Šã¾ã™: ${error.message}`);
                }
                
            } catch (error) {
                log(`âŒ æ§‹é€ ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
            
            log('ğŸ—ï¸ === ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ç¢ºèª å®Œäº† ===');
        };

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼
        window.copyDebugInfo = () => {
            const debugInfo = `ä½“é‡ç®¡ç†ã‚¢ãƒ—ãƒª ãƒ‡ãƒãƒƒã‚°æƒ…å ±
=================================
ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: ${new Date().toLocaleString()}
URL: ${window.location.href}
ãƒ—ãƒ­ãƒˆã‚³ãƒ«: ${window.location.protocol}
ãƒ‰ãƒ¡ã‚¤ãƒ³: ${window.location.hostname}
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: ${navigator.userAgent}

Firebaseè¨­å®š:
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID: ${firebaseConfig.projectId}
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹URL: ${firebaseConfig.databaseURL}
- èªè¨¼ãƒ‰ãƒ¡ã‚¤ãƒ³: ${firebaseConfig.authDomain}

èªè¨¼çŠ¶æ…‹: ${currentUser ? 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿' : 'æœªãƒ­ã‚°ã‚¤ãƒ³'}
${currentUser ? `- UID: ${currentUser.uid.substring(0,8)}...\n- Email: ${currentUser.email}\n- è¡¨ç¤ºå: ${currentUser.displayName}` : ''}

Firebase SDK: ${typeof firebase !== 'undefined' ? 'èª­ã¿è¾¼ã¿æ¸ˆã¿' : 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'}
Web Storage: ${(() => {
    try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        return 'åˆ©ç”¨å¯èƒ½';
    } catch (e) {
        return 'ç„¡åŠ¹';
    }
})()}

ãƒ­ã‚°å†…å®¹:
${document.getElementById('logArea').innerText}`;

            navigator.clipboard.writeText(debugInfo).then(() => {
                alert('âœ… ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(() => {
                // fallback
                const textArea = document.createElement('textarea');
                textArea.value = debugInfo;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('âœ… ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            });
        };

        // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
        function initializeApp() {
            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤ºã®å‹•çš„è¨­å®š
            document.title = `ä½“é‡ç®¡ç†ã‚¢ãƒ—ãƒª ${APP_VERSION}`;
            document.getElementById('appTitle').textContent = `ğŸ“Š ä½“é‡ç®¡ç†ã‚¢ãƒ—ãƒª ${APP_VERSION}`;
            
            log(`ğŸš€ ä½“é‡ç®¡ç†ã‚¢ãƒ—ãƒªèµ·å‹•å®Œäº† ${APP_VERSION}`);
            log('ğŸ” èªè¨¼ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†');
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        initializeApp();
        
        // ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªå‹•è¨ºæ–­ï¼‰
        if (window.location.protocol === 'file:') {
            log('âš ï¸ file://ãƒ—ãƒ­ãƒˆã‚³ãƒ«æ¤œå‡º - Googleãƒ­ã‚°ã‚¤ãƒ³ã«ã¯ HTTPã‚µãƒ¼ãƒãƒ¼ãŒå¿…è¦ã§ã™');
            log('ğŸ’¡ è§£æ±ºæ–¹æ³•: python -m http.server 8000 ã¾ãŸã¯ chrome://flagsè¨­å®š');
        }

        // ========== ç¡çœ ç®¡ç†æ©Ÿèƒ½ ==========

        // ç¡çœ ç®¡ç†ç”¨å¤‰æ•°
        let allSleepData = [];
        let selectedSleepType = '';
        let selectedSleepQuality = '';
        let selectedSleepTags = [];

        // ç¡çœ ç®¡ç†åˆæœŸåŒ–
        function initializeSleepManager() {
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;
            
            if (document.getElementById('sleepDateInput')) {
                document.getElementById('sleepDateInput').value = todayString;
                
                // ç¾åœ¨æ™‚åˆ»ã‚’è¨­å®š
                const now = new Date();
                const currentHour = String(now.getHours()).padStart(2, '0');
                const currentMinute = String(now.getMinutes()).padStart(2, '0');
                const currentTimeString = `${currentHour}:${currentMinute}`;
                
                const sleepTimeInput = document.getElementById('sleepTimeInput');
                if (sleepTimeInput) {
                    sleepTimeInput.value = currentTimeString;
                }
            }
            
            log('ğŸ›ï¸ ç¡çœ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
        }


        // ç¡çœ ã‚¿ã‚¤ãƒ—é¸æŠ
        function selectSleepType(type) {
            selectedSleepType = type;
            document.getElementById('selectedSleepType').value = type;
            
            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            document.querySelectorAll('.sleep-type-btn').forEach(btn => {
                if (btn.dataset.type === type) {
                    btn.style.opacity = '1';
                    btn.style.fontWeight = 'bold';
                } else {
                    btn.style.opacity = '0.7';
                    btn.style.fontWeight = 'normal';
                }
            });
            
            log(`ğŸ›ï¸ ç¡çœ ã‚¿ã‚¤ãƒ—é¸æŠ: ${type}`);
        }

        // ç¡çœ ã®è³ªé¸æŠ
        function selectQuality(quality) {
            selectedSleepQuality = quality;
            document.getElementById('selectedQuality').value = quality;
            
            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            document.querySelectorAll('.quality-btn').forEach(btn => {
                if (parseInt(btn.dataset.quality) === quality) {
                    btn.style.opacity = '1';
                    btn.style.fontWeight = 'bold';
                } else {
                    btn.style.opacity = '0.7';
                    btn.style.fontWeight = 'normal';
                }
            });
            
            log(`â­ ç¡çœ ã®è³ªé¸æŠ: ${quality}ç‚¹`);
        }

        // ç¡çœ ã‚¿ã‚°åˆ‡ã‚Šæ›¿ãˆ
        function toggleSleepTag(tag) {
            const index = selectedSleepTags.indexOf(tag);
            const button = document.querySelector(`[data-tag="${tag}"]`);
            
            if (index === -1) {
                // ã‚¿ã‚°è¿½åŠ 
                selectedSleepTags.push(tag);
                button.style.opacity = '1';
                button.style.fontWeight = 'bold';
                button.style.transform = 'scale(1.05)';
            } else {
                // ã‚¿ã‚°å‰Šé™¤
                selectedSleepTags.splice(index, 1);
                button.style.opacity = '0.7';
                button.style.fontWeight = 'normal';
                button.style.transform = 'scale(1)';
            }
            
            // hidden fieldã«ä¿å­˜
            document.getElementById('selectedSleepTags').value = selectedSleepTags.join(',');
            
            // è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
            const displayElement = document.getElementById('selectedTagsDisplay');
            if (displayElement) {
                displayElement.textContent = selectedSleepTags.length > 0 ? selectedSleepTags.join(', ') : 'ãªã—';
            }
            
            log(`ğŸ·ï¸ ç¡çœ ã‚¿ã‚°æ›´æ–°: [${selectedSleepTags.join(', ')}]`);
        }


        // ç¡çœ ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        async function saveSleepData() {
            if (!currentUser) {
                log('âŒ ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                return;
            }

            // å…¥åŠ›å€¤å–å¾—
            const sleepDate = document.getElementById('sleepDateInput').value;
            const sleepTime = document.getElementById('sleepTimeInput').value;
            const sleepMemo = document.getElementById('sleepMemoInput').value;

            // å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
            if (!sleepDate) {
                log('âŒ è¨˜éŒ²æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!sleepTime) {
                log('âŒ è¨˜éŒ²æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
            const sleepData = {
                date: sleepDate,
                time: sleepTime,
                sleepType: selectedSleepType || null,
                quality: selectedSleepQuality || null,
                tags: selectedSleepTags.slice(), // é…åˆ—ã®ã‚³ãƒ”ãƒ¼
                memo: sleepMemo || null,
                recordType: 'simple',
                timestamp: new Date().toISOString()
            };

            try {
                // Firebaseä¿å­˜
                const sleepRef = database.ref(`users/${currentUser.uid}/sleepData/${sleepDate}_${Date.now()}`);
                await sleepRef.set(sleepData);
                
                log(`ğŸ’¾ ç¡çœ è¨˜éŒ²ä¿å­˜å®Œäº†: ${sleepDate} ${sleepTime}`);
                
                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('sleepMemoInput').value = '';
                selectedSleepType = '';
                selectedSleepQuality = '';
                selectedSleepTags = [];
                document.getElementById('selectedSleepType').value = '';
                document.getElementById('selectedQuality').value = '';
                document.getElementById('selectedSleepTags').value = '';
                
                // ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ãƒªã‚»ãƒƒãƒˆ
                document.querySelectorAll('.sleep-type-btn, .quality-btn, .sleep-tag-btn').forEach(btn => {
                    btn.style.opacity = '0.7';
                    btn.style.fontWeight = 'normal';
                    btn.style.transform = 'scale(1)';
                });
                
                // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
                await loadSleepData();
                
            } catch (error) {
                log(`âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ç¡çœ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadSleepData() {
            if (!currentUser) return;

            try {
                const sleepRef = database.ref(`users/${currentUser.uid}/sleepData`);
                const snapshot = await sleepRef.once('value');
                
                allSleepData = [];
                if (snapshot.val()) {
                    Object.entries(snapshot.val()).forEach(([key, data]) => {
                        allSleepData.push({id: key, ...data});
                    });
                }
                
                // æ—¥ä»˜é †ã§ã‚½ãƒ¼ãƒˆ
                allSleepData.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                updateSleepHistory();
                updateSleepStats();
                
            } catch (error) {
                log(`âŒ ç¡çœ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ç¡çœ å±¥æ­´è¡¨ç¤ºæ›´æ–°
        function updateSleepHistory() {
            const historyArea = document.getElementById('sleepHistoryArea');
            
            if (allSleepData.length === 0) {
                historyArea.innerHTML = 'ã¾ã ç¡çœ è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“';
                return;
            }

            // ç›´è¿‘7ä»¶è¡¨ç¤º
            const recentData = allSleepData.slice(0, 7);
            
            historyArea.innerHTML = recentData.map(data => {
                let content = `<strong>${data.date}</strong> `;
                
                // è¨˜éŒ²è¡¨ç¤º
                content += `<span style="color: #666;">${data.sleepType || 'è¨˜éŒ²'}</span><br>`;
                content += `â° ${data.time || data.bedTime || data.wakeTime || '--'}`;
                if (data.quality) content += `<br>â­ ${data.quality}/5ç‚¹`;
                
                if (data.tags && data.tags.length > 0) {
                    content += `<br>ğŸ·ï¸ ${data.tags.join(', ')}`;
                }
                if (data.memo) {
                    content += `<br>ğŸ“ ${data.memo}`;
                }
                
                return `<div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0;">
                    <div>${content}</div>
                    <button onclick="deleteSleepEntry('${data.id}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; flex-shrink: 0;">ğŸ—‘ï¸</button>
                </div>`;
            }).join('');
        }

        // ç¡çœ çµ±è¨ˆæ›´æ–°
        function updateSleepStats() {
            if (allSleepData.length === 0) {
                document.getElementById('sleepStatsArea').innerHTML = `
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 24px; font-weight: bold; color: #007bff;">--</div>
                        <div style="font-size: 12px; color: #6c757d;">å¹³å‡ç¡çœ æ™‚é–“</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;">--</div>
                        <div style="font-size: 12px; color: #6c757d;">å¹³å‡ç¡çœ ã®è³ª</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 24px; font-weight: bold; color: #ffc107;">--</div>
                        <div style="font-size: 12px; color: #6c757d;">ä»Šé€±ã®è¨˜éŒ²æ•°</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">--</div>
                        <div style="font-size: 12px; color: #6c757d;">ä»Šæœˆã®è¨˜éŒ²æ•°</div>
                    </div>
                `;
                return;
            }

            // çµ±è¨ˆè¨ˆç®—
            const avgDuration = allSleepData.reduce((sum, data) => sum + data.duration, 0) / allSleepData.length;
            const avgQuality = allSleepData.reduce((sum, data) => sum + parseInt(data.quality), 0) / allSleepData.length;
            
            // ä»Šé€±ãƒ»ä»Šæœˆã®è¨˜éŒ²æ•°
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const weekCount = allSleepData.filter(data => new Date(data.date) >= weekAgo).length;
            const monthCount = allSleepData.filter(data => new Date(data.date) >= monthAgo).length;

            document.getElementById('sleepStatsArea').innerHTML = `
                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #007bff;">${avgDuration.toFixed(1)}h</div>
                    <div style="font-size: 12px; color: #6c757d;">å¹³å‡ç¡çœ æ™‚é–“</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;">${avgQuality.toFixed(1)}</div>
                    <div style="font-size: 12px; color: #6c757d;">å¹³å‡ç¡çœ ã®è³ª</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${weekCount}</div>
                    <div style="font-size: 12px; color: #6c757d;">ä»Šé€±ã®è¨˜éŒ²æ•°</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">${monthCount}</div>
                    <div style="font-size: 12px; color: #6c757d;">ä»Šæœˆã®è¨˜éŒ²æ•°</div>
                </div>
            `;
        }

        // ç¡çœ å±¥æ­´ã‚³ãƒ”ãƒ¼
        function copySleepHistory() {
            if (allSleepData.length === 0) {
                log('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã™ã‚‹ç¡çœ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const copyText = allSleepData.slice(0, 7).map(data => 
                `${data.date} ${data.sleepType} ${data.bedTime}-${data.wakeTime} (${data.duration.toFixed(1)}h) â­${data.quality}/5${data.memo ? ` ${data.memo}` : ''}`
            ).join('\n');

            navigator.clipboard.writeText(copyText).then(() => {
                log('ğŸ“‹ ç¡çœ å±¥æ­´ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(() => {
                log('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }

        // ç¡çœ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        window.deleteSleepEntry = async (entryId) => {
            if (!currentUser) {
                log('âŒ ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                return;
            }
            
            if (!confirm('ã“ã®ç¡çœ è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                const entryRef = database.ref(`users/${currentUser.uid}/sleepData/${entryId}`);
                await entryRef.remove();
                
                log('ğŸ—‘ï¸ ç¡çœ è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                await loadSleepData(); // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
                
            } catch (error) {
                log(`âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };

        // ========== éƒ¨å±‹ç‰‡ä»˜ã‘æ©Ÿèƒ½ ==========
        
        // éƒ¨å±‹ç‰‡ä»˜ã‘ç”¨å¤‰æ•° (åˆ†é›¢æ¸ˆã¿ - room-cleaning.jsã«ç§»å‹•)
        // let allRoomData = [];
        // let selectedRoomValue = '';
        // let selectedRoomAchievement = null;
        // let roomStartTime = null;
        // let roomEndTime = null;
        // let currentRoomMode = 'normal';
        
        // éƒ¨å±‹ç‰‡ä»˜ã‘ç®¡ç†åˆæœŸåŒ–
        function initRoomManagement() {
            // ç¾åœ¨ã®æ—¥ä»˜ãƒ»æ™‚åˆ»ã‚’è¨­å®š
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentTime = now.toTimeString().slice(0, 5);
            
            document.getElementById('roomDateInput').value = today;
            document.getElementById('roomTimeInput').value = currentTime;
            
            // ã‚«ã‚¹ã‚¿ãƒ å ´æ‰€ã‚’å¾©å…ƒ
            loadCustomRooms();
            
            log('ğŸ§¹ éƒ¨å±‹ç‰‡ä»˜ã‘ç®¡ç†åˆæœŸåŒ–å®Œäº†');
        }
        
        // å ´æ‰€ç®¡ç†ãƒ¢ãƒ¼ãƒ‰è¨­å®š
        window.setRoomMode = (mode) => {
            currentRoomMode = mode;
            
            // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’æ›´æ–°
            document.getElementById('roomNormalModeBtn').style.background = mode === 'normal' ? '#007bff' : '#6c757d';
            document.getElementById('roomAddModeBtn').style.background = mode === 'add' ? '#007bff' : '#6c757d';
            document.getElementById('roomDeleteModeBtn').style.background = mode === 'delete' ? '#007bff' : '#6c757d';
            
            // è¿½åŠ å…¥åŠ›ã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            const addInput = document.getElementById('roomUnifiedAddInput');
            if (mode === 'add') {
                addInput.style.display = 'block';
            } else {
                addInput.style.display = 'none';
            }
            
            log(`ğŸ”§ å ´æ‰€ç®¡ç†ãƒ¢ãƒ¼ãƒ‰: ${mode}`);
        };
        
        // ç‰‡ä»˜ã‘å ´æ‰€é¸æŠ
        window.selectRoom = (room) => {
            if (currentRoomMode === 'delete') {
                // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰: ã‚«ã‚¹ã‚¿ãƒ å ´æ‰€ã®ã¿å‰Šé™¤å¯èƒ½
                const isCustomRoom = !['ãƒªãƒ“ãƒ³ã‚°', 'ã‚­ãƒƒãƒãƒ³', 'å¯å®¤', 'ãŠé¢¨å‘‚', 'ãƒˆã‚¤ãƒ¬', 'ç„é–¢', 'ãã®ä»–'].includes(room);
                if (isCustomRoom) {
                    if (confirm(`ã€Œ${room}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        removeCustomRoom(room);
                    }
                } else {
                    log('âŒ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå ´æ‰€ã¯å‰Šé™¤ã§ãã¾ã›ã‚“');
                }
                return;
            }
            
            // é€šå¸¸é¸æŠ
            selectedRoomValue = room;
            document.getElementById('selectedRoom').value = room;
            
            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            document.querySelectorAll('.room-btn').forEach(btn => {
                if (btn.getAttribute('data-room') === room) {
                    btn.style.opacity = '1';
                    btn.style.transform = 'scale(1.05)';
                } else {
                    btn.style.opacity = '0.7';
                    btn.style.transform = 'scale(1)';
                }
            });
            
            log(`ğŸ“ å ´æ‰€é¸æŠ: ${room}`);
        };
        
        // ç‰‡ä»˜ã‘é–‹å§‹
        window.startRoomCleaning = () => {
            if (!selectedRoomValue) {
                log('âŒ ç‰‡ä»˜ã‘å ´æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            roomStartTime = new Date();
            const timeString = roomStartTime.toTimeString().slice(0, 5);
            
            // ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('startRoomBtn').style.display = 'none';
            document.getElementById('endRoomBtn').style.display = 'inline-block';
            
            // æ™‚åˆ»è¡¨ç¤ºã‚’é–‹å§‹æ™‚åˆ»ã«æ›´æ–°
            document.getElementById('roomTimeInput').value = timeString;
            document.getElementById('roomDuration').value = 'è¨ˆæ¸¬ä¸­...';
            
            log(`â–¶ï¸ ç‰‡ä»˜ã‘é–‹å§‹: ${selectedRoomValue} - ${timeString}`);
        };
        
        // ç‰‡ä»˜ã‘çµ‚äº†
        window.endRoomCleaning = () => {
            if (!roomStartTime) {
                log('âŒ ç‰‡ä»˜ã‘ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            roomEndTime = new Date();
            const duration = Math.round((roomEndTime - roomStartTime) / (1000 * 60)); // åˆ†å˜ä½
            
            // ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’æˆ»ã™
            document.getElementById('startRoomBtn').style.display = 'inline-block';
            document.getElementById('endRoomBtn').style.display = 'none';
            
            // æ™‚é–“è¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('roomDuration').value = `${duration}åˆ†`;
            
            log(`â¹ï¸ ç‰‡ä»˜ã‘çµ‚äº†: ${selectedRoomValue} - ${duration}åˆ†é–“`);
        };
        
        // é”æˆåº¦é¸æŠ
        window.selectAchievement = (level) => {
            selectedRoomAchievement = level;
            document.getElementById('selectedAchievement').value = `${level}/5`;
            
            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            document.querySelectorAll('.achievement-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            const selectedBtn = document.querySelector(`[onclick="selectAchievement(${level})"]`);
            if (selectedBtn) {
                selectedBtn.style.opacity = '1';
                selectedBtn.style.transform = 'scale(1.1)';
            }
            
            log(`ğŸ“Š é”æˆåº¦é¸æŠ: ${level}/5`);
        };
        
        // ã‚«ã‚¹ã‚¿ãƒ å ´æ‰€è¿½åŠ 
        window.executeRoomAdd = () => {
            const roomName = document.getElementById('roomUnifiedAddText').value.trim();
            if (!roomName) {
                log('âŒ å ´æ‰€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            const existingBtn = document.querySelector(`[data-room="${roomName}"]`);
            if (existingBtn) {
                log(`âŒ ã€Œ${roomName}ã€ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™`);
                return;
            }
            
            // ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            addCustomRoomButton(roomName);
            
            // ã‚«ã‚¹ã‚¿ãƒ å ´æ‰€ã‚’localStorageã«ä¿å­˜
            saveCustomRooms();
            
            // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('roomUnifiedAddText').value = '';
            setRoomMode('normal');
            
            log(`âœ… æ–°ã—ã„å ´æ‰€è¿½åŠ : ${roomName}`);
        };
        
        // ã‚«ã‚¹ã‚¿ãƒ å ´æ‰€è¿½åŠ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        window.cancelRoomAdd = () => {
            document.getElementById('roomUnifiedAddText').value = '';
            setRoomMode('normal');
            log('âŒ å ´æ‰€è¿½åŠ ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
        };
        
        // ã‚«ã‚¹ã‚¿ãƒ å ´æ‰€å‰Šé™¤
        function removeCustomRoom(roomName) {
            const roomBtn = document.querySelector(`[data-room="${roomName}"]`);
            if (roomBtn) {
                roomBtn.remove();
                saveCustomRooms(); // å‰Šé™¤å¾Œã«ä¿å­˜
                log(`ğŸ—‘ï¸ å ´æ‰€å‰Šé™¤: ${roomName}`);
            }
        }
        
        // ã‚«ã‚¹ã‚¿ãƒ å ´æ‰€ãƒœã‚¿ãƒ³ä½œæˆ
        function addCustomRoomButton(roomName) {
            const roomButtons = document.getElementById('roomButtons');
            const newButton = document.createElement('button');
            newButton.type = 'button';
            newButton.className = 'room-btn';
            newButton.onclick = () => selectRoom(roomName);
            newButton.setAttribute('data-room', roomName);
            newButton.style.cssText = 'background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7;';
            newButton.textContent = `ğŸ  ${roomName}`;
            
            roomButtons.appendChild(newButton);
        }
        
        // ã‚«ã‚¹ã‚¿ãƒ å ´æ‰€ã‚’localStorageã«ä¿å­˜
        function saveCustomRooms() {
            const defaultRooms = ['ãƒªãƒ“ãƒ³ã‚°', 'ã‚­ãƒƒãƒãƒ³', 'å¯å®¤', 'ãŠé¢¨å‘‚', 'ãƒˆã‚¤ãƒ¬', 'ç„é–¢', 'ãã®ä»–'];
            const customRooms = Array.from(document.querySelectorAll('.room-btn'))
                .map(btn => btn.getAttribute('data-room'))
                .filter(room => !defaultRooms.includes(room));
            
            localStorage.setItem('roomApp_customRooms', JSON.stringify(customRooms));
            log(`ğŸ’¾ ã‚«ã‚¹ã‚¿ãƒ å ´æ‰€ä¿å­˜: ${customRooms.length}ä»¶`);
        }
        
        // ã‚«ã‚¹ã‚¿ãƒ å ´æ‰€ã‚’localStorageã‹ã‚‰å¾©å…ƒ
        function loadCustomRooms() {
            try {
                const saved = localStorage.getItem('roomApp_customRooms');
                if (saved) {
                    const customRooms = JSON.parse(saved);
                    customRooms.forEach(roomName => {
                        addCustomRoomButton(roomName);
                    });
                    log(`ğŸ“‚ ã‚«ã‚¹ã‚¿ãƒ å ´æ‰€å¾©å…ƒ: ${customRooms.length}ä»¶`);
                }
            } catch (error) {
                log(`âŒ ã‚«ã‚¹ã‚¿ãƒ å ´æ‰€å¾©å…ƒã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // éƒ¨å±‹ç‰‡ä»˜ã‘ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        window.saveRoomData = async () => {
            if (!currentUser) {
                log('âŒ ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                return;
            }
            
            if (!selectedRoomValue) {
                log('âŒ ç‰‡ä»˜ã‘å ´æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!selectedRoomAchievement) {
                log('âŒ é”æˆåº¦ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const duration = document.getElementById('roomDuration').value;
            if (duration === 'é–‹å§‹ãƒœã‚¿ãƒ³ã§è¨ˆæ¸¬é–‹å§‹' || duration === 'è¨ˆæ¸¬ä¸­...') {
                log('âŒ ç‰‡ä»˜ã‘æ™‚é–“ã‚’è¨ˆæ¸¬ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                log('ğŸ’¾ éƒ¨å±‹ç‰‡ä»˜ã‘ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ä¸­...');
                
                const roomData = {
                    date: document.getElementById('roomDateInput').value,
                    time: document.getElementById('roomTimeInput').value,
                    room: selectedRoomValue,
                    duration: duration,
                    achievement: selectedRoomAchievement,
                    memo: document.getElementById('roomMemoInput').value || '',
                    userEmail: currentUser.email,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    createdAt: new Date().toISOString()
                };
                
                const userRef = database.ref(`users/${currentUser.uid}/roomData`);
                await userRef.push(roomData);
                
                log(`âœ… ç‰‡ä»˜ã‘è¨˜éŒ²ä¿å­˜å®Œäº†: ${selectedRoomValue} - ${duration} (é”æˆåº¦${selectedRoomAchievement}/5)`);
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                resetRoomForm();
                
                // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
                await loadRoomData();
                
            } catch (error) {
                log(`âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        // éƒ¨å±‹ç‰‡ä»˜ã‘ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        window.loadRoomData = async () => {
            if (!currentUser) return;
            
            try {
                const roomRef = database.ref(`users/${currentUser.uid}/roomData`);
                const snapshot = await roomRef.once('value');
                
                allRoomData = [];
                if (snapshot.val()) {
                    Object.entries(snapshot.val()).forEach(([key, data]) => {
                        allRoomData.push({ id: key, ...data });
                    });
                    
                    // æ—¥ä»˜é †ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
                    allRoomData.sort((a, b) => {
                        const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
                        const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
                        return dateB - dateA;
                    });
                }
                
                updateRoomHistory();
                updateRoomStats();
                
            } catch (error) {
                log(`âŒ éƒ¨å±‹ç‰‡ä»˜ã‘ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };
        
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetRoomForm() {
            selectedRoomValue = '';
            selectedRoomAchievement = null;
            roomStartTime = null;
            roomEndTime = null;
            
            document.getElementById('selectedRoom').value = '';
            document.getElementById('selectedAchievement').value = '';
            document.getElementById('roomDuration').value = 'é–‹å§‹ãƒœã‚¿ãƒ³ã§è¨ˆæ¸¬é–‹å§‹';
            document.getElementById('roomMemoInput').value = '';
            
            // ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.room-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            document.querySelectorAll('.achievement-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            // é–‹å§‹ãƒ»çµ‚äº†ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('startRoomBtn').style.display = 'inline-block';
            document.getElementById('endRoomBtn').style.display = 'none';
            
            // æ—¥æ™‚ã‚’ç¾åœ¨æ™‚åˆ»ã«æ›´æ–°
            const now = new Date();
            document.getElementById('roomDateInput').value = now.toISOString().split('T')[0];
            document.getElementById('roomTimeInput').value = now.toTimeString().slice(0, 5);
        }
        
        // éƒ¨å±‹ç‰‡ä»˜ã‘å±¥æ­´è¡¨ç¤ºæ›´æ–°
        function updateRoomHistory() {
            const historyArea = document.getElementById('roomHistoryArea');
            
            if (allRoomData.length === 0) {
                historyArea.innerHTML = 'ã¾ã ç‰‡ä»˜ã‘è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“';
                return;
            }
            
            // ç›´è¿‘7ä»¶è¡¨ç¤º
            const recentData = allRoomData.slice(0, 7);
            
            historyArea.innerHTML = recentData.map(data => {
                let content = `<strong>${data.date}</strong> ${data.time} `;
                content += `ğŸ“ ${data.room} `;
                content += `â±ï¸ ${data.duration} `;
                content += `ğŸ“Š ${data.achievement}/5`;
                if (data.memo) {
                    content += `<br>ğŸ“ ${data.memo}`;
                }
                
                return `<div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0;">
                    <div>${content}</div>
                    <button onclick="deleteRoomEntry('${data.id}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; flex-shrink: 0;">ğŸ—‘ï¸</button>
                </div>`;
            }).join('');
        }
        
        // éƒ¨å±‹ç‰‡ä»˜ã‘çµ±è¨ˆæ›´æ–°
        function updateRoomStats() {
            const totalSessions = allRoomData.length;
            const totalMinutes = allRoomData.reduce((sum, data) => {
                const minutes = parseInt(data.duration) || 0;
                return sum + minutes;
            }, 0);
            const avgAchievement = totalSessions > 0 ? 
                (allRoomData.reduce((sum, data) => sum + (data.achievement || 0), 0) / totalSessions).toFixed(1) : 0;
            
            // ä»Šæœˆã®è¨˜éŒ²æ•°
            const thisMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            const thisMonthCount = allRoomData.filter(data => data.date.startsWith(thisMonth)).length;
            
            document.getElementById('totalRoomSessions').textContent = totalSessions;
            document.getElementById('totalRoomTime').textContent = `${totalMinutes}åˆ†`;
            document.getElementById('avgRoomAchievement').textContent = avgAchievement;
            document.getElementById('thisMonthRoomCount').textContent = thisMonthCount;
        }
        
        // éƒ¨å±‹ç‰‡ä»˜ã‘å±¥æ­´ã‚³ãƒ”ãƒ¼
        window.copyRoomHistory = () => {
            if (allRoomData.length === 0) {
                log('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã™ã‚‹ç‰‡ä»˜ã‘ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const copyText = allRoomData.slice(0, 7).map(data => 
                `${data.date} ${data.time} ${data.room} ${data.duration} é”æˆåº¦${data.achievement}/5${data.memo ? ` ${data.memo}` : ''}`
            ).join('\n');
            
            navigator.clipboard.writeText(copyText).then(() => {
                log('ğŸ“‹ ç‰‡ä»˜ã‘å±¥æ­´ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(() => {
                log('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        };
        
        // éƒ¨å±‹ç‰‡ä»˜ã‘ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        window.deleteRoomEntry = async (entryId) => {
            if (!currentUser) {
                log('âŒ ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                return;
            }
            
            if (!confirm('ã“ã®ç‰‡ä»˜ã‘è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                const entryRef = database.ref(`users/${currentUser.uid}/roomData/${entryId}`);
                await entryRef.remove();
                
                log('ğŸ—‘ï¸ ç‰‡ä»˜ã‘è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                await loadRoomData();
                
            } catch (error) {
                log(`âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };

        // =====================
        // ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆæ©Ÿèƒ½
        // =====================
        let memoData = [];

        // é‡è¦åº¦ã®è‰²ã‚’å–å¾—
        function getPriorityColor(priority) {
            switch(priority) {
                case 'S': return '#dc3545'; // èµ¤
                case 'A': return '#fd7e14'; // ã‚ªãƒ¬ãƒ³ã‚¸
                case 'B': return '#ffc107'; // é»„è‰²
                case 'C': return '#6c757d'; // ã‚°ãƒ¬ãƒ¼
                default: return '#6c757d';
            }
        }

        // é‡è¦åº¦ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
        function getPriorityIcon(priority) {
            switch(priority) {
                case 'S': return 'ğŸ”¥';
                case 'A': return 'âš¡';
                case 'B': return 'ğŸ“‹';
                case 'C': return 'ğŸ“';
                default: return '';
            }
        }

        // å¯¾å¿œæ™‚é–“ã®è‰²ã‚’å–å¾—
        function getTimeframeColor(timeframe) {
            switch(timeframe) {
                case 'çŸ­æœŸ': return '#28a745'; // ç·‘
                case 'ä¸­é•·æœŸ': return '#17a2b8'; // é’
                default: return '#6c757d';
            }
        }

        // å¯¾å¿œæ™‚é–“ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
        function getTimeframeIcon(timeframe) {
            switch(timeframe) {
                case 'çŸ­æœŸ': return 'âš¡';
                case 'ä¸­é•·æœŸ': return 'ğŸ“…';
                default: return '';
            }
        }

        // ãƒ¡ãƒ¢ã‚’è¿½åŠ 
        window.addMemo = () => {
            const memoText = document.getElementById('newMemoText').value.trim();
            const category = document.getElementById('memoCategory').value;
            const priority = document.getElementById('memoPriority').value;
            const timeframe = document.getElementById('memoTimeframe').value;
            
            if (!memoText) {
                alert('ãƒ¡ãƒ¢å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const now = new Date();
            const memo = {
                id: Date.now(),
                text: memoText,
                category: category,
                priority: priority,
                timeframe: timeframe,
                timestamp: now.toISOString(),
                date: now.toLocaleDateString('ja-JP'),
                time: now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })
            };
            
            memoData.unshift(memo); // æ–°ã—ã„ãƒ¡ãƒ¢ã‚’å…ˆé ­ã«è¿½åŠ 
            
            // Firebaseã«ä¿å­˜
            if (currentUser) {
                saveMemoToFirebase(memo);
            } else {
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                localStorage.setItem('memos', JSON.stringify(memoData));
            }
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            updateMemoDisplay();
            updateMemoStats();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('newMemoText').value = '';
            document.getElementById('memoCategory').value = '';
            document.getElementById('memoPriority').value = '';
            document.getElementById('memoTimeframe').value = '';
            
            log(`ğŸ“ ãƒ¡ãƒ¢ã‚’è¿½åŠ ã—ã¾ã—ãŸ${category ? ` [${category}]` : ''}: ${memoText.substring(0, 30)}${memoText.length > 30 ? '...' : ''}`);
        };

        // Firebaseã«ãƒ¡ãƒ¢ã‚’ä¿å­˜
        function saveMemoToFirebase(memo) {
            if (!currentUser || !firebase.database) return;
            
            firebase.database().ref(`users/${currentUser.uid}/memos/${memo.id}`).set(memo)
            .then(() => {
                console.log('ãƒ¡ãƒ¢ã‚’Firebaseã«ä¿å­˜ã—ã¾ã—ãŸ');
            })
            .catch((error) => {
                console.error('Firebaseã¸ã®ä¿å­˜ã«å¤±æ•—:', error);
                log('âŒ ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }

        // ãƒ¡ãƒ¢è¡¨ç¤ºã‚’æ›´æ–°
        function updateMemoDisplay() {
            const container = document.getElementById('memoListArea');
            
            if (memoData.length === 0) {
                container.innerHTML = 'ã¾ã ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“';
                return;
            }
            
            const html = memoData.map(memo => {
                const categoryBadge = memo.category ? 
                    `<span style="background: #6c757d; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-right: 5px;">${memo.category}</span>` : '';
                
                // é‡è¦åº¦ã®ãƒãƒƒã‚¸
                const priorityBadge = memo.priority ? 
                    `<span style="background: ${getPriorityColor(memo.priority)}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-right: 5px; font-weight: bold;">${getPriorityIcon(memo.priority)} ${memo.priority}</span>` : '';
                
                // å¯¾å¿œæ™‚é–“ã®ãƒãƒƒã‚¸
                const timeframeBadge = memo.timeframe ? 
                    `<span style="background: ${getTimeframeColor(memo.timeframe)}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-right: 5px;">${getTimeframeIcon(memo.timeframe)} ${memo.timeframe}</span>` : '';
                
                return `
                    <div class="memo-item">
                        <div class="memo-header">
                            <div style="flex: 1;">
                                ${priorityBadge}${timeframeBadge}${categoryBadge}
                                <small class="memo-date">${memo.date} ${memo.time}</small>
                            </div>
                            <button onclick="deleteMemo(${memo.id})" class="memo-delete-btn">ğŸ—‘ï¸</button>
                        </div>
                        <div class="memo-text">
                            ${memo.text}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // ãƒ¡ãƒ¢ã‚’å‰Šé™¤
        window.deleteMemo = (memoId) => {
            if (!confirm('ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            memoData = memoData.filter(memo => memo.id !== memoId);
            
            // Firebaseã‹ã‚‰å‰Šé™¤
            if (currentUser) {
                firebase.database().ref(`users/${currentUser.uid}/memos/${memoId}`).remove();
            } else {
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ›´æ–°
                localStorage.setItem('memos', JSON.stringify(memoData));
            }
            
            updateMemoDisplay();
            updateMemoStats();
            log('ğŸ—‘ï¸ ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        };

        // å…¨ãƒ¡ãƒ¢ã‚’å‰Šé™¤
        window.clearAllMemos = () => {
            if (!confirm('ã™ã¹ã¦ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            memoData = [];
            
            // Firebaseã‹ã‚‰å‰Šé™¤
            if (currentUser) {
                firebase.database().ref(`users/${currentUser.uid}/memos`).remove();
            } else {
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ›´æ–°
                localStorage.setItem('memos', JSON.stringify(memoData));
            }
            
            updateMemoDisplay();
            updateMemoStats();
            log('ğŸ—‘ï¸ ã™ã¹ã¦ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        };

        // ãƒ¡ãƒ¢çµ±è¨ˆã‚’æ›´æ–°
        function updateMemoStats() {
            const now = new Date();
            const today = now.toLocaleDateString('ja-JP');
            
            // ä»Šé€±ã®é–‹å§‹æ—¥ï¼ˆæœˆæ›œæ—¥ï¼‰ã‚’è¨ˆç®—
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - ((now.getDay() + 6) % 7));
            weekStart.setHours(0, 0, 0, 0);
            
            // ä»Šæœˆã®é–‹å§‹æ—¥ã‚’è¨ˆç®—
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const todayCount = memoData.filter(memo => memo.date === today).length;
            const weekCount = memoData.filter(memo => new Date(memo.timestamp) >= weekStart).length;
            const monthCount = memoData.filter(memo => new Date(memo.timestamp) >= monthStart).length;
            
            document.getElementById('totalMemoCount').textContent = memoData.length;
            document.getElementById('todayMemoCount').textContent = todayCount;
            document.getElementById('weekMemoCount').textContent = weekCount;
            document.getElementById('monthMemoCount').textContent = monthCount;
        }

        // å…¨ãƒ¡ãƒ¢ã‚’ã‚³ãƒ”ãƒ¼
        window.copyAllMemos = () => {
            if (memoData.length === 0) {
                alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const copyText = memoData.map(memo => {
                const categoryText = memo.category ? `[${memo.category}] ` : '';
                return `${memo.date} ${memo.time} ${categoryText}${memo.text}`;
            }).join('\n\n');
            
            navigator.clipboard.writeText(copyText).then(() => {
                log('ğŸ“‹ å…¨ãƒ¡ãƒ¢ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(() => {
                log('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        };

        // ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        function loadMemoData() {
            if (currentUser) {
                // Firebaseã‹ã‚‰èª­ã¿è¾¼ã¿
                firebase.database().ref(`users/${currentUser.uid}/memos`).on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        memoData = Object.values(data).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    } else {
                        memoData = [];
                    }
                    updateMemoDisplay();
                    updateMemoStats();
                });
            } else {
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
                const stored = localStorage.getItem('memos');
                if (stored) {
                    memoData = JSON.parse(stored);
                }
                updateMemoDisplay();
                updateMemoStats();
            }
        }

        // Enterã‚­ãƒ¼ã§ãƒ¡ãƒ¢è¿½åŠ ï¼ˆCtrl+Enterã®å ´åˆï¼‰
        document.addEventListener('DOMContentLoaded', () => {
            const memoTextArea = document.getElementById('newMemoText');
            if (memoTextArea) {
                memoTextArea.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        addMemo();
                    }
                });
            }
            
            // æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
            if (!currentUser) {
                loadMemoData();
            }
        });

    </script>
</body>
</html>
