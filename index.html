
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>体重管理アプリ</title>
    
    <!-- カスタムスタイル -->
    <link rel="stylesheet" href="custom/styles.css">
    
    <!-- タブ固有スタイル -->
    <link rel="stylesheet" href="tabs/tab3-room-cleaning/room-cleaning.css">
    <link rel="stylesheet" href="tabs/tab8-memo-list/memo-list.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Chart.js with date adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <!-- カスタム設定 -->
    <script type="module" src="custom/app-config.js"></script>
    
    <!-- 共通JavaScript関数 -->
    <script src="shared/common-functions.js"></script>
    
    <!-- タブ固有JavaScript -->
    <!-- タブ用JSは動的読み込みのためstatic読み込み削除 -->
    <style>
        body { font-family: Arial, sans-serif; padding: 2px; background: #f5f5f5; line-height: 1.2; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 6px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* 文字数別ボタン幅調整 */
        .timing-btn[data-timing*="帰宅:食事有+半日(7時間以上)"],
        .timing-btn[data-timing*="ある程度飲んだ後"] {
            width: 200px !important; /* 3ボタン分 */
            flex-shrink: 0;
        }
        .timing-btn[data-timing*="帰宅:食事無し"],
        .timing-btn[data-timing*="帰宅後"] {
            width: 140px !important; /* 2ボタン分 */
            flex-shrink: 0;
        }
        
        /* スマホ対応 */
        @media (max-width: 768px) {
            body { padding: 3px; }
            .container { padding: 8px; margin: 0; border-radius: 0; }
            .weight-input { grid-template-columns: 1fr; gap: 8px; }
            .input-card { padding: 8px; }
        }
        .auth-section { background: #e7f3ff; color: #0c5460; padding: 6px; border-radius: 5px; margin-bottom: 6px; text-align: center; }
        .weight-input { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin: 8px 0; }
        .input-card { border: 1px solid #ddd; padding: 8px; border-radius: 8px; }
        
        /* メモリスト用スタイル */
        .memo-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            background: #fefefe;
        }
        .memo-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }
        .memo-category {
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-right: 5px;
        }
        .memo-date {
            color: #666;
            font-size: 11px;
        }
        .memo-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
            color: #333;  /* 文字を濃くして読みやすく */
            font-weight: 500;  /* やや太めにして視認性向上 */
        }
        .memo-delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            margin-left: 10px;
        }
        .memo-delete-btn:hover {
            background: #c82333;
        }
        
        /* タイミングパネルのスタイル */
        .timing-panel { 
            background: #f8f9fa; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            padding: 8px; 
            margin: 5px 0; 
        }
        .timing-buttons { 
            display: flex; 
            gap: 4px; 
            flex-wrap: wrap; 
            justify-content: center;
        }
        .timing-btn { 
            background: #6c757d; 
            color: white; 
            border: none; 
            padding: 6px 8px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 11px;
            transition: all 0.2s;
            min-width: 85px;
            text-align: center;
            flex: 1;
            max-width: 120px;
        }
        .timing-btn:hover {
            transform: scale(1.05);
        }
        .timing-btn.selected {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .timing-buttons { gap: 3px; }
            .timing-btn { 
                padding: 4px 6px; 
                font-size: 10px;
                min-width: 75px;
            }
        }

        /* 服装ボタンのスタイル統一 */
        .clothing-btn {
            border: none;
            padding: 6px 8px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 10px;
            min-width: 85px;
            text-align: center;
            transition: all 0.2s;
            flex: 1;
            max-width: 120px;
        }
        .clothing-btn:hover {
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .clothing-btn {
                padding: 4px 6px;
                min-width: 75px;
                font-size: 9px;
            }
        }
        .input-field { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 5px 0; font-size: 16px; }
        .save-button { background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin: 5px; font-size: 16px; }
        .save-button:hover { background: #218838; }
        .auth-button { background: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .auth-button:hover { background: #357ae8; }
        .logout-button { background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .data-area { background: #f8f9fa; border: 1px solid #dee2e6; padding: 8px; border-radius: 5px; font-family: monospace; min-height: 120px; }
        .hidden { display: none; }
        .user-info { background: #d4edda; color: #155724; padding: 4px 6px; border-radius: 5px; margin-bottom: 6px; font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ユーザー情報表示（一番上） -->
        <div class="user-info hidden" id="userInfo" style="margin-bottom: 10px;">
            <span>👤 ログイン中: <span id="userName"></span></span>
            <button class="logout-button" onclick="handleLogout()">ログアウト</button>
        </div>

        <!-- タブナビゲーション -->
        <div id="tabNavigation" class="hidden" style="margin-bottom: 15px;">
            <div style="display: flex; border-bottom: 2px solid #ddd; flex-wrap: wrap;">
                <button id="tab1" class="tab-btn active" onclick="switchTab(1)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #007bff; color: white; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">体重</button>
                <button id="tab2" class="tab-btn" onclick="switchTab(2)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">睡眠</button>
                <button id="tab3" class="tab-btn" onclick="switchTab(3)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">部屋片づけ</button>
                <button id="tab4" class="tab-btn" onclick="switchTab(4)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">ストレッチ</button>
                <button id="tab5" class="tab-btn" onclick="switchTab(5)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx5</button>
                <button id="tab6" class="tab-btn" onclick="switchTab(6)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx6</button>
                <button id="tab7" class="tab-btn" onclick="switchTab(7)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx7</button>
                <button id="tab8" class="tab-btn" onclick="switchTab(8)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">メモリスト</button>
            </div>
            <!-- 2行目のタブ（9-16） -->
            <div style="display: flex; border-bottom: 2px solid #ddd; flex-wrap: wrap;">
                <button id="tab9" class="tab-btn" onclick="switchTab(9)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx9</button>
                <button id="tab10" class="tab-btn" onclick="switchTab(10)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx10</button>
                <button id="tab11" class="tab-btn" onclick="switchTab(11)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx11</button>
                <button id="tab12" class="tab-btn" onclick="switchTab(12)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx12</button>
                <button id="tab13" class="tab-btn" onclick="switchTab(13)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx13</button>
                <button id="tab14" class="tab-btn" onclick="switchTab(14)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx14</button>
                <button id="tab15" class="tab-btn" onclick="switchTab(15)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx15</button>
                <button id="tab16" class="tab-btn" onclick="switchTab(16)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-bottom: 1px; font-size: 12px;">xx16</button>
            </div>
        </div>

        <!-- アプリタイトル -->
        <div class="app-header hidden" id="appHeader">
            <h1 class="app-title" id="appTitle">📊 体重管理アプリ</h1>
            <p class="app-subtitle">Core/Customフォルダ分離版 - Firebase + Google認証</p>
        </div>

        <!-- 認証セクション -->
        <div class="auth-section" id="authSection">
            <h1 class="app-title">📊 体重管理アプリ</h1>
            <p class="app-subtitle">Core/Customフォルダ分離版 - Firebase + Google認証</p>
            <h3>🔐 ログイン</h3>
            <p>Googleアカウントでログインしてデータを保存・同期できます</p>
            <button class="auth-button" onclick="handleGoogleLogin()">Googleでログイン</button>
        </div>

        <!-- タブコンテンツ -->
        <div id="tabContent1" class="tab-content">
            <!-- 体重管理コンテンツは動的読み込み -->
        </div>

        <!-- 共通ログエリア（全タブ用） -->
        <div class="hidden" id="globalLogArea">
            <h3>📋 アプリログ <button class="universal-copy-btn" onclick="copyLogs()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">📋 ログをコピー</button></h3>
            <div class="data-area" id="logArea">
                アプリテンプレート起動完了...<br>
                🔥 Firebase設定完了<br>
                🔐 Google認証準備完了<br>
            </div>
            
            <!-- デバッグボタンエリア -->
            <div style="margin-top: 8px; text-align: center;">
                <button class="universal-copy-btn" onclick="debugFirebaseConnection()" style="background: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">🔍 Firebase Debug</button>
                <button class="universal-copy-btn" onclick="checkLoginIssues()" style="background: #ffc107; color: #212529; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">⚠️ ログイン問題診断</button>
                <button class="universal-copy-btn" onclick="copyDebugInfo()" style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">📋 デバッグ情報をコピー</button>
                <button class="universal-copy-btn" onclick="checkDatabaseStructure()" style="background: #6f42c1; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">🏗️ DB構造確認</button>
                <button class="universal-copy-btn" onclick="checkMobileSupport()" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">📱 モバイル診断</button>
                <button class="universal-copy-btn" onclick="forceAuthCheck()" style="background: #fd7e14; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">🔄 認証状態確認</button>
                <button class="universal-copy-btn" onclick="checkFirebaseConfig()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">🔧 Firebase設定</button>
                <button class="universal-copy-btn" onclick="testPopup()" style="background: #20c997; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">🧪 ポップアップテスト</button>
            </div>
        </div>


        <!-- タブコンテンツ2 -->
        <div id="tabContent2" class="tab-content hidden">
            <!-- コンテンツは動的読み込み -->
        </div>

        <!-- タブコンテンツ3 -->
        <div id="tabContent3" class="tab-content hidden">
            <!-- コンテンツは動的読み込み -->
        </div>

        <!-- タブコンテンツ4 -->
        <div id="tabContent4" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>🔧 xx4</h3>
                <p>こちらのコンテンツは後で実装予定です</p>
            </div>
        </div>

        <!-- タブコンテンツ5 -->
        <div id="tabContent5" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>🔧 xx5</h3>
                <p>こちらのコンテンツは後で実装予定です</p>
            </div>
        </div>

        <!-- タブコンテンツ6 -->
        <div id="tabContent6" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>🔧 xx6</h3>
                <p>こちらのコンテンツは後で実装予定です</p>
            </div>
        </div>

        <!-- タブコンテンツ7 -->
        <div id="tabContent7" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>🔧 xx7</h3>
                <p>こちらのコンテンツは後で実装予定です</p>
            </div>
        </div>

        <!-- タブコンテンツ8: メモリスト -->
        <div id="tabContent8" class="tab-content hidden">
            <!-- コンテンツは動的読み込み -->
        </div>

        <!-- タブ9-16の空コンテンツ -->
        <div id="tabContent9" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>🔧 xx9</h3>
                <p>このタブはまだ実装されていません</p>
            </div>
        </div>

        <div id="tabContent10" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>🔧 xx10</h3>
                <p>このタブはまだ実装されていません</p>
            </div>
        </div>

        <div id="tabContent11" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>🔧 xx11</h3>
                <p>このタブはまだ実装されていません</p>
            </div>
        </div>

        <div id="tabContent12" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>🔧 xx12</h3>
                <p>このタブはまだ実装されていません</p>
            </div>
        </div>

        <div id="tabContent13" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>🔧 xx13</h3>
                <p>このタブはまだ実装されていません</p>
            </div>
        </div>

        <div id="tabContent14" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>🔧 xx14</h3>
                <p>このタブはまだ実装されていません</p>
            </div>
        </div>

        <div id="tabContent15" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>🔧 xx15</h3>
                <p>このタブはまだ実装されていません</p>
            </div>
        </div>

        <div id="tabContent16" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>🔧 xx16</h3>
                <p>このタブはまだ実装されていません</p>
            </div>
        </div>
    </div>

    <script>
        // Core Firebase設定（変更禁止 - core/src/firebase-config.js参照）
        const firebaseConfig = {
            apiKey: "AIzaSyA5PXKChizYDCXF_GJ4KL6Ylq9K5hCPXWE",
            authDomain: "shares-b1b97.firebaseapp.com",
            databaseURL: "https://shares-b1b97-default-rtdb.firebaseio.com",
            projectId: "shares-b1b97",
            storageBucket: "shares-b1b97.firebasestorage.app",
            messagingSenderId: "38311063248",
            appId: "1:38311063248:web:0d2d5726d12b305b24b8d5"
        };

        // Firebase初期化
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let selectedTimingValue = '';
        let selectedTopValue = '';
        let selectedBottomValue = '';
        let weightChart = null;
        let allWeightData = [];
        window.editingEntryId = null;

        // 統一モード状態管理
        let currentMode = 'normal'; // 'normal', 'add', 'delete'
        let selectedTarget = null; // 'timing', 'top', 'bottom' のいずれか

        // 前期間比較機能の状態管理
        let showPreviousPeriod = false; // 前期間表示のON/OFF

        // アプリバージョン（一元管理）
        const APP_VERSION = 'v1.98';
        
        // カラー配列定数化（3箇所の重複統一）
        const RANDOM_COLORS = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a55eea'];

        // カスタム項目の永続化機能（localStorage活用）
        const STORAGE_KEYS = {
            customTimings: 'weightApp_customTimings',
            customTops: 'weightApp_customTops',
            customBottoms: 'weightApp_customBottoms'
        };

        // カスタム項目関連の関数は tabs/tab1-weight/tab-weight.js に移動済み





        // 統一モードシステム完了 - 古い個別関数群は削除済み

        // キーボードでの値調整機能
        window.handleWeightKeypress = (event) => {
            const weightInput = document.getElementById('weightValue');
            const currentValue = parseFloat(weightInput.value) || 72.0;
            
            if (event.key === 'ArrowUp') {
                event.preventDefault();
                weightInput.value = (currentValue + 0.1).toFixed(1);
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                weightInput.value = Math.max(0, currentValue - 0.1).toFixed(1);
            }
        };

        // タイミング選択機能（改良版）
        window.selectTiming = (timing) => {
            selectedTimingValue = timing;
            document.getElementById('selectedTiming').value = timing;
            
            // すべてのボタンから選択状態を削除
            document.querySelectorAll('.timing-btn').forEach(btn => {
                btn.classList.remove('selected');
                btn.style.opacity = '0.7';
            });
            
            // 選択されたボタンに選択状態を追加
            const selectedBtn = document.querySelector(`[data-timing="${timing}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
                selectedBtn.style.opacity = '1';
            }
            
            log(`⏰ 測定タイミング選択: ${timing}`);
        };

        // 上半身服装選択機能
        window.selectClothingTop = (clothing) => {
            selectedTopValue = clothing;
            document.getElementById('selectedTop').value = clothing;
            
            // すべての上半身ボタンから選択状態を削除
            document.querySelectorAll('.clothing-btn[data-clothing-top]').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            // 選択されたボタンに選択状態を追加
            const selectedBtn = document.querySelector(`[data-clothing-top="${clothing}"]`);
            if (selectedBtn) {
                selectedBtn.style.opacity = '1';
                selectedBtn.style.transform = 'scale(1.05)';
            }
            
            log(`👕 上半身選択: ${clothing}`);
        };

        // 下半身服装選択機能
        window.selectClothingBottom = (clothing) => {
            selectedBottomValue = clothing;
            document.getElementById('selectedBottom').value = clothing;
            
            // すべての下半身ボタンから選択状態を削除
            document.querySelectorAll('.clothing-btn[data-clothing-bottom]').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            // 選択されたボタンに選択状態を追加
            const selectedBtn = document.querySelector(`[data-clothing-bottom="${clothing}"]`);
            if (selectedBtn) {
                selectedBtn.style.opacity = '1';
                selectedBtn.style.transform = 'scale(1.05)';
            }
            
            log(`🩲 下半身選択: ${clothing}`);
        };

        // 統一カスタム項目追加システム（addCustomClothingTop は統一モードに移行）

        window.addTopCustomItem = () => {
            const newItem = document.getElementById('topCustomText').value.trim();
            if (newItem) {
                const container = document.getElementById('topClothingButtons');
                
                // ランダムカラー生成（統一定数使用）
                // const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a55eea']; // 重複削除
                const randomColor = RANDOM_COLORS[Math.floor(Math.random() * RANDOM_COLORS.length)];
                
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'clothing-btn';
                button.setAttribute('data-clothing-top', newItem);
                button.onclick = () => selectClothingTop(newItem);
                button.style.cssText = `background: ${randomColor}; color: white; opacity: 0.7;`;
                button.setAttribute('data-original-color', randomColor);
                button.textContent = `👔 ${newItem}`;
                
                container.appendChild(button);
                log(`✅ 新しい上半身項目追加: ${newItem}`);
                
                // 追加後すぐに選択
                selectClothingTop(newItem);
                
                // カスタム項目を永続化保存
                saveCustomItems();
                
                // 入力フィールドをリセット・非表示
                document.getElementById('topCustomText').value = '';
                document.getElementById('topCustomInput').style.display = 'none';
            }
        };

        window.cancelTopCustom = () => {
            document.getElementById('topCustomText').value = '';
            document.getElementById('topCustomInput').style.display = 'none';
        };

        // カスタム下半身項目追加（改良版 - スマホ対応）
        window.addCustomClothingBottom = () => {
            document.getElementById('bottomCustomInput').style.display = 'block';
            document.getElementById('bottomCustomText').focus();
        };

        window.addBottomCustomItem = () => {
            const newItem = document.getElementById('bottomCustomText').value.trim();
            if (newItem) {
                const container = document.getElementById('bottomClothingButtons');
                
                // ランダムカラー生成（統一定数使用）
                // const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a55eea']; // 重複削除
                const randomColor = RANDOM_COLORS[Math.floor(Math.random() * RANDOM_COLORS.length)];
                
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'clothing-btn';
                button.setAttribute('data-clothing-bottom', newItem);
                button.onclick = () => selectClothingBottom(newItem);
                button.style.cssText = `background: ${randomColor}; color: white; opacity: 0.7;`;
                button.setAttribute('data-original-color', randomColor);
                button.textContent = `👖 ${newItem}`;
                
                container.appendChild(button);
                log(`✅ 新しい下半身項目追加: ${newItem}`);
                
                // 追加後すぐに選択
                selectClothingBottom(newItem);
                
                // カスタム項目を永続化保存
                saveCustomItems();
                
                // 入力フィールドをリセット・非表示
                document.getElementById('bottomCustomText').value = '';
                document.getElementById('bottomCustomInput').style.display = 'none';
            }
        };

        window.cancelBottomCustom = () => {
            document.getElementById('bottomCustomText').value = '';
            document.getElementById('bottomCustomInput').style.display = 'none';
        };

        // カスタムタイミング項目追加（改良版 - スマホ対応）
        window.addCustomTiming = () => {
            document.getElementById('timingCustomInput').style.display = 'block';
            document.getElementById('timingCustomText').focus();
        };

        window.addTimingCustomItem = () => {
            const newItem = document.getElementById('timingCustomText').value.trim();
            if (newItem) {
                const container = document.getElementById('timingButtons');
                
                // ランダムカラー生成（統一定数使用）
                // const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a55eea']; // 重複削除
                const randomColor = RANDOM_COLORS[Math.floor(Math.random() * RANDOM_COLORS.length)];
                
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'timing-btn';
                button.setAttribute('data-timing', newItem);
                button.onclick = () => selectTiming(newItem);
                button.style.cssText = `background: ${randomColor}; color: white; opacity: 0.7;`;
                button.setAttribute('data-original-color', randomColor);
                button.textContent = `⏰ ${newItem}`;
                
                container.appendChild(button);
                log(`✅ 新しいタイミング項目追加: ${newItem}`);
                
                // 追加後すぐに選択
                selectTiming(newItem);
                
                // カスタム項目を永続化保存
                saveCustomItems();
                
                // 入力フィールドをリセット・非表示
                document.getElementById('timingCustomText').value = '';
                document.getElementById('timingCustomInput').style.display = 'none';
            }
        };

        window.cancelTimingCustom = () => {
            document.getElementById('timingCustomText').value = '';
            document.getElementById('timingCustomInput').style.display = 'none';
        };


        // 認証状態の監視（改良版 + リダイレクト対応）
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            if (user) {
                log(`✅ 認証状態確認: ${user.displayName} でログイン中`);
                log(`📧 メール: ${user.email}`);
                showUserInterface(user);
                log('🔄 体重データ読み込み開始...');
                loadUserWeightData(user.uid);
            } else {
                // リダイレクト結果をチェック（iPhone対応）
                try {
                    const result = await auth.getRedirectResult();
                    if (result.user) {
                        log(`✅ リダイレクトログイン成功: ${result.user.displayName}`);
                    }
                } catch (error) {
                    // リダイレクトエラーは無視（初回アクセス時など）
                }
                log('🔒 認証状態: 未ログイン');
                showLoginInterface();
            }
        });

        // 初期化完了ログ
        log('🔄 Firebase認証システム初期化完了 - 認証状態を確認中...');

        // Googleログイン（改良版 - ポップアップブロック検知付き）
        window.handleGoogleLogin = async () => {
            try {
                log('🔐 Googleログイン開始...');
                const provider = new firebase.auth.GoogleAuthProvider();
                
                // モバイルデバイス検出（iPhone専用対応）
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const isIPhone = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                
                // iPhoneはリダイレクト方式、それ以外はポップアップ方式
                if (isIPhone) {
                    log('📱 iPhone/iPad検出 - リダイレクト方式でログイン（Safari対応）');
                    log('🔄 ページがGoogleに移動します...');
                    // リダイレクト方式（iPhone専用）
                    await auth.signInWithRedirect(provider);
                    return; // リダイレクトするのでここで終了
                } else if (isMobile) {
                    log('📱 モバイルデバイス検出 - ポップアップ方式でログイン');
                    log('💡 ポップアップが途中で止まる場合は、ブラウザ設定の確認が必要です');
                } else {
                    log('🖥️ デスクトップデバイス - ポップアップ方式でログイン');
                }
                
                // ポップアップブロック検知のためのタイムアウト設定（iPhone以外）
                log('🪟 ポップアップウィンドウでGoogleログインを開始...');
                
                const loginPromise = auth.signInWithPopup(provider);
                
                // タイムアウト検知（15秒でポップアップが開かない場合）
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => {
                        reject(new Error('ポップアップタイムアウト - ブロックされた可能性があります'));
                    }, 15000);  // 元の15秒に戻す（iPhone以外用）
                });
                
                try {
                    const result = await Promise.race([loginPromise, timeoutPromise]);
                    log(`✅ ログイン成功: ${result.user.displayName}`);
                } catch (raceError) {
                    // タイムアウトの場合の特別処理
                    if (raceError.message.includes('タイムアウト')) {
                        log('⏰ ポップアップが15秒以内に開きませんでした');
                        log('🔄 ポップアップブロック検知 - 解決方法をご案内します');
                        throw new Error('POPUP_TIMEOUT');
                    } else {
                        throw raceError;
                    }
                }
                
            } catch (error) {
                log(`❌ ログインエラー: ${error.message}`);
                
                // エラーの詳細情報をログに出力
                if (error.code) {
                    log(`- エラーコード: ${error.code}`);
                    
                    // 特定のエラーコードに対する解決策を提示
                    switch(error.code) {
                        case 'auth/unauthorized-domain':
                            log('💡 ドメイン許可設定の問題です');
                            log('💡 Firebase Consoleで認証ドメインを確認してください');
                            break;
                        case 'auth/popup-blocked':
                            log('💡 ポップアップがブロックされました');
                            showPopupGuide(isMobile);
                            break;
                        case 'auth/popup-closed-by-user':
                            log('💡 ユーザーがポップアップを閉じました');
                            log('💡 もう一度ログインボタンを押してください');
                            break;
                        case 'auth/cancelled-popup-request':
                            log('💡 前回のポップアップがキャンセルされました');
                            log('💡 しばらく待ってから再試行してください');
                            break;
                        default:
                            if (error.message === 'POPUP_TIMEOUT') {
                                log('⚠️ ポップアップが途中で止まりました');
                                showPopupGuide(isMobile);
                            } else {
                                log('💡 ブラウザを更新してもう一度お試しください');
                            }
                    }
                } else if (error.message === 'POPUP_TIMEOUT') {
                    showPopupGuide(isMobile);
                }
                
                if (error.credential) {
                    log('- 認証情報は取得済み');
                }
            }
        };

        // ポップアップ許可ガイド表示
        function showPopupGuide(isMobile) {
            log('📖 === ポップアップ許可ガイド ===');
            if (isMobile) {
                log('📱 スマートフォン向け解決手順:');
                log('1. ページ上部のアドレスバーに表示される「ポップアップがブロックされました」をタップ');
                log('2. または、ブラウザメニュー(⋮) → 設定 → サイト設定 → ポップアップとリダイレクト → 許可');
                log('3. Chrome: 右上⋮メニュー → 設定 → 詳細設定 → サイト設定 → ポップアップとリダイレクト');
                log('4. Safari: 設定アプリ → Safari → ポップアップブロック → オフ');
                log('5. 設定後、このページを更新してもう一度ログインボタンを押してください');
            } else {
                log('💻 PC向け解決手順:');
                log('1. アドレスバー右端のアイコン(🚫)をクリック → 許可');
                log('2. または、ブラウザ設定 → プライバシーとセキュリティ → ポップアップとリダイレクト → 許可');
            }
            log('💡 それでも解決しない場合: プライベートモードを終了するか、別のブラウザをお試しください');
            log('🔄 ポップアップ設定を確認したら、再度「Googleでログイン」ボタンを押してください');
            log('📖 ========================');
        }

        // ポップアップテスト機能
        window.testPopup = () => {
            log('🧪 ポップアップテスト開始...');
            
            try {
                const testWindow = window.open('', '_blank', 'width=400,height=500');
                
                if (testWindow) {
                    log('✅ ポップアップ許可済み - ログイン可能です');
                    testWindow.close();
                    log('💡 「Googleでログイン」ボタンを押してください');
                } else {
                    log('❌ ポップアップがブロックされています');
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    showPopupGuide(isMobile);
                }
            } catch (error) {
                log(`❌ ポップアップテストエラー: ${error.message}`);
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                showPopupGuide(isMobile);
            }
        };

        // ログアウト
        window.handleLogout = async () => {
            try {
                await auth.signOut();
                // loadCustomItems実行フラグをリセット（次回ログイン時に再実行可能にする）
                isLoadCustomItemsExecuted = false;
                log('📤 ログアウト完了 (カスタム項目フラグリセット済み)');
            } catch (error) {
                log(`❌ ログアウトエラー: ${error.message}`);
            }
        };

        // データ保存
        window.saveWeightData = async () => {
            if (!currentUser) {
                log('❌ ログインが必要です');
                return;
            }

            const date = document.getElementById('dateInput').value;
            const weight = document.getElementById('weightValue').value;
            const memo = document.getElementById('memoInput').value;

            if (!date || !weight) {
                log('❌ 日付と値を入力してください');
                return;
            }

            try {
                log('💾 データを保存中...');
                
                const now = new Date();
                const timeString = now.toLocaleTimeString('ja-JP', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const weightData = {
                    date: date,
                    time: timeString,
                    value: parseFloat(weight),
                    timing: selectedTimingValue || '',
                    clothing: {
                        top: selectedTopValue || '',
                        bottom: selectedBottomValue || ''
                    },
                    memo: memo || '',
                    userEmail: currentUser.email,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    createdAt: now.toISOString()
                };

                if (window.editingEntryId) {
                    // 編集モード: 既存データを更新
                    const entryRef = database.ref(`users/${currentUser.uid}/weights/${window.editingEntryId}`);
                    await entryRef.update({
                        date: date,
                        time: timeString,
                        weight: parseFloat(weight),
                        timing: selectedTimingValue || '',
                        clothing: {
                            top: selectedTopValue || '',
                            bottom: selectedBottomValue || ''
                        },
                        memo: memo || '',
                        userEmail: currentUser.email,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                } else {
                    // 新規保存モード
                    const userRef = database.ref(`users/${currentUser.uid}/weights`);
                    await userRef.push(weightData);
                }
                
                // 保存完了ログ（服装情報も含む）
                let logMessage;
                if (window.editingEntryId) {
                    logMessage = `✏️ 更新完了: ${date} ${timeString} - ${weight}kg`;
                } else {
                    logMessage = `✅ 保存完了: ${date} ${timeString} - ${weight}kg`;
                }
                if (selectedTimingValue) logMessage += ` (${selectedTimingValue})`;
                if (selectedTopValue || selectedBottomValue) {
                    const clothingInfo = [selectedTopValue, selectedBottomValue].filter(Boolean).join(', ');
                    logMessage += ` [${clothingInfo}]`;
                }
                log(logMessage);
                
                // 入力フィールドをクリア（体重は72.0に戻す）
                document.getElementById('weightValue').value = '72.0';
                document.getElementById('memoInput').value = '';
                document.getElementById('selectedTop').value = '';
                document.getElementById('selectedBottom').value = '';
                selectedTimingValue = '';
                selectedTopValue = '';
                selectedBottomValue = '';
                
                // 編集モードをリセット
                window.editingEntryId = null;
                document.querySelector('.save-button').textContent = '💾 保存';
                document.querySelector('.save-button').style.background = '#28a745';
                
                // 編集モードインジケーターを削除
                const editModeIndicator = document.getElementById('editModeIndicator');
                if (editModeIndicator) {
                    editModeIndicator.remove();
                }
                
                // キャンセルボタンを削除
                const cancelButton = document.getElementById('cancelEditButton');
                if (cancelButton) {
                    cancelButton.remove();
                }
                
                // ボタンのスタイルをリセット
                document.querySelectorAll('.timing-btn').forEach(btn => {
                    btn.style.opacity = '0.7';
                    btn.classList.remove('selected');
                });
                document.querySelectorAll('.clothing-btn').forEach(btn => {
                    btn.style.opacity = '0.7';
                    btn.style.transform = 'scale(1)';
                });
                
                // データを再読み込み
                loadUserWeightData(currentUser.uid);
            } catch (error) {
                log(`❌ 保存エラー: ${error.message}`);
            }
        };

        // 体重データ編集機能
        window.editWeightEntry = async (entryId) => {
            if (!currentUser) {
                log('❌ ログインが必要です');
                return;
            }
            
            try {
                const entryRef = database.ref(`users/${currentUser.uid}/weights/${entryId}`);
                const snapshot = await entryRef.once('value');
                const entry = snapshot.val();
                
                if (!entry) {
                    log('❌ 記録が見つかりません');
                    return;
                }
                
                // フォームにデータを設定
                document.getElementById('dateInput').value = entry.date;
                document.getElementById('weightValue').value = entry.value || entry.weight;
                document.getElementById('memoInput').value = entry.memo || '';
                
                // タイミングを設定
                if (entry.timing) {
                    selectTiming(entry.timing);
                }
                
                // 服装を設定
                if (entry.clothing && entry.clothing.top) {
                    selectClothingTop(entry.clothing.top);
                }
                if (entry.clothing && entry.clothing.bottom) {
                    selectClothingBottom(entry.clothing.bottom);
                }
                
                
                // 編集モードに切り替え
                window.editingEntryId = entryId;
                document.querySelector('.save-button').textContent = '✏️ 更新';
                document.querySelector('.save-button').style.background = '#ffc107';
                
                // 編集モードであることを明確に表示
                const editModeIndicator = document.getElementById('editModeIndicator');
                if (editModeIndicator) {
                    editModeIndicator.remove();
                }
                const indicator = document.createElement('div');
                indicator.id = 'editModeIndicator';
                indicator.innerHTML = '✏️ <strong>編集モード</strong> - ' + entry.date + ' ' + (entry.value || entry.weight) + 'kgのデータを修正して更新ボタンを押してください';
                indicator.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 15px; text-align: center; animation: fadeIn 0.3s;';
                document.querySelector('.save-button').parentNode.insertBefore(indicator, document.querySelector('.save-button'));
                
                // キャンセルボタンを追加
                const existingCancelButton = document.getElementById('cancelEditButton');
                if (existingCancelButton) {
                    existingCancelButton.remove();
                }
                const cancelButton = document.createElement('button');
                cancelButton.id = 'cancelEditButton';
                cancelButton.innerHTML = '❌ キャンセル';
                cancelButton.onclick = cancelEdit;
                cancelButton.style.cssText = 'background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; margin-left: 10px;';
                document.querySelector('.save-button').parentNode.insertBefore(cancelButton, document.querySelector('.save-button').nextSibling);
                
                log(`✏️ 編集モード: ${entry.date} ${entry.value || entry.weight} のデータを編集中`);
                
                // ページトップにスクロール
                window.scrollTo(0, 0);
                
            } catch (error) {
                log(`❌ 編集エラー: ${error.message}`);
            }
        };
        
        // 編集キャンセル機能
        window.cancelEdit = () => {
            // フォームをクリア
            document.getElementById('dateInput').value = '';
            document.getElementById('weightValue').value = '';
            document.getElementById('memoInput').value = '';
            
            // 選択状態をリセット
            selectedTimingValue = '';
            selectedTopValue = '';
            selectedBottomValue = '';
            
            // 編集モードをリセット
            window.editingEntryId = null;
            document.querySelector('.save-button').textContent = '💾 保存';
            document.querySelector('.save-button').style.background = '#28a745';
            
            // 編集モードインジケーターを削除
            const editModeIndicator = document.getElementById('editModeIndicator');
            if (editModeIndicator) {
                editModeIndicator.remove();
            }
            
            // キャンセルボタンを削除
            const cancelButton = document.getElementById('cancelEditButton');
            if (cancelButton) {
                cancelButton.remove();
            }
            
            // ボタンのスタイルをリセット
            document.querySelectorAll('.timing-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.classList.remove('selected');
            });
            document.querySelectorAll('.clothing-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            log('❌ 編集をキャンセルしました');
        };
        
        // データ削除
        window.deleteWeightEntry = async (entryId) => {
            if (!currentUser) {
                log('❌ ログインが必要です');
                return;
            }
            
            if (!confirm('この記録を削除しますか？')) {
                return;
            }
            
            try {
                log(`🗑️ データ削除中: ${entryId}`);
                const entryRef = database.ref(`users/${currentUser.uid}/weights/${entryId}`);
                await entryRef.remove();
                log(`✅ 削除完了: ${entryId}`);
            } catch (error) {
                log(`❌ 削除エラー: ${error.message}`);
            }
        };

        // ユーザーのデータを読み込み
        // loadUserWeightData関数は tabs/tab1-weight/tab-weight.js に移動済み

        // グラフを更新
        // 日付指定でチャートを更新
        function updateChartWithDate(days, endDate) {
            const ctx = document.getElementById('weightChart');
            if (!ctx) return;

            const end = new Date(endDate);
            const startDate = new Date(end);
            if (days > 0) {
                startDate.setDate(end.getDate() - days);
            } else {
                // 全期間の場合、最も古いデータから
                if (allWeightData.length > 0) {
                    startDate.setTime(new Date(allWeightData[0].date).getTime());
                }
            }

            // 期間内のデータをフィルタリング
            const filteredData = allWeightData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startDate && entryDate <= end;
            });

            // 既存のupdateChart関数のロジックを使用してチャートを描画
            renderChartWithData(days, filteredData, startDate, end);
        }

        // チャート描画の共通ロジック（安全アクセス対応）
        function renderChartWithData(days, filteredData, startDate, endDate) {
            const ctx = document.getElementById('weightChart');
            if (!ctx) {
                console.log('⚠️ weightChart要素が見つかりません - チャート描画をスキップ');
                return;
            }

            let chartData, datasets = [];
            let timeUnit, displayFormat, axisLabel;
            let dateRangeText = '';

            if (days === 1) {
                // 1日表示：時間軸を使用（24時間表示）
                chartData = filteredData.map(entry => {
                    const dateTime = entry.time ? 
                        new Date(`${entry.date}T${entry.time}:00`) : 
                        new Date(`${entry.date}T12:00:00`); // 時間なしの場合は12:00とする
                    
                    return {
                        x: dateTime,
                        y: parseFloat(entry.value || entry.weight)
                    };
                }).sort((a, b) => a.x - b.x);
                
                // 対象日付を表示用に設定
                if (filteredData.length > 0) {
                    const targetDate = new Date(filteredData[0].date);
                    const dateStr = `${targetDate.getMonth() + 1}/${targetDate.getDate()}`;
                    dateRangeText = `${dateStr}のデータ`;
                }
                
                datasets.push({
                    label: '体重',
                    data: chartData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    pointRadius: 4,
                    pointHoverRadius: 6
                });

                // 前期間データを追加（1日表示用）
                if (showPreviousPeriod) {
                    const previousData = getPreviousPeriodData(days, endDate);
                    if (previousData.length > 0) {
                        const previousChartData = previousData.map(entry => {
                            const dateTime = entry.time ? 
                                new Date(`${entry.date}T${entry.time}:00`) : 
                                new Date(`${entry.date}T12:00:00`);
                            
                            return {
                                x: dateTime,
                                y: parseFloat(entry.weight || entry.value)
                            };
                        }).sort((a, b) => a.x - b.x);

                        datasets.push({
                            label: '前日の記録',
                            data: previousChartData,
                            borderColor: 'rgba(128, 128, 128, 0.6)',
                            backgroundColor: 'rgba(128, 128, 128, 0.1)',
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderDash: [5, 5]
                        });
                    }
                }
                
                timeUnit = 'hour';
                displayFormat = 'HH:mm';
                axisLabel = '時間';
            } else {
                // 複数日表示：日付でグループ化（最大値・最小値・平均値を表示）
                const groupedData = {};
                filteredData.forEach(entry => {
                    if (!groupedData[entry.date]) {
                        groupedData[entry.date] = [];
                    }
                    groupedData[entry.date].push(parseFloat(entry.value || entry.weight));
                });

                const avgData = [], maxData = [], minData = [];
                Object.keys(groupedData).sort().forEach(date => {
                    const values = groupedData[date];
                    const avg = values.reduce((a, b) => a + b, 0) / values.length;
                    const max = Math.max(...values);
                    const min = Math.min(...values);
                    
                    avgData.push({ x: date, y: avg });
                    maxData.push({ x: date, y: max });
                    minData.push({ x: date, y: min });
                });

                // 複数測定日がある場合のみ全系列を表示
                const hasMultipleMeasurements = Object.values(groupedData).some(values => values.length > 1);
                
                if (hasMultipleMeasurements) {
                    const avgDataForDisplay = [];
                    const maxDataForDisplay = [];
                    const minDataForDisplay = [];
                    
                    avgData.forEach(item => {
                        const date = item.x;
                        if (groupedData[date] && groupedData[date].length > 1) {
                            avgDataForDisplay.push(item);
                        }
                    });
                    
                    maxData.forEach(item => {
                        const date = item.x;
                        if (groupedData[date] && groupedData[date].length > 1) {
                            maxDataForDisplay.push(item);
                        }
                    });
                    
                    minData.forEach(item => {
                        const date = item.x;
                        if (groupedData[date] && groupedData[date].length > 1) {
                            minDataForDisplay.push(item);
                        }
                    });

                    datasets.push({
                        label: '平均値',
                        data: avgDataForDisplay,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    });

                    if (maxDataForDisplay.length > 0) {
                        datasets.push({
                            label: '最大値',
                            data: maxDataForDisplay,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderDash: [5, 5]
                        });

                        datasets.push({
                            label: '最小値',
                            data: minDataForDisplay,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderDash: [5, 5]
                        });
                    }
                } else {
                    datasets.push({
                        label: '体重',
                        data: avgData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    });
                }

                // 前期間データを追加（複数日表示用）
                if (showPreviousPeriod) {
                    const previousData = getPreviousPeriodData(days, endDate);
                    if (previousData.length > 0) {
                        const previousGroupedData = {};
                        previousData.forEach(entry => {
                            if (!previousGroupedData[entry.date]) {
                                previousGroupedData[entry.date] = [];
                            }
                            previousGroupedData[entry.date].push(parseFloat(entry.weight || entry.value));
                        });

                        const previousAvgData = [];
                        Object.keys(previousGroupedData).sort().forEach(date => {
                            const values = previousGroupedData[date];
                            const avg = values.reduce((a, b) => a + b, 0) / values.length;
                            previousAvgData.push({ x: date, y: avg });
                        });

                        const periodName = days === 7 ? '前週' : days === 30 ? '前月' : days === 90 ? '前3ヶ月' : days === 365 ? '前年' : '前期間';
                        datasets.push({
                            label: `${periodName}の記録`,
                            data: previousAvgData,
                            borderColor: 'rgba(128, 128, 128, 0.6)',
                            backgroundColor: 'rgba(128, 128, 128, 0.1)',
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderDash: [5, 5]
                        });
                    }
                }
                
                // 期間表示テキストを設定
                if (avgData.length > 0) {
                    const startStr = new Date(avgData[0].x).toLocaleDateString('ja-JP', {month: 'numeric', day: 'numeric'});
                    const endStr = new Date(avgData[avgData.length - 1].x).toLocaleDateString('ja-JP', {month: 'numeric', day: 'numeric'});
                    dateRangeText = `${startStr}～${endStr}`;
                }
                
                timeUnit = 'day';
                displayFormat = 'MM/dd';
                axisLabel = '日付';
            }

            // 期間表示を更新
            updateDateRangeDisplay(dateRangeText);

            // グラフを描画
            if (weightChart) {
                weightChart.destroy();
            }

            const chartConfig = {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}kg`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: timeUnit,
                                displayFormats: {
                                    hour: displayFormat,
                                    day: displayFormat
                                }
                            },
                            title: {
                                display: true,
                                text: axisLabel
                            },
                            // 1日表示の場合は24時間表示
                            ...(days === 1 && filteredData.length > 0 ? {
                                min: new Date(`${filteredData[0].date}T00:00:00`),
                                max: new Date(`${filteredData[0].date}T23:59:59`)
                            } : {})
                        },
                        y: {
                            min: 71.5,
                            max: 74.0,
                            title: {
                                display: true,
                                text: '体重 (kg)'
                            },
                            ticks: {
                                stepSize: 0.5,
                                callback: function(value) {
                                    return value.toFixed(1) + 'kg';
                                }
                            }
                        }
                    }
                }
            };

            weightChart = new Chart(ctx, chartConfig);
            log(`📊 グラフ更新: ${filteredData.length}件のデータ表示 ${dateRangeText}`);
        }

        function updateChart(days = 30) {
            // 現在の日付を基準に更新
            currentChartDays = days;
            currentChartDate = new Date();
            
            const ctx = document.getElementById('weightChart');
            if (!ctx) return;

            const now = new Date();
            const startDate = new Date(now);
            if (days > 0) {
                startDate.setDate(now.getDate() - days);
            } else {
                // 全期間の場合、最も古いデータから
                if (allWeightData.length > 0) {
                    startDate.setTime(new Date(allWeightData[0].date).getTime());
                }
            }

            // 期間内のデータをフィルタリング
            const filteredData = allWeightData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startDate && entryDate <= now;
            });

            // 共通の描画ロジックを使用
            renderChartWithData(days, filteredData, startDate, now);
            
            // 期間情報を更新
            updateChartPeriodInfo();
        }

        // 日付範囲表示を更新
        function updateDateRangeDisplay(rangeText) {
            const chartContainer = document.querySelector('#chartPanel div[style*="position: relative"]');
            if (!chartContainer) {
                // フォールバック: chartPanelを使用
                const chartPanel = document.getElementById('chartPanel');
                if (!chartPanel) {
                    console.warn('Chart panel not found for date range display');
                    return;
                }
                
                let rangeDisplay = document.getElementById('chartDateRange');
                if (!rangeDisplay) {
                    rangeDisplay = document.createElement('div');
                    rangeDisplay.id = 'chartDateRange';
                    rangeDisplay.style.cssText = 'text-align: right; font-size: 12px; color: #666; margin-bottom: 5px; padding: 2px 0;';
                    const h3 = chartPanel.querySelector('h3');
                    if (h3) {
                        h3.insertAdjacentElement('afterend', rangeDisplay);
                    }
                }
                if (rangeDisplay && rangeText) {
                    rangeDisplay.textContent = rangeText;
                }
                return;
            }

            let rangeDisplay = document.getElementById('chartDateRange');
            if (!rangeDisplay) {
                // 日付範囲表示エリアが存在しない場合は作成
                rangeDisplay = document.createElement('div');
                rangeDisplay.id = 'chartDateRange';
                rangeDisplay.style.cssText = 'position: absolute; top: 5px; right: 10px; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px; font-size: 12px; color: #666; border: 1px solid #ddd; z-index: 10;';
                chartContainer.appendChild(rangeDisplay);
            }
            if (rangeDisplay && rangeText) {
                rangeDisplay.textContent = rangeText;
            }
        }

        // グラフの表示期間を変更
        window.updateChartRange = (days) => {
            updateChart(days);
            const rangeName = days === 1 ? '1日' :
                            days === 7 ? '1週間' : 
                            days === 30 ? '1ヶ月' : 
                            days === 90 ? '3ヶ月' : 
                            days === 365 ? '1年' : '全期間';
            log(`📊 グラフ表示期間変更: ${rangeName}`);
        }

        // チャートナビゲーション用変数
        let currentChartDays = 30; // デフォルト期間
        let currentChartDate = new Date(); // 基準日

        // チャートナビゲーション機能
        window.navigateChart = (direction) => {
            if (currentChartDays === 0) {
                log('⚠️ 全期間表示中はナビゲーションできません');
                return;
            }

            const today = new Date();
            
            if (direction === 'prev') {
                // 前の期間へ
                currentChartDate.setDate(currentChartDate.getDate() - currentChartDays);
            } else if (direction === 'next') {
                // 次の期間へ
                currentChartDate.setDate(currentChartDate.getDate() + currentChartDays);
                
                // 未来に行き過ぎないよう制限
                if (currentChartDate > today) {
                    currentChartDate = new Date(today);
                }
            }
            
            // チャートを更新
            updateChartWithDate(currentChartDays, currentChartDate);
            
            // 期間情報を更新
            updateChartPeriodInfo();
            
            const direction_jp = direction === 'prev' ? '前' : '次';
            log(`📊 チャート${direction_jp}へナビゲーション`);
        };

        // 期間情報表示を更新
        function updateChartPeriodInfo() {
            const periodInfo = document.getElementById('chartPeriodInfo');
            if (!periodInfo) return;
            
            const endDate = new Date(currentChartDate);
            const startDate = new Date(currentChartDate);
            
            if (currentChartDays === 1) {
                // 1日表示
                periodInfo.textContent = `${endDate.getMonth() + 1}/${endDate.getDate()} (1日)`;
            } else if (currentChartDays === 7) {
                // 1週間表示
                startDate.setDate(endDate.getDate() - 6);
                periodInfo.textContent = `${startDate.getMonth() + 1}/${startDate.getDate()} - ${endDate.getMonth() + 1}/${endDate.getDate()} (1週間)`;
            } else if (currentChartDays === 30) {
                // 1ヶ月表示
                startDate.setDate(endDate.getDate() - 29);
                periodInfo.textContent = `${startDate.getMonth() + 1}/${startDate.getDate()} - ${endDate.getMonth() + 1}/${endDate.getDate()} (1ヶ月)`;
            } else if (currentChartDays === 90) {
                // 3ヶ月表示
                startDate.setDate(endDate.getDate() - 89);
                periodInfo.textContent = `${startDate.getMonth() + 1}/${startDate.getDate()} - ${endDate.getMonth() + 1}/${endDate.getDate()} (3ヶ月)`;
            } else if (currentChartDays === 365) {
                // 1年表示
                startDate.setDate(endDate.getDate() - 364);
                periodInfo.textContent = `${startDate.getMonth() + 1}/${startDate.getDate()} - ${endDate.getMonth() + 1}/${endDate.getDate()} (1年)`;
            } else {
                periodInfo.textContent = '全期間';
            }
        }

        // 前期間比較機能
        function togglePreviousPeriod() {
            showPreviousPeriod = !showPreviousPeriod;
            const btn = document.getElementById('previousPeriodBtn');
            
            if (showPreviousPeriod) {
                btn.style.background = '#dc3545';
                btn.textContent = '前期間OFF';
            } else {
                btn.style.background = '#28a745';
                btn.textContent = '前期間の記録';
            }
            
            // チャートを再描画
            updateChartWithDate(currentChartDays, currentChartDate);
            log(`📊 前期間比較: ${showPreviousPeriod ? 'ON' : 'OFF'}`);
        }

        // 前期間データを取得
        function getPreviousPeriodData(days, currentEndDate) {
            if (days <= 0) return []; // 全期間表示の場合は前期間なし
            
            // 前期間の終了日を計算
            const previousEndDate = new Date(currentEndDate);
            if (days === 1) {
                // 1日表示の場合：前日
                previousEndDate.setDate(currentEndDate.getDate() - 1);
            } else {
                // 複数日表示の場合：前期間の終了日
                previousEndDate.setDate(currentEndDate.getDate() - days);
            }
            
            // 前期間の開始日を計算
            const previousStartDate = new Date(previousEndDate);
            if (days === 1) {
                // 1日表示：開始日=終了日（前日のみ）
                previousStartDate.setTime(previousEndDate.getTime());
            } else {
                // 複数日表示：期間の開始日を計算
                previousStartDate.setDate(previousEndDate.getDate() - days + 1);
            }
            
            // デバッグログ
            log(`🔍 前期間データ取得: ${days}日, 現在終了日: ${currentEndDate.toDateString()}`);
            log(`🔍 前期間範囲: ${previousStartDate.toDateString()} - ${previousEndDate.toDateString()}`);
            
            // 前期間のデータをフィルタリング
            const filteredData = allWeightData.filter(entry => {
                const entryDate = new Date(entry.date);
                const entryDateStr = entry.date; // YYYY-MM-DD形式の文字列
                const previousStartStr = previousStartDate.toISOString().split('T')[0];
                const previousEndStr = previousEndDate.toISOString().split('T')[0];
                
                // デバッグ用
                if (days === 1) {
                    log(`🔍 データ確認: ${entryDateStr} vs ${previousStartStr}-${previousEndStr}`);
                }
                
                return entryDateStr >= previousStartStr && entryDateStr <= previousEndStr;
            });
            
            log(`🔍 前期間データ件数: ${filteredData.length}件`);
            return filteredData;
        }

        // テスト環境でのアクセス用（本番環境に影響なし）
        if (typeof window !== 'undefined' && typeof module !== 'undefined') {
            window.getPreviousPeriodData = getPreviousPeriodData;
        }

        // 現在のタブ
        let currentTab = 1;
        
        // タブコンテンツ動的読み込み
        window.loadTabContent = async (tabNumber, tabType) => {
            try {
                const tabContentDiv = document.getElementById(`tabContent${tabNumber}`);
                if (!tabContentDiv) return;
                
                // HTMLコンテンツを読み込み
                const response = await fetch(`tabs/tab${tabNumber}-${tabType}/tab-${tabType}.html`);
                if (response.ok) {
                    const htmlContent = await response.text();
                    tabContentDiv.innerHTML = htmlContent;
                    
                    // JavaScriptファイルを動的読み込み
                    await loadTabScript(tabNumber, tabType);
                    
                    // タブ固有の初期化処理（JSファイル読み込み完了後）
                    if (tabNumber === 1 && currentUser) {
                        log(`🔄 tab1: 体重管理タブ初期化実行`);
                        
                        // 外部JSファイルの初期化関数を呼び出し
                        setTimeout(() => {
                            if (typeof window.initWeightTab === 'function') {
                                window.initWeightTab();
                                log('✅ 体重管理タブ初期化完了');
                            } else {
                                log('❌ initWeightTab関数が見つかりません');
                            }
                        }, 200);
                    } else if (tabNumber === 3 && currentUser) {
                        log('🔄 部屋片付けタブ: JS読み込み完了後のデータ読み込み開始');
                        setTimeout(() => {
                            if (typeof window.loadRoomData === 'function') {
                                window.loadRoomData();
                                log('✅ 部屋片付けデータ読み込み実行');
                            } else if (typeof loadRoomData === 'function') {
                                loadRoomData();
                                log('✅ 部屋片付けデータ読み込み実行（ローカル関数）');
                            } else {
                                log('❌ loadRoomData関数が見つかりません');
                            }
                        }, 200); // 少し長めの待機時間
                    } else if (tabNumber === 8 && currentUser) {
                        log('🔄 メモリストタブ: JS読み込み完了後のデータ読み込み開始');
                        setTimeout(() => {
                            loadMemoData();
                        }, 100);
                    }
                    
                    log(`✅ タブ${tabNumber}（${tabType}）コンテンツ読み込み完了`);
                } else {
                    log(`⚠️ タブ${tabNumber}の分離ファイルが見つかりません - 既存コンテンツを使用`);
                }
            } catch (error) {
                log(`❌ タブ読み込みエラー: ${error.message}`);
            }
        };
        
        // タブ用JavaScriptの動的読み込み
        window.loadTabScript = async (tabNumber, tabType) => {
            try {
                // 既存のスクリプトタグを削除
                const existingScript = document.getElementById(`tab${tabNumber}Script`);
                if (existingScript) {
                    existingScript.remove();
                }
                
                // 新しいスクリプトタグを作成
                const script = document.createElement('script');
                script.id = `tab${tabNumber}Script`;
                script.src = `tabs/tab${tabNumber}-${tabType}/tab-${tabType}.js`;
                document.head.appendChild(script);
                
                return new Promise((resolve, reject) => {
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error(`Script load failed: ${script.src}`));
                });
            } catch (error) {
                throw error;
            }
        };

        // タブ切り替え機能（動的読み込み対応）
        window.switchTab = async (tabNumber) => {
            currentTab = tabNumber;
            
            // 現在のタブを localStorage に保存
            localStorage.setItem('currentTab', tabNumber);
            
            // すべてのタブボタンを非アクティブに（16タブ対応）
            for (let i = 1; i <= 16; i++) {
                const tabBtn = document.getElementById(`tab${i}`);
                const tabContent = document.getElementById(`tabContent${i}`);
                
                log(`🔍 タブ${i}: ボタン=${tabBtn ? '存在' : 'なし'}, コンテンツ=${tabContent ? '存在' : 'なし'}`);
                
                if (i === tabNumber) {
                    // アクティブタブ
                    if (tabBtn) {
                        tabBtn.style.background = '#007bff';
                        tabBtn.style.color = 'white';
                    }
                    if (tabContent) {
                        tabContent.classList.remove('hidden');
                        log(`✅ タブ${i}コンテンツを表示`);
                    }
                    
                    // 動的読み込み（全分離タブ統一）
                    if (i === 1) {
                        await loadTabContent(1, 'weight');
                    } else if (i === 2) {
                        await loadTabContent(2, 'sleep');
                    } else if (i === 3) {
                        await loadTabContent(3, 'room-cleaning');
                    } else if (i === 8) {
                        await loadTabContent(8, 'memo-list');
                    }
                } else {
                    // 非アクティブタブ
                    if (tabBtn) {
                        tabBtn.style.background = '#f8f9fa';
                        tabBtn.style.color = '#495057';
                    }
                    if (tabContent) {
                        tabContent.classList.add('hidden');
                        log(`❌ タブ${i}コンテンツを非表示`);
                    }
                }
            }
            
            // タイトル更新
            const tabTitles = {
                1: '📊 体重管理アプリ',
                2: '🛏️ 睡眠管理',
                3: '🏠 部屋片づけ',
                4: '🤸 ストレッチ',
                5: '🔧 xx5',
                6: '🔧 xx6', 
                7: '🔧 xx7',
                8: '📝 メモリスト'
            };
            
            const titleElement = document.getElementById('appTitle');
            if (titleElement && tabTitles[tabNumber]) {
                titleElement.textContent = `${tabTitles[tabNumber]} ${APP_VERSION}`;
            }
            
            // 体重管理要素は常に表示（tabContent1内にあるため自動制御される）
            
            // タブ固有の初期化処理
            if (tabNumber === 1) {
                // 体重管理タブの初期化（外部JSで処理）
                if (currentUser && typeof window.initWeightTab === 'function') {
                    log('🔄 体重管理タブ: 外部JS初期化実行');
                    window.initWeightTab();
                }
            } else if (tabNumber === 2) {
                // 睡眠管理タブの初期化（ログインに関係なく実行）
                initializeSleepManager();
                if (currentUser) {
                    loadSleepData();
                }
            } else if (tabNumber === 3) {
                // 部屋片付けタブの初期化（データ読み込みはloadTabContent完了後に実行）
                log('🔄 部屋片付けタブに切り替え - 初期化のみ実行');
                initRoomManagement();
            } else if (tabNumber === 8) {
                // メモリストタブの初期化（データ読み込みはloadTabContent完了後に実行）
                log('🔄 メモリストタブに切り替え - 初期化のみ実行');
            }
            
            log(`📑 タブ切り替え: タブ${tabNumber}`);
        };

        // UI表示制御
        function showUserInterface(user) {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('tabNavigation').classList.remove('hidden');
            document.getElementById('appHeader').classList.remove('hidden');
            // 体重管理関連要素は存在チェック後に表示
            const modeControl = document.getElementById('modeControl');
            if (modeControl) modeControl.classList.remove('hidden');
            
            const weightInput = document.getElementById('weightInput');
            if (weightInput) weightInput.classList.remove('hidden');
            
            const chartPanel = document.getElementById('chartPanel');
            if (chartPanel) chartPanel.classList.remove('hidden');
            
            const weightHistoryPanel = document.getElementById('weightHistoryPanel');
            if (weightHistoryPanel) weightHistoryPanel.classList.remove('hidden');
            document.getElementById('userName').textContent = user.displayName;
            
            // 保存されたタブまたはデフォルトでタブ1を表示
            const savedTab = localStorage.getItem('currentTab');
            const tabToShow = savedTab ? parseInt(savedTab) : 1;
            switchTab(tabToShow);
            
            // 今日の日付と体重デフォルト値を設定（タイムゾーン考慮）
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;
            document.getElementById('dateInput').value = todayString;
            document.getElementById('weightValue').value = '72.0';
            
            // メモデータを読み込み（ログイン時、存在チェック付き）
            if (typeof loadMemoData === 'function') {
                loadMemoData();
                log('✅ メモデータ読み込み実行');
            } else {
                log('⚠️ loadMemoData関数未定義 - 初期化時スキップ');
            }
            
            // タイミングボタンの初期状態設定
            document.querySelectorAll('.timing-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.classList.remove('selected');
            });
            
            // 服装ボタンの初期状態設定
            document.querySelectorAll('.clothing-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            // デフォルト服装選択: 上=なし, 下=トランクス
            selectClothingTop('なし');
            selectClothingBottom('トランクス');
            
        }

        function showLoginInterface() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('tabNavigation').classList.add('hidden');
            document.getElementById('appHeader').classList.add('hidden');
            document.getElementById('modeControl').classList.add('hidden');
            document.getElementById('weightInput').classList.add('hidden');
            document.getElementById('chartPanel').classList.add('hidden');
        }

        // ログ出力関数（安全アクセス対応）
        function log(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            
            // DOM要素が存在しない場合はコンソールログのみ
            if (logArea) {
                logArea.innerHTML += `[${timestamp}] ${message}<br>`;
                logArea.scrollTop = logArea.scrollHeight;
            }
            console.log(`[${timestamp}] ${message}`);
        }

        // ログコピー機能（安全アクセス対応）
        window.copyLogs = () => {
            const logArea = document.getElementById('logArea');
            if (!logArea) {
                console.log('⚠️ logArea要素が見つかりません');
                return;
            }
            const logText = logArea.innerText || logArea.textContent;
            navigator.clipboard.writeText(logText).then(() => {
                alert('✅ ログをコピーしました');
            }).catch(() => {
                // fallback
                const textArea = document.createElement('textarea');
                textArea.value = logText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('✅ ログをコピーしました');
            });
        };

        // Firebase接続デバッグ
        window.debugFirebaseConnection = () => {
            log('🔍 === Firebase Debug 開始 ===');
            
            // 1. Firebase設定確認
            log(`🔥 Firebase Config確認:`);
            log(`- Project ID: ${firebaseConfig.projectId}`);
            log(`- Database URL: ${firebaseConfig.databaseURL}`);
            log(`- Auth Domain: ${firebaseConfig.authDomain}`);
            
            // 2. 認証状態確認
            if (currentUser) {
                log(`✅ 認証済みユーザー:`);
                log(`- UID: ${currentUser.uid.substring(0,8)}...`);
                log(`- Email: ${currentUser.email}`);
                log(`- 表示名: ${currentUser.displayName}`);
            } else {
                log('❌ 未認証状態');
            }
            
            // 3. 接続テスト
            const connectedRef = database.ref('.info/connected');
            connectedRef.once('value', (snapshot) => {
                const connected = snapshot.val();
                log(`🌐 Firebase接続状態: ${connected ? '接続中' : '未接続'}`);
                
                if (connected && currentUser) {
                    // データベーステスト
                    const testRef = database.ref(`users/${currentUser.uid}/test`);
                    testRef.set({
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        message: 'Connection test',
                        app: 'app-template'
                    }).then(() => {
                        log('✅ データベース書き込みテスト成功');
                    }).catch((error) => {
                        log(`❌ データベース書き込みエラー: ${error.message}`);
                        log(`- Error Code: ${error.code}`);
                    });
                }
            });
            
            log('🔍 === Firebase Debug 完了 ===');
        };

        // モバイル環境診断
        window.checkMobileSupport = () => {
            log('📱 === モバイル環境診断 開始 ===');
            
            const userAgent = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            
            log(`🌐 ユーザーエージェント: ${userAgent}`);
            log(`📱 モバイルデバイス判定: ${isMobile ? 'モバイル' : 'デスクトップ'}`);
            
            // ブラウザ判定
            const isChrome = /Chrome/i.test(userAgent);
            const isSafari = /Safari/i.test(userAgent) && !/Chrome/i.test(userAgent);
            const isFirefox = /Firefox/i.test(userAgent);
            
            log(`🌐 ブラウザ: ${isChrome ? 'Chrome' : isSafari ? 'Safari' : isFirefox ? 'Firefox' : '不明'}`);
            
            // ログイン方式の推奨
            if (isMobile) {
                log('💡 モバイルの推奨設定:');
                log('- Googleログインはリダイレクト方式を使用');
                log('- ポップアップブロッカーの影響なし');
                log('- 認証後にページが再読み込みされます');
            }
            
            log('📱 === モバイル環境診断 完了 ===');
        };

        // Firebase設定診断
        window.checkFirebaseConfig = () => {
            log('🔧 === Firebase設定診断 開始 ===');
            
            // 現在のドメイン確認
            const currentDomain = window.location.hostname;
            const currentUrl = window.location.href;
            log(`🌐 現在のドメイン: ${currentDomain}`);
            log(`🔗 現在のURL: ${currentUrl}`);
            
            // Firebase設定情報
            log(`🔥 Firebase設定:`);
            log(`- Project ID: ${firebaseConfig.projectId}`);
            log(`- Auth Domain: ${firebaseConfig.authDomain}`);
            log(`- Database URL: ${firebaseConfig.databaseURL}`);
            
            // 認証ドメイン許可状況の推測
            if (currentDomain === 'muumuu8181.github.io') {
                log('✅ GitHub Pagesドメイン検出');
                log('💡 Firebase Consoleでこのドメインが許可されているか確認が必要');
            } else if (currentDomain === 'localhost' || currentDomain === '127.0.0.1') {
                log('✅ ローカルホスト検出');
                log('💡 通常は自動で許可されています');
            } else {
                log('⚠️ 不明なドメインです');
                log('💡 Firebase Consoleの認証設定で許可が必要かもしれません');
            }
            
            // モバイルブラウザでのリダイレクト制限確認
            const userAgent = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            
            if (isMobile) {
                log('📱 モバイルブラウザ固有の制限:');
                log('- Safari: サードパーティCookieの制限あり');
                log('- Chrome Mobile: ポップアップの自動ブロック');
                log('- 解決策: リダイレクト方式またはポップアップ許可設定');
            }
            
            log('🔧 === Firebase設定診断 完了 ===');
        };

        // 認証状態の強制確認
        window.forceAuthCheck = () => {
            log('🔍 === 認証状態強制確認 開始 ===');
            
            const user = auth.currentUser;
            log(`🔐 Firebase認証状態: ${user ? `ログイン済み (${user.displayName})` : '未ログイン'}`);
            
            if (user) {
                log('✅ ユーザー画面を表示します');
                showUserInterface(user);
                loadUserWeightData(user.uid);
            } else {
                log('❌ ログイン画面を表示します');
                showLoginInterface();
            }
            
            // 認証トークンの有効性確認
            if (user) {
                user.getIdToken(true).then(() => {
                    log('✅ 認証トークンは有効です');
                }).catch((tokenError) => {
                    log(`❌ 認証トークンエラー: ${tokenError.message}`);
                    log('💡 再ログインが必要かもしれません');
                });
            }
            
            log('🔍 === 認証状態強制確認 完了 ===');
        };

        // ログイン問題診断
        window.checkLoginIssues = () => {
            log('⚠️ === ログイン問題診断 開始 ===');
            
            // 1. プロトコルチェック
            const protocol = window.location.protocol;
            log(`🌐 現在のプロトコル: ${protocol}`);
            
            if (protocol === 'file:') {
                log('❌ 問題発見: file://プロトコルではGoogle認証が動作しません');
                log('✅ 解決方法:');
                log('  1. HTTPサーバー経由でアクセス');
                log('  2. chrome://flags で insecure origins を許可');
                log('  3. ローカルサーバー起動 (python -m http.server 8000)');
            } else if (protocol === 'https:' || protocol === 'http:') {
                log('✅ プロトコル: 問題なし');
            }
            
            // 2. Web Storage確認
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                log('✅ Web Storage: 利用可能');
            } catch (e) {
                log('❌ Web Storage: 無効');
                log('✅ 解決方法: ブラウザ設定でCookieを有効にしてください');
            }
            
            // 3. Firebaseライブラリ確認
            if (typeof firebase !== 'undefined') {
                log('✅ Firebase SDK: 読み込み済み');
                log(`- Firebase Version: ${firebase.SDK_VERSION || 'Unknown'}`);
            } else {
                log('❌ Firebase SDK: 読み込みエラー');
            }
            
            // 4. ドメイン確認
            const domain = window.location.hostname;
            log(`🏠 現在のドメイン: ${domain}`);
            
            if (domain === 'localhost' || domain === '127.0.0.1') {
                log('✅ ローカル開発: Firebase設定で許可が必要');
            }
            
            log('⚠️ === ログイン問題診断 完了 ===');
        };

        // データベース構造確認
        window.checkDatabaseStructure = async () => {
            if (!currentUser) {
                log('❌ ログインが必要です');
                return;
            }
            
            log('🏗️ === データベース構造確認 開始 ===');
            
            try {
                // 現在のユーザーのweightsデータ構造を確認
                const userRef = database.ref(`users/${currentUser.uid}/weights`);
                const snapshot = await userRef.once('value');
                const data = snapshot.val();
                
                if (data) {
                    const entries = Object.keys(data);
                    log(`📊 現在のユーザー(${currentUser.email})のデータ:`);
                    log(`- データ記録数: ${entries.length}件`);
                    log(`- 最新記録ID: ${entries[entries.length - 1]}`);
                    
                    // サンプルデータ構造を表示
                    const sampleEntry = data[entries[0]];
                    log(`- データ構造: ${JSON.stringify(sampleEntry, null, 2)}`);
                } else {
                    log('📊 現在のユーザーにはデータがありません');
                }
                
                // ルートレベルの構造確認（管理者権限が必要）
                try {
                    const rootRef = database.ref('users');
                    const rootSnapshot = await rootRef.once('value');
                    const allUsers = rootSnapshot.val();
                    
                    if (allUsers) {
                        const userCount = Object.keys(allUsers).length;
                        log(`👥 全体統計:`);
                        log(`- 登録ユーザー数: ${userCount}人`);
                        
                        let totalWeights = 0;
                        Object.values(allUsers).forEach(user => {
                            if (user.weights) {
                                totalWeights += Object.keys(user.weights).length;
                            }
                        });
                        log(`- 全体の体重記録数: ${totalWeights}件`);
                    }
                } catch (error) {
                    log(`⚠️ 全体統計の取得に制限があります: ${error.message}`);
                }
                
            } catch (error) {
                log(`❌ 構造確認エラー: ${error.message}`);
            }
            
            log('🏗️ === データベース構造確認 完了 ===');
        };

        // デバッグ情報をコピー
        window.copyDebugInfo = () => {
            const debugInfo = `体重管理アプリ デバッグ情報
=================================
タイムスタンプ: ${new Date().toLocaleString()}
URL: ${window.location.href}
プロトコル: ${window.location.protocol}
ドメイン: ${window.location.hostname}
ユーザーエージェント: ${navigator.userAgent}

Firebase設定:
- プロジェクトID: ${firebaseConfig.projectId}
- データベースURL: ${firebaseConfig.databaseURL}
- 認証ドメイン: ${firebaseConfig.authDomain}

認証状態: ${currentUser ? 'ログイン済み' : '未ログイン'}
${currentUser ? `- UID: ${currentUser.uid.substring(0,8)}...\n- Email: ${currentUser.email}\n- 表示名: ${currentUser.displayName}` : ''}

Firebase SDK: ${typeof firebase !== 'undefined' ? '読み込み済み' : '読み込みエラー'}
Web Storage: ${(() => {
    try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        return '利用可能';
    } catch (e) {
        return '無効';
    }
})()}

ログ内容:
${document.getElementById('logArea').innerText}`;

            navigator.clipboard.writeText(debugInfo).then(() => {
                alert('✅ デバッグ情報をコピーしました');
            }).catch(() => {
                // fallback
                const textArea = document.createElement('textarea');
                textArea.value = debugInfo;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('✅ デバッグ情報をコピーしました');
            });
        };

        // アプリ初期化
        function initializeApp() {
            // バージョン表示の動的設定
            document.title = `体重管理アプリ ${APP_VERSION}`;
            document.getElementById('appTitle').textContent = `📊 体重管理アプリ ${APP_VERSION}`;
            
            log(`🚀 体重管理アプリ起動完了 ${APP_VERSION}`);
            log('🔐 認証システム準備完了');
        }

        // 初期化実行
        initializeApp();
        
        // プロトコルチェック（自動診断）
        if (window.location.protocol === 'file:') {
            log('⚠️ file://プロトコル検出 - Googleログインには HTTPサーバーが必要です');
            log('💡 解決方法: python -m http.server 8000 または chrome://flags設定');
        }

        // ========== 睡眠管理機能 ==========

        // 睡眠管理用変数
        // 睡眠管理変数はtab-sleep.jsで宣言

        // 睡眠管理初期化
        function initializeSleepManager() {
            // 今日の日付を設定
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;
            
            if (document.getElementById('sleepDateInput')) {
                document.getElementById('sleepDateInput').value = todayString;
                
                // 現在時刻を設定
                const now = new Date();
                const currentHour = String(now.getHours()).padStart(2, '0');
                const currentMinute = String(now.getMinutes()).padStart(2, '0');
                const currentTimeString = `${currentHour}:${currentMinute}`;
                
                const sleepTimeInput = document.getElementById('sleepTimeInput');
                if (sleepTimeInput) {
                    sleepTimeInput.value = currentTimeString;
                }
            }
            
            log('🛏️ 睡眠管理システム初期化完了');
        }


        // 睡眠タイプ選択
        function selectSleepType(type) {
            selectedSleepType = type;
            document.getElementById('selectedSleepType').value = type;
            
            // ボタンのスタイル更新
            document.querySelectorAll('.sleep-type-btn').forEach(btn => {
                if (btn.dataset.type === type) {
                    btn.style.opacity = '1';
                    btn.style.fontWeight = 'bold';
                } else {
                    btn.style.opacity = '0.7';
                    btn.style.fontWeight = 'normal';
                }
            });
            
            log(`🛏️ 睡眠タイプ選択: ${type}`);
        }

        // 睡眠の質選択
        function selectQuality(quality) {
            selectedSleepQuality = quality;
            document.getElementById('selectedQuality').value = quality;
            
            // ボタンのスタイル更新
            document.querySelectorAll('.quality-btn').forEach(btn => {
                if (parseInt(btn.dataset.quality) === quality) {
                    btn.style.opacity = '1';
                    btn.style.fontWeight = 'bold';
                } else {
                    btn.style.opacity = '0.7';
                    btn.style.fontWeight = 'normal';
                }
            });
            
            log(`⭐ 睡眠の質選択: ${quality}点`);
        }

        // 睡眠タグ切り替え
        function toggleSleepTag(tag) {
            const index = selectedSleepTags.indexOf(tag);
            const button = document.querySelector(`[data-tag="${tag}"]`);
            
            if (index === -1) {
                // タグ追加
                selectedSleepTags.push(tag);
                button.style.opacity = '1';
                button.style.fontWeight = 'bold';
                button.style.transform = 'scale(1.05)';
            } else {
                // タグ削除
                selectedSleepTags.splice(index, 1);
                button.style.opacity = '0.7';
                button.style.fontWeight = 'normal';
                button.style.transform = 'scale(1)';
            }
            
            // hidden fieldに保存
            document.getElementById('selectedSleepTags').value = selectedSleepTags.join(',');
            
            // 表示テキスト更新
            const displayElement = document.getElementById('selectedTagsDisplay');
            if (displayElement) {
                displayElement.textContent = selectedSleepTags.length > 0 ? selectedSleepTags.join(', ') : 'なし';
            }
            
            log(`🏷️ 睡眠タグ更新: [${selectedSleepTags.join(', ')}]`);
        }


        // 睡眠データ保存
        async function saveSleepData() {
            if (!currentUser) {
                log('❌ ログインが必要です');
                return;
            }

            // 入力値取得
            const sleepDate = document.getElementById('sleepDateInput').value;
            const sleepTime = document.getElementById('sleepTimeInput').value;
            const sleepMemo = document.getElementById('sleepMemoInput').value;

            // 必須項目チェック
            if (!sleepDate) {
                log('❌ 記録日を入力してください');
                return;
            }

            if (!sleepTime) {
                log('❌ 記録時間を入力してください');
                return;
            }

            // データ構造
            const sleepData = {
                date: sleepDate,
                time: sleepTime,
                sleepType: selectedSleepType || null,
                quality: selectedSleepQuality || null,
                tags: selectedSleepTags.slice(), // 配列のコピー
                memo: sleepMemo || null,
                recordType: 'simple',
                timestamp: new Date().toISOString()
            };

            try {
                // Firebase保存
                const sleepRef = database.ref(`users/${currentUser.uid}/sleepData/${sleepDate}_${Date.now()}`);
                await sleepRef.set(sleepData);
                
                log(`💾 睡眠記録保存完了: ${sleepDate} ${sleepTime}`);
                
                // 入力フィールドリセット
                document.getElementById('sleepMemoInput').value = '';
                selectedSleepType = '';
                selectedSleepQuality = '';
                selectedSleepTags = [];
                document.getElementById('selectedSleepType').value = '';
                document.getElementById('selectedQuality').value = '';
                document.getElementById('selectedSleepTags').value = '';
                
                // ボタンスタイルリセット
                document.querySelectorAll('.sleep-type-btn, .quality-btn, .sleep-tag-btn').forEach(btn => {
                    btn.style.opacity = '0.7';
                    btn.style.fontWeight = 'normal';
                    btn.style.transform = 'scale(1)';
                });
                
                // データ再読み込み
                await loadSleepData();
                
            } catch (error) {
                log(`❌ 保存エラー: ${error.message}`);
            }
        }

        // 睡眠データ読み込み
        async function loadSleepData() {
            if (!currentUser) return;

            try {
                log('🔄 睡眠データ読み込み開始...');
                const sleepRef = database.ref(`users/${currentUser.uid}/sleepData`);
                const snapshot = await sleepRef.once('value');
                
                allSleepData = [];
                if (snapshot.val()) {
                    Object.entries(snapshot.val()).forEach(([key, data]) => {
                        allSleepData.push({id: key, ...data});
                    });
                    log(`📊 睡眠データ読み込み完了: ${allSleepData.length}件`);
                } else {
                    log('📊 睡眠データなし');
                }
                
                // 日付順でソート
                allSleepData.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                updateSleepHistory();
                updateSleepStats();
                
            } catch (error) {
                log(`❌ 睡眠データ読み込みエラー: ${error.message}`);
            }
        }

        // 睡眠履歴表示更新
        function updateSleepHistory() {
            const historyArea = document.getElementById('sleepHistoryArea');
            
            if (allSleepData.length === 0) {
                historyArea.innerHTML = 'まだ睡眠記録がありません';
                return;
            }

            // 直近7件表示
            const recentData = allSleepData.slice(0, 7);
            
            historyArea.innerHTML = recentData.map(data => {
                let content = `<strong>${data.date}</strong> `;
                
                // 記録表示
                content += `<span style="color: #666;">${data.sleepType || '記録'}</span><br>`;
                content += `⏰ ${data.time || data.bedTime || data.wakeTime || '--'}`;
                if (data.quality) content += `<br>⭐ ${data.quality}/5点`;
                
                if (data.tags && data.tags.length > 0) {
                    content += `<br>🏷️ ${data.tags.join(', ')}`;
                }
                if (data.memo) {
                    content += `<br>📝 ${data.memo}`;
                }
                
                return `<div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0;">
                    <div>${content}</div>
                    <button onclick="deleteSleepEntry('${data.id}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; flex-shrink: 0;">🗑️</button>
                </div>`;
            }).join('');
        }

        // 睡眠統計更新
        function updateSleepStats() {
            if (allSleepData.length === 0) {
                document.getElementById('sleepStatsArea').innerHTML = `
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 24px; font-weight: bold; color: #007bff;">--</div>
                        <div style="font-size: 12px; color: #6c757d;">平均睡眠時間</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;">--</div>
                        <div style="font-size: 12px; color: #6c757d;">平均睡眠の質</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 24px; font-weight: bold; color: #ffc107;">--</div>
                        <div style="font-size: 12px; color: #6c757d;">今週の記録数</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">--</div>
                        <div style="font-size: 12px; color: #6c757d;">今月の記録数</div>
                    </div>
                `;
                return;
            }

            // 統計計算
            const avgDuration = allSleepData.reduce((sum, data) => sum + data.duration, 0) / allSleepData.length;
            const avgQuality = allSleepData.reduce((sum, data) => sum + parseInt(data.quality), 0) / allSleepData.length;
            
            // 今週・今月の記録数
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const weekCount = allSleepData.filter(data => new Date(data.date) >= weekAgo).length;
            const monthCount = allSleepData.filter(data => new Date(data.date) >= monthAgo).length;

            document.getElementById('sleepStatsArea').innerHTML = `
                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #007bff;">${avgDuration.toFixed(1)}h</div>
                    <div style="font-size: 12px; color: #6c757d;">平均睡眠時間</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;">${avgQuality.toFixed(1)}</div>
                    <div style="font-size: 12px; color: #6c757d;">平均睡眠の質</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${weekCount}</div>
                    <div style="font-size: 12px; color: #6c757d;">今週の記録数</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">${monthCount}</div>
                    <div style="font-size: 12px; color: #6c757d;">今月の記録数</div>
                </div>
            `;
        }

        // 睡眠履歴コピー
        function copySleepHistory() {
            if (allSleepData.length === 0) {
                log('📋 コピーする睡眠データがありません');
                return;
            }

            const copyText = allSleepData.slice(0, 7).map(data => 
                `${data.date} ${data.sleepType} ${data.bedTime}-${data.wakeTime} (${data.duration.toFixed(1)}h) ⭐${data.quality}/5${data.memo ? ` ${data.memo}` : ''}`
            ).join('\n');

            navigator.clipboard.writeText(copyText).then(() => {
                log('📋 睡眠履歴をクリップボードにコピーしました');
            }).catch(() => {
                log('❌ コピーに失敗しました');
            });
        }

        // 睡眠データ削除
        window.deleteSleepEntry = async (entryId) => {
            if (!currentUser) {
                log('❌ ログインが必要です');
                return;
            }
            
            if (!confirm('この睡眠記録を削除しますか？')) {
                return;
            }
            
            try {
                const entryRef = database.ref(`users/${currentUser.uid}/sleepData/${entryId}`);
                await entryRef.remove();
                
                log('🗑️ 睡眠記録を削除しました');
                await loadSleepData(); // データ再読み込み
                
            } catch (error) {
                log(`❌ 削除エラー: ${error.message}`);
            }
        };

        // ========== 部屋片付け機能 ==========
        
        // 部屋片付け用変数（room-cleaning.jsで宣言済み）
        
        // 部屋片付け管理初期化
        function initRoomManagement() {
            // 現在の日付・時刻を設定
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentTime = now.toTimeString().slice(0, 5);
            
            document.getElementById('roomDateInput').value = today;
            document.getElementById('roomTimeInput').value = currentTime;
            
            // カスタム場所を復元
            loadCustomRooms();
            
            log('🧹 部屋片付け管理初期化完了');
        }
        
        // 場所管理モード設定
        window.setRoomMode = (mode) => {
            currentRoomMode = mode;
            
            // ボタンの見た目を更新
            document.getElementById('roomNormalModeBtn').style.background = mode === 'normal' ? '#007bff' : '#6c757d';
            document.getElementById('roomAddModeBtn').style.background = mode === 'add' ? '#007bff' : '#6c757d';
            document.getElementById('roomDeleteModeBtn').style.background = mode === 'delete' ? '#007bff' : '#6c757d';
            
            // 追加入力エリアの表示切り替え
            const addInput = document.getElementById('roomUnifiedAddInput');
            if (mode === 'add') {
                addInput.style.display = 'block';
            } else {
                addInput.style.display = 'none';
            }
            
            log(`🔧 場所管理モード: ${mode}`);
        };
        
        // 片付け場所選択
        window.selectRoom = (room) => {
            if (currentRoomMode === 'delete') {
                // 削除モード: カスタム場所のみ削除可能
                const isCustomRoom = !['リビング', 'キッチン', '寝室', 'お風呂', 'トイレ', '玄関', 'その他'].includes(room);
                if (isCustomRoom) {
                    if (confirm(`「${room}」を削除しますか？`)) {
                        removeCustomRoom(room);
                    }
                } else {
                    log('❌ デフォルト場所は削除できません');
                }
                return;
            }
            
            // 通常選択
            selectedRoomValue = room;
            document.getElementById('selectedRoom').value = room;
            
            // ボタンのスタイル更新
            document.querySelectorAll('.room-btn').forEach(btn => {
                if (btn.getAttribute('data-room') === room) {
                    btn.style.opacity = '1';
                    btn.style.transform = 'scale(1.05)';
                } else {
                    btn.style.opacity = '0.7';
                    btn.style.transform = 'scale(1)';
                }
            });
            
            log(`📍 場所選択: ${room}`);
        };
        
        // 片付け開始
        window.startRoomCleaning = () => {
            if (!selectedRoomValue) {
                log('❌ 片付け場所を選択してください');
                return;
            }
            
            roomStartTime = new Date();
            const timeString = roomStartTime.toTimeString().slice(0, 5);
            
            // ボタン表示切り替え
            document.getElementById('startRoomBtn').style.display = 'none';
            document.getElementById('endRoomBtn').style.display = 'inline-block';
            
            // 時刻表示を開始時刻に更新
            document.getElementById('roomTimeInput').value = timeString;
            document.getElementById('roomDuration').value = '計測中...';
            
            log(`▶️ 片付け開始: ${selectedRoomValue} - ${timeString}`);
        };
        
        // 片付け終了
        window.endRoomCleaning = () => {
            if (!roomStartTime) {
                log('❌ 片付けが開始されていません');
                return;
            }
            
            roomEndTime = new Date();
            const duration = Math.round((roomEndTime - roomStartTime) / (1000 * 60)); // 分単位
            
            // ボタン表示を戻す
            document.getElementById('startRoomBtn').style.display = 'inline-block';
            document.getElementById('endRoomBtn').style.display = 'none';
            
            // 時間表示を更新
            document.getElementById('roomDuration').value = `${duration}分`;
            
            log(`⏹️ 片付け終了: ${selectedRoomValue} - ${duration}分間`);
        };
        
        // 達成度選択
        window.selectAchievement = (level) => {
            selectedRoomAchievement = level;
            document.getElementById('selectedAchievement').value = `${level}/5`;
            
            // ボタンのスタイル更新
            document.querySelectorAll('.achievement-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            const selectedBtn = document.querySelector(`[onclick="selectAchievement(${level})"]`);
            if (selectedBtn) {
                selectedBtn.style.opacity = '1';
                selectedBtn.style.transform = 'scale(1.1)';
            }
            
            log(`📊 達成度選択: ${level}/5`);
        };
        
        // カスタム場所追加
        window.executeRoomAdd = () => {
            const roomName = document.getElementById('roomUnifiedAddText').value.trim();
            if (!roomName) {
                log('❌ 場所名を入力してください');
                return;
            }
            
            // 重複チェック
            const existingBtn = document.querySelector(`[data-room="${roomName}"]`);
            if (existingBtn) {
                log(`❌ 「${roomName}」は既に存在します`);
                return;
            }
            
            // ボタンを追加
            addCustomRoomButton(roomName);
            
            // カスタム場所をlocalStorageに保存
            saveCustomRooms();
            
            // 入力をクリア
            document.getElementById('roomUnifiedAddText').value = '';
            setRoomMode('normal');
            
            log(`✅ 新しい場所追加: ${roomName}`);
        };
        
        // カスタム場所追加キャンセル
        window.cancelRoomAdd = () => {
            document.getElementById('roomUnifiedAddText').value = '';
            setRoomMode('normal');
            log('❌ 場所追加をキャンセル');
        };
        
        // カスタム場所削除
        function removeCustomRoom(roomName) {
            const roomBtn = document.querySelector(`[data-room="${roomName}"]`);
            if (roomBtn) {
                roomBtn.remove();
                saveCustomRooms(); // 削除後に保存
                log(`🗑️ 場所削除: ${roomName}`);
            }
        }
        
        // カスタム場所ボタン作成
        function addCustomRoomButton(roomName) {
            const roomButtons = document.getElementById('roomButtons');
            const newButton = document.createElement('button');
            newButton.type = 'button';
            newButton.className = 'room-btn';
            newButton.onclick = () => selectRoom(roomName);
            newButton.setAttribute('data-room', roomName);
            newButton.style.cssText = 'background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7;';
            newButton.textContent = `🏠 ${roomName}`;
            
            roomButtons.appendChild(newButton);
        }
        
        // カスタム場所をlocalStorageに保存
        function saveCustomRooms() {
            const defaultRooms = ['リビング', 'キッチン', '寝室', 'お風呂', 'トイレ', '玄関', 'その他'];
            const customRooms = Array.from(document.querySelectorAll('.room-btn'))
                .map(btn => btn.getAttribute('data-room'))
                .filter(room => !defaultRooms.includes(room));
            
            localStorage.setItem('roomApp_customRooms', JSON.stringify(customRooms));
            log(`💾 カスタム場所保存: ${customRooms.length}件`);
        }
        
        // カスタム場所をlocalStorageから復元
        function loadCustomRooms() {
            try {
                const saved = localStorage.getItem('roomApp_customRooms');
                if (saved) {
                    const customRooms = JSON.parse(saved);
                    customRooms.forEach(roomName => {
                        addCustomRoomButton(roomName);
                    });
                    log(`📂 カスタム場所復元: ${customRooms.length}件`);
                }
            } catch (error) {
                log(`❌ カスタム場所復元エラー: ${error.message}`);
            }
        }
        
        // 部屋片付けデータ保存
        window.saveRoomData = async () => {
            if (!currentUser) {
                log('❌ ログインが必要です');
                return;
            }
            
            if (!selectedRoomValue) {
                log('❌ 片付け場所を選択してください');
                return;
            }
            
            if (!selectedRoomAchievement) {
                log('❌ 達成度を選択してください');
                return;
            }
            
            const duration = document.getElementById('roomDuration').value;
            if (duration === '開始ボタンで計測開始' || duration === '計測中...') {
                log('❌ 片付け時間を計測してください');
                return;
            }
            
            try {
                log('💾 部屋片付けデータを保存中...');
                
                const roomData = {
                    date: document.getElementById('roomDateInput').value,
                    time: document.getElementById('roomTimeInput').value,
                    room: selectedRoomValue,
                    duration: duration,
                    achievement: selectedRoomAchievement,
                    memo: document.getElementById('roomMemoInput').value || '',
                    userEmail: currentUser.email,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    createdAt: new Date().toISOString()
                };
                
                const userRef = database.ref(`users/${currentUser.uid}/roomData`);
                await userRef.push(roomData);
                
                log(`✅ 片付け記録保存完了: ${selectedRoomValue} - ${duration} (達成度${selectedRoomAchievement}/5)`);
                
                // フォームをリセット
                resetRoomForm();
                
                // データ再読み込み
                await loadRoomData();
                
            } catch (error) {
                log(`❌ 保存エラー: ${error.message}`);
            }
        };
        
        // 部屋片付けデータ読み込み（外部JSファイルで定義済み）
        
        // フォームリセット
        function resetRoomForm() {
            selectedRoomValue = '';
            selectedRoomAchievement = null;
            roomStartTime = null;
            roomEndTime = null;
            
            document.getElementById('selectedRoom').value = '';
            document.getElementById('selectedAchievement').value = '';
            document.getElementById('roomDuration').value = '開始ボタンで計測開始';
            document.getElementById('roomMemoInput').value = '';
            
            // ボタンスタイルをリセット
            document.querySelectorAll('.room-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            document.querySelectorAll('.achievement-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            // 開始・終了ボタンをリセット
            document.getElementById('startRoomBtn').style.display = 'inline-block';
            document.getElementById('endRoomBtn').style.display = 'none';
            
            // 日時を現在時刻に更新
            const now = new Date();
            document.getElementById('roomDateInput').value = now.toISOString().split('T')[0];
            document.getElementById('roomTimeInput').value = now.toTimeString().slice(0, 5);
        }
        
        // 部屋片付け履歴表示更新
        function updateRoomHistory() {
            log('🔍 updateRoomHistory() 開始');
            const historyArea = document.getElementById('roomHistoryArea');
            
            log(`📊 部屋データ件数: ${allRoomData.length}`);
            log('🔍 historyArea要素:', historyArea ? '存在' : '見つからない');
            
            if (!historyArea) {
                log('❌ roomHistoryArea要素が見つかりません');
                return;
            }
            
            if (allRoomData.length === 0) {
                historyArea.innerHTML = 'まだ片付け記録がありません';
                log('ℹ️ 部屋データなし - プレースホルダー表示');
                return;
            }
            
            // 直近7件表示
            const recentData = allRoomData.slice(0, 7);
            log(`📋 表示データ件数: ${recentData.length}`);
            
            historyArea.innerHTML = recentData.map(data => {
                let content = `<strong>${data.date}</strong> ${data.time} `;
                content += `📍 ${data.room} `;
                content += `⏱️ ${data.duration} `;
                content += `📊 ${data.achievement}/5`;
                if (data.memo) {
                    content += `<br>📝 ${data.memo}`;
                }
                
                return `<div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0;">
                    <div>${content}</div>
                    <button onclick="deleteRoomEntry('${data.id}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; flex-shrink: 0;">🗑️</button>
                </div>`;
            }).join('');
            
            log('✅ updateRoomHistory() 完了');
        }
        
        // 部屋片付け統計更新
        function updateRoomStats() {
            const totalSessions = allRoomData.length;
            const totalMinutes = allRoomData.reduce((sum, data) => {
                const minutes = parseInt(data.duration) || 0;
                return sum + minutes;
            }, 0);
            const avgAchievement = totalSessions > 0 ? 
                (allRoomData.reduce((sum, data) => sum + (data.achievement || 0), 0) / totalSessions).toFixed(1) : 0;
            
            // 今月の記録数
            const thisMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            const thisMonthCount = allRoomData.filter(data => data.date.startsWith(thisMonth)).length;
            
            document.getElementById('totalRoomSessions').textContent = totalSessions;
            document.getElementById('totalRoomTime').textContent = `${totalMinutes}分`;
            document.getElementById('avgRoomAchievement').textContent = avgAchievement;
            document.getElementById('thisMonthRoomCount').textContent = thisMonthCount;
        }
        
        // 部屋片付け履歴コピー
        window.copyRoomHistory = () => {
            if (allRoomData.length === 0) {
                log('📋 コピーする片付けデータがありません');
                return;
            }
            
            const copyText = allRoomData.slice(0, 7).map(data => 
                `${data.date} ${data.time} ${data.room} ${data.duration} 達成度${data.achievement}/5${data.memo ? ` ${data.memo}` : ''}`
            ).join('\n');
            
            navigator.clipboard.writeText(copyText).then(() => {
                log('📋 片付け履歴をクリップボードにコピーしました');
            }).catch(() => {
                log('❌ コピーに失敗しました');
            });
        };
        
        // 部屋片付けデータ削除
        window.deleteRoomEntry = async (entryId) => {
            if (!currentUser) {
                log('❌ ログインが必要です');
                return;
            }
            
            if (!confirm('この片付け記録を削除しますか？')) {
                return;
            }
            
            try {
                const entryRef = database.ref(`users/${currentUser.uid}/roomData/${entryId}`);
                await entryRef.remove();
                
                log('🗑️ 片付け記録を削除しました');
                await loadRoomData();
                
            } catch (error) {
                log(`❌ 削除エラー: ${error.message}`);
            }
        };

        // ===================== 
        // メモリスト機能 (分離済み - memo-list.jsに移動) - 全てコメントアウト
        /*
        // =====================
        // let memoData = [];

        // 重要度の色を取得
        function getPriorityColor(priority) {
            switch(priority) {
                case 'S': return '#dc3545'; // 赤
                case 'A': return '#fd7e14'; // オレンジ
                case 'B': return '#ffc107'; // 黄色
                case 'C': return '#6c757d'; // グレー
                default: return '#6c757d';
            }
        }

        // 重要度のアイコンを取得
        function getPriorityIcon(priority) {
            switch(priority) {
                case 'S': return '🔥';
                case 'A': return '⚡';
                case 'B': return '📋';
                case 'C': return '📝';
                default: return '';
            }
        }

        // 対応時間の色を取得
        function getTimeframeColor(timeframe) {
            switch(timeframe) {
                case '短期': return '#28a745'; // 緑
                case '中長期': return '#17a2b8'; // 青
                default: return '#6c757d';
            }
        }

        // 対応時間のアイコンを取得
        function getTimeframeIcon(timeframe) {
            switch(timeframe) {
                case '短期': return '⚡';
                case '中長期': return '📅';
                default: return '';
            }
        }

        // メモを追加
        window.addMemo = () => {
            const memoText = document.getElementById('newMemoText').value.trim();
            const category = document.getElementById('memoCategory').value;
            const priority = document.getElementById('memoPriority').value;
            const timeframe = document.getElementById('memoTimeframe').value;
            
            if (!memoText) {
                alert('メモ内容を入力してください');
                return;
            }
            
            const now = new Date();
            const memo = {
                id: Date.now(),
                text: memoText,
                category: category,
                priority: priority,
                timeframe: timeframe,
                timestamp: now.toISOString(),
                date: now.toLocaleDateString('ja-JP'),
                time: now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })
            };
            
            memoData.unshift(memo); // 新しいメモを先頭に追加
            
            // Firebaseに保存
            if (currentUser) {
                saveMemoToFirebase(memo);
            } else {
                // ローカルストレージに保存
                localStorage.setItem('memos', JSON.stringify(memoData));
            }
            
            // 表示を更新
            updateMemoDisplay();
            updateMemoStats();
            
            // フォームをクリア
            document.getElementById('newMemoText').value = '';
            document.getElementById('memoCategory').value = '';
            document.getElementById('memoPriority').value = '';
            document.getElementById('memoTimeframe').value = '';
            
            log(`📝 メモを追加しました${category ? ` [${category}]` : ''}: ${memoText.substring(0, 30)}${memoText.length > 30 ? '...' : ''}`);
        };

        // Firebaseにメモを保存
        function saveMemoToFirebase(memo) {
            if (!currentUser || !firebase.database) return;
            
            firebase.database().ref(`users/${currentUser.uid}/memos/${memo.id}`).set(memo)
            .then(() => {
                console.log('メモをFirebaseに保存しました');
            })
            .catch((error) => {
                console.error('Firebaseへの保存に失敗:', error);
                log('❌ メモの保存に失敗しました');
            });
        }

        // メモ表示を更新
        function updateMemoDisplay() {
            log('🔍 updateMemoDisplay() 開始');
            const container = document.getElementById('memoListArea');
            
            log(`📊 メモデータ件数: ${memoData.length}`);
            log('🔍 memoListArea要素:', container ? '存在' : '見つからない');
            
            if (!container) {
                log('❌ memoListArea要素が見つかりません');
                return;
            }
            
            if (memoData.length === 0) {
                container.innerHTML = 'まだメモがありません';
                log('ℹ️ メモデータなし - プレースホルダー表示');
                return;
            }
            
            const html = memoData.map(memo => {
                const categoryBadge = memo.category ? 
                    `<span style="background: #6c757d; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-right: 5px;">${memo.category}</span>` : '';
                
                // 重要度のバッジ
                const priorityBadge = memo.priority ? 
                    `<span style="background: ${getPriorityColor(memo.priority)}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-right: 5px; font-weight: bold;">${getPriorityIcon(memo.priority)} ${memo.priority}</span>` : '';
                
                // 対応時間のバッジ
                const timeframeBadge = memo.timeframe ? 
                    `<span style="background: ${getTimeframeColor(memo.timeframe)}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-right: 5px;">${getTimeframeIcon(memo.timeframe)} ${memo.timeframe}</span>` : '';
                
                return `
                    <div class="memo-item">
                        <div class="memo-header">
                            <div style="flex: 1;">
                                ${priorityBadge}${timeframeBadge}${categoryBadge}
                                <small class="memo-date">${memo.date} ${memo.time}</small>
                            </div>
                            <button onclick="deleteMemo(${memo.id})" class="memo-delete-btn">🗑️</button>
                        </div>
                        <div class="memo-text">
                            ${memo.text}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            
            log('✅ updateMemoDisplay() 完了');
        }

        // メモを削除
        window.deleteMemo = (memoId) => {
            if (!confirm('このメモを削除しますか？')) {
                return;
            }
            
            memoData = memoData.filter(memo => memo.id !== memoId);
            
            // Firebaseから削除
            if (currentUser) {
                firebase.database().ref(`users/${currentUser.uid}/memos/${memoId}`).remove();
            } else {
                // ローカルストレージを更新
                localStorage.setItem('memos', JSON.stringify(memoData));
            }
            
            updateMemoDisplay();
            updateMemoStats();
            log('🗑️ メモを削除しました');
        };

        // clearAllMemos関数は安全上の理由により完全削除済み

        // メモ統計を更新
        function updateMemoStats() {
            const now = new Date();
            const today = now.toLocaleDateString('ja-JP');
            
            // 今週の開始日（月曜日）を計算
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - ((now.getDay() + 6) % 7));
            weekStart.setHours(0, 0, 0, 0);
            
            // 今月の開始日を計算
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const todayCount = memoData.filter(memo => memo.date === today).length;
            const weekCount = memoData.filter(memo => new Date(memo.timestamp) >= weekStart).length;
            const monthCount = memoData.filter(memo => new Date(memo.timestamp) >= monthStart).length;
            
            document.getElementById('totalMemoCount').textContent = memoData.length;
            document.getElementById('todayMemoCount').textContent = todayCount;
            document.getElementById('weekMemoCount').textContent = weekCount;
            document.getElementById('monthMemoCount').textContent = monthCount;
        }

        // 全メモをコピー
        window.copyAllMemos = () => {
            if (memoData.length === 0) {
                alert('コピーするメモがありません');
                return;
            }
            
            const copyText = memoData.map(memo => {
                const categoryText = memo.category ? `[${memo.category}] ` : '';
                return `${memo.date} ${memo.time} ${categoryText}${memo.text}`;
            }).join('\n\n');
            
            navigator.clipboard.writeText(copyText).then(() => {
                log('📋 全メモをクリップボードにコピーしました');
            }).catch(() => {
                log('❌ コピーに失敗しました');
            });
        };

        // メモデータを読み込み
        function loadMemoData() {
            log('📚 loadMemoData() 開始');
            if (currentUser) {
                // Firebaseから読み込み
                firebase.database().ref(`users/${currentUser.uid}/memos`).on('value', (snapshot) => {
                    log('🔥 Firebaseからメモデータ取得中...');
                    const data = snapshot.val();
                    if (data) {
                        memoData = Object.values(data).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        log(`✅ メモデータ${memoData.length}件を取得`);
                    } else {
                        memoData = [];
                        log('ℹ️ Firebaseにメモデータなし');
                    }
                    log('🔄 updateMemoDisplay()、updateMemoStats()を呼び出し');
                    updateMemoDisplay();
                    updateMemoStats();
                });
            } else {
                // ローカルストレージから読み込み
                const stored = localStorage.getItem('memos');
                if (stored) {
                    memoData = JSON.parse(stored);
                }
                updateMemoDisplay();
                updateMemoStats();
            }
        }

        // Enterキーでメモ追加（Ctrl+Enterの場合）
        document.addEventListener('DOMContentLoaded', () => {
            const memoTextArea = document.getElementById('newMemoText');
            if (memoTextArea) {
                memoTextArea.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        addMemo();
                    }
                });
            }
            
            // 未ログイン時のメモデータ初期化
            if (!currentUser) {
                loadMemoData();
            }
        });
        */ // メモリスト機能コメント終了

    </script>
</body>
</html>
