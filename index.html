
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰ΩìÈáçÁÆ°ÁêÜ„Ç¢„Éó„É™</title>
    
    <!-- „Ç´„Çπ„Çø„É†„Çπ„Çø„Ç§„É´ -->
    <link rel="stylesheet" href="custom/styles.css">
    
    <!-- „Çø„ÉñÂõ∫Êúâ„Çπ„Çø„Ç§„É´ -->
    <link rel="stylesheet" href="tabs/tab3-room-cleaning/room-cleaning.css">
    <link rel="stylesheet" href="tabs/tab8-memo-list/memo-list.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Chart.js with date adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <!-- „Ç´„Çπ„Çø„É†Ë®≠ÂÆö -->
    <script type="module" src="custom/app-config.js"></script>
    
    <!-- „Çø„ÉñÂõ∫ÊúâJavaScript -->
    <script src="tabs/tab3-room-cleaning/room-cleaning.js"></script>
    <script src="tabs/tab8-memo-list/memo-list.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 2px; background: #f5f5f5; line-height: 1.2; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 6px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* „Çπ„Éû„ÉõÂØæÂøú */
        @media (max-width: 768px) {
            body { padding: 3px; }
            .container { padding: 8px; margin: 0; border-radius: 0; }
            .weight-input { grid-template-columns: 1fr; gap: 8px; }
            .input-card { padding: 8px; }
        }
        .auth-section { background: #e7f3ff; color: #0c5460; padding: 6px; border-radius: 5px; margin-bottom: 6px; text-align: center; }
        .weight-input { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin: 8px 0; }
        .input-card { border: 1px solid #ddd; padding: 8px; border-radius: 8px; }
        
        /* „É°„É¢„É™„Çπ„ÉàÁî®„Çπ„Çø„Ç§„É´ */
        .memo-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            background: #fefefe;
        }
        .memo-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }
        .memo-category {
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-right: 5px;
        }
        .memo-date {
            color: #666;
            font-size: 11px;
        }
        .memo-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
            color: #333;  /* ÊñáÂ≠ó„ÇíÊøÉ„Åè„Åó„Å¶Ë™≠„Åø„ÇÑ„Åô„Åè */
            font-weight: 500;  /* „ÇÑ„ÇÑÂ§™„ÇÅ„Å´„Åó„Å¶Ë¶ñË™çÊÄßÂêë‰∏ä */
        }
        .memo-delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            margin-left: 10px;
        }
        .memo-delete-btn:hover {
            background: #c82333;
        }
        
        /* „Çø„Ç§„Éü„É≥„Ç∞„Éë„Éç„É´„ÅÆ„Çπ„Çø„Ç§„É´ */
        .timing-panel { 
            background: #f8f9fa; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            padding: 8px; 
            margin: 5px 0; 
        }
        .timing-buttons { 
            display: flex; 
            gap: 4px; 
            flex-wrap: wrap; 
            justify-content: center;
        }
        .timing-btn { 
            background: #6c757d; 
            color: white; 
            border: none; 
            padding: 6px 8px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 11px;
            transition: all 0.2s;
            min-width: 85px;
            text-align: center;
            flex: 1;
            max-width: 120px;
        }
        .timing-btn:hover {
            transform: scale(1.05);
        }
        .timing-btn.selected {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .timing-buttons { gap: 3px; }
            .timing-btn { 
                padding: 4px 6px; 
                font-size: 10px;
                min-width: 75px;
            }
        }

        /* ÊúçË£Ö„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´Áµ±‰∏Ä */
        .clothing-btn {
            border: none;
            padding: 6px 8px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 10px;
            min-width: 85px;
            text-align: center;
            transition: all 0.2s;
            flex: 1;
            max-width: 120px;
        }
        .clothing-btn:hover {
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .clothing-btn {
                padding: 4px 6px;
                min-width: 75px;
                font-size: 9px;
            }
        }
        .input-field { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 5px 0; font-size: 16px; }
        .save-button { background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin: 5px; font-size: 16px; }
        .save-button:hover { background: #218838; }
        .auth-button { background: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .auth-button:hover { background: #357ae8; }
        .logout-button { background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .data-area { background: #f8f9fa; border: 1px solid #dee2e6; padding: 8px; border-radius: 5px; font-family: monospace; min-height: 120px; }
        .hidden { display: none; }
        .user-info { background: #d4edda; color: #155724; padding: 4px 6px; border-radius: 5px; margin-bottom: 6px; font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Ë°®Á§∫Ôºà‰∏ÄÁï™‰∏äÔºâ -->
        <div class="user-info hidden" id="userInfo" style="margin-bottom: 10px;">
            <span>üë§ „É≠„Ç∞„Ç§„É≥‰∏≠: <span id="userName"></span></span>
            <button class="logout-button" onclick="handleLogout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
        </div>

        <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
        <div id="tabNavigation" class="hidden" style="margin-bottom: 15px;">
            <div style="display: flex; border-bottom: 2px solid #ddd; flex-wrap: wrap;">
                <button id="tab1" class="tab-btn active" onclick="switchTab(1)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #007bff; color: white; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">‰ΩìÈáç</button>
                <button id="tab2" class="tab-btn" onclick="switchTab(2)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">Áù°Áú†</button>
                <button id="tab3" class="tab-btn" onclick="switchTab(3)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">ÈÉ®Â±ãÁâá„Å•„Åë</button>
                <button id="tab4" class="tab-btn" onclick="switchTab(4)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">„Çπ„Éà„É¨„ÉÉ„ÉÅ</button>
                <button id="tab5" class="tab-btn" onclick="switchTab(5)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx5</button>
                <button id="tab6" class="tab-btn" onclick="switchTab(6)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx6</button>
                <button id="tab7" class="tab-btn" onclick="switchTab(7)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx7</button>
                <button id="tab8" class="tab-btn" onclick="switchTab(8)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">„É°„É¢„É™„Çπ„Éà</button>
            </div>
            <!-- 2Ë°åÁõÆ„ÅÆ„Çø„ÉñÔºà9-16Ôºâ -->
            <div style="display: flex; border-bottom: 2px solid #ddd; flex-wrap: wrap;">
                <button id="tab9" class="tab-btn" onclick="switchTab(9)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx9</button>
                <button id="tab10" class="tab-btn" onclick="switchTab(10)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx10</button>
                <button id="tab11" class="tab-btn" onclick="switchTab(11)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx11</button>
                <button id="tab12" class="tab-btn" onclick="switchTab(12)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx12</button>
                <button id="tab13" class="tab-btn" onclick="switchTab(13)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx13</button>
                <button id="tab14" class="tab-btn" onclick="switchTab(14)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx14</button>
                <button id="tab15" class="tab-btn" onclick="switchTab(15)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 1px; margin-bottom: 1px; font-size: 12px;">xx15</button>
                <button id="tab16" class="tab-btn" onclick="switchTab(16)" style="flex: 1; min-width: 80px; padding: 8px 10px; border: none; background: #f8f9fa; color: #495057; cursor: pointer; border-radius: 5px 5px 0 0; margin-bottom: 1px; font-size: 12px;">xx16</button>
            </div>
        </div>

        <!-- „Ç¢„Éó„É™„Çø„Ç§„Éà„É´ -->
        <div class="app-header hidden" id="appHeader">
            <h1 class="app-title" id="appTitle">üìä ‰ΩìÈáçÁÆ°ÁêÜ„Ç¢„Éó„É™</h1>
            <p class="app-subtitle">Core/Custom„Éï„Ç©„É´„ÉÄÂàÜÈõ¢Áâà - Firebase + GoogleË™çË®º</p>
        </div>

        <!-- Ë™çË®º„Çª„ÇØ„Ç∑„Éß„É≥ -->
        <div class="auth-section" id="authSection">
            <h1 class="app-title">üìä ‰ΩìÈáçÁÆ°ÁêÜ„Ç¢„Éó„É™</h1>
            <p class="app-subtitle">Core/Custom„Éï„Ç©„É´„ÉÄÂàÜÈõ¢Áâà - Firebase + GoogleË™çË®º</p>
            <h3>üîê „É≠„Ç∞„Ç§„É≥</h3>
            <p>Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Éá„Éº„Çø„Çí‰øùÂ≠ò„ÉªÂêåÊúü„Åß„Åç„Åæ„Åô</p>
            <button class="auth-button" onclick="handleGoogleLogin()">Google„Åß„É≠„Ç∞„Ç§„É≥</button>
        </div>

        <!-- „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div id="tabContent1" class="tab-content">
            <!-- ‰ΩìÈáçÁÆ°ÁêÜ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØÂãïÁöÑË™≠„ÅøËæº„Åø -->
            <div style="text-align: center; padding: 20px; color: #666;">
                <span>üìä ‰ΩìÈáçÁÆ°ÁêÜÊ©üËÉΩ„ÇíË™≠„ÅøËæº„Åø‰∏≠...</span>
            </div>
        <!-- „É¢„Éº„ÉâÈÅ∏Êäû„Ç®„É™„Ç¢ -->
        <div class="mode-control hidden" id="modeControl" style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 8px; margin: 8px 0; text-align: center;">
            <div style="margin-bottom: 8px;">
                <span style="font-size: 13px; color: #444; font-weight: bold;">üîß Êìç‰Ωú„É¢„Éº„Éâ</span>
            </div>
            <div style="display: flex; gap: 5px; justify-content: center; margin-bottom: 8px;">
                <button id="normalModeBtn" onclick="setMode('normal')" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 11px;">üìù ÈÄöÂ∏∏</button>
                <button id="addModeBtn" onclick="setMode('add')" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 11px;">‚ûï ËøΩÂä†</button>
                <button id="deleteModeBtn" onclick="setMode('delete')" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 11px;">üóëÔ∏è ÂâäÈô§</button>
            </div>
            <div style="display: flex; gap: 5px; justify-content: center; align-items: center;">
                <span style="font-size: 11px; color: #666;">ÂØæË±°:</span>
                <button id="timingTargetBtn" onclick="selectTarget('timing')" style="background: #6c757d; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">‚è∞ „Çø„Ç§„Éü„É≥„Ç∞</button>
                <button id="topTargetBtn" onclick="selectTarget('top')" style="background: #6c757d; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">üëï ‰∏ä</button>
                <button id="bottomTargetBtn" onclick="selectTarget('bottom')" style="background: #6c757d; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">üëñ ‰∏ã</button>
            </div>
            
            <!-- ËøΩÂä†„É¢„Éº„ÉâÁî®„ÅÆÁµ±‰∏ÄÂÖ•Âäõ„Ç®„É™„Ç¢ -->
            <div id="unifiedAddInput" style="display: none; margin-top: 8px; padding: 8px; background: #e8f5e8; border-radius: 5px; border: 2px solid #28a745;">
                <div style="margin-bottom: 5px;">
                    <span style="font-size: 11px; color: #155724; font-weight: bold;">‚ú® Êñ∞Ë¶èÈ†ÖÁõÆ„ÇíËøΩÂä†</span>
                </div>
                <div style="display: flex; gap: 3px; align-items: center;">
                    <input type="text" id="unifiedAddText" placeholder="È†ÖÁõÆÂêç„ÇíÂÖ•Âäõ" style="flex: 1; padding: 4px 8px; border: 1px solid #28a745; border-radius: 3px; font-size: 11px;">
                    <button onclick="executeAdd()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">‚úì ËøΩÂä†</button>
                    <button onclick="cancelAdd()" style="background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">‚úó „Ç≠„É£„É≥„Çª„É´</button>
                </div>
            </div>
        </div>

        <!-- „Éá„Éº„ÇøÂÖ•Âäõ„Çª„ÇØ„Ç∑„Éß„É≥ -->
        <div class="weight-input hidden" id="weightInput">
            <div class="input-card">
                <h3 style="margin-top: 0; margin-bottom: 8px;">üìù „Éá„Éº„Çø„ÇíË®òÈå≤</h3>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="date" class="input-field" id="dateInput" style="flex: 1; min-width: 140px;">
                    <input type="number" class="input-field" id="weightValue" placeholder="ÂÄ§" step="0.1" min="0" max="300" value="72.0" style="flex: 1; min-width: 100px;" onkeydown="handleWeightKeypress(event)">
                    <span style="font-size: 11px; color: #666; white-space: nowrap;">‚Üë‚Üì„ÅßË™øÊï¥</span>
                </div>
                
                <!-- „Çø„Ç§„Éü„É≥„Ç∞ÈÅ∏Êäû„Éë„Éç„É´ -->
                <div class="timing-panel">
                    <div style="text-align: center; margin-bottom: 8px;">
                        <span style="font-size: 13px; color: #444; font-weight: bold;">‚è∞ „Çø„Ç§„Éü„É≥„Ç∞</span>
                    </div>
                    <div class="timing-buttons" id="timingButtons">
                        <button type="button" class="timing-btn" onclick="selectTiming('Ëµ∑Â∫äÂæå')" data-timing="Ëµ∑Â∫äÂæå" style="background: #55a3ff;">üõèÔ∏è Ëµ∑Â∫äÂæå</button>
                        <button type="button" class="timing-btn" onclick="selectTiming('„Éà„Ç§„É¨Ââç')" data-timing="„Éà„Ç§„É¨Ââç" style="background: #81ecec;">üöΩ „Éà„Ç§„É¨Ââç</button>
                        <button type="button" class="timing-btn" onclick="selectTiming('„Éà„Ç§„É¨Âæå')" data-timing="„Éà„Ç§„É¨Âæå" style="background: #74b9ff;">üöΩ „Éà„Ç§„É¨Âæå</button>
                        <button type="button" class="timing-btn" onclick="selectTiming('È¢®ÂëÇÂâç')" data-timing="È¢®ÂëÇÂâç" style="background: #fd79a8;">üõÅ È¢®ÂëÇÂâç</button>
                        <button type="button" class="timing-btn" onclick="selectTiming('È¢®ÂëÇÂæå')" data-timing="È¢®ÂëÇÂæå" style="background: #00b894;">üõÄ È¢®ÂëÇÂæå</button>
                        <button type="button" class="timing-btn" onclick="selectTiming('È£ü‰∫ãÂâç')" data-timing="È£ü‰∫ãÂâç" style="background: #e84393;">üçΩÔ∏è È£ü‰∫ãÂâç</button>
                        <button type="button" class="timing-btn" onclick="selectTiming('È£ü‰∫ãÂæå')" data-timing="È£ü‰∫ãÂæå" style="background: #a29bfe;">üçΩÔ∏è È£ü‰∫ãÂæå</button>
                    </div>
                    <input type="text" class="input-field" id="selectedTiming" placeholder="„Çø„Ç§„Éü„É≥„Ç∞" readonly style="margin-top: 5px; font-size: 12px; padding: 6px; text-align: center; background: #f0f8ff;">
                </div>
                
                <!-- ÊúçË£ÖË®òÈå≤„Éë„Éç„É´ (Âæ©Ê¥ª+ÊîπËâØÁâà) -->
                <div class="clothing-panel" style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 8px; margin: 5px 0;">
                    <h4 style="margin: 2px 0 5px 0; font-size: 13px; text-align: center;">üëï ÊúçË£ÖË®òÈå≤</h4>
                    
                    <!-- ‰∏äÂçäË∫´ -->
                    <div style="margin: 3px 0;">
                        <div style="text-align: center; margin-bottom: 3px;">
                            <span style="font-size: 11px; color: #444;">‰∏ä:</span>
                        </div>
                        <div id="topClothingButtons" style="display: flex; gap: 3px; flex-wrap: wrap; justify-content: center;">
                            <button type="button" class="clothing-btn" onclick="selectClothingTop('„Å™„Åó')" data-clothing-top="„Å™„Åó" style="background: #e0e0e0; color: #424242;">‚ùå „Å™„Åó</button>
                            <button type="button" class="clothing-btn" onclick="selectClothingTop('‰∏ãÁùÄ„Ç∑„É£„ÉÑ')" data-clothing-top="‰∏ãÁùÄ„Ç∑„É£„ÉÑ" style="background: #87ceeb; color: #2f4f4f;">üëï ‰∏ãÁùÄ„Ç∑„É£„ÉÑ</button>
                            <button type="button" class="clothing-btn" onclick="selectClothingTop('„ÉØ„Ç§„Ç∑„É£„ÉÑ')" data-clothing-top="„ÉØ„Ç§„Ç∑„É£„ÉÑ" style="background: #add8e6; color: #2f4f4f;">üëî „ÉØ„Ç§„Ç∑„É£„ÉÑ</button>
                        </div>
                        <input type="text" class="input-field" id="selectedTop" placeholder="‰∏ä" readonly style="margin-top: 2px; font-size: 10px; padding: 4px; text-align: center; background: #ffffff;">
                    </div>
                    
                    <!-- ‰∏ãÂçäË∫´ -->
                    <div style="margin: 3px 0;">
                        <div style="text-align: center; margin-bottom: 3px;">
                            <span style="font-size: 11px; color: #444;">‰∏ã:</span>
                        </div>
                        <div id="bottomClothingButtons" style="display: flex; gap: 3px; flex-wrap: wrap; justify-content: center;">
                            <button type="button" class="clothing-btn" onclick="selectClothingBottom('„Å™„Åó')" data-clothing-bottom="„Å™„Åó" style="background: #e0e0e0; color: #424242;">‚ùå „Å™„Åó</button>
                            <button type="button" class="clothing-btn" onclick="selectClothingBottom('„Éà„É©„É≥„ÇØ„Çπ')" data-clothing-bottom="„Éà„É©„É≥„ÇØ„Çπ" style="background: #dda0dd; color: #4b0082;">ü©≤ „Éà„É©„É≥„ÇØ„Çπ</button>
                            <button type="button" class="clothing-btn" onclick="selectClothingBottom('„Éè„Éº„Éï„Éë„É≥„ÉÑ')" data-clothing-bottom="„Éè„Éº„Éï„Éë„É≥„ÉÑ" style="background: #f0e68c; color: #8b4513;">ü©≥ „Éè„Éº„Éï„Éë„É≥„ÉÑ</button>
                        </div>
                        <input type="text" class="input-field" id="selectedBottom" placeholder="‰∏ã" readonly style="margin-top: 2px; font-size: 10px; padding: 4px; text-align: center; background: #ffffff;">
                    </div>
                </div>
                
                <textarea class="input-field" id="memoInput" placeholder="„É°„É¢ („Ç™„Éó„Ç∑„Éß„É≥)" rows="2"></textarea>
                <button class="save-button" onclick="saveWeightData()">üíæ ‰øùÂ≠ò</button>
            </div>
        </div>

        <!-- „Ç∞„É©„Éï„Éë„Éç„É´Ôºà‰∏ä„Å´ÁßªÂãïÔºâ -->
        <div class="input-card hidden" id="chartPanel">
            <h3>üìä „Éá„Éº„ÇøÊé®Áßª„Ç∞„É©„Éï</h3>
            <div style="position: relative; height: 300px;">
                <canvas id="weightChart"></canvas>
            </div>
            
            <!-- ÊúüÈñìÈÅ∏Êäû„Å®„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
            <div style="margin-top: 10px;">
                <!-- ÊúüÈñìÈÅ∏Êäû„Éú„Çø„É≥ -->
                <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px;">
                    <button onclick="updateChartRange(1)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">1Êó•</button>
                    <button onclick="updateChartRange(7)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">1ÈÄ±Èñì</button>
                    <button onclick="updateChartRange(30)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">1„É∂Êúà</button>
                    <button onclick="updateChartRange(90)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">3„É∂Êúà</button>
                    <button onclick="updateChartRange(365)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">1Âπ¥</button>
                    <button onclick="updateChartRange(0)" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">ÂÖ®ÊúüÈñì</button>
                    <button id="previousPeriodBtn" onclick="togglePreviousPeriod()" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">ÂâçÊúüÈñì„ÅÆË®òÈå≤</button>
                </div>
                
                <!-- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
                <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
                    <button onclick="navigateChart('prev')" style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 3px; cursor: pointer; font-size: 14px; font-weight: bold;">‚Üê Ââç</button>
                    <span id="chartPeriodInfo" style="font-size: 12px; color: #666; min-width: 120px; text-align: center;">ÊúüÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
                    <button onclick="navigateChart('next')" style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 3px; cursor: pointer; font-size: 14px; font-weight: bold;">Ê¨° ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- „Éá„Éº„ÇøÂ±•Ê≠¥Ôºà„Ç∞„É©„Éï„ÅÆ‰∏ã„Å´ÁßªÂãïÔºâ -->
        <div class="input-card hidden" id="weightHistoryPanel">
            <h3>üìà „Éá„Éº„ÇøÂ±•Ê≠¥</h3>
            <div class="data-area" id="weightHistory">
                „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...<br>
            </div>
        </div>

        <h3>üìã „Ç¢„Éó„É™„É≠„Ç∞ <button class="universal-copy-btn" onclick="copyLogs()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">üìã „É≠„Ç∞„Çí„Ç≥„Éî„Éº</button></h3>
        <div class="data-area" id="logArea">
            „Ç¢„Éó„É™„ÉÜ„É≥„Éó„É¨„Éº„ÉàËµ∑ÂãïÂÆå‰∫Ü...<br>
            üî• FirebaseË®≠ÂÆöÂÆå‰∫Ü<br>
            üîê GoogleË™çË®ºÊ∫ñÂÇôÂÆå‰∫Ü<br>
        </div>
        
        <!-- „Éá„Éê„ÉÉ„Ç∞„Éú„Çø„É≥„Ç®„É™„Ç¢ -->
        <div style="margin-top: 8px; text-align: center;">
            <button class="universal-copy-btn" onclick="debugFirebaseConnection()" style="background: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">üîç Firebase Debug</button>
            <button class="universal-copy-btn" onclick="checkLoginIssues()" style="background: #ffc107; color: #212529; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">‚ö†Ô∏è „É≠„Ç∞„Ç§„É≥ÂïèÈ°åË®∫Êñ≠</button>
            <button class="universal-copy-btn" onclick="copyDebugInfo()" style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">üìã „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„Çí„Ç≥„Éî„Éº</button>
            <button class="universal-copy-btn" onclick="checkDatabaseStructure()" style="background: #6f42c1; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">üèóÔ∏è DBÊßãÈÄ†Á¢∫Ë™ç</button>
            <button class="universal-copy-btn" onclick="checkMobileSupport()" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">üì± „É¢„Éê„Ç§„É´Ë®∫Êñ≠</button>
            <button class="universal-copy-btn" onclick="forceAuthCheck()" style="background: #fd7e14; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">üîÑ Ë™çË®ºÁä∂ÊÖãÁ¢∫Ë™ç</button>
            <button class="universal-copy-btn" onclick="checkFirebaseConfig()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">üîß FirebaseË®≠ÂÆö</button>
            <button class="universal-copy-btn" onclick="testPopup()" style="background: #20c997; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">üß™ „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÉÜ„Çπ„Éà</button>
        </div>
        </div> <!-- „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ1ÁµÇ‰∫Ü -->

        <!-- „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ2 -->
        <div id="tabContent2" class="tab-content hidden">
            <!-- „Çø„Éñ2: Áù°Áú†ÁÆ°ÁêÜ -->
            <div id="tab2Content">
                <!-- Áù°Áú†Ë®òÈå≤ÂÖ•Âäõ„Ç®„É™„Ç¢ -->
                <div class="input-card" id="sleepInput">
                    <h3>üõèÔ∏è Áù°Áú†Ë®òÈå≤</h3>
                    
                    <!-- Êó•‰ªòÈÅ∏Êäû -->
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                        <label style="font-weight: bold;">üìÖ Ë®òÈå≤Êó•:</label>
                        <input type="date" id="sleepDateInput" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    </div>

                    <!-- Áù°Áú†Ë®òÈå≤„Çø„Ç§„ÉóÈÅ∏Êäû -->
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 8px;">üõèÔ∏è Áù°Áú†„Çø„Ç§„Éó:</label>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="sleep-type-btn" data-type="Â§úÈñìÁù°Áú†" onclick="selectSleepType('Â§úÈñìÁù°Áú†')" style="background: #6f42c1; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">üåô Â§úÈñìÁù°Áú†</button>
                            <button type="button" class="sleep-type-btn" data-type="ÊòºÂØù" onclick="selectSleepType('ÊòºÂØù')" style="background: #ffc107; color: #212529; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">‚òÄÔ∏è ÊòºÂØù</button>
                            <button type="button" class="sleep-type-btn" data-type="‰ªÆÁú†" onclick="selectSleepType('‰ªÆÁú†')" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">üò¥ ‰ªÆÁú†</button>
                        </div>
                        <input type="hidden" id="selectedSleepType" value="">
                    </div>


                    <!-- Ë®òÈå≤ÊôÇÈñì -->
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <div>
                            <label style="font-weight: bold; display: block; margin-bottom: 3px;">‚è∞ Ë®òÈå≤ÊôÇÈñì:</label>
                            <input type="time" id="sleepTimeInput" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                        </div>
                    </div>

                    <!-- Áù°Áú†„ÅÆË≥™Ë©ï‰æ° -->
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 8px;">‚≠ê Áù°Áú†„ÅÆË≥™:</label>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="quality-btn" data-quality="1" onclick="selectQuality(1)" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">üò¥ 1 (ÊúÄÊÇ™)</button>
                            <button type="button" class="quality-btn" data-quality="2" onclick="selectQuality(2)" style="background: #fd7e14; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">üò™ 2 (ÊÇ™„ÅÑ)</button>
                            <button type="button" class="quality-btn" data-quality="3" onclick="selectQuality(3)" style="background: #ffc107; color: #212529; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">üòê 3 (ÊôÆÈÄö)</button>
                            <button type="button" class="quality-btn" data-quality="4" onclick="selectQuality(4)" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">üòä 4 (ËâØ„ÅÑ)</button>
                            <button type="button" class="quality-btn" data-quality="5" onclick="selectQuality(5)" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">üò¥ 5 (ÊúÄÈ´ò)</button>
                        </div>
                        <input type="hidden" id="selectedQuality" value="">
                    </div>

                    <!-- Áù°Áú†„Çø„Ç∞ÈÅ∏Êäû -->
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 8px;">üè∑Ô∏è Áù°Áú†„Çø„Ç∞ÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ:</label>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="sleep-tag-btn" data-tag="‰∫åÂ∫¶ÂØù" onclick="toggleSleepTag('‰∫åÂ∫¶ÂØù')" style="background: #6f42c1; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">üò¥ ‰∫åÂ∫¶ÂØù</button>
                            <button type="button" class="sleep-tag-btn" data-tag="Â§¢„ÇíË¶ã„Åü" onclick="toggleSleepTag('Â§¢„ÇíË¶ã„Åü')" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">üí≠ Â§¢„ÇíË¶ã„Åü</button>
                            <button type="button" class="sleep-tag-btn" data-tag="ÁÜüÁù°" onclick="toggleSleepTag('ÁÜüÁù°')" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">üò¥ ÁÜüÁù°</button>
                            <button type="button" class="sleep-tag-btn" data-tag="ÈÄî‰∏≠„ÅßËµ∑„Åç„Åü" onclick="toggleSleepTag('ÈÄî‰∏≠„ÅßËµ∑„Åç„Åü')" style="background: #fd7e14; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">üò™ ÈÄî‰∏≠„ÅßËµ∑„Åç„Åü</button>
                            <button type="button" class="sleep-tag-btn" data-tag="ÂØù„Å§„Åç„ÅåÊÇ™„ÅÑ" onclick="toggleSleepTag('ÂØù„Å§„Åç„ÅåÊÇ™„ÅÑ')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7;">üò£ ÂØù„Å§„Åç„ÅåÊÇ™„ÅÑ</button>
                        </div>
                        <input type="hidden" id="selectedSleepTags" value="">
                        <div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; min-height: 20px;">
                            <span style="font-size: 12px; color: #666;">ÈÅ∏Êäû‰∏≠:</span>
                            <span id="selectedTagsDisplay" style="font-size: 12px; color: #007bff; font-weight: bold;">„Å™„Åó</span>
                        </div>
                    </div>

                    <!-- „É°„É¢ÂÖ•Âäõ -->
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">üìù „É°„É¢Ôºà‰ªªÊÑèÔºâ:</label>
                        <input type="text" id="sleepMemoInput" placeholder="‰ΩìË™ø„ÄÅËµ∑„Åç„ÅüÊôÇ„ÅÆÊÑüÊÉ≥„Å™„Å©" style="width: 100%; max-width: 400px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    </div>

                    <!-- ‰øùÂ≠ò„Éú„Çø„É≥ -->
                    <div style="text-align: center;">
                        <button onclick="saveSleepData()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">üíæ Áù°Áú†Ë®òÈå≤„Çí‰øùÂ≠ò</button>
                    </div>
                </div>

                <!-- Áù°Áú†Â±•Ê≠¥Ë°®Á§∫ -->
                <div class="input-card" id="sleepHistory">
                    <h3>üìä Áù°Áú†Â±•Ê≠¥ <button class="universal-copy-btn" onclick="copySleepHistory()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">üìã Â±•Ê≠¥„Çí„Ç≥„Éî„Éº</button></h3>
                    <div class="data-area" id="sleepHistoryArea">
                        „Åæ„Å†Áù°Áú†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                    </div>
                </div>

                <!-- Áù°Áú†Áµ±Ë®à -->
                <div class="input-card" id="sleepStats">
                    <h3>üìà Áù°Áú†Áµ±Ë®à</h3>
                    <div id="sleepStatsArea" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 24px; font-weight: bold; color: #007bff;">--</div>
                            <div style="font-size: 12px; color: #6c757d;">Âπ≥ÂùáÁù°Áú†ÊôÇÈñì</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 24px; font-weight: bold; color: #28a745;">--</div>
                            <div style="font-size: 12px; color: #6c757d;">Âπ≥ÂùáÁù°Áú†„ÅÆË≥™</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 24px; font-weight: bold; color: #ffc107;">--</div>
                            <div style="font-size: 12px; color: #6c757d;">‰ªäÈÄ±„ÅÆË®òÈå≤Êï∞</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">--</div>
                            <div style="font-size: 12px; color: #6c757d;">‰ªäÊúà„ÅÆË®òÈå≤Êï∞</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ3 -->
        <div id="tabContent3" class="tab-content hidden">
            <!-- ÈÉ®Â±ãÁâá‰ªò„ÅëÁÆ°ÁêÜ -->
            <div id="tab3Content">
                <!-- Áâá‰ªò„Åë„Çø„Çπ„ÇØÂÖ•Âäõ„Ç®„É™„Ç¢ -->
                <div class="input-card" id="roomInput">
                    <h3>üßπ ÈÉ®Â±ãÁâá‰ªò„ÅëË®òÈå≤</h3>
                    
                    <!-- Êìç‰Ωú„É¢„Éº„ÉâÈÅ∏Êäû -->
                    <div class="room-mode-control" style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 8px; margin: 8px 0; text-align: center;">
                        <div style="margin-bottom: 8px;">
                            <span style="font-size: 13px; color: #444; font-weight: bold;">üîß Â†¥ÊâÄÁÆ°ÁêÜ„É¢„Éº„Éâ</span>
                        </div>
                        <div style="display: flex; gap: 5px; justify-content: center; margin-bottom: 8px;">
                            <button id="roomNormalModeBtn" onclick="setRoomMode('normal')" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 11px;">üìù ÈÄöÂ∏∏</button>
                            <button id="roomAddModeBtn" onclick="setRoomMode('add')" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 11px;">‚ûï ËøΩÂä†</button>
                            <button id="roomDeleteModeBtn" onclick="setRoomMode('delete')" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 11px;">üóëÔ∏è ÂâäÈô§</button>
                        </div>
                        
                        <!-- ËøΩÂä†„É¢„Éº„ÉâÁî®„ÅÆÁµ±‰∏ÄÂÖ•Âäõ„Ç®„É™„Ç¢ -->
                        <div id="roomUnifiedAddInput" style="display: none; margin-top: 8px; padding: 8px; background: #e8f5e8; border-radius: 5px; border: 2px solid #28a745;">
                            <div style="margin-bottom: 5px;">
                                <span style="font-size: 11px; color: #155724; font-weight: bold;">‚ú® Êñ∞„Åó„ÅÑÂ†¥ÊâÄ„ÇíËøΩÂä†</span>
                            </div>
                            <div style="display: flex; gap: 3px; align-items: center;">
                                <input type="text" id="roomUnifiedAddText" placeholder="Â†¥ÊâÄÂêç„ÇíÂÖ•Âäõ" style="flex: 1; padding: 4px 8px; border: 1px solid #28a745; border-radius: 3px; font-size: 11px;">
                                <button onclick="executeRoomAdd()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">‚úì ËøΩÂä†</button>
                                <button onclick="cancelRoomAdd()" style="background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">‚úó „Ç≠„É£„É≥„Çª„É´</button>
                            </div>
                        </div>
                    </div>

                    <!-- Êó•‰ªò„ÉªÊôÇÂàªË°®Á§∫ÔºàËá™ÂãïÂèñÂæóÔºâ -->
                    <div style="margin-bottom: 10px;">
                        <input type="date" class="input-field" id="roomDateInput" style="width: 100%;" readonly>
                        <input type="time" class="input-field" id="roomTimeInput" style="width: 100%; margin-top: 5px;" readonly>
                    </div>
                    
                    <!-- ÈñãÂßã„ÉªÁµÇ‰∫Ü„Éú„Çø„É≥ -->
                    <div style="margin-bottom: 15px; text-align: center;">
                        <button id="startRoomBtn" onclick="startRoomCleaning()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; margin-right: 10px;">‚ñ∂Ô∏è Áâá‰ªò„ÅëÈñãÂßã</button>
                        <button id="endRoomBtn" onclick="endRoomCleaning()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; display: none;">‚èπÔ∏è Áâá‰ªò„ÅëÁµÇ‰∫Ü</button>
                    </div>
                    
                    <!-- Áâá‰ªò„ÅëÂ†¥ÊâÄÈÅ∏Êäû -->
                    <div style="margin-bottom: 10px;">
                        <div style="text-align: center; margin-bottom: 8px;">
                            <span style="font-size: 13px; color: #444; font-weight: bold;">üìç Áâá‰ªò„ÅëÂ†¥ÊâÄ</span>
                        </div>
                        <div id="roomButtons" style="display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; margin-bottom: 8px;">
                            <button type="button" class="room-btn" onclick="selectRoom('„É™„Éì„É≥„Ç∞')" data-room="„É™„Éì„É≥„Ç∞" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7;">üõãÔ∏è „É™„Éì„É≥„Ç∞</button>
                            <button type="button" class="room-btn" onclick="selectRoom('„Ç≠„ÉÉ„ÉÅ„É≥')" data-room="„Ç≠„ÉÉ„ÉÅ„É≥" style="background: #ffc107; color: #212529; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7;">üç≥ „Ç≠„ÉÉ„ÉÅ„É≥</button>
                            <button type="button" class="room-btn" onclick="selectRoom('ÂØùÂÆ§')" data-room="ÂØùÂÆ§" style="background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7;">üõèÔ∏è ÂØùÂÆ§</button>
                            <button type="button" class="room-btn" onclick="selectRoom('„ÅäÈ¢®ÂëÇ')" data-room="„ÅäÈ¢®ÂëÇ" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7;">üõÅ „ÅäÈ¢®ÂëÇ</button>
                            <button type="button" class="room-btn" onclick="selectRoom('„Éà„Ç§„É¨')" data-room="„Éà„Ç§„É¨" style="background: #fd79a8; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7;">üöΩ „Éà„Ç§„É¨</button>
                            <button type="button" class="room-btn" onclick="selectRoom('ÁéÑÈñ¢')" data-room="ÁéÑÈñ¢" style="background: #6f42c1; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7;">üö™ ÁéÑÈñ¢</button>
                            <button type="button" class="room-btn" onclick="selectRoom('„Åù„ÅÆ‰ªñ')" data-room="„Åù„ÅÆ‰ªñ" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7;">üì¶ „Åù„ÅÆ‰ªñ</button>
                        </div>
                        <input type="text" class="input-field" id="selectedRoom" placeholder="ÈÅ∏Êäû„Åó„ÅüÂ†¥ÊâÄ" readonly style="margin-top: 5px; font-size: 12px; padding: 6px; text-align: center; background: #f0f8ff;">
                    </div>
                    
                    <!-- Áâá‰ªò„ÅëÊôÇÈñìÔºàËá™ÂãïË®àÁÆóÔºâ -->
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #444;">‚è±Ô∏è Áâá‰ªò„ÅëÊôÇÈñì</label>
                        <input type="text" class="input-field" id="roomDuration" placeholder="ÈñãÂßã„Éú„Çø„É≥„ÅßË®àÊ∏¨ÈñãÂßã" readonly style="width: 100%; text-align: center; background: #f0f8ff;">
                    </div>
                    
                    <!-- ÈÅîÊàêÂ∫¶ -->
                    <div style="margin-bottom: 10px;">
                        <div style="text-align: center; margin-bottom: 8px;">
                            <span style="font-size: 13px; color: #444; font-weight: bold;">üìä ÈÅîÊàêÂ∫¶</span>
                        </div>
                        <div style="display: flex; gap: 5px; justify-content: center; margin-bottom: 8px;">
                            <button type="button" class="achievement-btn" onclick="selectAchievement(1)" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">üòû 1</button>
                            <button type="button" class="achievement-btn" onclick="selectAchievement(2)" style="background: #fd7e14; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">üòê 2</button>
                            <button type="button" class="achievement-btn" onclick="selectAchievement(3)" style="background: #ffc107; color: #212529; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">üôÇ 3</button>
                            <button type="button" class="achievement-btn" onclick="selectAchievement(4)" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">üòä 4</button>
                            <button type="button" class="achievement-btn" onclick="selectAchievement(5)" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">ü§© 5</button>
                        </div>
                        <input type="text" class="input-field" id="selectedAchievement" placeholder="ÈÅîÊàêÂ∫¶" readonly style="margin-top: 5px; font-size: 12px; padding: 6px; text-align: center; background: #f0f8ff;">
                    </div>
                    
                    <!-- „É°„É¢ -->
                    <textarea class="input-field" id="roomMemoInput" placeholder="Áâá‰ªò„Åë„ÅÆ„É°„É¢„ÉªÊ∞ó„Å•„ÅçÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ" rows="3" style="margin-bottom: 10px;"></textarea>
                    
                    <div style="text-align: center;">
                        <button onclick="saveRoomData()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">üíæ Áâá‰ªò„ÅëË®òÈå≤„Çí‰øùÂ≠ò</button>
                    </div>
                </div>

                <!-- Áâá‰ªò„ÅëÂ±•Ê≠¥Ë°®Á§∫ -->
                <div class="input-card" id="roomHistory">
                    <h3>üßπ Áâá‰ªò„ÅëÂ±•Ê≠¥ <button class="universal-copy-btn" onclick="copyRoomHistory()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">üìã Â±•Ê≠¥„Çí„Ç≥„Éî„Éº</button></h3>
                    <div class="data-area" id="roomHistoryArea">
                        „Åæ„Å†Áâá‰ªò„ÅëË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                    </div>
                </div>

                <!-- Áâá‰ªò„ÅëÁµ±Ë®à -->
                <div class="input-card" id="roomStats">
                    <h3>üìà Áâá‰ªò„ÅëÁµ±Ë®à</h3>
                    <div id="roomStatsArea" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 24px; color: #007bff; font-weight: bold;" id="totalRoomSessions">-</div>
                            <div style="font-size: 12px; color: #6c757d;">Á∑èÁâá‰ªò„ÅëÂõûÊï∞</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 24px; color: #28a745; font-weight: bold;" id="totalRoomTime">-</div>
                            <div style="font-size: 12px; color: #6c757d;">Á∑èÁâá‰ªò„ÅëÊôÇÈñì</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 24px; color: #ffc107; font-weight: bold;" id="avgRoomAchievement">-</div>
                            <div style="font-size: 12px; color: #6c757d;">Âπ≥ÂùáÈÅîÊàêÂ∫¶</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div style="font-size: 24px; color: #17a2b8; font-weight: bold;" id="thisMonthRoomCount">-</div>
                            <div style="font-size: 12px; color: #6c757d;">‰ªäÊúà„ÅÆË®òÈå≤Êï∞</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ4 -->
        <div id="tabContent4" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>üîß xx4</h3>
                <p>„Åì„Å°„Çâ„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØÂæå„ÅßÂÆüË£Ö‰∫àÂÆö„Åß„Åô</p>
            </div>
        </div>

        <!-- „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ5 -->
        <div id="tabContent5" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>üîß xx5</h3>
                <p>„Åì„Å°„Çâ„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØÂæå„ÅßÂÆüË£Ö‰∫àÂÆö„Åß„Åô</p>
            </div>
        </div>

        <!-- „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ6 -->
        <div id="tabContent6" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>üîß xx6</h3>
                <p>„Åì„Å°„Çâ„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØÂæå„ÅßÂÆüË£Ö‰∫àÂÆö„Åß„Åô</p>
            </div>
        </div>

        <!-- „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ7 -->
        <div id="tabContent7" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>üîß xx7</h3>
                <p>„Åì„Å°„Çâ„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØÂæå„ÅßÂÆüË£Ö‰∫àÂÆö„Åß„Åô</p>
            </div>
        </div>

        <!-- „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ8: „É°„É¢„É™„Çπ„Éà -->
        <div id="tabContent8" class="tab-content hidden">
            <div id="tab8Content">
                <!-- „É°„É¢ËøΩÂä†„Ç®„É™„Ç¢ -->
                <div class="input-card" id="memoInput">
                    <h3>üìù „É°„É¢„É™„Çπ„Éà</h3>
                    
                    <!-- „É°„É¢ÂÖ•Âäõ„Éï„Ç©„Éº„É† -->
                    <div style="margin-bottom: 15px;">
                        <textarea id="newMemoText" placeholder="ËÄÉ„Åà„Åü„Åì„Å®„ÄÅ„ÇÑ„Çä„Åü„ÅÑ„Åì„Å®„ÄÅ„Å™„Çì„Åß„ÇÇËá™Áî±„Å´Êõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ..." 
                            style="width: 100%; max-width: 600px; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical; font-family: inherit; font-size: 14px; line-height: 1.4;"></textarea>
                    </div>

                    <!-- „Ç´„ÉÜ„Ç¥„É™„ÉªÈáçË¶ÅÂ∫¶„ÉªÂØæÂøúÊôÇÈñì„ÅÆÈÅ∏Êäû -->
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <label style="font-weight: bold;">üè∑Ô∏è „Ç´„ÉÜ„Ç¥„É™Ôºà‰ªªÊÑèÔºâ:</label>
                        <select id="memoCategory" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <option value="">ÈÅ∏Êäû„Å™„Åó</option>
                            <option value="„Ç¢„Ç§„Éá„Ç¢">üí° „Ç¢„Ç§„Éá„Ç¢</option>
                            <option value="„ÇÑ„Çã„Åì„Å®">‚úÖ „ÇÑ„Çã„Åì„Å®</option>
                            <option value="ËÄÉ„Åà‰∫ã">ü§î ËÄÉ„Åà‰∫ã</option>
                            <option value="„É°„É¢">üìù „É°„É¢</option>
                            <option value="ÈáçË¶Å">‚ö†Ô∏è ÈáçË¶Å</option>
                            <option value="„Åù„ÅÆ‰ªñ">üìã „Åù„ÅÆ‰ªñ</option>
                        </select>
                    </div>

                    <!-- ÈáçË¶ÅÂ∫¶ÈÅ∏Êäû -->
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <label style="font-weight: bold;">üéØ ÈáçË¶ÅÂ∫¶:</label>
                        <select id="memoPriority" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <option value="">ÈÅ∏Êäû„Å™„Åó</option>
                            <option value="S">üî• S - ÊúÄÈáçË¶ÅÔºàÁ∑äÊÄ•ÂØæÂøúÔºâ</option>
                            <option value="A">‚ö° A - ÈáçË¶ÅÔºàÂÑ™ÂÖàÂØæÂøúÔºâ</option>
                            <option value="B">üìã B - ‰∏≠Á®ãÂ∫¶ÔºàÈÄöÂ∏∏ÂØæÂøúÔºâ</option>
                            <option value="C">üìù C - ‰Ωé„ÇÅÔºàÊôÇÈñì„Åå„ÅÇ„Çã„Å®„ÅçÔºâ</option>
                        </select>
                    </div>

                    <!-- ÂØæÂøúÊôÇÈñìÈÅ∏Êäû -->
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <label style="font-weight: bold;">‚è∞ ÂØæÂøúÊôÇÈñì:</label>
                        <select id="memoTimeframe" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <option value="">ÈÅ∏Êäû„Å™„Åó</option>
                            <option value="Áü≠Êúü">‚ö° Áü≠ÊúüÔºà„Åô„Åê„Å´ÁµÇ„Çè„ÇãÔºâ</option>
                            <option value="‰∏≠Èï∑Êúü">üìÖ ‰∏≠Èï∑ÊúüÔºàÊôÇÈñì„Çí„Åã„Åë„ÇãÔºâ</option>
                        </select>
                    </div>

                    <!-- ËøΩÂä†„Éú„Çø„É≥ -->
                    <div style="text-align: center;">
                        <button onclick="addMemo()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">‚ûï „É°„É¢„ÇíËøΩÂä†</button>
                    </div>
                </div>

                <!-- „É°„É¢‰∏ÄË¶ßË°®Á§∫ -->
                <div class="input-card" id="memoList">
                    <h3>üìã „É°„É¢‰∏ÄË¶ß 
                        <button class="universal-copy-btn" onclick="copyAllMemos()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">üìã ÂÖ®„É°„É¢„Çí„Ç≥„Éî„Éº</button>
                        <button onclick="clearAllMemos()" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-left: 5px;">üóëÔ∏è ÂÖ®ÂâäÈô§</button>
                    </h3>
                    <div class="data-area" id="memoListArea">
                        „Åæ„Å†„É°„É¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                    </div>
                </div>

                <!-- „É°„É¢Áµ±Ë®à -->
                <div class="input-card" id="memoStats">
                    <h3>üìä „É°„É¢Áµ±Ë®à</h3>
                    <div id="memoStatsArea" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div id="totalMemoCount" style="font-size: 24px; font-weight: bold; color: #007bff;">0</div>
                            <div style="font-size: 12px; color: #6c757d;">Á∑è„É°„É¢Êï∞</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div id="todayMemoCount" style="font-size: 24px; font-weight: bold; color: #28a745;">0</div>
                            <div style="font-size: 12px; color: #6c757d;">‰ªäÊó•„ÅÆ„É°„É¢</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div id="weekMemoCount" style="font-size: 24px; font-weight: bold; color: #ffc107;">0</div>
                            <div style="font-size: 12px; color: #6c757d;">‰ªäÈÄ±„ÅÆ„É°„É¢</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <div id="monthMemoCount" style="font-size: 24px; font-weight: bold; color: #17a2b8;">0</div>
                            <div style="font-size: 12px; color: #6c757d;">‰ªäÊúà„ÅÆ„É°„É¢</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- „Çø„Éñ9-16„ÅÆÁ©∫„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div id="tabContent9" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>üîß xx9</h3>
                <p>„Åì„ÅÆ„Çø„Éñ„ÅØ„Åæ„Å†ÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
            </div>
        </div>

        <div id="tabContent10" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>üîß xx10</h3>
                <p>„Åì„ÅÆ„Çø„Éñ„ÅØ„Åæ„Å†ÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
            </div>
        </div>

        <div id="tabContent11" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>üîß xx11</h3>
                <p>„Åì„ÅÆ„Çø„Éñ„ÅØ„Åæ„Å†ÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
            </div>
        </div>

        <div id="tabContent12" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>üîß xx12</h3>
                <p>„Åì„ÅÆ„Çø„Éñ„ÅØ„Åæ„Å†ÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
            </div>
        </div>

        <div id="tabContent13" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>üîß xx13</h3>
                <p>„Åì„ÅÆ„Çø„Éñ„ÅØ„Åæ„Å†ÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
            </div>
        </div>

        <div id="tabContent14" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>üîß xx14</h3>
                <p>„Åì„ÅÆ„Çø„Éñ„ÅØ„Åæ„Å†ÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
            </div>
        </div>

        <div id="tabContent15" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>üîß xx15</h3>
                <p>„Åì„ÅÆ„Çø„Éñ„ÅØ„Åæ„Å†ÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
            </div>
        </div>

        <div id="tabContent16" class="tab-content hidden">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>üîß xx16</h3>
                <p>„Åì„ÅÆ„Çø„Éñ„ÅØ„Åæ„Å†ÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
            </div>
        </div>
    </div>

    <script>
        // Core FirebaseË®≠ÂÆöÔºàÂ§âÊõ¥Á¶ÅÊ≠¢ - core/src/firebase-config.jsÂèÇÁÖßÔºâ
        const firebaseConfig = {
            apiKey: "AIzaSyA5PXKChizYDCXF_GJ4KL6Ylq9K5hCPXWE",
            authDomain: "shares-b1b97.firebaseapp.com",
            databaseURL: "https://shares-b1b97-default-rtdb.firebaseio.com",
            projectId: "shares-b1b97",
            storageBucket: "shares-b1b97.firebasestorage.app",
            messagingSenderId: "38311063248",
            appId: "1:38311063248:web:0d2d5726d12b305b24b8d5"
        };

        // FirebaseÂàùÊúüÂåñ
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let selectedTimingValue = '';
        let selectedTopValue = '';
        let selectedBottomValue = '';
        let weightChart = null;
        let allWeightData = [];
        window.editingEntryId = null;

        // Áµ±‰∏Ä„É¢„Éº„ÉâÁä∂ÊÖãÁÆ°ÁêÜ
        let currentMode = 'normal'; // 'normal', 'add', 'delete'
        let selectedTarget = null; // 'timing', 'top', 'bottom' „ÅÆ„ÅÑ„Åö„Çå„Åã

        // ÂâçÊúüÈñìÊØîËºÉÊ©üËÉΩ„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
        let showPreviousPeriod = false; // ÂâçÊúüÈñìË°®Á§∫„ÅÆON/OFF

        // „Ç¢„Éó„É™„Éê„Éº„Ç∏„Éß„É≥Ôºà‰∏ÄÂÖÉÁÆ°ÁêÜÔºâ
        const APP_VERSION = 'v0.91';
        
        // „Ç´„É©„ÉºÈÖçÂàóÂÆöÊï∞ÂåñÔºà3ÁÆáÊâÄ„ÅÆÈáçË§áÁµ±‰∏ÄÔºâ
        const RANDOM_COLORS = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a55eea'];

        // „Ç´„Çπ„Çø„É†È†ÖÁõÆ„ÅÆÊ∞∏Á∂öÂåñÊ©üËÉΩÔºàlocalStorageÊ¥ªÁî®Ôºâ
        const STORAGE_KEYS = {
            customTimings: 'weightApp_customTimings',
            customTops: 'weightApp_customTops',
            customBottoms: 'weightApp_customBottoms'
        };

        // „Ç´„Çπ„Çø„É†È†ÖÁõÆ„ÇílocalStorage„Å´‰øùÂ≠ò
        function saveCustomItems() {
            const customTimings = Array.from(document.querySelectorAll('.timing-btn:not([data-timing="Ëµ∑Â∫äÂæå"]):not([data-timing="„Éà„Ç§„É¨Ââç"]):not([data-timing="„Éà„Ç§„É¨Âæå"]):not([data-timing="È¢®ÂëÇÂâç"]):not([data-timing="È¢®ÂëÇÂæå"]):not([data-timing="È£ü‰∫ãÂâç"]):not([data-timing="È£ü‰∫ãÂæå"])'))
                .map(btn => ({
                    text: btn.getAttribute('data-timing'),
                    color: btn.style.background
                }));
            
            const customTops = Array.from(document.querySelectorAll('.clothing-btn[data-clothing-top]:not([data-clothing-top="„Å™„Åó"]):not([data-clothing-top="‰∏ãÁùÄ„Ç∑„É£„ÉÑ"]):not([data-clothing-top="„ÉØ„Ç§„Ç∑„É£„ÉÑ"])'))
                .map(btn => ({
                    text: btn.getAttribute('data-clothing-top'),
                    color: btn.style.background
                }));
            
            const customBottoms = Array.from(document.querySelectorAll('.clothing-btn[data-clothing-bottom]:not([data-clothing-bottom="„Å™„Åó"]):not([data-clothing-bottom="„Éà„É©„É≥„ÇØ„Çπ"]):not([data-clothing-bottom="„Éè„Éº„Éï„Éë„É≥„ÉÑ"])'))
                .map(btn => ({
                    text: btn.getAttribute('data-clothing-bottom'),
                    color: btn.style.background
                }));

            localStorage.setItem(STORAGE_KEYS.customTimings, JSON.stringify(customTimings));
            localStorage.setItem(STORAGE_KEYS.customTops, JSON.stringify(customTops));
            localStorage.setItem(STORAGE_KEYS.customBottoms, JSON.stringify(customBottoms));
        }

        // „Ç´„Çπ„Çø„É†È†ÖÁõÆ„ÇílocalStorage„Åã„ÇâÂæ©ÂÖÉ
        function loadCustomItems() {
            // „Çø„Ç§„Éü„É≥„Ç∞È†ÖÁõÆ„ÅÆÂæ©ÂÖÉ
            const savedTimings = localStorage.getItem(STORAGE_KEYS.customTimings);
            if (savedTimings) {
                const timings = JSON.parse(savedTimings);
                const container = document.getElementById('timingButtons');
                timings.forEach(item => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'timing-btn';
                    button.setAttribute('data-timing', item.text);
                    button.onclick = () => selectTiming(item.text);
                    button.style.cssText = `background: ${item.color}; color: white; opacity: 0.7;`;
                    button.setAttribute('data-original-color', item.color);
                    button.textContent = `‚è∞ ${item.text}`;
                    container.appendChild(button);
                });
            }

            // ‰∏äÂçäË∫´È†ÖÁõÆ„ÅÆÂæ©ÂÖÉ
            const savedTops = localStorage.getItem(STORAGE_KEYS.customTops);
            if (savedTops) {
                const tops = JSON.parse(savedTops);
                const container = document.getElementById('topClothingButtons');
                tops.forEach(item => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'clothing-btn';
                    button.setAttribute('data-clothing-top', item.text);
                    button.onclick = () => selectClothingTop(item.text);
                    button.style.cssText = `background: ${item.color}; color: white; opacity: 0.7;`;
                    button.setAttribute('data-original-color', item.color);
                    button.textContent = `üëî ${item.text}`;
                    container.appendChild(button);
                });
            }

            // ‰∏ãÂçäË∫´È†ÖÁõÆ„ÅÆÂæ©ÂÖÉ
            const savedBottoms = localStorage.getItem(STORAGE_KEYS.customBottoms);
            if (savedBottoms) {
                const bottoms = JSON.parse(savedBottoms);
                const container = document.getElementById('bottomClothingButtons');
                bottoms.forEach(item => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'clothing-btn';
                    button.setAttribute('data-clothing-bottom', item.text);
                    button.onclick = () => selectClothingBottom(item.text);
                    button.style.cssText = `background: ${item.color}; color: white; opacity: 0.7;`;
                    button.setAttribute('data-original-color', item.color);
                    button.textContent = `üëñ ${item.text}`;
                    container.appendChild(button);
                });
            }
        }

        // Áµ±‰∏Ä„É¢„Éº„ÉâÂà∂Âæ°Ê©üËÉΩ
        window.setMode = (mode) => {
            currentMode = mode;
            updateModeUI();
            
            // „É¢„Éº„ÉâÂ§âÊõ¥ÊôÇ„ÅÆË°®Á§∫Êõ¥Êñ∞
            if (mode === 'delete' && selectedTarget) {
                updateDeleteModeDisplay();
            } else if (mode !== 'delete') {
                restoreNormalDisplay();
            }
            
            log(`üîß „É¢„Éº„ÉâÂ§âÊõ¥: ${mode === 'normal' ? 'ÈÄöÂ∏∏' : mode === 'add' ? 'ËøΩÂä†' : 'ÂâäÈô§'}„É¢„Éº„Éâ`);
        };

        // ÂØæË±°ÈÅ∏ÊäûÊ©üËÉΩÔºàÁµ±‰∏ÄÁâàÔºâ
        window.selectTarget = (target) => {
            selectedTarget = target;
            updateTargetUI();
            log(`üéØ ÂØæË±°ÈÅ∏Êäû: ${target === 'timing' ? '„Çø„Ç§„Éü„É≥„Ç∞' : target === 'top' ? '‰∏äÂçäË∫´' : '‰∏ãÂçäË∫´'}`);
            
            // „É¢„Éº„Éâ„Å´Âøú„Åò„Å¶Âá¶ÁêÜÂÆüË°å
            handleModeAction();
            
            // ÂâäÈô§„É¢„Éº„ÉâÊôÇ„ÅØ„Ç¨„Ç§„ÉÄ„É≥„ÇπÊõ¥Êñ∞
            if (currentMode === 'delete') {
                updateDeleteModeGuidance();
            }
        };

        // „É¢„Éº„Éâ„Å´Âøú„Åò„ÅüÂá¶ÁêÜÂÆüË°å
        function handleModeAction() {
            if (currentMode === 'add' && selectedTarget) {
                // ËøΩÂä†„É¢„Éº„Éâ: Áµ±‰∏ÄÂÖ•Âäõ„Éï„Ç£„Éº„É´„ÉâË°®Á§∫
                showUnifiedAddInput();
            } else if (currentMode === 'delete' && selectedTarget) {
                // ÂâäÈô§„É¢„Éº„Éâ: „Ç´„Çπ„Çø„É†È†ÖÁõÆ„ÅÆË°®Á§∫Â§âÊõ¥
                updateDeleteModeDisplay();
            }
        }

        // Áµ±‰∏ÄËøΩÂä†ÂÖ•ÂäõË°®Á§∫
        function showUnifiedAddInput() {
            const inputArea = document.getElementById('unifiedAddInput');
            
            // ÂÖÉ„ÅÆÂÖ•Âäõ„Éï„Ç©„Éº„É†„Å´Âæ©ÂÖÉ
            inputArea.innerHTML = `
                <div style="margin-bottom: 5px;">
                    <span style="font-size: 11px; color: #155724; font-weight: bold;">‚ú® Êñ∞Ë¶èÈ†ÖÁõÆ„ÇíËøΩÂä†</span>
                </div>
                <div style="display: flex; gap: 3px; align-items: center;">
                    <input type="text" id="unifiedAddText" placeholder="È†ÖÁõÆÂêç„ÇíÂÖ•Âäõ" style="flex: 1; padding: 4px 8px; border: 1px solid #28a745; border-radius: 3px; font-size: 11px;">
                    <button onclick="executeAdd()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">‚úì ËøΩÂä†</button>
                    <button onclick="cancelAdd()" style="background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">‚úó „Ç≠„É£„É≥„Çª„É´</button>
                </div>
            `;
            inputArea.style.background = '#e8f5e8';
            inputArea.style.borderColor = '#28a745';
            inputArea.style.display = 'block';
            
            const textField = document.getElementById('unifiedAddText');
            textField.value = '';
            textField.placeholder = `${selectedTarget === 'timing' ? '„Çø„Ç§„Éü„É≥„Ç∞' : selectedTarget === 'top' ? '‰∏äÂçäË∫´„ÅÆÊúçË£Ö' : '‰∏ãÂçäË∫´„ÅÆÊúçË£Ö'}„ÇíÂÖ•Âäõ`;
            textField.focus();
        }

        // Áµ±‰∏ÄËøΩÂä†ÂÆüË°å
        window.executeAdd = () => {
            const newItem = document.getElementById('unifiedAddText').value.trim();
            if (!newItem || !selectedTarget) return;

            // „É©„É≥„ÉÄ„É†„Ç´„É©„ÉºÁîüÊàê
            const randomColor = RANDOM_COLORS[Math.floor(Math.random() * RANDOM_COLORS.length)];
            
            // ÂØæË±°„Å´Âøú„Åò„Å¶„Éú„Çø„É≥‰ΩúÊàê
            const containers = {
                timing: document.getElementById('timingButtons'),
                top: document.getElementById('topClothingButtons'),
                bottom: document.getElementById('bottomClothingButtons')
            };
            
            const button = document.createElement('button');
            button.type = 'button';
            
            if (selectedTarget === 'timing') {
                button.className = 'timing-btn';
                button.setAttribute('data-timing', newItem);
                button.onclick = () => selectTiming(newItem);
                button.textContent = `‚è∞ ${newItem}`;
            } else if (selectedTarget === 'top') {
                button.className = 'clothing-btn';
                button.setAttribute('data-clothing-top', newItem);
                button.onclick = () => selectClothingTop(newItem);
                button.textContent = `üëî ${newItem}`;
            } else if (selectedTarget === 'bottom') {
                button.className = 'clothing-btn';
                button.setAttribute('data-clothing-bottom', newItem);
                button.onclick = () => selectClothingBottom(newItem);
                button.textContent = `üëñ ${newItem}`;
            }
            
            button.style.cssText = `background: ${randomColor}; color: white; opacity: 0.7;`;
            button.setAttribute('data-original-color', randomColor);
            
            containers[selectedTarget].appendChild(button);
            
            // ËøΩÂä†Âæå„Åô„Åê„Å´ÈÅ∏Êäû
            if (selectedTarget === 'timing') selectTiming(newItem);
            else if (selectedTarget === 'top') selectClothingTop(newItem);
            else if (selectedTarget === 'bottom') selectClothingBottom(newItem);
            
            // Ê∞∏Á∂öÂåñ‰øùÂ≠ò
            saveCustomItems();
            
            // „É≠„Ç∞Âá∫Âäõ
            const targetName = selectedTarget === 'timing' ? '„Çø„Ç§„Éü„É≥„Ç∞' : selectedTarget === 'top' ? '‰∏äÂçäË∫´' : '‰∏ãÂçäË∫´';
            log(`‚úÖ ${targetName}È†ÖÁõÆËøΩÂä†: ${newItem}`);
            
            // ÂÖ•Âäõ„Ç®„É™„Ç¢„ÇíÈùûË°®Á§∫
            cancelAdd();
        };

        // ËøΩÂä†„Ç≠„É£„É≥„Çª„É´
        window.cancelAdd = () => {
            document.getElementById('unifiedAddInput').style.display = 'none';
            document.getElementById('unifiedAddText').value = '';
        };

        // „É¢„Éº„ÉâUIÊõ¥Êñ∞
        function updateModeUI() {
            const buttons = {
                normal: document.getElementById('normalModeBtn'),
                add: document.getElementById('addModeBtn'),
                delete: document.getElementById('deleteModeBtn')
            };

            // „Åô„Åπ„Å¶„É™„Çª„ÉÉ„Éà
            Object.entries(buttons).forEach(([key, btn]) => {
                btn.style.background = '#6c757d';
            });

            // ÈÅ∏Êäû„Åï„Çå„Åü„É¢„Éº„Éâ„ÇíÂº∑Ë™ø
            if (buttons[currentMode]) {
                const colors = { normal: '#007bff', add: '#28a745', delete: '#dc3545' };
                buttons[currentMode].style.background = colors[currentMode];
            }

            // „É¢„Éº„ÉâÂà•„ÅÆË°®Á§∫Âà∂Âæ°
            if (currentMode === 'add') {
                // ËøΩÂä†„É¢„Éº„ÉâÊôÇ„ÅÆ„Ç¨„Ç§„ÉÄ„É≥„ÇπË°®Á§∫
                updateAddModeGuidance();
            } else if (currentMode === 'delete') {
                // ÂâäÈô§„É¢„Éº„ÉâÊôÇ„ÅÆ„Ç¨„Ç§„ÉÄ„É≥„ÇπË°®Á§∫
                updateDeleteModeGuidance();
            } else {
                // ÈÄöÂ∏∏„É¢„Éº„ÉâÊôÇ„ÅØÁµ±‰∏ÄÂÖ•Âäõ„ÇíÈùûË°®Á§∫
                document.getElementById('unifiedAddInput').style.display = 'none';
            }
        }

        // ËøΩÂä†„É¢„Éº„Éâ„Ç¨„Ç§„ÉÄ„É≥„ÇπÊõ¥Êñ∞
        function updateAddModeGuidance() {
            const inputArea = document.getElementById('unifiedAddInput');
            
            if (!selectedTarget) {
                // ÂØæË±°Êú™ÈÅ∏ÊäûÊôÇ„ÅØ„Ç¨„Ç§„ÉÄ„É≥„ÇπË°®Á§∫
                inputArea.style.display = 'block';
                inputArea.innerHTML = `
                    <div style="margin-bottom: 5px;">
                        <span style="font-size: 11px; color: #856404; font-weight: bold;">üëÜ ËøΩÂä†„Åó„Åü„ÅÑÈ†ÖÁõÆ„ÅÆÂØæË±°„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
                    </div>
                `;
                inputArea.style.background = '#fff3cd';
                inputArea.style.borderColor = '#ffc107';
            }
        }

        // ÂâäÈô§„É¢„Éº„Éâ„Ç¨„Ç§„ÉÄ„É≥„ÇπÊõ¥Êñ∞
        function updateDeleteModeGuidance() {
            const inputArea = document.getElementById('unifiedAddInput');
            
            if (!selectedTarget) {
                // ÂØæË±°Êú™ÈÅ∏ÊäûÊôÇ„ÅØ„Ç¨„Ç§„ÉÄ„É≥„ÇπË°®Á§∫
                inputArea.style.display = 'block';
                inputArea.innerHTML = `
                    <div style="margin-bottom: 5px;">
                        <span style="font-size: 11px; color: #721c24; font-weight: bold;">üëÜ ÂâäÈô§„Åó„Åü„ÅÑÈ†ÖÁõÆ„ÅÆÂØæË±°„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
                    </div>
                `;
                inputArea.style.background = '#f8d7da';
                inputArea.style.borderColor = '#dc3545';
            } else {
                // ÂØæË±°ÈÅ∏ÊäûÊ∏à„ÅøÊôÇ„ÅØÂâäÈô§ÊñπÊ≥ï„ÅÆÊ°àÂÜÖ
                inputArea.style.display = 'block';
                inputArea.innerHTML = `
                    <div style="margin-bottom: 5px;">
                        <span style="font-size: 11px; color: #721c24; font-weight: bold;">‚ùå Ëµ§Ëâ≤„ÅÆ„Ç´„Çπ„Çø„É†È†ÖÁõÆ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÂâäÈô§</span>
                    </div>
                `;
                inputArea.style.background = '#f8d7da';
                inputArea.style.borderColor = '#dc3545';
            }
        }

        // ÂØæË±°UIÊõ¥Êñ∞
        function updateTargetUI() {
            const buttons = {
                timing: document.getElementById('timingTargetBtn'),
                top: document.getElementById('topTargetBtn'),
                bottom: document.getElementById('bottomTargetBtn')
            };

            // „Åô„Åπ„Å¶„É™„Çª„ÉÉ„Éà
            Object.entries(buttons).forEach(([key, btn]) => {
                btn.style.background = '#6c757d';
            });

            // ÈÅ∏Êäû„Åï„Çå„ÅüÂØæË±°„ÇíÂº∑Ë™ø
            if (selectedTarget && buttons[selectedTarget]) {
                buttons[selectedTarget].style.background = '#007bff';
            }
        }

        // ÂâäÈô§„É¢„Éº„ÉâË°®Á§∫Êõ¥Êñ∞
        function updateDeleteModeDisplay() {
            if (currentMode !== 'delete' || !selectedTarget) {
                // ÂâäÈô§„É¢„Éº„Éâ‰ª•Â§ñ„Åß„ÅØÂÖÉ„ÅÆË°®Á§∫„Å´Êàª„Åô
                restoreNormalDisplay();
                return;
            }

            const selectors = {
                timing: '.timing-btn',
                top: '.clothing-btn[data-clothing-top]',
                bottom: '.clothing-btn[data-clothing-bottom]'
            };

            const buttons = document.querySelectorAll(selectors[selectedTarget]);
            
            buttons.forEach(btn => {
                const item = btn.getAttribute(`data-${selectedTarget === 'timing' ? 'timing' : selectedTarget === 'top' ? 'clothing-top' : 'clothing-bottom'}`);
                if (isCustomItem(item, selectedTarget)) {
                    // „Ç´„Çπ„Çø„É†È†ÖÁõÆ„ÇíÂâäÈô§„É¢„Éº„ÉâË°®Á§∫„Å´
                    btn.style.background = '#dc3545';
                    btn.style.transform = 'scale(0.9)';
                    btn.innerHTML = `‚ùå ${item}`;
                    
                    // Êó¢Â≠ò„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂâäÈô§„Åó„Å¶„Åã„ÇâÊñ∞„Åó„ÅÑ„ÇÇ„ÅÆ„ÇíËøΩÂä†
                    btn.replaceWith(btn.cloneNode(true));
                    const newBtn = document.querySelector(`[data-${selectedTarget === 'timing' ? 'timing' : selectedTarget === 'top' ? 'clothing-top' : 'clothing-bottom'}="${item}"]`);
                    newBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        deleteCustomItem(item, selectedTarget);
                        // ÂâäÈô§Âæå„Å´„É¢„Éº„Éâ„ÇíÈÄöÂ∏∏„Å´Êàª„Åô
                        setMode('normal');
                    });
                } else {
                    // „Éá„Éï„Ç©„É´„ÉàÈ†ÖÁõÆ„ÅØÁÑ°ÂäπÂåñÔºàÂâäÈô§‰∏çÂèØ„ÅÆË°®Á§∫Ôºâ
                    btn.style.opacity = '0.5';
                    btn.style.transform = 'scale(0.95)';
                }
            });

            log(`üóëÔ∏è ÂâäÈô§„É¢„Éº„Éâ: ${selectedTarget === 'timing' ? '„Çø„Ç§„Éü„É≥„Ç∞' : selectedTarget === 'top' ? '‰∏äÂçäË∫´' : '‰∏ãÂçäË∫´'}„ÅÆ„Ç´„Çπ„Çø„É†È†ÖÁõÆ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÂâäÈô§`);
        }

        // ÈÄöÂ∏∏Ë°®Á§∫„Å´Âæ©Êóß
        function restoreNormalDisplay() {
            const allButtons = document.querySelectorAll('.timing-btn, .clothing-btn');
            
            allButtons.forEach(btn => {
                const item = btn.getAttribute('data-timing') || btn.getAttribute('data-clothing-top') || btn.getAttribute('data-clothing-bottom');
                const originalColor = btn.getAttribute('data-original-color');
                
                // ÈÄöÂ∏∏„ÅÆË°®Á§∫„Å´Âæ©Êóß
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
                
                if (originalColor) {
                    // „Ç´„Çπ„Çø„É†È†ÖÁõÆ
                    btn.style.background = originalColor;
                    if (btn.classList.contains('timing-btn')) {
                        btn.innerHTML = `‚è∞ ${item}`;
                        btn.onclick = () => selectTiming(item);
                    } else if (btn.hasAttribute('data-clothing-top')) {
                        btn.innerHTML = `üëî ${item}`;
                        btn.onclick = () => selectClothingTop(item);
                    } else if (btn.hasAttribute('data-clothing-bottom')) {
                        btn.innerHTML = `üëñ ${item}`;
                        btn.onclick = () => selectClothingBottom(item);
                    }
                }
                // „Éá„Éï„Ç©„É´„ÉàÈ†ÖÁõÆ„ÅØÂÖÉ„Åã„ÇâÊ≠£„Åó„ÅÑË°®Á§∫„Å™„ÅÆ„Åß‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            });
        }

        // „Ç´„Çπ„Çø„É†È†ÖÁõÆÂà§ÂÆöÔºàÁµ±‰∏ÄÁâàÔºâ
        function isCustomItem(item, target) {
            const defaults = {
                timing: ['Ëµ∑Â∫äÂæå', '„Éà„Ç§„É¨Ââç', '„Éà„Ç§„É¨Âæå', 'È¢®ÂëÇÂâç', 'È¢®ÂëÇÂæå', 'È£ü‰∫ãÂâç', 'È£ü‰∫ãÂæå'],
                top: ['„Å™„Åó', '‰∏ãÁùÄ„Ç∑„É£„ÉÑ', '„ÉØ„Ç§„Ç∑„É£„ÉÑ'],
                bottom: ['„Å™„Åó', '„Éà„É©„É≥„ÇØ„Çπ', '„Éè„Éº„Éï„Éë„É≥„ÉÑ']
            };
            return !defaults[target].includes(item);
        }

        // „Ç´„Çπ„Çø„É†È†ÖÁõÆÂâäÈô§ÔºàÁµ±‰∏ÄÁâàÔºâ
        function deleteCustomItem(item, target) {
            const selector = `[data-${target === 'timing' ? 'timing' : target === 'top' ? 'clothing-top' : 'clothing-bottom'}="${item}"]`;
            const button = document.querySelector(selector);
            if (button && isCustomItem(item, target)) {
                button.remove();
                saveCustomItems();
                log(`üóëÔ∏è „Ç´„Çπ„Çø„É†È†ÖÁõÆÂâäÈô§: ${item} (${target === 'timing' ? '„Çø„Ç§„Éü„É≥„Ç∞' : target === 'top' ? '‰∏äÂçäË∫´' : '‰∏ãÂçäË∫´'})`);
            }
        }

        // Áµ±‰∏Ä„É¢„Éº„Éâ„Ç∑„Çπ„ÉÜ„É†ÂÆå‰∫Ü - Âè§„ÅÑÂÄãÂà•Èñ¢Êï∞Áæ§„ÅØÂâäÈô§Ê∏à„Åø

        // „Ç≠„Éº„Éú„Éº„Éâ„Åß„ÅÆÂÄ§Ë™øÊï¥Ê©üËÉΩ
        window.handleWeightKeypress = (event) => {
            const weightInput = document.getElementById('weightValue');
            const currentValue = parseFloat(weightInput.value) || 72.0;
            
            if (event.key === 'ArrowUp') {
                event.preventDefault();
                weightInput.value = (currentValue + 0.1).toFixed(1);
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                weightInput.value = Math.max(0, currentValue - 0.1).toFixed(1);
            }
        };

        // „Çø„Ç§„Éü„É≥„Ç∞ÈÅ∏ÊäûÊ©üËÉΩÔºàÊîπËâØÁâàÔºâ
        window.selectTiming = (timing) => {
            selectedTimingValue = timing;
            document.getElementById('selectedTiming').value = timing;
            
            // „Åô„Åπ„Å¶„ÅÆ„Éú„Çø„É≥„Åã„ÇâÈÅ∏ÊäûÁä∂ÊÖã„ÇíÂâäÈô§
            document.querySelectorAll('.timing-btn').forEach(btn => {
                btn.classList.remove('selected');
                btn.style.opacity = '0.7';
            });
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Éú„Çø„É≥„Å´ÈÅ∏ÊäûÁä∂ÊÖã„ÇíËøΩÂä†
            const selectedBtn = document.querySelector(`[data-timing="${timing}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
                selectedBtn.style.opacity = '1';
            }
            
            log(`‚è∞ Ê∏¨ÂÆö„Çø„Ç§„Éü„É≥„Ç∞ÈÅ∏Êäû: ${timing}`);
        };

        // ‰∏äÂçäË∫´ÊúçË£ÖÈÅ∏ÊäûÊ©üËÉΩ
        window.selectClothingTop = (clothing) => {
            selectedTopValue = clothing;
            document.getElementById('selectedTop').value = clothing;
            
            // „Åô„Åπ„Å¶„ÅÆ‰∏äÂçäË∫´„Éú„Çø„É≥„Åã„ÇâÈÅ∏ÊäûÁä∂ÊÖã„ÇíÂâäÈô§
            document.querySelectorAll('.clothing-btn[data-clothing-top]').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Éú„Çø„É≥„Å´ÈÅ∏ÊäûÁä∂ÊÖã„ÇíËøΩÂä†
            const selectedBtn = document.querySelector(`[data-clothing-top="${clothing}"]`);
            if (selectedBtn) {
                selectedBtn.style.opacity = '1';
                selectedBtn.style.transform = 'scale(1.05)';
            }
            
            log(`üëï ‰∏äÂçäË∫´ÈÅ∏Êäû: ${clothing}`);
        };

        // ‰∏ãÂçäË∫´ÊúçË£ÖÈÅ∏ÊäûÊ©üËÉΩ
        window.selectClothingBottom = (clothing) => {
            selectedBottomValue = clothing;
            document.getElementById('selectedBottom').value = clothing;
            
            // „Åô„Åπ„Å¶„ÅÆ‰∏ãÂçäË∫´„Éú„Çø„É≥„Åã„ÇâÈÅ∏ÊäûÁä∂ÊÖã„ÇíÂâäÈô§
            document.querySelectorAll('.clothing-btn[data-clothing-bottom]').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Éú„Çø„É≥„Å´ÈÅ∏ÊäûÁä∂ÊÖã„ÇíËøΩÂä†
            const selectedBtn = document.querySelector(`[data-clothing-bottom="${clothing}"]`);
            if (selectedBtn) {
                selectedBtn.style.opacity = '1';
                selectedBtn.style.transform = 'scale(1.05)';
            }
            
            log(`ü©≤ ‰∏ãÂçäË∫´ÈÅ∏Êäû: ${clothing}`);
        };

        // Áµ±‰∏Ä„Ç´„Çπ„Çø„É†È†ÖÁõÆËøΩÂä†„Ç∑„Çπ„ÉÜ„É†ÔºàaddCustomClothingTop „ÅØÁµ±‰∏Ä„É¢„Éº„Éâ„Å´ÁßªË°åÔºâ

        window.addTopCustomItem = () => {
            const newItem = document.getElementById('topCustomText').value.trim();
            if (newItem) {
                const container = document.getElementById('topClothingButtons');
                
                // „É©„É≥„ÉÄ„É†„Ç´„É©„ÉºÁîüÊàêÔºàÁµ±‰∏ÄÂÆöÊï∞‰ΩøÁî®Ôºâ
                // const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a55eea']; // ÈáçË§áÂâäÈô§
                const randomColor = RANDOM_COLORS[Math.floor(Math.random() * RANDOM_COLORS.length)];
                
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'clothing-btn';
                button.setAttribute('data-clothing-top', newItem);
                button.onclick = () => selectClothingTop(newItem);
                button.style.cssText = `background: ${randomColor}; color: white; opacity: 0.7;`;
                button.setAttribute('data-original-color', randomColor);
                button.textContent = `üëî ${newItem}`;
                
                container.appendChild(button);
                log(`‚úÖ Êñ∞„Åó„ÅÑ‰∏äÂçäË∫´È†ÖÁõÆËøΩÂä†: ${newItem}`);
                
                // ËøΩÂä†Âæå„Åô„Åê„Å´ÈÅ∏Êäû
                selectClothingTop(newItem);
                
                // „Ç´„Çπ„Çø„É†È†ÖÁõÆ„ÇíÊ∞∏Á∂öÂåñ‰øùÂ≠ò
                saveCustomItems();
                
                // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„É™„Çª„ÉÉ„Éà„ÉªÈùûË°®Á§∫
                document.getElementById('topCustomText').value = '';
                document.getElementById('topCustomInput').style.display = 'none';
            }
        };

        window.cancelTopCustom = () => {
            document.getElementById('topCustomText').value = '';
            document.getElementById('topCustomInput').style.display = 'none';
        };

        // „Ç´„Çπ„Çø„É†‰∏ãÂçäË∫´È†ÖÁõÆËøΩÂä†ÔºàÊîπËâØÁâà - „Çπ„Éû„ÉõÂØæÂøúÔºâ
        window.addCustomClothingBottom = () => {
            document.getElementById('bottomCustomInput').style.display = 'block';
            document.getElementById('bottomCustomText').focus();
        };

        window.addBottomCustomItem = () => {
            const newItem = document.getElementById('bottomCustomText').value.trim();
            if (newItem) {
                const container = document.getElementById('bottomClothingButtons');
                
                // „É©„É≥„ÉÄ„É†„Ç´„É©„ÉºÁîüÊàêÔºàÁµ±‰∏ÄÂÆöÊï∞‰ΩøÁî®Ôºâ
                // const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a55eea']; // ÈáçË§áÂâäÈô§
                const randomColor = RANDOM_COLORS[Math.floor(Math.random() * RANDOM_COLORS.length)];
                
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'clothing-btn';
                button.setAttribute('data-clothing-bottom', newItem);
                button.onclick = () => selectClothingBottom(newItem);
                button.style.cssText = `background: ${randomColor}; color: white; opacity: 0.7;`;
                button.setAttribute('data-original-color', randomColor);
                button.textContent = `üëñ ${newItem}`;
                
                container.appendChild(button);
                log(`‚úÖ Êñ∞„Åó„ÅÑ‰∏ãÂçäË∫´È†ÖÁõÆËøΩÂä†: ${newItem}`);
                
                // ËøΩÂä†Âæå„Åô„Åê„Å´ÈÅ∏Êäû
                selectClothingBottom(newItem);
                
                // „Ç´„Çπ„Çø„É†È†ÖÁõÆ„ÇíÊ∞∏Á∂öÂåñ‰øùÂ≠ò
                saveCustomItems();
                
                // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„É™„Çª„ÉÉ„Éà„ÉªÈùûË°®Á§∫
                document.getElementById('bottomCustomText').value = '';
                document.getElementById('bottomCustomInput').style.display = 'none';
            }
        };

        window.cancelBottomCustom = () => {
            document.getElementById('bottomCustomText').value = '';
            document.getElementById('bottomCustomInput').style.display = 'none';
        };

        // „Ç´„Çπ„Çø„É†„Çø„Ç§„Éü„É≥„Ç∞È†ÖÁõÆËøΩÂä†ÔºàÊîπËâØÁâà - „Çπ„Éû„ÉõÂØæÂøúÔºâ
        window.addCustomTiming = () => {
            document.getElementById('timingCustomInput').style.display = 'block';
            document.getElementById('timingCustomText').focus();
        };

        window.addTimingCustomItem = () => {
            const newItem = document.getElementById('timingCustomText').value.trim();
            if (newItem) {
                const container = document.getElementById('timingButtons');
                
                // „É©„É≥„ÉÄ„É†„Ç´„É©„ÉºÁîüÊàêÔºàÁµ±‰∏ÄÂÆöÊï∞‰ΩøÁî®Ôºâ
                // const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a55eea']; // ÈáçË§áÂâäÈô§
                const randomColor = RANDOM_COLORS[Math.floor(Math.random() * RANDOM_COLORS.length)];
                
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'timing-btn';
                button.setAttribute('data-timing', newItem);
                button.onclick = () => selectTiming(newItem);
                button.style.cssText = `background: ${randomColor}; color: white; opacity: 0.7;`;
                button.setAttribute('data-original-color', randomColor);
                button.textContent = `‚è∞ ${newItem}`;
                
                container.appendChild(button);
                log(`‚úÖ Êñ∞„Åó„ÅÑ„Çø„Ç§„Éü„É≥„Ç∞È†ÖÁõÆËøΩÂä†: ${newItem}`);
                
                // ËøΩÂä†Âæå„Åô„Åê„Å´ÈÅ∏Êäû
                selectTiming(newItem);
                
                // „Ç´„Çπ„Çø„É†È†ÖÁõÆ„ÇíÊ∞∏Á∂öÂåñ‰øùÂ≠ò
                saveCustomItems();
                
                // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„É™„Çª„ÉÉ„Éà„ÉªÈùûË°®Á§∫
                document.getElementById('timingCustomText').value = '';
                document.getElementById('timingCustomInput').style.display = 'none';
            }
        };

        window.cancelTimingCustom = () => {
            document.getElementById('timingCustomText').value = '';
            document.getElementById('timingCustomInput').style.display = 'none';
        };


        // Ë™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñÔºàÊîπËâØÁâà + „É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÂØæÂøúÔºâ
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            if (user) {
                log(`‚úÖ Ë™çË®ºÁä∂ÊÖãÁ¢∫Ë™ç: ${user.displayName} „Åß„É≠„Ç∞„Ç§„É≥‰∏≠`);
                log(`üìß „É°„Éº„É´: ${user.email}`);
                showUserInterface(user);
                loadUserWeightData(user.uid);
            } else {
                // „É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÁµêÊûú„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºàiPhoneÂØæÂøúÔºâ
                try {
                    const result = await auth.getRedirectResult();
                    if (result.user) {
                        log(`‚úÖ „É™„ÉÄ„Ç§„É¨„ÇØ„Éà„É≠„Ç∞„Ç§„É≥ÊàêÂäü: ${result.user.displayName}`);
                    }
                } catch (error) {
                    // „É™„ÉÄ„Ç§„É¨„ÇØ„Éà„Ç®„É©„Éº„ÅØÁÑ°Ë¶ñÔºàÂàùÂõû„Ç¢„ÇØ„Çª„ÇπÊôÇ„Å™„Å©Ôºâ
                }
                log('üîí Ë™çË®ºÁä∂ÊÖã: Êú™„É≠„Ç∞„Ç§„É≥');
                showLoginInterface();
            }
        });

        // ÂàùÊúüÂåñÂÆå‰∫Ü„É≠„Ç∞
        log('üîÑ FirebaseË™çË®º„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü - Ë™çË®ºÁä∂ÊÖã„ÇíÁ¢∫Ë™ç‰∏≠...');

        // Google„É≠„Ç∞„Ç§„É≥ÔºàÊîπËâØÁâà - „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Éñ„É≠„ÉÉ„ÇØÊ§úÁü•‰ªò„ÅçÔºâ
        window.handleGoogleLogin = async () => {
            try {
                log('üîê Google„É≠„Ç∞„Ç§„É≥ÈñãÂßã...');
                const provider = new firebase.auth.GoogleAuthProvider();
                
                // „É¢„Éê„Ç§„É´„Éá„Éê„Ç§„ÇπÊ§úÂá∫ÔºàiPhoneÂ∞ÇÁî®ÂØæÂøúÔºâ
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const isIPhone = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                
                // iPhone„ÅØ„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÊñπÂºè„ÄÅ„Åù„Çå‰ª•Â§ñ„ÅØ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÊñπÂºè
                if (isIPhone) {
                    log('üì± iPhone/iPadÊ§úÂá∫ - „É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÊñπÂºè„Åß„É≠„Ç∞„Ç§„É≥ÔºàSafariÂØæÂøúÔºâ');
                    log('üîÑ „Éö„Éº„Ç∏„ÅåGoogle„Å´ÁßªÂãï„Åó„Åæ„Åô...');
                    // „É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÊñπÂºèÔºàiPhoneÂ∞ÇÁî®Ôºâ
                    await auth.signInWithRedirect(provider);
                    return; // „É™„ÉÄ„Ç§„É¨„ÇØ„Éà„Åô„Çã„ÅÆ„Åß„Åì„Åì„ÅßÁµÇ‰∫Ü
                } else if (isMobile) {
                    log('üì± „É¢„Éê„Ç§„É´„Éá„Éê„Ç§„ÇπÊ§úÂá∫ - „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÊñπÂºè„Åß„É≠„Ç∞„Ç§„É≥');
                    log('üí° „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅåÈÄî‰∏≠„ÅßÊ≠¢„Åæ„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Éñ„É©„Ç¶„Ç∂Ë®≠ÂÆö„ÅÆÁ¢∫Ë™ç„ÅåÂøÖË¶Å„Åß„Åô');
                } else {
                    log('üñ•Ô∏è „Éá„Çπ„ÇØ„Éà„ÉÉ„Éó„Éá„Éê„Ç§„Çπ - „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÊñπÂºè„Åß„É≠„Ç∞„Ç§„É≥');
                }
                
                // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Éñ„É≠„ÉÉ„ÇØÊ§úÁü•„ÅÆ„Åü„ÇÅ„ÅÆ„Çø„Ç§„É†„Ç¢„Ç¶„ÉàË®≠ÂÆöÔºàiPhone‰ª•Â§ñÔºâ
                log('ü™ü „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅßGoogle„É≠„Ç∞„Ç§„É≥„ÇíÈñãÂßã...');
                
                const loginPromise = auth.signInWithPopup(provider);
                
                // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàÊ§úÁü•Ôºà15Áßí„Åß„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅåÈñã„Åã„Å™„ÅÑÂ†¥ÂêàÔºâ
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => {
                        reject(new Error('„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Çø„Ç§„É†„Ç¢„Ç¶„Éà - „Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„ÅüÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô'));
                    }, 15000);  // ÂÖÉ„ÅÆ15Áßí„Å´Êàª„ÅôÔºàiPhone‰ª•Â§ñÁî®Ôºâ
                });
                
                try {
                    const result = await Promise.race([loginPromise, timeoutPromise]);
                    log(`‚úÖ „É≠„Ç∞„Ç§„É≥ÊàêÂäü: ${result.user.displayName}`);
                } catch (raceError) {
                    // „Çø„Ç§„É†„Ç¢„Ç¶„Éà„ÅÆÂ†¥Âêà„ÅÆÁâπÂà•Âá¶ÁêÜ
                    if (raceError.message.includes('„Çø„Ç§„É†„Ç¢„Ç¶„Éà')) {
                        log('‚è∞ „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå15Áßí‰ª•ÂÜÖ„Å´Èñã„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                        log('üîÑ „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Éñ„É≠„ÉÉ„ÇØÊ§úÁü• - Ëß£Ê±∫ÊñπÊ≥ï„Çí„ÅîÊ°àÂÜÖ„Åó„Åæ„Åô');
                        throw new Error('POPUP_TIMEOUT');
                    } else {
                        throw raceError;
                    }
                }
                
            } catch (error) {
                log(`‚ùå „É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº: ${error.message}`);
                
                // „Ç®„É©„Éº„ÅÆË©≥Á¥∞ÊÉÖÂ†±„Çí„É≠„Ç∞„Å´Âá∫Âäõ
                if (error.code) {
                    log(`- „Ç®„É©„Éº„Ç≥„Éº„Éâ: ${error.code}`);
                    
                    // ÁâπÂÆö„ÅÆ„Ç®„É©„Éº„Ç≥„Éº„Éâ„Å´ÂØæ„Åô„ÇãËß£Ê±∫Á≠ñ„ÇíÊèêÁ§∫
                    switch(error.code) {
                        case 'auth/unauthorized-domain':
                            log('üí° „Éâ„É°„Ç§„É≥Ë®±ÂèØË®≠ÂÆö„ÅÆÂïèÈ°å„Åß„Åô');
                            log('üí° Firebase Console„ÅßË™çË®º„Éâ„É°„Ç§„É≥„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                            break;
                        case 'auth/popup-blocked':
                            log('üí° „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü');
                            showPopupGuide(isMobile);
                            break;
                        case 'auth/popup-closed-by-user':
                            log('üí° „É¶„Éº„Ç∂„Éº„Åå„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÈñâ„Åò„Åæ„Åó„Åü');
                            log('üí° „ÇÇ„ÅÜ‰∏ÄÂ∫¶„É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                            break;
                        case 'auth/cancelled-popup-request':
                            log('üí° ÂâçÂõû„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü');
                            log('üí° „Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                            break;
                        default:
                            if (error.message === 'POPUP_TIMEOUT') {
                                log('‚ö†Ô∏è „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅåÈÄî‰∏≠„ÅßÊ≠¢„Åæ„Çä„Åæ„Åó„Åü');
                                showPopupGuide(isMobile);
                            } else {
                                log('üí° „Éñ„É©„Ç¶„Ç∂„ÇíÊõ¥Êñ∞„Åó„Å¶„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ');
                            }
                    }
                } else if (error.message === 'POPUP_TIMEOUT') {
                    showPopupGuide(isMobile);
                }
                
                if (error.credential) {
                    log('- Ë™çË®ºÊÉÖÂ†±„ÅØÂèñÂæóÊ∏à„Åø');
                }
            }
        };

        // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË®±ÂèØ„Ç¨„Ç§„ÉâË°®Á§∫
        function showPopupGuide(isMobile) {
            log('üìñ === „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË®±ÂèØ„Ç¨„Ç§„Éâ ===');
            if (isMobile) {
                log('üì± „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥Âêë„ÅëËß£Ê±∫ÊâãÈ†Ü:');
                log('1. „Éö„Éº„Ç∏‰∏äÈÉ®„ÅÆ„Ç¢„Éâ„É¨„Çπ„Éê„Éº„Å´Ë°®Á§∫„Åï„Çå„Çã„Äå„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü„Äç„Çí„Çø„ÉÉ„Éó');
                log('2. „Åæ„Åü„ÅØ„ÄÅ„Éñ„É©„Ç¶„Ç∂„É°„Éã„É•„Éº(‚ãÆ) ‚Üí Ë®≠ÂÆö ‚Üí „Çµ„Ç§„ÉàË®≠ÂÆö ‚Üí „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Å®„É™„ÉÄ„Ç§„É¨„ÇØ„Éà ‚Üí Ë®±ÂèØ');
                log('3. Chrome: Âè≥‰∏ä‚ãÆ„É°„Éã„É•„Éº ‚Üí Ë®≠ÂÆö ‚Üí Ë©≥Á¥∞Ë®≠ÂÆö ‚Üí „Çµ„Ç§„ÉàË®≠ÂÆö ‚Üí „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Å®„É™„ÉÄ„Ç§„É¨„ÇØ„Éà');
                log('4. Safari: Ë®≠ÂÆö„Ç¢„Éó„É™ ‚Üí Safari ‚Üí „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Éñ„É≠„ÉÉ„ÇØ ‚Üí „Ç™„Éï');
                log('5. Ë®≠ÂÆöÂæå„ÄÅ„Åì„ÅÆ„Éö„Éº„Ç∏„ÇíÊõ¥Êñ∞„Åó„Å¶„ÇÇ„ÅÜ‰∏ÄÂ∫¶„É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            } else {
                log('üíª PCÂêë„ÅëËß£Ê±∫ÊâãÈ†Ü:');
                log('1. „Ç¢„Éâ„É¨„Çπ„Éê„ÉºÂè≥Á´Ø„ÅÆ„Ç¢„Ç§„Ç≥„É≥(üö´)„Çí„ÇØ„É™„ÉÉ„ÇØ ‚Üí Ë®±ÂèØ');
                log('2. „Åæ„Åü„ÅØ„ÄÅ„Éñ„É©„Ç¶„Ç∂Ë®≠ÂÆö ‚Üí „Éó„É©„Ç§„Éê„Ç∑„Éº„Å®„Çª„Ç≠„É•„É™„ÉÜ„Ç£ ‚Üí „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Å®„É™„ÉÄ„Ç§„É¨„ÇØ„Éà ‚Üí Ë®±ÂèØ');
            }
            log('üí° „Åù„Çå„Åß„ÇÇËß£Ê±∫„Åó„Å™„ÅÑÂ†¥Âêà: „Éó„É©„Ç§„Éô„Éº„Éà„É¢„Éº„Éâ„ÇíÁµÇ‰∫Ü„Åô„Çã„Åã„ÄÅÂà•„ÅÆ„Éñ„É©„Ç¶„Ç∂„Çí„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ');
            log('üîÑ „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Åü„Çâ„ÄÅÂÜçÂ∫¶„ÄåGoogle„Åß„É≠„Ç∞„Ç§„É≥„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            log('üìñ ========================');
        }

        // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÉÜ„Çπ„ÉàÊ©üËÉΩ
        window.testPopup = () => {
            log('üß™ „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÉÜ„Çπ„ÉàÈñãÂßã...');
            
            try {
                const testWindow = window.open('', '_blank', 'width=400,height=500');
                
                if (testWindow) {
                    log('‚úÖ „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË®±ÂèØÊ∏à„Åø - „É≠„Ç∞„Ç§„É≥ÂèØËÉΩ„Åß„Åô');
                    testWindow.close();
                    log('üí° „ÄåGoogle„Åß„É≠„Ç∞„Ç§„É≥„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                } else {
                    log('‚ùå „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    showPopupGuide(isMobile);
                }
            } catch (error) {
                log(`‚ùå „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÉÜ„Çπ„Éà„Ç®„É©„Éº: ${error.message}`);
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                showPopupGuide(isMobile);
            }
        };

        // „É≠„Ç∞„Ç¢„Ç¶„Éà
        window.handleLogout = async () => {
            try {
                await auth.signOut();
                log('üì§ „É≠„Ç∞„Ç¢„Ç¶„ÉàÂÆå‰∫Ü');
            } catch (error) {
                log(`‚ùå „É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº: ${error.message}`);
            }
        };

        // „Éá„Éº„Çø‰øùÂ≠ò
        window.saveWeightData = async () => {
            if (!currentUser) {
                log('‚ùå „É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }

            const date = document.getElementById('dateInput').value;
            const weight = document.getElementById('weightValue').value;
            const memo = document.getElementById('memoInput').value;

            if (!date || !weight) {
                log('‚ùå Êó•‰ªò„Å®ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            try {
                log('üíæ „Éá„Éº„Çø„Çí‰øùÂ≠ò‰∏≠...');
                
                const now = new Date();
                const timeString = now.toLocaleTimeString('ja-JP', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const weightData = {
                    date: date,
                    time: timeString,
                    value: parseFloat(weight),
                    timing: selectedTimingValue || '',
                    clothing: {
                        top: selectedTopValue || '',
                        bottom: selectedBottomValue || ''
                    },
                    memo: memo || '',
                    userEmail: currentUser.email,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    createdAt: now.toISOString()
                };

                if (window.editingEntryId) {
                    // Á∑®ÈõÜ„É¢„Éº„Éâ: Êó¢Â≠ò„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
                    const entryRef = database.ref(`users/${currentUser.uid}/weights/${window.editingEntryId}`);
                    await entryRef.update({
                        date: date,
                        time: timeString,
                        weight: parseFloat(weight),
                        timing: selectedTimingValue || '',
                        clothing: {
                            top: selectedTopValue || '',
                            bottom: selectedBottomValue || ''
                        },
                        memo: memo || '',
                        userEmail: currentUser.email,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                } else {
                    // Êñ∞Ë¶è‰øùÂ≠ò„É¢„Éº„Éâ
                    const userRef = database.ref(`users/${currentUser.uid}/weights`);
                    await userRef.push(weightData);
                }
                
                // ‰øùÂ≠òÂÆå‰∫Ü„É≠„Ç∞ÔºàÊúçË£ÖÊÉÖÂ†±„ÇÇÂê´„ÇÄÔºâ
                let logMessage;
                if (window.editingEntryId) {
                    logMessage = `‚úèÔ∏è Êõ¥Êñ∞ÂÆå‰∫Ü: ${date} ${timeString} - ${weight}kg`;
                } else {
                    logMessage = `‚úÖ ‰øùÂ≠òÂÆå‰∫Ü: ${date} ${timeString} - ${weight}kg`;
                }
                if (selectedTimingValue) logMessage += ` (${selectedTimingValue})`;
                if (selectedTopValue || selectedBottomValue) {
                    const clothingInfo = [selectedTopValue, selectedBottomValue].filter(Boolean).join(', ');
                    logMessage += ` [${clothingInfo}]`;
                }
                log(logMessage);
                
                // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢Ôºà‰ΩìÈáç„ÅØ72.0„Å´Êàª„ÅôÔºâ
                document.getElementById('weightValue').value = '72.0';
                document.getElementById('memoInput').value = '';
                document.getElementById('selectedTop').value = '';
                document.getElementById('selectedBottom').value = '';
                selectedTimingValue = '';
                selectedTopValue = '';
                selectedBottomValue = '';
                
                // Á∑®ÈõÜ„É¢„Éº„Éâ„Çí„É™„Çª„ÉÉ„Éà
                window.editingEntryId = null;
                document.querySelector('.save-button').textContent = 'üíæ ‰øùÂ≠ò';
                document.querySelector('.save-button').style.background = '#28a745';
                
                // Á∑®ÈõÜ„É¢„Éº„Éâ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÂâäÈô§
                const editModeIndicator = document.getElementById('editModeIndicator');
                if (editModeIndicator) {
                    editModeIndicator.remove();
                }
                
                // „Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥„ÇíÂâäÈô§
                const cancelButton = document.getElementById('cancelEditButton');
                if (cancelButton) {
                    cancelButton.remove();
                }
                
                // „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´„Çí„É™„Çª„ÉÉ„Éà
                document.querySelectorAll('.timing-btn').forEach(btn => {
                    btn.style.opacity = '0.7';
                    btn.classList.remove('selected');
                });
                document.querySelectorAll('.clothing-btn').forEach(btn => {
                    btn.style.opacity = '0.7';
                    btn.style.transform = 'scale(1)';
                });
                
                // „Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø
                loadUserWeightData(currentUser.uid);
            } catch (error) {
                log(`‚ùå ‰øùÂ≠ò„Ç®„É©„Éº: ${error.message}`);
            }
        };

        // ‰ΩìÈáç„Éá„Éº„ÇøÁ∑®ÈõÜÊ©üËÉΩ
        window.editWeightEntry = async (entryId) => {
            if (!currentUser) {
                log('‚ùå „É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            try {
                const entryRef = database.ref(`users/${currentUser.uid}/weights/${entryId}`);
                const snapshot = await entryRef.once('value');
                const entry = snapshot.val();
                
                if (!entry) {
                    log('‚ùå Ë®òÈå≤„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                // „Éï„Ç©„Éº„É†„Å´„Éá„Éº„Çø„ÇíË®≠ÂÆö
                document.getElementById('dateInput').value = entry.date;
                document.getElementById('weightValue').value = entry.value || entry.weight;
                document.getElementById('memoInput').value = entry.memo || '';
                
                // „Çø„Ç§„Éü„É≥„Ç∞„ÇíË®≠ÂÆö
                if (entry.timing) {
                    selectTiming(entry.timing);
                }
                
                // ÊúçË£Ö„ÇíË®≠ÂÆö
                if (entry.clothing && entry.clothing.top) {
                    selectClothingTop(entry.clothing.top);
                }
                if (entry.clothing && entry.clothing.bottom) {
                    selectClothingBottom(entry.clothing.bottom);
                }
                
                
                // Á∑®ÈõÜ„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
                window.editingEntryId = entryId;
                document.querySelector('.save-button').textContent = '‚úèÔ∏è Êõ¥Êñ∞';
                document.querySelector('.save-button').style.background = '#ffc107';
                
                // Á∑®ÈõÜ„É¢„Éº„Éâ„Åß„ÅÇ„Çã„Åì„Å®„ÇíÊòéÁ¢∫„Å´Ë°®Á§∫
                const editModeIndicator = document.getElementById('editModeIndicator');
                if (editModeIndicator) {
                    editModeIndicator.remove();
                }
                const indicator = document.createElement('div');
                indicator.id = 'editModeIndicator';
                indicator.innerHTML = '‚úèÔ∏è <strong>Á∑®ÈõÜ„É¢„Éº„Éâ</strong> - ' + entry.date + ' ' + (entry.value || entry.weight) + 'kg„ÅÆ„Éá„Éº„Çø„Çí‰øÆÊ≠£„Åó„Å¶Êõ¥Êñ∞„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                indicator.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 15px; text-align: center; animation: fadeIn 0.3s;';
                document.querySelector('.save-button').parentNode.insertBefore(indicator, document.querySelector('.save-button'));
                
                // „Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥„ÇíËøΩÂä†
                const existingCancelButton = document.getElementById('cancelEditButton');
                if (existingCancelButton) {
                    existingCancelButton.remove();
                }
                const cancelButton = document.createElement('button');
                cancelButton.id = 'cancelEditButton';
                cancelButton.innerHTML = '‚ùå „Ç≠„É£„É≥„Çª„É´';
                cancelButton.onclick = cancelEdit;
                cancelButton.style.cssText = 'background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; margin-left: 10px;';
                document.querySelector('.save-button').parentNode.insertBefore(cancelButton, document.querySelector('.save-button').nextSibling);
                
                log(`‚úèÔ∏è Á∑®ÈõÜ„É¢„Éº„Éâ: ${entry.date} ${entry.value || entry.weight} „ÅÆ„Éá„Éº„Çø„ÇíÁ∑®ÈõÜ‰∏≠`);
                
                // „Éö„Éº„Ç∏„Éà„ÉÉ„Éó„Å´„Çπ„ÇØ„É≠„Éº„É´
                window.scrollTo(0, 0);
                
            } catch (error) {
                log(`‚ùå Á∑®ÈõÜ„Ç®„É©„Éº: ${error.message}`);
            }
        };
        
        // Á∑®ÈõÜ„Ç≠„É£„É≥„Çª„É´Ê©üËÉΩ
        window.cancelEdit = () => {
            // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
            document.getElementById('dateInput').value = '';
            document.getElementById('weightValue').value = '';
            document.getElementById('memoInput').value = '';
            
            // ÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            selectedTimingValue = '';
            selectedTopValue = '';
            selectedBottomValue = '';
            
            // Á∑®ÈõÜ„É¢„Éº„Éâ„Çí„É™„Çª„ÉÉ„Éà
            window.editingEntryId = null;
            document.querySelector('.save-button').textContent = 'üíæ ‰øùÂ≠ò';
            document.querySelector('.save-button').style.background = '#28a745';
            
            // Á∑®ÈõÜ„É¢„Éº„Éâ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÂâäÈô§
            const editModeIndicator = document.getElementById('editModeIndicator');
            if (editModeIndicator) {
                editModeIndicator.remove();
            }
            
            // „Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥„ÇíÂâäÈô§
            const cancelButton = document.getElementById('cancelEditButton');
            if (cancelButton) {
                cancelButton.remove();
            }
            
            // „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´„Çí„É™„Çª„ÉÉ„Éà
            document.querySelectorAll('.timing-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.classList.remove('selected');
            });
            document.querySelectorAll('.clothing-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            log('‚ùå Á∑®ÈõÜ„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åó„Åü');
        };
        
        // „Éá„Éº„ÇøÂâäÈô§
        window.deleteWeightEntry = async (entryId) => {
            if (!currentUser) {
                log('‚ùå „É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            if (!confirm('„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }
            
            try {
                log(`üóëÔ∏è „Éá„Éº„ÇøÂâäÈô§‰∏≠: ${entryId}`);
                const entryRef = database.ref(`users/${currentUser.uid}/weights/${entryId}`);
                await entryRef.remove();
                log(`‚úÖ ÂâäÈô§ÂÆå‰∫Ü: ${entryId}`);
            } catch (error) {
                log(`‚ùå ÂâäÈô§„Ç®„É©„Éº: ${error.message}`);
            }
        };

        // „É¶„Éº„Ç∂„Éº„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
        function loadUserWeightData(userId) {
            const userRef = database.ref(`users/${userId}/weights`);
            userRef.on('value', (snapshot) => {
                const data = snapshot.val();
                const historyDiv = document.getElementById('weightHistory');
                
                if (data) {
                    const entries = Object.entries(data)
                        .map(([key, value]) => ({ id: key, ...value }))
                        .sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
                    
                    // „Ç∞„É©„ÉïÁî®„Å´„Éá„Éº„Çø„Çí‰øùÂ≠ò
                    allWeightData = entries.sort((a, b) => new Date(a.date) - new Date(b.date));
                    updateChart();
                    
                    // Áõ¥Ëøë7‰ª∂„ÅÆ„ÅøË°®Á§∫
                    const recentEntries = entries.slice(-7);
                    
                    historyDiv.innerHTML = recentEntries.map(entry => {
                        let displayText = `${entry.date}`;
                        if (entry.time) displayText += ` ${entry.time}`;
                        displayText += `: ${entry.value || entry.weight}kg`;
                        if (entry.timing) displayText += ` (${entry.timing})`;
                        
                        // ÊúçË£ÖÊÉÖÂ†±„ÇíËøΩÂä†
                        if (entry.clothing && (entry.clothing.top || entry.clothing.bottom)) {
                            const clothingInfo = [entry.clothing.top, entry.clothing.bottom].filter(Boolean).join(', ');
                            displayText += ` [${clothingInfo}]`;
                        }
                        
                        if (entry.memo) displayText += ` - ${entry.memo}`;
                        return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 2px 0; border-bottom: 1px solid #eee;"><span>${displayText}</span><div style="display: flex; gap: 2px;"><button onclick="editWeightEntry('${entry.id}')" style="background: #007bff; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">‚úèÔ∏è</button><button onclick="deleteWeightEntry('${entry.id}')" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">üóëÔ∏è</button></div></div>`;
                    }).join('');
                    
                    log(`üìà „Éá„Éº„ÇøÂ±•Ê≠¥Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü: ${entries.length}‰ª∂`);
                } else {
                    historyDiv.innerHTML = '„Åæ„Å†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                    log('üìà „Éá„Éº„ÇøÂ±•Ê≠¥: „Éá„Éº„Çø„Å™„Åó');
                    allWeightData = [];
                    updateChart();
                }
            });
        }

        // „Ç∞„É©„Éï„ÇíÊõ¥Êñ∞
        // Êó•‰ªòÊåáÂÆö„Åß„ÉÅ„É£„Éº„Éà„ÇíÊõ¥Êñ∞
        function updateChartWithDate(days, endDate) {
            const ctx = document.getElementById('weightChart');
            if (!ctx) return;

            const end = new Date(endDate);
            const startDate = new Date(end);
            if (days > 0) {
                startDate.setDate(end.getDate() - days);
            } else {
                // ÂÖ®ÊúüÈñì„ÅÆÂ†¥Âêà„ÄÅÊúÄ„ÇÇÂè§„ÅÑ„Éá„Éº„Çø„Åã„Çâ
                if (allWeightData.length > 0) {
                    startDate.setTime(new Date(allWeightData[0].date).getTime());
                }
            }

            // ÊúüÈñìÂÜÖ„ÅÆ„Éá„Éº„Çø„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const filteredData = allWeightData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startDate && entryDate <= end;
            });

            // Êó¢Â≠ò„ÅÆupdateChartÈñ¢Êï∞„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„Çí‰ΩøÁî®„Åó„Å¶„ÉÅ„É£„Éº„Éà„ÇíÊèèÁîª
            renderChartWithData(days, filteredData, startDate, end);
        }

        // „ÉÅ„É£„Éº„ÉàÊèèÁîª„ÅÆÂÖ±ÈÄö„É≠„Ç∏„ÉÉ„ÇØÔºàÂÆâÂÖ®„Ç¢„ÇØ„Çª„ÇπÂØæÂøúÔºâ
        function renderChartWithData(days, filteredData, startDate, endDate) {
            const ctx = document.getElementById('weightChart');
            if (!ctx) {
                console.log('‚ö†Ô∏è weightChartË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì - „ÉÅ„É£„Éº„ÉàÊèèÁîª„Çí„Çπ„Ç≠„ÉÉ„Éó');
                return;
            }

            let chartData, datasets = [];
            let timeUnit, displayFormat, axisLabel;
            let dateRangeText = '';

            if (days === 1) {
                // 1Êó•Ë°®Á§∫ÔºöÊôÇÈñìËª∏„Çí‰ΩøÁî®Ôºà24ÊôÇÈñìË°®Á§∫Ôºâ
                chartData = filteredData.map(entry => {
                    const dateTime = entry.time ? 
                        new Date(`${entry.date}T${entry.time}:00`) : 
                        new Date(`${entry.date}T12:00:00`); // ÊôÇÈñì„Å™„Åó„ÅÆÂ†¥Âêà„ÅØ12:00„Å®„Åô„Çã
                    
                    return {
                        x: dateTime,
                        y: parseFloat(entry.value || entry.weight)
                    };
                }).sort((a, b) => a.x - b.x);
                
                // ÂØæË±°Êó•‰ªò„ÇíË°®Á§∫Áî®„Å´Ë®≠ÂÆö
                if (filteredData.length > 0) {
                    const targetDate = new Date(filteredData[0].date);
                    const dateStr = `${targetDate.getMonth() + 1}/${targetDate.getDate()}`;
                    dateRangeText = `${dateStr}„ÅÆ„Éá„Éº„Çø`;
                }
                
                datasets.push({
                    label: '‰ΩìÈáç',
                    data: chartData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    pointRadius: 4,
                    pointHoverRadius: 6
                });

                // ÂâçÊúüÈñì„Éá„Éº„Çø„ÇíËøΩÂä†Ôºà1Êó•Ë°®Á§∫Áî®Ôºâ
                if (showPreviousPeriod) {
                    const previousData = getPreviousPeriodData(days, endDate);
                    if (previousData.length > 0) {
                        const previousChartData = previousData.map(entry => {
                            const dateTime = entry.time ? 
                                new Date(`${entry.date}T${entry.time}:00`) : 
                                new Date(`${entry.date}T12:00:00`);
                            
                            return {
                                x: dateTime,
                                y: parseFloat(entry.weight || entry.value)
                            };
                        }).sort((a, b) => a.x - b.x);

                        datasets.push({
                            label: 'ÂâçÊó•„ÅÆË®òÈå≤',
                            data: previousChartData,
                            borderColor: 'rgba(128, 128, 128, 0.6)',
                            backgroundColor: 'rgba(128, 128, 128, 0.1)',
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderDash: [5, 5]
                        });
                    }
                }
                
                timeUnit = 'hour';
                displayFormat = 'HH:mm';
                axisLabel = 'ÊôÇÈñì';
            } else {
                // Ë§áÊï∞Êó•Ë°®Á§∫ÔºöÊó•‰ªò„Åß„Ç∞„É´„Éº„ÉóÂåñÔºàÊúÄÂ§ßÂÄ§„ÉªÊúÄÂ∞èÂÄ§„ÉªÂπ≥ÂùáÂÄ§„ÇíË°®Á§∫Ôºâ
                const groupedData = {};
                filteredData.forEach(entry => {
                    if (!groupedData[entry.date]) {
                        groupedData[entry.date] = [];
                    }
                    groupedData[entry.date].push(parseFloat(entry.value || entry.weight));
                });

                const avgData = [], maxData = [], minData = [];
                Object.keys(groupedData).sort().forEach(date => {
                    const values = groupedData[date];
                    const avg = values.reduce((a, b) => a + b, 0) / values.length;
                    const max = Math.max(...values);
                    const min = Math.min(...values);
                    
                    avgData.push({ x: date, y: avg });
                    maxData.push({ x: date, y: max });
                    minData.push({ x: date, y: min });
                });

                // Ë§áÊï∞Ê∏¨ÂÆöÊó•„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÂÖ®Á≥ªÂàó„ÇíË°®Á§∫
                const hasMultipleMeasurements = Object.values(groupedData).some(values => values.length > 1);
                
                if (hasMultipleMeasurements) {
                    const avgDataForDisplay = [];
                    const maxDataForDisplay = [];
                    const minDataForDisplay = [];
                    
                    avgData.forEach(item => {
                        const date = item.x;
                        if (groupedData[date] && groupedData[date].length > 1) {
                            avgDataForDisplay.push(item);
                        }
                    });
                    
                    maxData.forEach(item => {
                        const date = item.x;
                        if (groupedData[date] && groupedData[date].length > 1) {
                            maxDataForDisplay.push(item);
                        }
                    });
                    
                    minData.forEach(item => {
                        const date = item.x;
                        if (groupedData[date] && groupedData[date].length > 1) {
                            minDataForDisplay.push(item);
                        }
                    });

                    datasets.push({
                        label: 'Âπ≥ÂùáÂÄ§',
                        data: avgDataForDisplay,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    });

                    if (maxDataForDisplay.length > 0) {
                        datasets.push({
                            label: 'ÊúÄÂ§ßÂÄ§',
                            data: maxDataForDisplay,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderDash: [5, 5]
                        });

                        datasets.push({
                            label: 'ÊúÄÂ∞èÂÄ§',
                            data: minDataForDisplay,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderDash: [5, 5]
                        });
                    }
                } else {
                    datasets.push({
                        label: '‰ΩìÈáç',
                        data: avgData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    });
                }

                // ÂâçÊúüÈñì„Éá„Éº„Çø„ÇíËøΩÂä†ÔºàË§áÊï∞Êó•Ë°®Á§∫Áî®Ôºâ
                if (showPreviousPeriod) {
                    const previousData = getPreviousPeriodData(days, endDate);
                    if (previousData.length > 0) {
                        const previousGroupedData = {};
                        previousData.forEach(entry => {
                            if (!previousGroupedData[entry.date]) {
                                previousGroupedData[entry.date] = [];
                            }
                            previousGroupedData[entry.date].push(parseFloat(entry.weight || entry.value));
                        });

                        const previousAvgData = [];
                        Object.keys(previousGroupedData).sort().forEach(date => {
                            const values = previousGroupedData[date];
                            const avg = values.reduce((a, b) => a + b, 0) / values.length;
                            previousAvgData.push({ x: date, y: avg });
                        });

                        const periodName = days === 7 ? 'ÂâçÈÄ±' : days === 30 ? 'ÂâçÊúà' : days === 90 ? 'Ââç3„É∂Êúà' : days === 365 ? 'ÂâçÂπ¥' : 'ÂâçÊúüÈñì';
                        datasets.push({
                            label: `${periodName}„ÅÆË®òÈå≤`,
                            data: previousAvgData,
                            borderColor: 'rgba(128, 128, 128, 0.6)',
                            backgroundColor: 'rgba(128, 128, 128, 0.1)',
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderDash: [5, 5]
                        });
                    }
                }
                
                // ÊúüÈñìË°®Á§∫„ÉÜ„Ç≠„Çπ„Éà„ÇíË®≠ÂÆö
                if (avgData.length > 0) {
                    const startStr = new Date(avgData[0].x).toLocaleDateString('ja-JP', {month: 'numeric', day: 'numeric'});
                    const endStr = new Date(avgData[avgData.length - 1].x).toLocaleDateString('ja-JP', {month: 'numeric', day: 'numeric'});
                    dateRangeText = `${startStr}ÔΩû${endStr}`;
                }
                
                timeUnit = 'day';
                displayFormat = 'MM/dd';
                axisLabel = 'Êó•‰ªò';
            }

            // ÊúüÈñìË°®Á§∫„ÇíÊõ¥Êñ∞
            updateDateRangeDisplay(dateRangeText);

            // „Ç∞„É©„Éï„ÇíÊèèÁîª
            if (weightChart) {
                weightChart.destroy();
            }

            const chartConfig = {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}kg`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: timeUnit,
                                displayFormats: {
                                    hour: displayFormat,
                                    day: displayFormat
                                }
                            },
                            title: {
                                display: true,
                                text: axisLabel
                            },
                            // 1Êó•Ë°®Á§∫„ÅÆÂ†¥Âêà„ÅØ24ÊôÇÈñìË°®Á§∫
                            ...(days === 1 && filteredData.length > 0 ? {
                                min: new Date(`${filteredData[0].date}T00:00:00`),
                                max: new Date(`${filteredData[0].date}T23:59:59`)
                            } : {})
                        },
                        y: {
                            min: 71.5,
                            max: 74.0,
                            title: {
                                display: true,
                                text: '‰ΩìÈáç (kg)'
                            },
                            ticks: {
                                stepSize: 0.5,
                                callback: function(value) {
                                    return value.toFixed(1) + 'kg';
                                }
                            }
                        }
                    }
                }
            };

            weightChart = new Chart(ctx, chartConfig);
            log(`üìä „Ç∞„É©„ÉïÊõ¥Êñ∞: ${filteredData.length}‰ª∂„ÅÆ„Éá„Éº„ÇøË°®Á§∫ ${dateRangeText}`);
        }

        function updateChart(days = 30) {
            // ÁèæÂú®„ÅÆÊó•‰ªò„ÇíÂü∫Ê∫ñ„Å´Êõ¥Êñ∞
            currentChartDays = days;
            currentChartDate = new Date();
            
            const ctx = document.getElementById('weightChart');
            if (!ctx) return;

            const now = new Date();
            const startDate = new Date(now);
            if (days > 0) {
                startDate.setDate(now.getDate() - days);
            } else {
                // ÂÖ®ÊúüÈñì„ÅÆÂ†¥Âêà„ÄÅÊúÄ„ÇÇÂè§„ÅÑ„Éá„Éº„Çø„Åã„Çâ
                if (allWeightData.length > 0) {
                    startDate.setTime(new Date(allWeightData[0].date).getTime());
                }
            }

            // ÊúüÈñìÂÜÖ„ÅÆ„Éá„Éº„Çø„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const filteredData = allWeightData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startDate && entryDate <= now;
            });

            // ÂÖ±ÈÄö„ÅÆÊèèÁîª„É≠„Ç∏„ÉÉ„ÇØ„Çí‰ΩøÁî®
            renderChartWithData(days, filteredData, startDate, now);
            
            // ÊúüÈñìÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            updateChartPeriodInfo();
        }

        // Êó•‰ªòÁØÑÂõ≤Ë°®Á§∫„ÇíÊõ¥Êñ∞
        function updateDateRangeDisplay(rangeText) {
            const chartContainer = document.querySelector('#chartPanel div[style*="position: relative"]');
            if (!chartContainer) {
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: chartPanel„Çí‰ΩøÁî®
                const chartPanel = document.getElementById('chartPanel');
                if (!chartPanel) {
                    console.warn('Chart panel not found for date range display');
                    return;
                }
                
                let rangeDisplay = document.getElementById('chartDateRange');
                if (!rangeDisplay) {
                    rangeDisplay = document.createElement('div');
                    rangeDisplay.id = 'chartDateRange';
                    rangeDisplay.style.cssText = 'text-align: right; font-size: 12px; color: #666; margin-bottom: 5px; padding: 2px 0;';
                    const h3 = chartPanel.querySelector('h3');
                    if (h3) {
                        h3.insertAdjacentElement('afterend', rangeDisplay);
                    }
                }
                if (rangeDisplay && rangeText) {
                    rangeDisplay.textContent = rangeText;
                }
                return;
            }

            let rangeDisplay = document.getElementById('chartDateRange');
            if (!rangeDisplay) {
                // Êó•‰ªòÁØÑÂõ≤Ë°®Á§∫„Ç®„É™„Ç¢„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ‰ΩúÊàê
                rangeDisplay = document.createElement('div');
                rangeDisplay.id = 'chartDateRange';
                rangeDisplay.style.cssText = 'position: absolute; top: 5px; right: 10px; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px; font-size: 12px; color: #666; border: 1px solid #ddd; z-index: 10;';
                chartContainer.appendChild(rangeDisplay);
            }
            if (rangeDisplay && rangeText) {
                rangeDisplay.textContent = rangeText;
            }
        }

        // „Ç∞„É©„Éï„ÅÆË°®Á§∫ÊúüÈñì„ÇíÂ§âÊõ¥
        window.updateChartRange = (days) => {
            updateChart(days);
            const rangeName = days === 1 ? '1Êó•' :
                            days === 7 ? '1ÈÄ±Èñì' : 
                            days === 30 ? '1„É∂Êúà' : 
                            days === 90 ? '3„É∂Êúà' : 
                            days === 365 ? '1Âπ¥' : 'ÂÖ®ÊúüÈñì';
            log(`üìä „Ç∞„É©„ÉïË°®Á§∫ÊúüÈñìÂ§âÊõ¥: ${rangeName}`);
        }

        // „ÉÅ„É£„Éº„Éà„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥Áî®Â§âÊï∞
        let currentChartDays = 30; // „Éá„Éï„Ç©„É´„ÉàÊúüÈñì
        let currentChartDate = new Date(); // Âü∫Ê∫ñÊó•

        // „ÉÅ„É£„Éº„Éà„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥Ê©üËÉΩ
        window.navigateChart = (direction) => {
            if (currentChartDays === 0) {
                log('‚ö†Ô∏è ÂÖ®ÊúüÈñìË°®Á§∫‰∏≠„ÅØ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Åß„Åç„Åæ„Åõ„Çì');
                return;
            }

            const today = new Date();
            
            if (direction === 'prev') {
                // Ââç„ÅÆÊúüÈñì„Å∏
                currentChartDate.setDate(currentChartDate.getDate() - currentChartDays);
            } else if (direction === 'next') {
                // Ê¨°„ÅÆÊúüÈñì„Å∏
                currentChartDate.setDate(currentChartDate.getDate() + currentChartDays);
                
                // Êú™Êù•„Å´Ë°å„ÅçÈÅé„Åé„Å™„ÅÑ„Çà„ÅÜÂà∂Èôê
                if (currentChartDate > today) {
                    currentChartDate = new Date(today);
                }
            }
            
            // „ÉÅ„É£„Éº„Éà„ÇíÊõ¥Êñ∞
            updateChartWithDate(currentChartDays, currentChartDate);
            
            // ÊúüÈñìÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            updateChartPeriodInfo();
            
            const direction_jp = direction === 'prev' ? 'Ââç' : 'Ê¨°';
            log(`üìä „ÉÅ„É£„Éº„Éà${direction_jp}„Å∏„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥`);
        };

        // ÊúüÈñìÊÉÖÂ†±Ë°®Á§∫„ÇíÊõ¥Êñ∞
        function updateChartPeriodInfo() {
            const periodInfo = document.getElementById('chartPeriodInfo');
            if (!periodInfo) return;
            
            const endDate = new Date(currentChartDate);
            const startDate = new Date(currentChartDate);
            
            if (currentChartDays === 1) {
                // 1Êó•Ë°®Á§∫
                periodInfo.textContent = `${endDate.getMonth() + 1}/${endDate.getDate()} (1Êó•)`;
            } else if (currentChartDays === 7) {
                // 1ÈÄ±ÈñìË°®Á§∫
                startDate.setDate(endDate.getDate() - 6);
                periodInfo.textContent = `${startDate.getMonth() + 1}/${startDate.getDate()} - ${endDate.getMonth() + 1}/${endDate.getDate()} (1ÈÄ±Èñì)`;
            } else if (currentChartDays === 30) {
                // 1„É∂ÊúàË°®Á§∫
                startDate.setDate(endDate.getDate() - 29);
                periodInfo.textContent = `${startDate.getMonth() + 1}/${startDate.getDate()} - ${endDate.getMonth() + 1}/${endDate.getDate()} (1„É∂Êúà)`;
            } else if (currentChartDays === 90) {
                // 3„É∂ÊúàË°®Á§∫
                startDate.setDate(endDate.getDate() - 89);
                periodInfo.textContent = `${startDate.getMonth() + 1}/${startDate.getDate()} - ${endDate.getMonth() + 1}/${endDate.getDate()} (3„É∂Êúà)`;
            } else if (currentChartDays === 365) {
                // 1Âπ¥Ë°®Á§∫
                startDate.setDate(endDate.getDate() - 364);
                periodInfo.textContent = `${startDate.getMonth() + 1}/${startDate.getDate()} - ${endDate.getMonth() + 1}/${endDate.getDate()} (1Âπ¥)`;
            } else {
                periodInfo.textContent = 'ÂÖ®ÊúüÈñì';
            }
        }

        // ÂâçÊúüÈñìÊØîËºÉÊ©üËÉΩ
        function togglePreviousPeriod() {
            showPreviousPeriod = !showPreviousPeriod;
            const btn = document.getElementById('previousPeriodBtn');
            
            if (showPreviousPeriod) {
                btn.style.background = '#dc3545';
                btn.textContent = 'ÂâçÊúüÈñìOFF';
            } else {
                btn.style.background = '#28a745';
                btn.textContent = 'ÂâçÊúüÈñì„ÅÆË®òÈå≤';
            }
            
            // „ÉÅ„É£„Éº„Éà„ÇíÂÜçÊèèÁîª
            updateChartWithDate(currentChartDays, currentChartDate);
            log(`üìä ÂâçÊúüÈñìÊØîËºÉ: ${showPreviousPeriod ? 'ON' : 'OFF'}`);
        }

        // ÂâçÊúüÈñì„Éá„Éº„Çø„ÇíÂèñÂæó
        function getPreviousPeriodData(days, currentEndDate) {
            if (days <= 0) return []; // ÂÖ®ÊúüÈñìË°®Á§∫„ÅÆÂ†¥Âêà„ÅØÂâçÊúüÈñì„Å™„Åó
            
            // ÂâçÊúüÈñì„ÅÆÁµÇ‰∫ÜÊó•„ÇíË®àÁÆó
            const previousEndDate = new Date(currentEndDate);
            if (days === 1) {
                // 1Êó•Ë°®Á§∫„ÅÆÂ†¥ÂêàÔºöÂâçÊó•
                previousEndDate.setDate(currentEndDate.getDate() - 1);
            } else {
                // Ë§áÊï∞Êó•Ë°®Á§∫„ÅÆÂ†¥ÂêàÔºöÂâçÊúüÈñì„ÅÆÁµÇ‰∫ÜÊó•
                previousEndDate.setDate(currentEndDate.getDate() - days);
            }
            
            // ÂâçÊúüÈñì„ÅÆÈñãÂßãÊó•„ÇíË®àÁÆó
            const previousStartDate = new Date(previousEndDate);
            if (days === 1) {
                // 1Êó•Ë°®Á§∫ÔºöÈñãÂßãÊó•=ÁµÇ‰∫ÜÊó•ÔºàÂâçÊó•„ÅÆ„ÅøÔºâ
                previousStartDate.setTime(previousEndDate.getTime());
            } else {
                // Ë§áÊï∞Êó•Ë°®Á§∫ÔºöÊúüÈñì„ÅÆÈñãÂßãÊó•„ÇíË®àÁÆó
                previousStartDate.setDate(previousEndDate.getDate() - days + 1);
            }
            
            // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞
            log(`üîç ÂâçÊúüÈñì„Éá„Éº„ÇøÂèñÂæó: ${days}Êó•, ÁèæÂú®ÁµÇ‰∫ÜÊó•: ${currentEndDate.toDateString()}`);
            log(`üîç ÂâçÊúüÈñìÁØÑÂõ≤: ${previousStartDate.toDateString()} - ${previousEndDate.toDateString()}`);
            
            // ÂâçÊúüÈñì„ÅÆ„Éá„Éº„Çø„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const filteredData = allWeightData.filter(entry => {
                const entryDate = new Date(entry.date);
                const entryDateStr = entry.date; // YYYY-MM-DDÂΩ¢Âºè„ÅÆÊñáÂ≠óÂàó
                const previousStartStr = previousStartDate.toISOString().split('T')[0];
                const previousEndStr = previousEndDate.toISOString().split('T')[0];
                
                // „Éá„Éê„ÉÉ„Ç∞Áî®
                if (days === 1) {
                    log(`üîç „Éá„Éº„ÇøÁ¢∫Ë™ç: ${entryDateStr} vs ${previousStartStr}-${previousEndStr}`);
                }
                
                return entryDateStr >= previousStartStr && entryDateStr <= previousEndStr;
            });
            
            log(`üîç ÂâçÊúüÈñì„Éá„Éº„Çø‰ª∂Êï∞: ${filteredData.length}‰ª∂`);
            return filteredData;
        }

        // „ÉÜ„Çπ„ÉàÁí∞Â¢É„Åß„ÅÆ„Ç¢„ÇØ„Çª„ÇπÁî®ÔºàÊú¨Áï™Áí∞Â¢É„Å´ÂΩ±Èüø„Å™„ÅóÔºâ
        if (typeof window !== 'undefined' && typeof module !== 'undefined') {
            window.getPreviousPeriodData = getPreviousPeriodData;
        }

        // ÁèæÂú®„ÅÆ„Çø„Éñ
        let currentTab = 1;
        
        // „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑÂãïÁöÑË™≠„ÅøËæº„Åø
        window.loadTabContent = async (tabNumber, tabType) => {
            try {
                const tabContentDiv = document.getElementById(`tabContent${tabNumber}`);
                if (!tabContentDiv) return;
                
                // HTML„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíË™≠„ÅøËæº„Åø
                const response = await fetch(`tabs/tab${tabNumber}-${tabType}/${tabType}-tab.html`);
                if (response.ok) {
                    const htmlContent = await response.text();
                    tabContentDiv.innerHTML = htmlContent;
                    
                    // JavaScript„Éï„Ç°„Ç§„É´„ÇíÂãïÁöÑË™≠„ÅøËæº„Åø
                    await loadTabScript(tabNumber, tabType);
                    
                    log(`‚úÖ „Çø„Éñ${tabNumber}Ôºà${tabType}Ôºâ„Ç≥„É≥„ÉÜ„É≥„ÉÑË™≠„ÅøËæº„ÅøÂÆå‰∫Ü`);
                } else {
                    log(`‚ö†Ô∏è „Çø„Éñ${tabNumber}„ÅÆÂàÜÈõ¢„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì - Êó¢Â≠ò„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰ΩøÁî®`);
                }
            } catch (error) {
                log(`‚ùå „Çø„ÉñË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${error.message}`);
            }
        };
        
        // „Çø„ÉñÁî®JavaScript„ÅÆÂãïÁöÑË™≠„ÅøËæº„Åø
        window.loadTabScript = async (tabNumber, tabType) => {
            try {
                // Êó¢Â≠ò„ÅÆ„Çπ„ÇØ„É™„Éó„Éà„Çø„Ç∞„ÇíÂâäÈô§
                const existingScript = document.getElementById(`tab${tabNumber}Script`);
                if (existingScript) {
                    existingScript.remove();
                }
                
                // Êñ∞„Åó„ÅÑ„Çπ„ÇØ„É™„Éó„Éà„Çø„Ç∞„Çí‰ΩúÊàê
                const script = document.createElement('script');
                script.id = `tab${tabNumber}Script`;
                script.src = `tabs/tab${tabNumber}-${tabType}/${tabType}-tab.js`;
                document.head.appendChild(script);
                
                return new Promise((resolve, reject) => {
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error(`Script load failed: ${script.src}`));
                });
            } catch (error) {
                throw error;
            }
        };

        // „Çø„ÉñÂàá„ÇäÊõø„ÅàÊ©üËÉΩÔºàÂãïÁöÑË™≠„ÅøËæº„ÅøÂØæÂøúÔºâ
        window.switchTab = async (tabNumber) => {
            currentTab = tabNumber;
            
            // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Éú„Çø„É≥„ÇíÈùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´Ôºà16„Çø„ÉñÂØæÂøúÔºâ
            for (let i = 1; i <= 16; i++) {
                const tabBtn = document.getElementById(`tab${i}`);
                const tabContent = document.getElementById(`tabContent${i}`);
                
                if (i === tabNumber) {
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„Éñ
                    tabBtn.style.background = '#007bff';
                    tabBtn.style.color = 'white';
                    tabContent.classList.remove('hidden');
                    
                    // ÂãïÁöÑË™≠„ÅøËæº„ÅøÔºàÂàÜÈõ¢„Åï„Çå„Åü„Çø„Éñ„ÅÆ„ÅøÔºâ
                    // ‰∏ÄÊôÇÁöÑ„Å´ÁÑ°ÂäπÂåñ - ÂæìÊù•ÈÄö„Çä„ÅÆÂãï‰Ωú„ÇíÁ∂≠ÊåÅ
                    // if (i === 1) {
                    //     await loadTabContent(1, 'weight');
                    // }
                } else {
                    // Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„Éñ
                    tabBtn.style.background = '#f8f9fa';
                    tabBtn.style.color = '#495057';
                    tabContent.classList.add('hidden');
                }
            }
            
            // „Çø„Ç§„Éà„É´Êõ¥Êñ∞
            const tabTitles = {
                1: 'üìä ‰ΩìÈáçÁÆ°ÁêÜ„Ç¢„Éó„É™',
                2: 'üõèÔ∏è Áù°Áú†ÁÆ°ÁêÜ',
                3: 'üè† ÈÉ®Â±ãÁâá„Å•„Åë',
                4: 'ü§∏ „Çπ„Éà„É¨„ÉÉ„ÉÅ',
                5: 'üîß xx5',
                6: 'üîß xx6', 
                7: 'üîß xx7',
                8: 'üîß xx8'
            };
            
            const titleElement = document.getElementById('appTitle');
            if (titleElement && tabTitles[tabNumber]) {
                titleElement.textContent = `${tabTitles[tabNumber]} ${APP_VERSION}`;
            }
            
            // „Çø„ÉñÂõ∫Êúâ„ÅÆÂàùÊúüÂåñÂá¶ÁêÜ
            if (tabNumber === 2) {
                // Áù°Áú†ÁÆ°ÁêÜ„Çø„Éñ„ÅÆÂàùÊúüÂåñÔºà„É≠„Ç∞„Ç§„É≥„Å´Èñ¢‰øÇ„Å™„ÅèÂÆüË°åÔºâ
                initializeSleepManager();
                if (currentUser) {
                    loadSleepData();
                }
            } else if (tabNumber === 3) {
                // ÈÉ®Â±ãÁâá‰ªò„Åë„Çø„Éñ„ÅÆÂàùÊúüÂåñ
                initRoomManagement();
                if (currentUser) {
                    loadRoomData();
                }
            }
            
            log(`üìë „Çø„ÉñÂàá„ÇäÊõø„Åà: „Çø„Éñ${tabNumber}`);
        };

        // UIË°®Á§∫Âà∂Âæ°
        function showUserInterface(user) {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('tabNavigation').classList.remove('hidden');
            document.getElementById('appHeader').classList.remove('hidden');
            document.getElementById('modeControl').classList.remove('hidden');
            document.getElementById('weightInput').classList.remove('hidden');
            document.getElementById('chartPanel').classList.remove('hidden');
            document.getElementById('weightHistoryPanel').classList.remove('hidden');
            document.getElementById('userName').textContent = user.displayName;
            
            // „Éá„Éï„Ç©„É´„Éà„Åß„Çø„Éñ1„ÇíË°®Á§∫
            switchTab(1);
            
            // „Ç´„Çπ„Çø„É†È†ÖÁõÆ„ÇíÂæ©ÂÖÉÔºà„É≠„Ç∞„Ç§„É≥ÊôÇ„Å´ÂÆüË°åÔºâ
            loadCustomItems();
            
            // „É°„É¢„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÅøÔºà„É≠„Ç∞„Ç§„É≥ÊôÇÔºâ
            loadMemoData();
            
            // ‰ªäÊó•„ÅÆÊó•‰ªò„Å®‰ΩìÈáç„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÇíË®≠ÂÆöÔºà„Çø„Ç§„É†„Çæ„Éº„É≥ËÄÉÊÖÆÔºâ
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;
            document.getElementById('dateInput').value = todayString;
            document.getElementById('weightValue').value = '72.0';
            
            // „Çø„Ç§„Éü„É≥„Ç∞„Éú„Çø„É≥„ÅÆÂàùÊúüÁä∂ÊÖãË®≠ÂÆö
            document.querySelectorAll('.timing-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.classList.remove('selected');
            });
            
            // ÊúçË£Ö„Éú„Çø„É≥„ÅÆÂàùÊúüÁä∂ÊÖãË®≠ÂÆö
            document.querySelectorAll('.clothing-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            // „Éá„Éï„Ç©„É´„ÉàÊúçË£ÖÈÅ∏Êäû: ‰∏ä=„Å™„Åó, ‰∏ã=„Éà„É©„É≥„ÇØ„Çπ
            selectClothingTop('„Å™„Åó');
            selectClothingBottom('„Éà„É©„É≥„ÇØ„Çπ');
            
        }

        function showLoginInterface() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('tabNavigation').classList.add('hidden');
            document.getElementById('appHeader').classList.add('hidden');
            document.getElementById('modeControl').classList.add('hidden');
            document.getElementById('weightInput').classList.add('hidden');
            document.getElementById('chartPanel').classList.add('hidden');
        }

        // „É≠„Ç∞Âá∫ÂäõÈñ¢Êï∞ÔºàÂÆâÂÖ®„Ç¢„ÇØ„Çª„ÇπÂØæÂøúÔºâ
        function log(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            
            // DOMË¶ÅÁ¥†„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ„Ç≥„É≥„ÇΩ„Éº„É´„É≠„Ç∞„ÅÆ„Åø
            if (logArea) {
                logArea.innerHTML += `[${timestamp}] ${message}<br>`;
                logArea.scrollTop = logArea.scrollHeight;
            }
            console.log(`[${timestamp}] ${message}`);
        }

        // „É≠„Ç∞„Ç≥„Éî„ÉºÊ©üËÉΩÔºàÂÆâÂÖ®„Ç¢„ÇØ„Çª„ÇπÂØæÂøúÔºâ
        window.copyLogs = () => {
            const logArea = document.getElementById('logArea');
            if (!logArea) {
                console.log('‚ö†Ô∏è logAreaË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            const logText = logArea.innerText || logArea.textContent;
            navigator.clipboard.writeText(logText).then(() => {
                alert('‚úÖ „É≠„Ç∞„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            }).catch(() => {
                // fallback
                const textArea = document.createElement('textarea');
                textArea.value = logText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('‚úÖ „É≠„Ç∞„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            });
        };

        // FirebaseÊé•Á∂ö„Éá„Éê„ÉÉ„Ç∞
        window.debugFirebaseConnection = () => {
            log('üîç === Firebase Debug ÈñãÂßã ===');
            
            // 1. FirebaseË®≠ÂÆöÁ¢∫Ë™ç
            log(`üî• Firebase ConfigÁ¢∫Ë™ç:`);
            log(`- Project ID: ${firebaseConfig.projectId}`);
            log(`- Database URL: ${firebaseConfig.databaseURL}`);
            log(`- Auth Domain: ${firebaseConfig.authDomain}`);
            
            // 2. Ë™çË®ºÁä∂ÊÖãÁ¢∫Ë™ç
            if (currentUser) {
                log(`‚úÖ Ë™çË®ºÊ∏à„Åø„É¶„Éº„Ç∂„Éº:`);
                log(`- UID: ${currentUser.uid.substring(0,8)}...`);
                log(`- Email: ${currentUser.email}`);
                log(`- Ë°®Á§∫Âêç: ${currentUser.displayName}`);
            } else {
                log('‚ùå Êú™Ë™çË®ºÁä∂ÊÖã');
            }
            
            // 3. Êé•Á∂ö„ÉÜ„Çπ„Éà
            const connectedRef = database.ref('.info/connected');
            connectedRef.once('value', (snapshot) => {
                const connected = snapshot.val();
                log(`üåê FirebaseÊé•Á∂öÁä∂ÊÖã: ${connected ? 'Êé•Á∂ö‰∏≠' : 'Êú™Êé•Á∂ö'}`);
                
                if (connected && currentUser) {
                    // „Éá„Éº„Çø„Éô„Éº„Çπ„ÉÜ„Çπ„Éà
                    const testRef = database.ref(`users/${currentUser.uid}/test`);
                    testRef.set({
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        message: 'Connection test',
                        app: 'app-template'
                    }).then(() => {
                        log('‚úÖ „Éá„Éº„Çø„Éô„Éº„ÇπÊõ∏„ÅçËæº„Åø„ÉÜ„Çπ„ÉàÊàêÂäü');
                    }).catch((error) => {
                        log(`‚ùå „Éá„Éº„Çø„Éô„Éº„ÇπÊõ∏„ÅçËæº„Åø„Ç®„É©„Éº: ${error.message}`);
                        log(`- Error Code: ${error.code}`);
                    });
                }
            });
            
            log('üîç === Firebase Debug ÂÆå‰∫Ü ===');
        };

        // „É¢„Éê„Ç§„É´Áí∞Â¢ÉË®∫Êñ≠
        window.checkMobileSupport = () => {
            log('üì± === „É¢„Éê„Ç§„É´Áí∞Â¢ÉË®∫Êñ≠ ÈñãÂßã ===');
            
            const userAgent = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            
            log(`üåê „É¶„Éº„Ç∂„Éº„Ç®„Éº„Ç∏„Çß„É≥„Éà: ${userAgent}`);
            log(`üì± „É¢„Éê„Ç§„É´„Éá„Éê„Ç§„ÇπÂà§ÂÆö: ${isMobile ? '„É¢„Éê„Ç§„É´' : '„Éá„Çπ„ÇØ„Éà„ÉÉ„Éó'}`);
            
            // „Éñ„É©„Ç¶„Ç∂Âà§ÂÆö
            const isChrome = /Chrome/i.test(userAgent);
            const isSafari = /Safari/i.test(userAgent) && !/Chrome/i.test(userAgent);
            const isFirefox = /Firefox/i.test(userAgent);
            
            log(`üåê „Éñ„É©„Ç¶„Ç∂: ${isChrome ? 'Chrome' : isSafari ? 'Safari' : isFirefox ? 'Firefox' : '‰∏çÊòé'}`);
            
            // „É≠„Ç∞„Ç§„É≥ÊñπÂºè„ÅÆÊé®Â•®
            if (isMobile) {
                log('üí° „É¢„Éê„Ç§„É´„ÅÆÊé®Â•®Ë®≠ÂÆö:');
                log('- Google„É≠„Ç∞„Ç§„É≥„ÅØ„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÊñπÂºè„Çí‰ΩøÁî®');
                log('- „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Éñ„É≠„ÉÉ„Ç´„Éº„ÅÆÂΩ±Èüø„Å™„Åó');
                log('- Ë™çË®ºÂæå„Å´„Éö„Éº„Ç∏„ÅåÂÜçË™≠„ÅøËæº„Åø„Åï„Çå„Åæ„Åô');
            }
            
            log('üì± === „É¢„Éê„Ç§„É´Áí∞Â¢ÉË®∫Êñ≠ ÂÆå‰∫Ü ===');
        };

        // FirebaseË®≠ÂÆöË®∫Êñ≠
        window.checkFirebaseConfig = () => {
            log('üîß === FirebaseË®≠ÂÆöË®∫Êñ≠ ÈñãÂßã ===');
            
            // ÁèæÂú®„ÅÆ„Éâ„É°„Ç§„É≥Á¢∫Ë™ç
            const currentDomain = window.location.hostname;
            const currentUrl = window.location.href;
            log(`üåê ÁèæÂú®„ÅÆ„Éâ„É°„Ç§„É≥: ${currentDomain}`);
            log(`üîó ÁèæÂú®„ÅÆURL: ${currentUrl}`);
            
            // FirebaseË®≠ÂÆöÊÉÖÂ†±
            log(`üî• FirebaseË®≠ÂÆö:`);
            log(`- Project ID: ${firebaseConfig.projectId}`);
            log(`- Auth Domain: ${firebaseConfig.authDomain}`);
            log(`- Database URL: ${firebaseConfig.databaseURL}`);
            
            // Ë™çË®º„Éâ„É°„Ç§„É≥Ë®±ÂèØÁä∂Ê≥Å„ÅÆÊé®Ê∏¨
            if (currentDomain === 'muumuu8181.github.io') {
                log('‚úÖ GitHub Pages„Éâ„É°„Ç§„É≥Ê§úÂá∫');
                log('üí° Firebase Console„Åß„Åì„ÅÆ„Éâ„É°„Ç§„É≥„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„ÅåÂøÖË¶Å');
            } else if (currentDomain === 'localhost' || currentDomain === '127.0.0.1') {
                log('‚úÖ „É≠„Éº„Ç´„É´„Éõ„Çπ„ÉàÊ§úÂá∫');
                log('üí° ÈÄöÂ∏∏„ÅØËá™Âãï„ÅßË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
            } else {
                log('‚ö†Ô∏è ‰∏çÊòé„Å™„Éâ„É°„Ç§„É≥„Åß„Åô');
                log('üí° Firebase Console„ÅÆË™çË®ºË®≠ÂÆö„ÅßË®±ÂèØ„ÅåÂøÖË¶Å„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì');
            }
            
            // „É¢„Éê„Ç§„É´„Éñ„É©„Ç¶„Ç∂„Åß„ÅÆ„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÂà∂ÈôêÁ¢∫Ë™ç
            const userAgent = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            
            if (isMobile) {
                log('üì± „É¢„Éê„Ç§„É´„Éñ„É©„Ç¶„Ç∂Âõ∫Êúâ„ÅÆÂà∂Èôê:');
                log('- Safari: „Çµ„Éº„Éâ„Éë„Éº„ÉÜ„Ç£Cookie„ÅÆÂà∂Èôê„ÅÇ„Çä');
                log('- Chrome Mobile: „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆËá™Âãï„Éñ„É≠„ÉÉ„ÇØ');
                log('- Ëß£Ê±∫Á≠ñ: „É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÊñπÂºè„Åæ„Åü„ÅØ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË®±ÂèØË®≠ÂÆö');
            }
            
            log('üîß === FirebaseË®≠ÂÆöË®∫Êñ≠ ÂÆå‰∫Ü ===');
        };

        // Ë™çË®ºÁä∂ÊÖã„ÅÆÂº∑Âà∂Á¢∫Ë™ç
        window.forceAuthCheck = () => {
            log('üîç === Ë™çË®ºÁä∂ÊÖãÂº∑Âà∂Á¢∫Ë™ç ÈñãÂßã ===');
            
            const user = auth.currentUser;
            log(`üîê FirebaseË™çË®ºÁä∂ÊÖã: ${user ? `„É≠„Ç∞„Ç§„É≥Ê∏à„Åø (${user.displayName})` : 'Êú™„É≠„Ç∞„Ç§„É≥'}`);
            
            if (user) {
                log('‚úÖ „É¶„Éº„Ç∂„ÉºÁîªÈù¢„ÇíË°®Á§∫„Åó„Åæ„Åô');
                showUserInterface(user);
                loadUserWeightData(user.uid);
            } else {
                log('‚ùå „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÇíË°®Á§∫„Åó„Åæ„Åô');
                showLoginInterface();
            }
            
            // Ë™çË®º„Éà„Éº„ÇØ„É≥„ÅÆÊúâÂäπÊÄßÁ¢∫Ë™ç
            if (user) {
                user.getIdToken(true).then(() => {
                    log('‚úÖ Ë™çË®º„Éà„Éº„ÇØ„É≥„ÅØÊúâÂäπ„Åß„Åô');
                }).catch((tokenError) => {
                    log(`‚ùå Ë™çË®º„Éà„Éº„ÇØ„É≥„Ç®„É©„Éº: ${tokenError.message}`);
                    log('üí° ÂÜç„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì');
                });
            }
            
            log('üîç === Ë™çË®ºÁä∂ÊÖãÂº∑Âà∂Á¢∫Ë™ç ÂÆå‰∫Ü ===');
        };

        // „É≠„Ç∞„Ç§„É≥ÂïèÈ°åË®∫Êñ≠
        window.checkLoginIssues = () => {
            log('‚ö†Ô∏è === „É≠„Ç∞„Ç§„É≥ÂïèÈ°åË®∫Êñ≠ ÈñãÂßã ===');
            
            // 1. „Éó„É≠„Éà„Ç≥„É´„ÉÅ„Çß„ÉÉ„ÇØ
            const protocol = window.location.protocol;
            log(`üåê ÁèæÂú®„ÅÆ„Éó„É≠„Éà„Ç≥„É´: ${protocol}`);
            
            if (protocol === 'file:') {
                log('‚ùå ÂïèÈ°åÁô∫Ë¶ã: file://„Éó„É≠„Éà„Ç≥„É´„Åß„ÅØGoogleË™çË®º„ÅåÂãï‰Ωú„Åó„Åæ„Åõ„Çì');
                log('‚úÖ Ëß£Ê±∫ÊñπÊ≥ï:');
                log('  1. HTTP„Çµ„Éº„Éê„ÉºÁµåÁî±„Åß„Ç¢„ÇØ„Çª„Çπ');
                log('  2. chrome://flags „Åß insecure origins „ÇíË®±ÂèØ');
                log('  3. „É≠„Éº„Ç´„É´„Çµ„Éº„Éê„ÉºËµ∑Âãï (python -m http.server 8000)');
            } else if (protocol === 'https:' || protocol === 'http:') {
                log('‚úÖ „Éó„É≠„Éà„Ç≥„É´: ÂïèÈ°å„Å™„Åó');
            }
            
            // 2. Web StorageÁ¢∫Ë™ç
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                log('‚úÖ Web Storage: Âà©Áî®ÂèØËÉΩ');
            } catch (e) {
                log('‚ùå Web Storage: ÁÑ°Âäπ');
                log('‚úÖ Ëß£Ê±∫ÊñπÊ≥ï: „Éñ„É©„Ç¶„Ç∂Ë®≠ÂÆö„ÅßCookie„ÇíÊúâÂäπ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            }
            
            // 3. Firebase„É©„Ç§„Éñ„É©„É™Á¢∫Ë™ç
            if (typeof firebase !== 'undefined') {
                log('‚úÖ Firebase SDK: Ë™≠„ÅøËæº„ÅøÊ∏à„Åø');
                log(`- Firebase Version: ${firebase.SDK_VERSION || 'Unknown'}`);
            } else {
                log('‚ùå Firebase SDK: Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº');
            }
            
            // 4. „Éâ„É°„Ç§„É≥Á¢∫Ë™ç
            const domain = window.location.hostname;
            log(`üè† ÁèæÂú®„ÅÆ„Éâ„É°„Ç§„É≥: ${domain}`);
            
            if (domain === 'localhost' || domain === '127.0.0.1') {
                log('‚úÖ „É≠„Éº„Ç´„É´ÈñãÁô∫: FirebaseË®≠ÂÆö„ÅßË®±ÂèØ„ÅåÂøÖË¶Å');
            }
            
            log('‚ö†Ô∏è === „É≠„Ç∞„Ç§„É≥ÂïèÈ°åË®∫Êñ≠ ÂÆå‰∫Ü ===');
        };

        // „Éá„Éº„Çø„Éô„Éº„ÇπÊßãÈÄ†Á¢∫Ë™ç
        window.checkDatabaseStructure = async () => {
            if (!currentUser) {
                log('‚ùå „É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            log('üèóÔ∏è === „Éá„Éº„Çø„Éô„Éº„ÇπÊßãÈÄ†Á¢∫Ë™ç ÈñãÂßã ===');
            
            try {
                // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆweights„Éá„Éº„ÇøÊßãÈÄ†„ÇíÁ¢∫Ë™ç
                const userRef = database.ref(`users/${currentUser.uid}/weights`);
                const snapshot = await userRef.once('value');
                const data = snapshot.val();
                
                if (data) {
                    const entries = Object.keys(data);
                    log(`üìä ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº(${currentUser.email})„ÅÆ„Éá„Éº„Çø:`);
                    log(`- „Éá„Éº„ÇøË®òÈå≤Êï∞: ${entries.length}‰ª∂`);
                    log(`- ÊúÄÊñ∞Ë®òÈå≤ID: ${entries[entries.length - 1]}`);
                    
                    // „Çµ„É≥„Éó„É´„Éá„Éº„ÇøÊßãÈÄ†„ÇíË°®Á§∫
                    const sampleEntry = data[entries[0]];
                    log(`- „Éá„Éº„ÇøÊßãÈÄ†: ${JSON.stringify(sampleEntry, null, 2)}`);
                } else {
                    log('üìä ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„Å´„ÅØ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                }
                
                // „É´„Éº„Éà„É¨„Éô„É´„ÅÆÊßãÈÄ†Á¢∫Ë™çÔºàÁÆ°ÁêÜËÄÖÊ®©Èôê„ÅåÂøÖË¶ÅÔºâ
                try {
                    const rootRef = database.ref('users');
                    const rootSnapshot = await rootRef.once('value');
                    const allUsers = rootSnapshot.val();
                    
                    if (allUsers) {
                        const userCount = Object.keys(allUsers).length;
                        log(`üë• ÂÖ®‰ΩìÁµ±Ë®à:`);
                        log(`- ÁôªÈå≤„É¶„Éº„Ç∂„ÉºÊï∞: ${userCount}‰∫∫`);
                        
                        let totalWeights = 0;
                        Object.values(allUsers).forEach(user => {
                            if (user.weights) {
                                totalWeights += Object.keys(user.weights).length;
                            }
                        });
                        log(`- ÂÖ®‰Ωì„ÅÆ‰ΩìÈáçË®òÈå≤Êï∞: ${totalWeights}‰ª∂`);
                    }
                } catch (error) {
                    log(`‚ö†Ô∏è ÂÖ®‰ΩìÁµ±Ë®à„ÅÆÂèñÂæó„Å´Âà∂Èôê„Åå„ÅÇ„Çä„Åæ„Åô: ${error.message}`);
                }
                
            } catch (error) {
                log(`‚ùå ÊßãÈÄ†Á¢∫Ë™ç„Ç®„É©„Éº: ${error.message}`);
            }
            
            log('üèóÔ∏è === „Éá„Éº„Çø„Éô„Éº„ÇπÊßãÈÄ†Á¢∫Ë™ç ÂÆå‰∫Ü ===');
        };

        // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„Çí„Ç≥„Éî„Éº
        window.copyDebugInfo = () => {
            const debugInfo = `‰ΩìÈáçÁÆ°ÁêÜ„Ç¢„Éó„É™ „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±
=================================
„Çø„Ç§„É†„Çπ„Çø„É≥„Éó: ${new Date().toLocaleString()}
URL: ${window.location.href}
„Éó„É≠„Éà„Ç≥„É´: ${window.location.protocol}
„Éâ„É°„Ç§„É≥: ${window.location.hostname}
„É¶„Éº„Ç∂„Éº„Ç®„Éº„Ç∏„Çß„É≥„Éà: ${navigator.userAgent}

FirebaseË®≠ÂÆö:
- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàID: ${firebaseConfig.projectId}
- „Éá„Éº„Çø„Éô„Éº„ÇπURL: ${firebaseConfig.databaseURL}
- Ë™çË®º„Éâ„É°„Ç§„É≥: ${firebaseConfig.authDomain}

Ë™çË®ºÁä∂ÊÖã: ${currentUser ? '„É≠„Ç∞„Ç§„É≥Ê∏à„Åø' : 'Êú™„É≠„Ç∞„Ç§„É≥'}
${currentUser ? `- UID: ${currentUser.uid.substring(0,8)}...\n- Email: ${currentUser.email}\n- Ë°®Á§∫Âêç: ${currentUser.displayName}` : ''}

Firebase SDK: ${typeof firebase !== 'undefined' ? 'Ë™≠„ÅøËæº„ÅøÊ∏à„Åø' : 'Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº'}
Web Storage: ${(() => {
    try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        return 'Âà©Áî®ÂèØËÉΩ';
    } catch (e) {
        return 'ÁÑ°Âäπ';
    }
})()}

„É≠„Ç∞ÂÜÖÂÆπ:
${document.getElementById('logArea').innerText}`;

            navigator.clipboard.writeText(debugInfo).then(() => {
                alert('‚úÖ „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            }).catch(() => {
                // fallback
                const textArea = document.createElement('textarea');
                textArea.value = debugInfo;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('‚úÖ „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            });
        };

        // „Ç¢„Éó„É™ÂàùÊúüÂåñ
        function initializeApp() {
            // „Éê„Éº„Ç∏„Éß„É≥Ë°®Á§∫„ÅÆÂãïÁöÑË®≠ÂÆö
            document.title = `‰ΩìÈáçÁÆ°ÁêÜ„Ç¢„Éó„É™ ${APP_VERSION}`;
            document.getElementById('appTitle').textContent = `üìä ‰ΩìÈáçÁÆ°ÁêÜ„Ç¢„Éó„É™ ${APP_VERSION}`;
            
            log(`üöÄ ‰ΩìÈáçÁÆ°ÁêÜ„Ç¢„Éó„É™Ëµ∑ÂãïÂÆå‰∫Ü ${APP_VERSION}`);
            log('üîê Ë™çË®º„Ç∑„Çπ„ÉÜ„É†Ê∫ñÂÇôÂÆå‰∫Ü');
        }

        // ÂàùÊúüÂåñÂÆüË°å
        initializeApp();
        
        // „Éó„É≠„Éà„Ç≥„É´„ÉÅ„Çß„ÉÉ„ÇØÔºàËá™ÂãïË®∫Êñ≠Ôºâ
        if (window.location.protocol === 'file:') {
            log('‚ö†Ô∏è file://„Éó„É≠„Éà„Ç≥„É´Ê§úÂá∫ - Google„É≠„Ç∞„Ç§„É≥„Å´„ÅØ HTTP„Çµ„Éº„Éê„Éº„ÅåÂøÖË¶Å„Åß„Åô');
            log('üí° Ëß£Ê±∫ÊñπÊ≥ï: python -m http.server 8000 „Åæ„Åü„ÅØ chrome://flagsË®≠ÂÆö');
        }

        // ========== Áù°Áú†ÁÆ°ÁêÜÊ©üËÉΩ ==========

        // Áù°Áú†ÁÆ°ÁêÜÁî®Â§âÊï∞
        let allSleepData = [];
        let selectedSleepType = '';
        let selectedSleepQuality = '';
        let selectedSleepTags = [];

        // Áù°Áú†ÁÆ°ÁêÜÂàùÊúüÂåñ
        function initializeSleepManager() {
            // ‰ªäÊó•„ÅÆÊó•‰ªò„ÇíË®≠ÂÆö
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;
            
            if (document.getElementById('sleepDateInput')) {
                document.getElementById('sleepDateInput').value = todayString;
                
                // ÁèæÂú®ÊôÇÂàª„ÇíË®≠ÂÆö
                const now = new Date();
                const currentHour = String(now.getHours()).padStart(2, '0');
                const currentMinute = String(now.getMinutes()).padStart(2, '0');
                const currentTimeString = `${currentHour}:${currentMinute}`;
                
                const sleepTimeInput = document.getElementById('sleepTimeInput');
                if (sleepTimeInput) {
                    sleepTimeInput.value = currentTimeString;
                }
            }
            
            log('üõèÔ∏è Áù°Áú†ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü');
        }


        // Áù°Áú†„Çø„Ç§„ÉóÈÅ∏Êäû
        function selectSleepType(type) {
            selectedSleepType = type;
            document.getElementById('selectedSleepType').value = type;
            
            // „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
            document.querySelectorAll('.sleep-type-btn').forEach(btn => {
                if (btn.dataset.type === type) {
                    btn.style.opacity = '1';
                    btn.style.fontWeight = 'bold';
                } else {
                    btn.style.opacity = '0.7';
                    btn.style.fontWeight = 'normal';
                }
            });
            
            log(`üõèÔ∏è Áù°Áú†„Çø„Ç§„ÉóÈÅ∏Êäû: ${type}`);
        }

        // Áù°Áú†„ÅÆË≥™ÈÅ∏Êäû
        function selectQuality(quality) {
            selectedSleepQuality = quality;
            document.getElementById('selectedQuality').value = quality;
            
            // „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
            document.querySelectorAll('.quality-btn').forEach(btn => {
                if (parseInt(btn.dataset.quality) === quality) {
                    btn.style.opacity = '1';
                    btn.style.fontWeight = 'bold';
                } else {
                    btn.style.opacity = '0.7';
                    btn.style.fontWeight = 'normal';
                }
            });
            
            log(`‚≠ê Áù°Áú†„ÅÆË≥™ÈÅ∏Êäû: ${quality}ÁÇπ`);
        }

        // Áù°Áú†„Çø„Ç∞Âàá„ÇäÊõø„Åà
        function toggleSleepTag(tag) {
            const index = selectedSleepTags.indexOf(tag);
            const button = document.querySelector(`[data-tag="${tag}"]`);
            
            if (index === -1) {
                // „Çø„Ç∞ËøΩÂä†
                selectedSleepTags.push(tag);
                button.style.opacity = '1';
                button.style.fontWeight = 'bold';
                button.style.transform = 'scale(1.05)';
            } else {
                // „Çø„Ç∞ÂâäÈô§
                selectedSleepTags.splice(index, 1);
                button.style.opacity = '0.7';
                button.style.fontWeight = 'normal';
                button.style.transform = 'scale(1)';
            }
            
            // hidden field„Å´‰øùÂ≠ò
            document.getElementById('selectedSleepTags').value = selectedSleepTags.join(',');
            
            // Ë°®Á§∫„ÉÜ„Ç≠„Çπ„ÉàÊõ¥Êñ∞
            const displayElement = document.getElementById('selectedTagsDisplay');
            if (displayElement) {
                displayElement.textContent = selectedSleepTags.length > 0 ? selectedSleepTags.join(', ') : '„Å™„Åó';
            }
            
            log(`üè∑Ô∏è Áù°Áú†„Çø„Ç∞Êõ¥Êñ∞: [${selectedSleepTags.join(', ')}]`);
        }


        // Áù°Áú†„Éá„Éº„Çø‰øùÂ≠ò
        async function saveSleepData() {
            if (!currentUser) {
                log('‚ùå „É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }

            // ÂÖ•ÂäõÂÄ§ÂèñÂæó
            const sleepDate = document.getElementById('sleepDateInput').value;
            const sleepTime = document.getElementById('sleepTimeInput').value;
            const sleepMemo = document.getElementById('sleepMemoInput').value;

            // ÂøÖÈ†àÈ†ÖÁõÆ„ÉÅ„Çß„ÉÉ„ÇØ
            if (!sleepDate) {
                log('‚ùå Ë®òÈå≤Êó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (!sleepTime) {
                log('‚ùå Ë®òÈå≤ÊôÇÈñì„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // „Éá„Éº„ÇøÊßãÈÄ†
            const sleepData = {
                date: sleepDate,
                time: sleepTime,
                sleepType: selectedSleepType || null,
                quality: selectedSleepQuality || null,
                tags: selectedSleepTags.slice(), // ÈÖçÂàó„ÅÆ„Ç≥„Éî„Éº
                memo: sleepMemo || null,
                recordType: 'simple',
                timestamp: new Date().toISOString()
            };

            try {
                // Firebase‰øùÂ≠ò
                const sleepRef = database.ref(`users/${currentUser.uid}/sleepData/${sleepDate}_${Date.now()}`);
                await sleepRef.set(sleepData);
                
                log(`üíæ Áù°Áú†Ë®òÈå≤‰øùÂ≠òÂÆå‰∫Ü: ${sleepDate} ${sleepTime}`);
                
                // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„É™„Çª„ÉÉ„Éà
                document.getElementById('sleepMemoInput').value = '';
                selectedSleepType = '';
                selectedSleepQuality = '';
                selectedSleepTags = [];
                document.getElementById('selectedSleepType').value = '';
                document.getElementById('selectedQuality').value = '';
                document.getElementById('selectedSleepTags').value = '';
                
                // „Éú„Çø„É≥„Çπ„Çø„Ç§„É´„É™„Çª„ÉÉ„Éà
                document.querySelectorAll('.sleep-type-btn, .quality-btn, .sleep-tag-btn').forEach(btn => {
                    btn.style.opacity = '0.7';
                    btn.style.fontWeight = 'normal';
                    btn.style.transform = 'scale(1)';
                });
                
                // „Éá„Éº„ÇøÂÜçË™≠„ÅøËæº„Åø
                await loadSleepData();
                
            } catch (error) {
                log(`‚ùå ‰øùÂ≠ò„Ç®„É©„Éº: ${error.message}`);
            }
        }

        // Áù°Áú†„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        async function loadSleepData() {
            if (!currentUser) return;

            try {
                const sleepRef = database.ref(`users/${currentUser.uid}/sleepData`);
                const snapshot = await sleepRef.once('value');
                
                allSleepData = [];
                if (snapshot.val()) {
                    Object.entries(snapshot.val()).forEach(([key, data]) => {
                        allSleepData.push({id: key, ...data});
                    });
                }
                
                // Êó•‰ªòÈ†Ü„Åß„ÇΩ„Éº„Éà
                allSleepData.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                updateSleepHistory();
                updateSleepStats();
                
            } catch (error) {
                log(`‚ùå Áù°Áú†„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${error.message}`);
            }
        }

        // Áù°Áú†Â±•Ê≠¥Ë°®Á§∫Êõ¥Êñ∞
        function updateSleepHistory() {
            const historyArea = document.getElementById('sleepHistoryArea');
            
            if (allSleepData.length === 0) {
                historyArea.innerHTML = '„Åæ„Å†Áù°Áú†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                return;
            }

            // Áõ¥Ëøë7‰ª∂Ë°®Á§∫
            const recentData = allSleepData.slice(0, 7);
            
            historyArea.innerHTML = recentData.map(data => {
                let content = `<strong>${data.date}</strong> `;
                
                // Ë®òÈå≤Ë°®Á§∫
                content += `<span style="color: #666;">${data.sleepType || 'Ë®òÈå≤'}</span><br>`;
                content += `‚è∞ ${data.time || data.bedTime || data.wakeTime || '--'}`;
                if (data.quality) content += `<br>‚≠ê ${data.quality}/5ÁÇπ`;
                
                if (data.tags && data.tags.length > 0) {
                    content += `<br>üè∑Ô∏è ${data.tags.join(', ')}`;
                }
                if (data.memo) {
                    content += `<br>üìù ${data.memo}`;
                }
                
                return `<div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0;">
                    <div>${content}</div>
                    <button onclick="deleteSleepEntry('${data.id}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; flex-shrink: 0;">üóëÔ∏è</button>
                </div>`;
            }).join('');
        }

        // Áù°Áú†Áµ±Ë®àÊõ¥Êñ∞
        function updateSleepStats() {
            if (allSleepData.length === 0) {
                document.getElementById('sleepStatsArea').innerHTML = `
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 24px; font-weight: bold; color: #007bff;">--</div>
                        <div style="font-size: 12px; color: #6c757d;">Âπ≥ÂùáÁù°Áú†ÊôÇÈñì</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;">--</div>
                        <div style="font-size: 12px; color: #6c757d;">Âπ≥ÂùáÁù°Áú†„ÅÆË≥™</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 24px; font-weight: bold; color: #ffc107;">--</div>
                        <div style="font-size: 12px; color: #6c757d;">‰ªäÈÄ±„ÅÆË®òÈå≤Êï∞</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">--</div>
                        <div style="font-size: 12px; color: #6c757d;">‰ªäÊúà„ÅÆË®òÈå≤Êï∞</div>
                    </div>
                `;
                return;
            }

            // Áµ±Ë®àË®àÁÆó
            const avgDuration = allSleepData.reduce((sum, data) => sum + data.duration, 0) / allSleepData.length;
            const avgQuality = allSleepData.reduce((sum, data) => sum + parseInt(data.quality), 0) / allSleepData.length;
            
            // ‰ªäÈÄ±„Éª‰ªäÊúà„ÅÆË®òÈå≤Êï∞
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const weekCount = allSleepData.filter(data => new Date(data.date) >= weekAgo).length;
            const monthCount = allSleepData.filter(data => new Date(data.date) >= monthAgo).length;

            document.getElementById('sleepStatsArea').innerHTML = `
                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #007bff;">${avgDuration.toFixed(1)}h</div>
                    <div style="font-size: 12px; color: #6c757d;">Âπ≥ÂùáÁù°Áú†ÊôÇÈñì</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;">${avgQuality.toFixed(1)}</div>
                    <div style="font-size: 12px; color: #6c757d;">Âπ≥ÂùáÁù°Áú†„ÅÆË≥™</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${weekCount}</div>
                    <div style="font-size: 12px; color: #6c757d;">‰ªäÈÄ±„ÅÆË®òÈå≤Êï∞</div>
                </div>
                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">${monthCount}</div>
                    <div style="font-size: 12px; color: #6c757d;">‰ªäÊúà„ÅÆË®òÈå≤Êï∞</div>
                </div>
            `;
        }

        // Áù°Áú†Â±•Ê≠¥„Ç≥„Éî„Éº
        function copySleepHistory() {
            if (allSleepData.length === 0) {
                log('üìã „Ç≥„Éî„Éº„Åô„ÇãÁù°Áú†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            const copyText = allSleepData.slice(0, 7).map(data => 
                `${data.date} ${data.sleepType} ${data.bedTime}-${data.wakeTime} (${data.duration.toFixed(1)}h) ‚≠ê${data.quality}/5${data.memo ? ` ${data.memo}` : ''}`
            ).join('\n');

            navigator.clipboard.writeText(copyText).then(() => {
                log('üìã Áù°Áú†Â±•Ê≠¥„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            }).catch(() => {
                log('‚ùå „Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            });
        }

        // Áù°Áú†„Éá„Éº„ÇøÂâäÈô§
        window.deleteSleepEntry = async (entryId) => {
            if (!currentUser) {
                log('‚ùå „É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            if (!confirm('„Åì„ÅÆÁù°Áú†Ë®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }
            
            try {
                const entryRef = database.ref(`users/${currentUser.uid}/sleepData/${entryId}`);
                await entryRef.remove();
                
                log('üóëÔ∏è Áù°Áú†Ë®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                await loadSleepData(); // „Éá„Éº„ÇøÂÜçË™≠„ÅøËæº„Åø
                
            } catch (error) {
                log(`‚ùå ÂâäÈô§„Ç®„É©„Éº: ${error.message}`);
            }
        };

        // ========== ÈÉ®Â±ãÁâá‰ªò„ÅëÊ©üËÉΩ ==========
        
        // ÈÉ®Â±ãÁâá‰ªò„ÅëÁî®Â§âÊï∞ (ÂàÜÈõ¢Ê∏à„Åø - room-cleaning.js„Å´ÁßªÂãï)
        // let allRoomData = [];
        // let selectedRoomValue = '';
        // let selectedRoomAchievement = null;
        // let roomStartTime = null;
        // let roomEndTime = null;
        // let currentRoomMode = 'normal';
        
        // ÈÉ®Â±ãÁâá‰ªò„ÅëÁÆ°ÁêÜÂàùÊúüÂåñ
        function initRoomManagement() {
            // ÁèæÂú®„ÅÆÊó•‰ªò„ÉªÊôÇÂàª„ÇíË®≠ÂÆö
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentTime = now.toTimeString().slice(0, 5);
            
            document.getElementById('roomDateInput').value = today;
            document.getElementById('roomTimeInput').value = currentTime;
            
            // „Ç´„Çπ„Çø„É†Â†¥ÊâÄ„ÇíÂæ©ÂÖÉ
            loadCustomRooms();
            
            log('üßπ ÈÉ®Â±ãÁâá‰ªò„ÅëÁÆ°ÁêÜÂàùÊúüÂåñÂÆå‰∫Ü');
        }
        
        // Â†¥ÊâÄÁÆ°ÁêÜ„É¢„Éº„ÉâË®≠ÂÆö
        window.setRoomMode = (mode) => {
            currentRoomMode = mode;
            
            // „Éú„Çø„É≥„ÅÆË¶ã„ÅüÁõÆ„ÇíÊõ¥Êñ∞
            document.getElementById('roomNormalModeBtn').style.background = mode === 'normal' ? '#007bff' : '#6c757d';
            document.getElementById('roomAddModeBtn').style.background = mode === 'add' ? '#007bff' : '#6c757d';
            document.getElementById('roomDeleteModeBtn').style.background = mode === 'delete' ? '#007bff' : '#6c757d';
            
            // ËøΩÂä†ÂÖ•Âäõ„Ç®„É™„Ç¢„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
            const addInput = document.getElementById('roomUnifiedAddInput');
            if (mode === 'add') {
                addInput.style.display = 'block';
            } else {
                addInput.style.display = 'none';
            }
            
            log(`üîß Â†¥ÊâÄÁÆ°ÁêÜ„É¢„Éº„Éâ: ${mode}`);
        };
        
        // Áâá‰ªò„ÅëÂ†¥ÊâÄÈÅ∏Êäû
        window.selectRoom = (room) => {
            if (currentRoomMode === 'delete') {
                // ÂâäÈô§„É¢„Éº„Éâ: „Ç´„Çπ„Çø„É†Â†¥ÊâÄ„ÅÆ„ÅøÂâäÈô§ÂèØËÉΩ
                const isCustomRoom = !['„É™„Éì„É≥„Ç∞', '„Ç≠„ÉÉ„ÉÅ„É≥', 'ÂØùÂÆ§', '„ÅäÈ¢®ÂëÇ', '„Éà„Ç§„É¨', 'ÁéÑÈñ¢', '„Åù„ÅÆ‰ªñ'].includes(room);
                if (isCustomRoom) {
                    if (confirm(`„Äå${room}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                        removeCustomRoom(room);
                    }
                } else {
                    log('‚ùå „Éá„Éï„Ç©„É´„ÉàÂ†¥ÊâÄ„ÅØÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì');
                }
                return;
            }
            
            // ÈÄöÂ∏∏ÈÅ∏Êäû
            selectedRoomValue = room;
            document.getElementById('selectedRoom').value = room;
            
            // „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
            document.querySelectorAll('.room-btn').forEach(btn => {
                if (btn.getAttribute('data-room') === room) {
                    btn.style.opacity = '1';
                    btn.style.transform = 'scale(1.05)';
                } else {
                    btn.style.opacity = '0.7';
                    btn.style.transform = 'scale(1)';
                }
            });
            
            log(`üìç Â†¥ÊâÄÈÅ∏Êäû: ${room}`);
        };
        
        // Áâá‰ªò„ÅëÈñãÂßã
        window.startRoomCleaning = () => {
            if (!selectedRoomValue) {
                log('‚ùå Áâá‰ªò„ÅëÂ†¥ÊâÄ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            roomStartTime = new Date();
            const timeString = roomStartTime.toTimeString().slice(0, 5);
            
            // „Éú„Çø„É≥Ë°®Á§∫Âàá„ÇäÊõø„Åà
            document.getElementById('startRoomBtn').style.display = 'none';
            document.getElementById('endRoomBtn').style.display = 'inline-block';
            
            // ÊôÇÂàªË°®Á§∫„ÇíÈñãÂßãÊôÇÂàª„Å´Êõ¥Êñ∞
            document.getElementById('roomTimeInput').value = timeString;
            document.getElementById('roomDuration').value = 'Ë®àÊ∏¨‰∏≠...';
            
            log(`‚ñ∂Ô∏è Áâá‰ªò„ÅëÈñãÂßã: ${selectedRoomValue} - ${timeString}`);
        };
        
        // Áâá‰ªò„ÅëÁµÇ‰∫Ü
        window.endRoomCleaning = () => {
            if (!roomStartTime) {
                log('‚ùå Áâá‰ªò„Åë„ÅåÈñãÂßã„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }
            
            roomEndTime = new Date();
            const duration = Math.round((roomEndTime - roomStartTime) / (1000 * 60)); // ÂàÜÂçò‰Ωç
            
            // „Éú„Çø„É≥Ë°®Á§∫„ÇíÊàª„Åô
            document.getElementById('startRoomBtn').style.display = 'inline-block';
            document.getElementById('endRoomBtn').style.display = 'none';
            
            // ÊôÇÈñìË°®Á§∫„ÇíÊõ¥Êñ∞
            document.getElementById('roomDuration').value = `${duration}ÂàÜ`;
            
            log(`‚èπÔ∏è Áâá‰ªò„ÅëÁµÇ‰∫Ü: ${selectedRoomValue} - ${duration}ÂàÜÈñì`);
        };
        
        // ÈÅîÊàêÂ∫¶ÈÅ∏Êäû
        window.selectAchievement = (level) => {
            selectedRoomAchievement = level;
            document.getElementById('selectedAchievement').value = `${level}/5`;
            
            // „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
            document.querySelectorAll('.achievement-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            const selectedBtn = document.querySelector(`[onclick="selectAchievement(${level})"]`);
            if (selectedBtn) {
                selectedBtn.style.opacity = '1';
                selectedBtn.style.transform = 'scale(1.1)';
            }
            
            log(`üìä ÈÅîÊàêÂ∫¶ÈÅ∏Êäû: ${level}/5`);
        };
        
        // „Ç´„Çπ„Çø„É†Â†¥ÊâÄËøΩÂä†
        window.executeRoomAdd = () => {
            const roomName = document.getElementById('roomUnifiedAddText').value.trim();
            if (!roomName) {
                log('‚ùå Â†¥ÊâÄÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
            const existingBtn = document.querySelector(`[data-room="${roomName}"]`);
            if (existingBtn) {
                log(`‚ùå „Äå${roomName}„Äç„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô`);
                return;
            }
            
            // „Éú„Çø„É≥„ÇíËøΩÂä†
            addCustomRoomButton(roomName);
            
            // „Ç´„Çπ„Çø„É†Â†¥ÊâÄ„ÇílocalStorage„Å´‰øùÂ≠ò
            saveCustomRooms();
            
            // ÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢
            document.getElementById('roomUnifiedAddText').value = '';
            setRoomMode('normal');
            
            log(`‚úÖ Êñ∞„Åó„ÅÑÂ†¥ÊâÄËøΩÂä†: ${roomName}`);
        };
        
        // „Ç´„Çπ„Çø„É†Â†¥ÊâÄËøΩÂä†„Ç≠„É£„É≥„Çª„É´
        window.cancelRoomAdd = () => {
            document.getElementById('roomUnifiedAddText').value = '';
            setRoomMode('normal');
            log('‚ùå Â†¥ÊâÄËøΩÂä†„Çí„Ç≠„É£„É≥„Çª„É´');
        };
        
        // „Ç´„Çπ„Çø„É†Â†¥ÊâÄÂâäÈô§
        function removeCustomRoom(roomName) {
            const roomBtn = document.querySelector(`[data-room="${roomName}"]`);
            if (roomBtn) {
                roomBtn.remove();
                saveCustomRooms(); // ÂâäÈô§Âæå„Å´‰øùÂ≠ò
                log(`üóëÔ∏è Â†¥ÊâÄÂâäÈô§: ${roomName}`);
            }
        }
        
        // „Ç´„Çπ„Çø„É†Â†¥ÊâÄ„Éú„Çø„É≥‰ΩúÊàê
        function addCustomRoomButton(roomName) {
            const roomButtons = document.getElementById('roomButtons');
            const newButton = document.createElement('button');
            newButton.type = 'button';
            newButton.className = 'room-btn';
            newButton.onclick = () => selectRoom(roomName);
            newButton.setAttribute('data-room', roomName);
            newButton.style.cssText = 'background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; opacity: 0.7;';
            newButton.textContent = `üè† ${roomName}`;
            
            roomButtons.appendChild(newButton);
        }
        
        // „Ç´„Çπ„Çø„É†Â†¥ÊâÄ„ÇílocalStorage„Å´‰øùÂ≠ò
        function saveCustomRooms() {
            const defaultRooms = ['„É™„Éì„É≥„Ç∞', '„Ç≠„ÉÉ„ÉÅ„É≥', 'ÂØùÂÆ§', '„ÅäÈ¢®ÂëÇ', '„Éà„Ç§„É¨', 'ÁéÑÈñ¢', '„Åù„ÅÆ‰ªñ'];
            const customRooms = Array.from(document.querySelectorAll('.room-btn'))
                .map(btn => btn.getAttribute('data-room'))
                .filter(room => !defaultRooms.includes(room));
            
            localStorage.setItem('roomApp_customRooms', JSON.stringify(customRooms));
            log(`üíæ „Ç´„Çπ„Çø„É†Â†¥ÊâÄ‰øùÂ≠ò: ${customRooms.length}‰ª∂`);
        }
        
        // „Ç´„Çπ„Çø„É†Â†¥ÊâÄ„ÇílocalStorage„Åã„ÇâÂæ©ÂÖÉ
        function loadCustomRooms() {
            try {
                const saved = localStorage.getItem('roomApp_customRooms');
                if (saved) {
                    const customRooms = JSON.parse(saved);
                    customRooms.forEach(roomName => {
                        addCustomRoomButton(roomName);
                    });
                    log(`üìÇ „Ç´„Çπ„Çø„É†Â†¥ÊâÄÂæ©ÂÖÉ: ${customRooms.length}‰ª∂`);
                }
            } catch (error) {
                log(`‚ùå „Ç´„Çπ„Çø„É†Â†¥ÊâÄÂæ©ÂÖÉ„Ç®„É©„Éº: ${error.message}`);
            }
        }
        
        // ÈÉ®Â±ãÁâá‰ªò„Åë„Éá„Éº„Çø‰øùÂ≠ò
        window.saveRoomData = async () => {
            if (!currentUser) {
                log('‚ùå „É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            if (!selectedRoomValue) {
                log('‚ùå Áâá‰ªò„ÅëÂ†¥ÊâÄ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (!selectedRoomAchievement) {
                log('‚ùå ÈÅîÊàêÂ∫¶„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const duration = document.getElementById('roomDuration').value;
            if (duration === 'ÈñãÂßã„Éú„Çø„É≥„ÅßË®àÊ∏¨ÈñãÂßã' || duration === 'Ë®àÊ∏¨‰∏≠...') {
                log('‚ùå Áâá‰ªò„ÅëÊôÇÈñì„ÇíË®àÊ∏¨„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            try {
                log('üíæ ÈÉ®Â±ãÁâá‰ªò„Åë„Éá„Éº„Çø„Çí‰øùÂ≠ò‰∏≠...');
                
                const roomData = {
                    date: document.getElementById('roomDateInput').value,
                    time: document.getElementById('roomTimeInput').value,
                    room: selectedRoomValue,
                    duration: duration,
                    achievement: selectedRoomAchievement,
                    memo: document.getElementById('roomMemoInput').value || '',
                    userEmail: currentUser.email,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    createdAt: new Date().toISOString()
                };
                
                const userRef = database.ref(`users/${currentUser.uid}/roomData`);
                await userRef.push(roomData);
                
                log(`‚úÖ Áâá‰ªò„ÅëË®òÈå≤‰øùÂ≠òÂÆå‰∫Ü: ${selectedRoomValue} - ${duration} (ÈÅîÊàêÂ∫¶${selectedRoomAchievement}/5)`);
                
                // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
                resetRoomForm();
                
                // „Éá„Éº„ÇøÂÜçË™≠„ÅøËæº„Åø
                await loadRoomData();
                
            } catch (error) {
                log(`‚ùå ‰øùÂ≠ò„Ç®„É©„Éº: ${error.message}`);
            }
        };
        
        // ÈÉ®Â±ãÁâá‰ªò„Åë„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        window.loadRoomData = async () => {
            if (!currentUser) return;
            
            try {
                const roomRef = database.ref(`users/${currentUser.uid}/roomData`);
                const snapshot = await roomRef.once('value');
                
                allRoomData = [];
                if (snapshot.val()) {
                    Object.entries(snapshot.val()).forEach(([key, data]) => {
                        allRoomData.push({ id: key, ...data });
                    });
                    
                    // Êó•‰ªòÈ†Ü„Åß„ÇΩ„Éº„ÉàÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ
                    allRoomData.sort((a, b) => {
                        const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
                        const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
                        return dateB - dateA;
                    });
                }
                
                updateRoomHistory();
                updateRoomStats();
                
            } catch (error) {
                log(`‚ùå ÈÉ®Â±ãÁâá‰ªò„Åë„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${error.message}`);
            }
        };
        
        // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
        function resetRoomForm() {
            selectedRoomValue = '';
            selectedRoomAchievement = null;
            roomStartTime = null;
            roomEndTime = null;
            
            document.getElementById('selectedRoom').value = '';
            document.getElementById('selectedAchievement').value = '';
            document.getElementById('roomDuration').value = 'ÈñãÂßã„Éú„Çø„É≥„ÅßË®àÊ∏¨ÈñãÂßã';
            document.getElementById('roomMemoInput').value = '';
            
            // „Éú„Çø„É≥„Çπ„Çø„Ç§„É´„Çí„É™„Çª„ÉÉ„Éà
            document.querySelectorAll('.room-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            document.querySelectorAll('.achievement-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
            });
            
            // ÈñãÂßã„ÉªÁµÇ‰∫Ü„Éú„Çø„É≥„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('startRoomBtn').style.display = 'inline-block';
            document.getElementById('endRoomBtn').style.display = 'none';
            
            // Êó•ÊôÇ„ÇíÁèæÂú®ÊôÇÂàª„Å´Êõ¥Êñ∞
            const now = new Date();
            document.getElementById('roomDateInput').value = now.toISOString().split('T')[0];
            document.getElementById('roomTimeInput').value = now.toTimeString().slice(0, 5);
        }
        
        // ÈÉ®Â±ãÁâá‰ªò„ÅëÂ±•Ê≠¥Ë°®Á§∫Êõ¥Êñ∞
        function updateRoomHistory() {
            const historyArea = document.getElementById('roomHistoryArea');
            
            if (allRoomData.length === 0) {
                historyArea.innerHTML = '„Åæ„Å†Áâá‰ªò„ÅëË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                return;
            }
            
            // Áõ¥Ëøë7‰ª∂Ë°®Á§∫
            const recentData = allRoomData.slice(0, 7);
            
            historyArea.innerHTML = recentData.map(data => {
                let content = `<strong>${data.date}</strong> ${data.time} `;
                content += `üìç ${data.room} `;
                content += `‚è±Ô∏è ${data.duration} `;
                content += `üìä ${data.achievement}/5`;
                if (data.memo) {
                    content += `<br>üìù ${data.memo}`;
                }
                
                return `<div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0;">
                    <div>${content}</div>
                    <button onclick="deleteRoomEntry('${data.id}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; flex-shrink: 0;">üóëÔ∏è</button>
                </div>`;
            }).join('');
        }
        
        // ÈÉ®Â±ãÁâá‰ªò„ÅëÁµ±Ë®àÊõ¥Êñ∞
        function updateRoomStats() {
            const totalSessions = allRoomData.length;
            const totalMinutes = allRoomData.reduce((sum, data) => {
                const minutes = parseInt(data.duration) || 0;
                return sum + minutes;
            }, 0);
            const avgAchievement = totalSessions > 0 ? 
                (allRoomData.reduce((sum, data) => sum + (data.achievement || 0), 0) / totalSessions).toFixed(1) : 0;
            
            // ‰ªäÊúà„ÅÆË®òÈå≤Êï∞
            const thisMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            const thisMonthCount = allRoomData.filter(data => data.date.startsWith(thisMonth)).length;
            
            document.getElementById('totalRoomSessions').textContent = totalSessions;
            document.getElementById('totalRoomTime').textContent = `${totalMinutes}ÂàÜ`;
            document.getElementById('avgRoomAchievement').textContent = avgAchievement;
            document.getElementById('thisMonthRoomCount').textContent = thisMonthCount;
        }
        
        // ÈÉ®Â±ãÁâá‰ªò„ÅëÂ±•Ê≠¥„Ç≥„Éî„Éº
        window.copyRoomHistory = () => {
            if (allRoomData.length === 0) {
                log('üìã „Ç≥„Éî„Éº„Åô„ÇãÁâá‰ªò„Åë„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            const copyText = allRoomData.slice(0, 7).map(data => 
                `${data.date} ${data.time} ${data.room} ${data.duration} ÈÅîÊàêÂ∫¶${data.achievement}/5${data.memo ? ` ${data.memo}` : ''}`
            ).join('\n');
            
            navigator.clipboard.writeText(copyText).then(() => {
                log('üìã Áâá‰ªò„ÅëÂ±•Ê≠¥„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            }).catch(() => {
                log('‚ùå „Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            });
        };
        
        // ÈÉ®Â±ãÁâá‰ªò„Åë„Éá„Éº„ÇøÂâäÈô§
        window.deleteRoomEntry = async (entryId) => {
            if (!currentUser) {
                log('‚ùå „É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            if (!confirm('„Åì„ÅÆÁâá‰ªò„ÅëË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }
            
            try {
                const entryRef = database.ref(`users/${currentUser.uid}/roomData/${entryId}`);
                await entryRef.remove();
                
                log('üóëÔ∏è Áâá‰ªò„ÅëË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                await loadRoomData();
                
            } catch (error) {
                log(`‚ùå ÂâäÈô§„Ç®„É©„Éº: ${error.message}`);
            }
        };

        // =====================
        // „É°„É¢„É™„Çπ„ÉàÊ©üËÉΩ
        // =====================
        let memoData = [];

        // ÈáçË¶ÅÂ∫¶„ÅÆËâ≤„ÇíÂèñÂæó
        function getPriorityColor(priority) {
            switch(priority) {
                case 'S': return '#dc3545'; // Ëµ§
                case 'A': return '#fd7e14'; // „Ç™„É¨„É≥„Ç∏
                case 'B': return '#ffc107'; // ÈªÑËâ≤
                case 'C': return '#6c757d'; // „Ç∞„É¨„Éº
                default: return '#6c757d';
            }
        }

        // ÈáçË¶ÅÂ∫¶„ÅÆ„Ç¢„Ç§„Ç≥„É≥„ÇíÂèñÂæó
        function getPriorityIcon(priority) {
            switch(priority) {
                case 'S': return 'üî•';
                case 'A': return '‚ö°';
                case 'B': return 'üìã';
                case 'C': return 'üìù';
                default: return '';
            }
        }

        // ÂØæÂøúÊôÇÈñì„ÅÆËâ≤„ÇíÂèñÂæó
        function getTimeframeColor(timeframe) {
            switch(timeframe) {
                case 'Áü≠Êúü': return '#28a745'; // Á∑ë
                case '‰∏≠Èï∑Êúü': return '#17a2b8'; // Èùí
                default: return '#6c757d';
            }
        }

        // ÂØæÂøúÊôÇÈñì„ÅÆ„Ç¢„Ç§„Ç≥„É≥„ÇíÂèñÂæó
        function getTimeframeIcon(timeframe) {
            switch(timeframe) {
                case 'Áü≠Êúü': return '‚ö°';
                case '‰∏≠Èï∑Êúü': return 'üìÖ';
                default: return '';
            }
        }

        // „É°„É¢„ÇíËøΩÂä†
        window.addMemo = () => {
            const memoText = document.getElementById('newMemoText').value.trim();
            const category = document.getElementById('memoCategory').value;
            const priority = document.getElementById('memoPriority').value;
            const timeframe = document.getElementById('memoTimeframe').value;
            
            if (!memoText) {
                alert('„É°„É¢ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const now = new Date();
            const memo = {
                id: Date.now(),
                text: memoText,
                category: category,
                priority: priority,
                timeframe: timeframe,
                timestamp: now.toISOString(),
                date: now.toLocaleDateString('ja-JP'),
                time: now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })
            };
            
            memoData.unshift(memo); // Êñ∞„Åó„ÅÑ„É°„É¢„ÇíÂÖàÈ†≠„Å´ËøΩÂä†
            
            // Firebase„Å´‰øùÂ≠ò
            if (currentUser) {
                saveMemoToFirebase(memo);
            } else {
                // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
                localStorage.setItem('memos', JSON.stringify(memoData));
            }
            
            // Ë°®Á§∫„ÇíÊõ¥Êñ∞
            updateMemoDisplay();
            updateMemoStats();
            
            // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
            document.getElementById('newMemoText').value = '';
            document.getElementById('memoCategory').value = '';
            document.getElementById('memoPriority').value = '';
            document.getElementById('memoTimeframe').value = '';
            
            log(`üìù „É°„É¢„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü${category ? ` [${category}]` : ''}: ${memoText.substring(0, 30)}${memoText.length > 30 ? '...' : ''}`);
        };

        // Firebase„Å´„É°„É¢„Çí‰øùÂ≠ò
        function saveMemoToFirebase(memo) {
            if (!currentUser || !firebase.database) return;
            
            firebase.database().ref(`users/${currentUser.uid}/memos/${memo.id}`).set(memo)
            .then(() => {
                console.log('„É°„É¢„ÇíFirebase„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            })
            .catch((error) => {
                console.error('Firebase„Å∏„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', error);
                log('‚ùå „É°„É¢„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            });
        }

        // „É°„É¢Ë°®Á§∫„ÇíÊõ¥Êñ∞
        function updateMemoDisplay() {
            const container = document.getElementById('memoListArea');
            
            if (memoData.length === 0) {
                container.innerHTML = '„Åæ„Å†„É°„É¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                return;
            }
            
            const html = memoData.map(memo => {
                const categoryBadge = memo.category ? 
                    `<span style="background: #6c757d; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-right: 5px;">${memo.category}</span>` : '';
                
                // ÈáçË¶ÅÂ∫¶„ÅÆ„Éê„ÉÉ„Ç∏
                const priorityBadge = memo.priority ? 
                    `<span style="background: ${getPriorityColor(memo.priority)}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-right: 5px; font-weight: bold;">${getPriorityIcon(memo.priority)} ${memo.priority}</span>` : '';
                
                // ÂØæÂøúÊôÇÈñì„ÅÆ„Éê„ÉÉ„Ç∏
                const timeframeBadge = memo.timeframe ? 
                    `<span style="background: ${getTimeframeColor(memo.timeframe)}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-right: 5px;">${getTimeframeIcon(memo.timeframe)} ${memo.timeframe}</span>` : '';
                
                return `
                    <div class="memo-item">
                        <div class="memo-header">
                            <div style="flex: 1;">
                                ${priorityBadge}${timeframeBadge}${categoryBadge}
                                <small class="memo-date">${memo.date} ${memo.time}</small>
                            </div>
                            <button onclick="deleteMemo(${memo.id})" class="memo-delete-btn">üóëÔ∏è</button>
                        </div>
                        <div class="memo-text">
                            ${memo.text}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // „É°„É¢„ÇíÂâäÈô§
        window.deleteMemo = (memoId) => {
            if (!confirm('„Åì„ÅÆ„É°„É¢„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }
            
            memoData = memoData.filter(memo => memo.id !== memoId);
            
            // Firebase„Åã„ÇâÂâäÈô§
            if (currentUser) {
                firebase.database().ref(`users/${currentUser.uid}/memos/${memoId}`).remove();
            } else {
                // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÇíÊõ¥Êñ∞
                localStorage.setItem('memos', JSON.stringify(memoData));
            }
            
            updateMemoDisplay();
            updateMemoStats();
            log('üóëÔ∏è „É°„É¢„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
        };

        // ÂÖ®„É°„É¢„ÇíÂâäÈô§
        window.clearAllMemos = () => {
            if (!confirm('„Åô„Åπ„Å¶„ÅÆ„É°„É¢„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                return;
            }
            
            memoData = [];
            
            // Firebase„Åã„ÇâÂâäÈô§
            if (currentUser) {
                firebase.database().ref(`users/${currentUser.uid}/memos`).remove();
            } else {
                // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÇíÊõ¥Êñ∞
                localStorage.setItem('memos', JSON.stringify(memoData));
            }
            
            updateMemoDisplay();
            updateMemoStats();
            log('üóëÔ∏è „Åô„Åπ„Å¶„ÅÆ„É°„É¢„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
        };

        // „É°„É¢Áµ±Ë®à„ÇíÊõ¥Êñ∞
        function updateMemoStats() {
            const now = new Date();
            const today = now.toLocaleDateString('ja-JP');
            
            // ‰ªäÈÄ±„ÅÆÈñãÂßãÊó•ÔºàÊúàÊõúÊó•Ôºâ„ÇíË®àÁÆó
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - ((now.getDay() + 6) % 7));
            weekStart.setHours(0, 0, 0, 0);
            
            // ‰ªäÊúà„ÅÆÈñãÂßãÊó•„ÇíË®àÁÆó
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const todayCount = memoData.filter(memo => memo.date === today).length;
            const weekCount = memoData.filter(memo => new Date(memo.timestamp) >= weekStart).length;
            const monthCount = memoData.filter(memo => new Date(memo.timestamp) >= monthStart).length;
            
            document.getElementById('totalMemoCount').textContent = memoData.length;
            document.getElementById('todayMemoCount').textContent = todayCount;
            document.getElementById('weekMemoCount').textContent = weekCount;
            document.getElementById('monthMemoCount').textContent = monthCount;
        }

        // ÂÖ®„É°„É¢„Çí„Ç≥„Éî„Éº
        window.copyAllMemos = () => {
            if (memoData.length === 0) {
                alert('„Ç≥„Éî„Éº„Åô„Çã„É°„É¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            const copyText = memoData.map(memo => {
                const categoryText = memo.category ? `[${memo.category}] ` : '';
                return `${memo.date} ${memo.time} ${categoryText}${memo.text}`;
            }).join('\n\n');
            
            navigator.clipboard.writeText(copyText).then(() => {
                log('üìã ÂÖ®„É°„É¢„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            }).catch(() => {
                log('‚ùå „Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            });
        };

        // „É°„É¢„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
        function loadMemoData() {
            if (currentUser) {
                // Firebase„Åã„ÇâË™≠„ÅøËæº„Åø
                firebase.database().ref(`users/${currentUser.uid}/memos`).on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        memoData = Object.values(data).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    } else {
                        memoData = [];
                    }
                    updateMemoDisplay();
                    updateMemoStats();
                });
            } else {
                // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâË™≠„ÅøËæº„Åø
                const stored = localStorage.getItem('memos');
                if (stored) {
                    memoData = JSON.parse(stored);
                }
                updateMemoDisplay();
                updateMemoStats();
            }
        }

        // Enter„Ç≠„Éº„Åß„É°„É¢ËøΩÂä†ÔºàCtrl+Enter„ÅÆÂ†¥ÂêàÔºâ
        document.addEventListener('DOMContentLoaded', () => {
            const memoTextArea = document.getElementById('newMemoText');
            if (memoTextArea) {
                memoTextArea.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        addMemo();
                    }
                });
            }
            
            // Êú™„É≠„Ç∞„Ç§„É≥ÊôÇ„ÅÆ„É°„É¢„Éá„Éº„ÇøÂàùÊúüÂåñ
            if (!currentUser) {
                loadMemoData();
            }
        });

    </script>
</body>
</html>
